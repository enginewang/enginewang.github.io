[{"categories":"posts","content":"\u003ch2 id=\"翻转链表寻找相同状态迭代与递归\"\u003e翻转链表：寻找相同状态迭代与递归\u003c/h2\u003e\n\u003cp\u003e有些指针变来变去的题目，特别绕，比如翻转链表。\u003c/p\u003e\n\u003ch3 id=\"leetcode-206-反转链表-httpsleetcodecnproblemsreverse-linked-list\"\u003e\u003ca href=\"https://leetcode.cn/problems/reverse-linked-list/\"\u003eLeetCode 206. 反转链表 ☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e可以寻找相同的状态，解决这个状态下的问题，然后一个循环到最后。\u003c/p\u003e\n\u003cp\u003e相同状态就是：\n当前结点，前面一个结点已经倒序排好了，假设是back。后面还未遍历。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1644504983/lc206-1.png\" alt=\"leetcode206-1\"\u003e\u003c/p\u003e\n\u003cp\u003e先把循环写出来，很好写：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"c1\"\u003e// 为了方便直接让head走到底，head指针代码cur\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003enext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eback\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003eback\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003enext\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e然后再考虑最前面的情况：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 最开始没有back，让第一个是back，head往后移一个\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"nx\"\u003eback\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ehead\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 这边记得要把最开始head的Next置为nil，不然就无限循环了。\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"nx\"\u003eback\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e和最后的情况：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eback\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"leetcode-92-反转链表-ii-httpsleetcodecnproblemsreverse-linked-list-ii\"\u003e\u003ca href=\"https://leetcode.cn/problems/reverse-linked-list-ii/\"\u003eLeetCode 92. 反转链表 II ☆☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e反转一个区间内的链表\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://assets.leetcode.com/uploads/2021/02/19/rev2ex2.jpg\" alt=\"\"\u003e\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e输入：head = [1,2,3,4,5], left = 2, right = 4\n输出：[1,4,3,2,5]\n\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003ereverseBetween\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ehead\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eright\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 设置 dummyNode 是这一类问题的一般做法\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nx\"\u003edummyNode\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nx\"\u003eVal\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003edummyNode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003epre\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003edummyNode\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nx\"\u003eleft\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003epre\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003epre\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ecur\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003epre\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nx\"\u003eright\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"nx\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003enext\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003enext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003enext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003epre\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003epre\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003enext\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003edummyNode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"leetcode-25-k-个一组翻转链表-httpsleetcodecnproblemsreverse-nodes-in-k-group\"\u003e\u003ca href=\"https://leetcode.cn/problems/reverse-nodes-in-k-group/\"\u003eLeetCode 25. K 个一组翻转链表 ☆☆☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e给定一个链表，每 k 个节点一组进行翻转，返回翻转后的链表\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e32\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e33\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e34\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e35\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e36\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e37\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e38\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e39\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e40\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e41\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e42\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e43\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e44\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003ehasKNode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ehead\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ek\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ek\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n               \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n          \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n               \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\n          \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003ereverseKGroup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ehead\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ek\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ek\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\n     \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"nx\"\u003efirstTime\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\n     \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003eresult\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e\n     \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003etempTail\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e\n     \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nf\"\u003ehasKNode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n          \u003cspan class=\"nx\"\u003ep\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n          \u003cspan class=\"nx\"\u003etempHead\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\n          \u003cspan class=\"nx\"\u003eback\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\n          \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n          \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n               \u003cspan class=\"nx\"\u003ep\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n               \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ep\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"nx\"\u003ek\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n               \u003cspan class=\"nx\"\u003enext\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n               \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eback\u003c/span\u003e\n               \u003cspan class=\"nx\"\u003eback\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\n               \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003enext\u003c/span\u003e\n          \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n          \u003cspan class=\"nx\"\u003etempHead\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n          \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003efirstTime\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n               \u003cspan class=\"nx\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\n               \u003cspan class=\"nx\"\u003efirstTime\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\n          \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n               \u003cspan class=\"nx\"\u003etempTail\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\n          \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n          \u003cspan class=\"nx\"\u003etempTail\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003etempHead\u003c/span\u003e\n          \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eback\u003c/span\u003e\n          \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003etempHead\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n     \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003eresult\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"合并有序链表简单比较或最小堆\"\u003e合并有序链表：简单比较或最小堆\u003c/h2\u003e\n\u003ch3 id=\"leetcode-21-合并两个有序链表-httpsleetcodecnproblemsmerge-two-sorted-lists\"\u003e\u003ca href=\"https://leetcode.cn/problems/merge-two-sorted-lists/\"\u003eLeetCode 21. 合并两个有序链表 ☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e合并两个有序数组很简单，用两个指针从左往右遍历比较大小即可，小的接到结果链表上，最后一个到结尾了把另一个接上去就好了，很简单。\u003c/p\u003e\n\u003cp\u003e为了不讨论头结点的情况，一个更好的方式是用虚拟头结点DummyHead\n代码如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003emergeTwoLists\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003el1\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003el2\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003el1\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nx\"\u003el2\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003ehead\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nx\"\u003eVal\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003ecurrent\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003el1\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nx\"\u003el2\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003el1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eVal\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nx\"\u003el2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eVal\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003ecurrent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003el1\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003ecurrent\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003el1\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003el1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003el1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003ecurrent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003el2\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003ecurrent\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003el2\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003el2\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003el2\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003el1\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003ecurrent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003el2\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003ecurrent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003el1\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"leetcode-23-合并k个升序链表-httpsleetcodecnproblemsmiddle-of-the-linked-list\"\u003e\u003ca href=\"https://leetcode.cn/problems/middle-of-the-linked-list/\"\u003eLeetCode 23. 合并K个升序链表 ☆☆☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e一旦把两个拓展到K个，就比较困难了，因为要判断K个链表头结点的最小值，一般遍历的话复杂度很高，所以一个比较好的方式是用最小堆来实现，先实现一个堆的数据结构，加入每个链表的头结点，每次选出最小值的，然后从堆中剔除它，再加入该链表的next结点。\u003c/p\u003e\n\u003ch2 id=\"中点问题找环问题重复链表快慢指针构造相遇\"\u003e中点问题、找环问题、重复链表：快慢指针、构造相遇\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e中点问题\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"leetcode-876-链表的中间结点-httpsleetcodecnproblemsmiddle-of-the-linked-list\"\u003e\u003ca href=\"https://leetcode.cn/problems/middle-of-the-linked-list/\"\u003eLeetCode 876. 链表的中间结点 ☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e很简单，快慢指针，快的每次走两步，慢的每次走一步，快的指针走到最后时，慢的指针恰好在中间的位置。\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e找环问题\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"leetcode-141-环形链表-httpsleetcodecnproblemslinked-list-cycle\"\u003e\u003ca href=\"https://leetcode.cn/problems/linked-list-cycle/\"\u003eLeetCode 141. 环形链表 ☆\u003c/a\u003e\u003c/h3\u003e\n\u003ch3 id=\"leetcode-142-环形链表-ii-httpsleetcodecnproblemslinked-list-cycle-ii\"\u003e\u003ca href=\"https://leetcode.cn/problems/linked-list-cycle-ii/\"\u003eLeetCode 142. 环形链表 II ☆☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e当然，这类问题有一个更容易理解的解法，就是用哈希表将遇到的结点存起来，但是效率不及快慢指针法。\u003c/p\u003e\n\u003cp\u003e快慢指针法：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e定义两个指针slow、fast都处于开始的位置，每次迭代，fast往前走两步，slow往前走一步。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e如果fast遇到null，说明无环，直接返回\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e如果有环，fast必然会在slow走到第二圈之前追上slow\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e在追击的位置，另设一个指针从head开始，和slow一起一格一格走，它们两个相遇的位置就是成环的位置\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e如果有环，fast必然能追上slow，这一点很容易理解。\u003c/p\u003e\n\u003cp\u003e那么为什么slow走不到第二圈必然就会被追上？\nfast可能走了多圈，但是一定能在slow还没开始第二圈的时候追上slow。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1644504984/lc141-1.png\" alt=\"leetcode-141\"\u003e\u003c/p\u003e\n\u003cp\u003e举个极限的例子，假如说没有a，一开始就是环，此时由于fast速度是slow两倍，slow刚好走完一圈的时候，就被走完两圈的fast追上了。那么加上了a，也就是说slow走到环开始的地方的时候，fast早就进环了，反而能更快地追上a，所以a走不到一圈。\u003c/p\u003e\n\u003cp\u003eb可以走多圈，比如a很长，b+c比较短，slow走到了环开始的地方，fast就已经走了很多圈了。\u003c/p\u003e\n\u003cp\u003e假设fast走了f圈：\nslow走的长度：a + b\nfast走的长度：a + f(b+c) + b\n因为fast的速度是slow的两倍，时间一样，fast走的长度一定是slow的两倍，也就是：\na + f(b+c) + b = 2(a + s(b+c) + b)\n-\u0026gt; a + -f(b+c) + b = 0\n-\u0026gt; a = f(b+c) - b\u003c/p\u003e\n\u003cp\u003e那么我们发现，如果一个新的指针p从head开始走，之前的slow从之前相遇的地方开始走，它们都一格一格走，必然会相遇，而这个相遇的地方刚好就是开始有环的位置。\n此时p走了a = f(b+c) - b的距离，刚好是slow绕环f-1圈然后走一个c，它们刚好在环开始的地方相遇。\u003c/p\u003e\n\u003cp\u003e该算法的时间复杂度为$O(n)$，空间复杂度为$O(1)$\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003edetectCycle\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ehead\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003eslow\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003efast\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003efast\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nx\"\u003efast\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003efast\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003efast\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003eslow\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eslow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eslow\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"nx\"\u003efast\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003eslow\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\n\t\t\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003eslow\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"nx\"\u003efast\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003eslow\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eslow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003efast\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003efast\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n\t\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003eslow\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003col start=\"3\"\u003e\n\u003cli\u003e相交链表\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e相交链表是找相遇情况\u003c/p\u003e\n\u003ch3 id=\"leetcode-160-相交链表-httpsleetcodecnproblemsintersection-of-two-linked-lists\"\u003e\u003ca href=\"https://leetcode.cn/problems/intersection-of-two-linked-lists/\"\u003eLeetCode 160. 相交链表 ☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e这是一道很有意思的题目，实际上我们也需要某种方式让两个指针相遇。\u003c/p\u003e\n\u003cp\u003e假设两个链表长度分别是a和b，后面公共部分的长度是c，当然也可能没有公共部分。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1644504984/lc160-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e首先两个结点pa和pb分别从headA和headB开始往后以同样的速度依次遍历，直到一方走到最后，从另一个链表的头开始走起，如果有公共部分的话，pa在第二圈的首个公共结点处会走a（走了一次完整的a链表）+b-c的路程，pb在第二圈的首个公共结点处会走b（走了一次完整的b链表）+a-c的路程，pa和pb会在首个公共结点相遇。\u003c/p\u003e\n\u003cp\u003e要是a和b没有公共部分，那么它们会同时走完a+b的路程，同时为null，同样跳出循环。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003egetIntersectionNode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eheadA\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eheadB\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eheadA\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"nx\"\u003eheadB\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003epa\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epb\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003eheadA\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eheadB\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003epa\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"nx\"\u003epb\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003epa\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003epa\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003epa\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003epa\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eheadB\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003epb\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003epb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003epb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003epb\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eheadA\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003epa\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e还有一个巧妙的思路，就是将一条链表的末端连接零一条链的头部，这样的话问题就转换为了找环。\u003c/p\u003e\n\u003ch2 id=\"出现倒数尝试先遍历一次\"\u003e出现倒数：尝试先遍历一次\u003c/h2\u003e\n\u003ch3 id=\"leetcode-19-删除链表的倒数第-n-个结点-httpsleetcodecnproblemsremove-nth-node-from-end-of-list\"\u003e\u003ca href=\"https://leetcode.cn/problems/remove-nth-node-from-end-of-list/\"\u003eLeetCode 19. 删除链表的倒数第 N 个结点 ☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e出现倒数，先遍历一次，得到长度len，然后第二次遍历的时候找到len-N的结点，把这个结点删除即可，代码很简单\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"c1\"\u003e// 删除倒数第N个节点，那么我们当前遍历的指针一定要指向 第N个节点的前一个节点\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003eremoveNthFromEnd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ehead\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003en\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003edummyNode\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003eListNode\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nx\"\u003eVal\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003ecount\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003ecur\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehead\u003c/span\u003e\n\t\u003cspan class=\"c1\"\u003e// 首先要遍历一遍算一下有多长，从而计算倒数第N个是正数第几个\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ecur\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003ecur\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003ecount\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ecount\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"nx\"\u003en\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003ecur\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003edummyNode\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003eid\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003ecur\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003eid\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003edummyNode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eNext\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"leetcode-160-相交链表-httpsleetcodecnproblemsremove-nth-node-from-end-of-list\"\u003e\u003ca href=\"https://leetcode.cn/problems/remove-nth-node-from-end-of-list/\"\u003eLeetCode 160. 相交链表 ☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e上面已经讲了一个方法，但是第一次还是很难想到的，另一种思路是，既然重复的部分在最后，尝试先遍历一次。\u003c/p\u003e\n\u003cp\u003e先分别遍历依次pa和pb，找到各自的长度，让长度长的先往后走到和短的一样长，然后一起开始走，这样如果有交叉就一定能碰到，这种方式的复杂度并没有提升，而且更容易理解。当然只是代码的简洁程度和巧妙性不如前一种找相遇的方式。\u003c/p\u003e\n","date":1668935989,"description":"","fuzzywordcount":2800,"kind":"page","lang":"zh","lastmod":1673084269,"objectID":"8dd69823517e489164ca94e9f990bb58","publishdate":1668935989,"relpermalink":"/posts/leetcode-notes-linkedlist/","section":"posts","summary":"翻转链表：寻找相同状态迭代与递归 有些指针变来变去的题目，特别绕，比如翻转链表。 LeetCode 206. 反转链表 ☆ 可以寻找相同的状态，解决这个状态下的问题，然后一个循环到最后。 相同状","tags":["算法","LeetCode"],"title":"LeetCode算法笔记（链表篇）","url":"https://blog.engine.wang/posts/leetcode-notes-linkedlist/","wordcount":2749},{"categories":"posts","content":"\u003ch2 id=\"双指针\"\u003e双指针\u003c/h2\u003e\n\u003ch3 id=\"leetcode-27-移除元素-httpsleetcodecnproblemsremove-element\"\u003e\u003ca href=\"https://leetcode.cn/problems/remove-element/\"\u003eLeetCode 27. 移除元素 ☆\u003c/a\u003e\u003c/h3\u003e\n\u003cblockquote\u003e\n\u003cp\u003e给你一个数组 \u003ccode\u003enums\u003c/code\u003e 和一个值 \u003ccode\u003eval\u003c/code\u003e，你需要 \u003cstrong\u003e\u003ca href=\"https://baike.baidu.com/item/%E5%8E%9F%E5%9C%B0%E7%AE%97%E6%B3%95\"\u003e原地\u003c/a\u003e\u003c/strong\u003e 移除所有数值等于 \u003ccode\u003eval\u003c/code\u003e 的元素，并返回移除后数组的新长度。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003eremoveElement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eval\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003eleft\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003enum\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003enum\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"nx\"\u003eval\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003enum\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003eleft\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003eleft\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"leetcode-977-有序数组的平方-httpsleetcodecnproblemssquares-of-a-sorted-array\"\u003e\u003ca href=\"https://leetcode.cn/problems/squares-of-a-sorted-array/\"\u003eLeetCode 977. 有序数组的平方 ☆\u003c/a\u003e\u003c/h3\u003e\n\u003cblockquote\u003e\n\u003cp\u003e给你一个按 \u003cstrong\u003e非递减顺序\u003c/strong\u003e 排序的整数数组 \u003ccode\u003enums\u003c/code\u003e，返回 \u003cstrong\u003e每个数字的平方\u003c/strong\u003e 组成的新数组，要求也按 \u003cstrong\u003e非递减顺序\u003c/strong\u003e 排序。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e思路：先找到最小的非负数的位置，然后左右双指针向左右移动，比较大小\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003esortedSquares\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003enum\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003enum\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003ej\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"nx\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ej\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\n\t\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e\n\t\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003eresult\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"二分查找\"\u003e二分查找\u003c/h2\u003e\n\u003cp\u003e掌握程度：基本掌握\u003c/p\u003e\n\u003cp\u003e二分查找本身原理比较简单，是一种分治的策略，但是实际写代码的时候，边界问题容易出错。\u003c/p\u003e\n\u003ch3 id=\"leetcode-704-二分查找-httpsleetcodecnproblemsbinary-search\"\u003e\u003ca href=\"https://leetcode.cn/problems/binary-search/\"\u003eLeetCode 704. 二分查找 ☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e搜索有序数组中target的位置，没找到则返回-1\u003c/p\u003e\n\u003cp\u003e首先要明确的是搜索的边界范围，是\u003ccode\u003e[left, right]\u003c/code\u003e还是\u003ccode\u003e[left, right)\u003c/code\u003e，比如下面两种都是对的。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003esearch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003etarget\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 在[left, right]搜索\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"nx\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eright\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003eleft\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"nx\"\u003eright\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003emid\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003eleft\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eright\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"nx\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003emid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nx\"\u003etarget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003eleft\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003emid\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003emid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nx\"\u003etarget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003eright\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003emid\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003emid\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"leetcode-35-搜索插入位置-httpsleetcodecnproblemssearch-insert-position\"\u003e\u003ca href=\"https://leetcode.cn/problems/search-insert-position/\"\u003eLeetCode 35. 搜索插入位置 ☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e在数组中找到目标值，并返回其索引。如果目标值不存在于数组中，返回它将会被按顺序插入的位置。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003esearchInsert\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003etarget\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"c1\"\u003e// 在[left, right]里寻找\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"nx\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eright\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003eleft\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"nx\"\u003eright\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003emid\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eright\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"nx\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003eleft\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003emid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nx\"\u003etarget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003eleft\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003emid\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003emid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nx\"\u003etarget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003eright\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003emid\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003emid\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003eleft\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"leetcode-34--在排序数组中查找元素的第一个和最后一个位置httpsleetcodecnproblemsfind-first-and-last-position-of-element-in-sorted-array\"\u003e\u003ca href=\"https://leetcode.cn/problems/find-first-and-last-position-of-element-in-sorted-array/\"\u003eLeetCode 34.  在排序数组中查找元素的第一个和最后一个位置☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e给定一个按照非递减顺序排列的整数数组 \u003ccode\u003enums\u003c/code\u003e，和一个目标值 \u003ccode\u003etarget\u003c/code\u003e。找出给定目标值在数组中的开始位置和结束位置。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e32\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e33\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003ebinarySearch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003etarget\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eright\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003eleft\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"nx\"\u003eright\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003emid\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eright\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"nx\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003eleft\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003emid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"nx\"\u003etarget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003emid\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003emid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nx\"\u003etarget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003eright\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003emid\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003eleft\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003emid\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003esearchRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003etarget\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003efindOne\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nf\"\u003ebinarySearch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003etarget\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003efindOne\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003efirstId\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003elastId\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003efindOne\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003efindOne\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003efirstId\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003efirstId\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"nx\"\u003etarget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003efirstId\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003elastId\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003elastId\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"nx\"\u003etarget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003elastId\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nx\"\u003efirstId\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003elastId\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"区间内元素之和前缀和\"\u003e区间内元素之和：前缀和\u003c/h2\u003e\n\u003cp\u003e掌握程度：基本掌握\u003c/p\u003e\n\u003cp\u003e通过构造一个新的数组，存储前缀和，从而节约时间。这也是一个空间换时间的典型方法。\u003c/p\u003e\n\u003cp\u003e前缀和的代码框架为：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\n\u003cspan class=\"nx\"\u003epreSum\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003epreSum\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epreSum\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"nx\"\u003e区间\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"nx\"\u003e的累加量\u003c/span\u003e\u003cspan class=\"err\"\u003e：\u003c/span\u003e\u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"leetcode-303-区域和检索---数组不可变-httpsleetcodecnproblemsrange-sum-query-immutable\"\u003e\u003ca href=\"https://leetcode.cn/problems/range-sum-query-immutable/\"\u003eLeetCode 303. 区域和检索 - 数组不可变 ☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e设定一个辅助数组aux，第i个位置存的是原数组arr的0-i的和，然后计算原数组(i,j]之和时直接aux[j]-aux[i]即可。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eNumArray\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eAux\u003c/span\u003e  \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003eConstructor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nx\"\u003eNumArray\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003esum\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ena\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eNumArray\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ev\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003esum\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"nx\"\u003ev\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ena\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eAux\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ena\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eAux\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003esum\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003ena\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ethis\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eNumArray\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eSumRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eleft\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eright\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eleft\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eAux\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003eright\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"nx\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eAux\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003eleft\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eAux\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003eright\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"leetcode-304-二维区域和检索---矩阵不可变-httpsleetcodecnproblemsrange-sum-query-2d-immutable\"\u003e\u003ca href=\"https://leetcode.cn/problems/range-sum-query-2d-immutable/\"\u003eLeetCode 304. 二维区域和检索 - 矩阵不可变 ☆☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e无非是把一维数组换为了二维数组，需要求给定左上角点和右下角点围城矩形包含的元素和，方法还是一样的。\n原矩阵matrix，创建一个二维辅助矩阵，其i行j列表示原矩阵左上角点和(i,j)点围成的矩形的和，原矩阵的任意一个矩形区域的和就可以通过四个矩形的容斥原理（左上+右下-右上-左下）算出来。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eNumMatrix\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eMatrix\u003c/span\u003e \u003cspan class=\"p\"\u003e[][]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003eConstructor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e \u003cspan class=\"p\"\u003e[][]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nx\"\u003eNumMatrix\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003enumMatrix\u003c/span\u003e \u003cspan class=\"nx\"\u003eNumMatrix\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003enumMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMatrix\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003emake\u003c/span\u003e\u003cspan class=\"p\"\u003e([][]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003enumMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMatrix\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003enumMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003emake\u003c/span\u003e\u003cspan class=\"p\"\u003e([]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e \u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nx\"\u003enumMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003enumMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003enumMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"nx\"\u003enumMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enumMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003enumMatrix\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ethis\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eNumMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eSumRegion\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003erow1\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ecol1\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003erow2\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ecol2\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003erow2\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ecol2\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"nx\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003erow1\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ecol2\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"nx\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003erow2\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ecol1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003erow1\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ecol1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"leetcode-560-和为-k-的子数组-httpsleetcodecnproblemssubarray-sum-equals-k\"\u003e\u003ca href=\"https://leetcode.cn/problems/subarray-sum-equals-k/\"\u003eLeetCode 560. 和为 K 的子数组 ☆☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e这道题给出一个数组，要找出和为K的连续的子数组的个数，实际上很容易想到，先构造一个前缀和辅助数组，然后构造两个for循环找出每种可能的情况，但是这样效率很低：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003esubarraySum\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ek\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003epreSum\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eresultSum\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003epreSum\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epreSum\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e([]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e\u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ej\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"nx\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"nx\"\u003eresultSum\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003eresultSum\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e注意到，使用前缀和数组之后，这个问题就变成了从前缀和数组中，找两个数，其差为K，与2Sum问题类似，使用一个哈希表即可优化，只需要一次从小到大的遍历，存preSumArray[i]+K -\u0026gt; 次数的映射，如果新的preSumArray[j]在这个哈希表中，结果就加preSumArray[j]\u003c/p\u003e\n\u003cp\u003e所以优化为：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003esubarraySum\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ek\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003epreSum\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eresultSum\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003epreSum\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epreSum\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e([]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e\u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eauxMap\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003emake\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003emap\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eok\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003eauxMap\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]];\u003c/span\u003e \u003cspan class=\"nx\"\u003eok\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nx\"\u003eresultSum\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"nx\"\u003eauxMap\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]]\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003eauxMap\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003epreSumArray\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"nx\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003eresultSum\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"leetcode-1248-统计优美子数组-httpsleetcodecnproblemscount-number-of-nice-subarrays\"\u003e\u003ca href=\"https://leetcode.cn/problems/count-number-of-nice-subarrays/\"\u003eLeetCode 1248. 统计「优美子数组」 ☆☆\u003c/a\u003e\u003c/h3\u003e\n\u003ch2 id=\"差分数组\"\u003e差分数组\u003c/h2\u003e\n\u003cp\u003e差分相当于前缀和的逆变换，数组前缀和的差分就是原数组。差分数组的适用场景是频繁对区间内的元素进行增减运算。\u003c/p\u003e\n\u003cp\u003e差分数组\u003ccode\u003ediff[i] = arr[i] - arr[i-1]\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1644634855/chafenshuzhu-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e很容易发现差分数组做一次前缀和，就可以恢复为原数组。\u003c/p\u003e\n\u003cp\u003e此时如要要对原数组区间[i,j]统一增加k，那么只需要差分数组\u003ccode\u003ediff[i] += k\u003c/code\u003e，\u003ccode\u003ediff[j+1] -= k\u003c/code\u003e即可。\u003c/p\u003e\n\u003cp\u003e差分数组的代码框架为：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ediffArray\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]}\u003c/span\u003e\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ediffArray\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ediffArray\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"nx\"\u003enums\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 区间[i, j]上增加val\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"nx\"\u003ediff\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"nx\"\u003eval\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ediff\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ediff\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"nx\"\u003eval\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\n\u003cspan class=\"c1\"\u003e// 构造前缀和还原\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\n\u003cspan class=\"nx\"\u003epreSum\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003ediffArray\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003epreSum\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epreSum\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"leetcode-370-区间加法-\"\u003eLeetCode 370. 区间加法 ☆☆\u003c/h3\u003e\n\u003cp\u003e直接考察差分数组，直接套代码框架即可。（不过该题为LeetCode会员题）\u003c/p\u003e\n\u003ch3 id=\"leetcode-1109-航班预订统计-httpsleetcodecnproblemscorporate-flight-bookings\"\u003e\u003ca href=\"https://leetcode.cn/problems/corporate-flight-bookings/\"\u003eLeetCode 1109. 航班预订统计 ☆☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e题目例子如下：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e输入：bookings = [[1,2,10],[2,3,20],[2,5,25]], n = 5\n输出：[10,55,45,25,25]\n解释：\n航班编号        1   2   3   4   5\n预订记录 1 ：   10  10\n预订记录 2 ：       20  20\n预订记录 3 ：       25  25  25  25\n总座位数：      10  55  45  25  25\nanswer = [10,55,45,25,25]\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e实际上还是区间加法，只是加了一个应用场景。\n不过这里注意航班从1开始，所以first和last先-1。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003ecorpFlightBookings\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ebookings\u003c/span\u003e \u003cspan class=\"p\"\u003e[][]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003en\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eresult\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003emake\u003c/span\u003e\u003cspan class=\"p\"\u003e([]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ediffArray\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003emake\u003c/span\u003e\u003cspan class=\"p\"\u003e([]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ebooking\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003ebookings\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003efirst\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ebooking\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003elast\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ebooking\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003eseats\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ebooking\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ediffArray\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003efirst\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"nx\"\u003eseats\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003elast\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nx\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nx\"\u003ediffArray\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003elast\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"nx\"\u003eseats\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ecur\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ediff\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003ediffArray\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ecur\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"nx\"\u003ediff\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ecur\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003eresult\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"leetcode-1094-拼车-httpsleetcodecnproblemscorporate-flight-bookings\"\u003e\u003ca href=\"https://leetcode.cn/problems/corporate-flight-bookings/\"\u003eLeetCode 1094. 拼车 ☆☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e乘客行程计划表\u003ccode\u003etrips[][]\u003c/code\u003e，其中 \u003ccode\u003etrips[i] = [num_passengers, start_location, end_location]\u003c/code\u003e\n车子的容量是capacity，问中途是否可能接完所有乘客。\u003c/p\u003e\n\u003cp\u003e本质上还是和上面一样，不同的是注意可以先下后上，diffArray的生成方式要看具体的问题，最后转换为前缀和，看当前的载客量是否都小于capacity：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003ecarPooling\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003etrips\u003c/span\u003e \u003cspan class=\"p\"\u003e[][]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ecapacity\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003emaxLength\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003etrip\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003etrips\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003etrip\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nx\"\u003emaxLength\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nx\"\u003emaxLength\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003etrip\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ediffArray\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003emake\u003c/span\u003e\u003cspan class=\"p\"\u003e([]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003emaxLength\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003etrip\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003etrips\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003enumP\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003etrip\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003efrom\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003etrip\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003eto\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003etrip\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ediffArray\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"nx\"\u003enumP\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ediffArray\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"nx\"\u003enumP\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ecur\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003ediffArray\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ecur\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ecur\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nx\"\u003ecapacity\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"二维数组花式遍历\"\u003e二维数组花式遍历\u003c/h2\u003e\n\u003ch3 id=\"leetcode-48-旋转图像-httpsleetcodecnproblemsrotate-image\"\u003e\u003ca href=\"https://leetcode.cn/problems/rotate-image/\"\u003eLeetCode 48. 旋转图像 ☆☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e很简单，比如原地旋转图像，顺时针旋转90°等于先沿着对角线转置，再对于每一行进行翻转。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003erotate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e \u003cspan class=\"p\"\u003e[][]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003en\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 先转置\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ej\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nx\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 对于每行，左右颠倒\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ej\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nx\"\u003en\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003en\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003en\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"leetcode-54-螺旋矩阵-httpsleetcodecnproblemsspiral-matrix\"\u003e\u003ca href=\"https://leetcode.cn/problems/spiral-matrix/\"\u003eLeetCode 54. 螺旋矩阵 ☆☆\u003c/a\u003e\u003c/h3\u003e\n\u003cblockquote\u003e\n\u003cp\u003e按照顺时针螺旋遍历返回矩阵的所有元素\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e\u003cimg src=\"https://assets.leetcode.com/uploads/2020/11/13/spiral1.jpg\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e用四元组确定一个矩形，这个矩形随着每次遍历都有改变。这里用左上角的坐标和width、height确定。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e32\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e33\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003espiralOrder\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e \u003cspan class=\"p\"\u003e[][]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003earr\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eheight\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]),\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nx\"\u003eheight\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eheight\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nx\"\u003ex\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003earr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003earr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\t\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003eheight\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nx\"\u003ey\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"nx\"\u003eheight\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003earr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003earr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ex\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\t\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eheight\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"nx\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003earr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003earr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ey\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"nx\"\u003eheight\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\t\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003eheight\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003eheight\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"nx\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003earr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003earr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\t\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003earr\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"leetcode-59-螺旋矩阵-ii-httpsleetcodecnproblemsspiral-matrix-ii\"\u003e\u003ca href=\"https://leetcode.cn/problems/spiral-matrix-ii/\"\u003eLeetCode 59. 螺旋矩阵 II ☆☆\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003e和前一题相反，给定一个n，返回一个顺时针螺旋排列的正形矩阵。\u003c/p\u003e\n\u003cp\u003e代码只需要微调即可：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e32\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e33\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e34\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e35\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e36\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e37\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e38\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e39\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e40\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e41\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e42\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003egenerateMatrix\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003en\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e[][]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003emake\u003c/span\u003e\u003cspan class=\"p\"\u003e([][]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003emake\u003c/span\u003e\u003cspan class=\"p\"\u003e([]\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eheight\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003en\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003enum\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nx\"\u003eheight\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eheight\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nx\"\u003ex\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003enum\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003enum\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003eheight\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nx\"\u003ey\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"nx\"\u003eheight\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ex\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003enum\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003enum\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eheight\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"nx\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ey\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"nx\"\u003eheight\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003enum\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003enum\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003eheight\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003eheight\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"nx\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"nx\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003enum\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"nx\"\u003enum\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003ewidth\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003ematrix\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e","date":1667294389,"description":"","fuzzywordcount":3400,"kind":"page","lang":"zh","lastmod":1673084584,"objectID":"356c83db7cf2bef9ae3d7eb194eb7cad","publishdate":1667294389,"relpermalink":"/posts/leetcode-notes-array/","section":"posts","summary":"双指针 LeetCode 27. 移除元素 ☆ 给你一个数组 nums 和一个值 val，你需要 原地 移除所有数值等于 val 的元素，并返回移除后数组的新长度。 1 2 3 4 5 6 7 8 9 10 func removeElement(nums []int, val int) int { left := 0 for _, num :=","tags":["算法","LeetCode"],"title":"LeetCode算法笔记（数组篇）","url":"https://blog.engine.wang/posts/leetcode-notes-array/","wordcount":3337},{"categories":"posts","content":"\u003ch2 id=\"准备硬件环境\"\u003e准备硬件环境\u003c/h2\u003e\n\u003cp\u003ek8s搭建的一些难点：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e需要多台服务器，贵\u003c/li\u003e\n\u003cli\u003e搭建时需要科学上网\u003c/li\u003e\n\u003cli\u003e搭建比较复杂，学习起来也比较复杂\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e如果是学习阶段，也接触不到大型集群，可以在本地局域网进行搭建。\u003c/p\u003e\n\u003cp\u003e因为在学习k8s，但是要搭建集群的话最少也要两台机子（虚拟机也可以但是不太喜欢虚拟机），然而去云服务商租的话又太贵了，因为至少需要两核，所以就使用了本地局域网下的两台主机进行k8s搭建。其中一台主力机作为master，一台之前闲鱼收的废品mac mini 2012作为slave，之前内存只有4G（2+2），拆机升级到了10G（2+8），好在这个cpu有两个核心。\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:center\"\u003e\u003c/th\u003e\n\u003cth style=\"text-align:center\"\u003e角色\u003c/th\u003e\n\u003cth style=\"text-align:center\"\u003eOS\u003c/th\u003e\n\u003cth style=\"text-align:center\"\u003eMEM\u003c/th\u003e\n\u003cth style=\"text-align:center\"\u003eCPU\u003c/th\u003e\n\u003cth style=\"text-align:center\"\u003e核心数\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center\"\u003e台式工作站\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003eMaster\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003eUbuntu 18.04\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e32G\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003ei7-10700\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e8\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center\"\u003eMac mini 2012\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003eSlave\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003eUbuntu 18.04\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e10G\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003ei5-3210M\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e2\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e后面的操作都是以普通用户来操作，不直接用root因为不安全。\u003c/p\u003e\n\u003cp\u003e首先关闭swap\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# 关闭swap\u003c/span\u003e\n$ swapoff -a\n\u003cspan class=\"c1\"\u003e# 检查swap是否被成功关掉了\u003c/span\u003e\n$ free -m\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"安装-docker\"\u003e安装 Docker\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e32\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e33\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e34\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e35\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e36\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e37\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e38\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e39\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e40\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e41\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e42\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# (Install Docker CE)\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e## Set up the repository:\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e### Install packages to allow apt to use a repository over HTTPS\u003c/span\u003e\n$ sudo apt-get update \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e apt-get install -y \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  apt-transport-https ca-certificates curl software-properties-common gnupg2\n\n\u003cspan class=\"c1\"\u003e# Add Docker’s official GPG key:\u003c/span\u003e\n$ sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg \u003cspan class=\"p\"\u003e|\u003c/span\u003e  \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003esudo apt-key add -\n\n\u003cspan class=\"c1\"\u003e# Add the Docker apt repository:\u003c/span\u003e\n$ sudo add-apt-repository \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;deb [arch=amd64] https://download.docker.com/linux/ubuntu \\\n\u003c/span\u003e\u003cspan class=\"s2\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003elsb_release -cs\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"s2\"\u003e \\\n\u003c/span\u003e\u003cspan class=\"s2\"\u003e  stable\u0026#34;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Install Docker CE\u003c/span\u003e\n$ sudo apt-get update \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e sudo apt-get install -y \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    containerd.io\u003cspan class=\"o\"\u003e=\u003c/span\u003e1.2.13-1 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    docker-ce\u003cspan class=\"o\"\u003e=\u003c/span\u003e5:19.03.8~3-0~ubuntu-\u003cspan class=\"k\"\u003e$(\u003c/span\u003elsb_release -cs\u003cspan class=\"k\"\u003e)\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    docker-ce-cli\u003cspan class=\"o\"\u003e=\u003c/span\u003e5:19.03.8~3-0~ubuntu-\u003cspan class=\"k\"\u003e$(\u003c/span\u003elsb_release -cs\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\n\n$ sudo vim /etc/docker/daemon.json\n\u003cspan class=\"c1\"\u003e# 写入以下内容到该文件中\u003c/span\u003e\n\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"s2\"\u003e\u0026#34;exec-opts\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;native.cgroupdriver=systemd\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e]\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;log-driver\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;json-file\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;log-opts\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"s2\"\u003e\u0026#34;max-size\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;100m\u0026#34;\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;storage-driver\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;overlay2\u0026#34;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\nsudo mkdir -p /etc/systemd/system/docker.service.d\n\n\u003cspan class=\"c1\"\u003e# Restart Docker\u003c/span\u003e\n$ systemctl daemon-reload\n$ systemctl restart docker\n\n$ sudo usermod -aG docker \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eUSER\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e   \u003cspan class=\"c1\"\u003e#当前用户加入docker组\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"安装-kuberadm-kubelet-kubectl\"\u003e安装 kuberadm kubelet kubectl\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# Update the apt package index and install packages needed to use the Kubernetes apt repository:\u003c/span\u003e\n$ sudo apt-get update\n$ sudo apt-get install -y apt-transport-https ca-certificates curl\n\u003cspan class=\"c1\"\u003e# Install kubeadm\u003c/span\u003e\n$ sudo curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg \u003cspan class=\"p\"\u003e|\u003c/span\u003e sudo apt-key add -\n\u003cspan class=\"c1\"\u003e# Add the Kubernetes apt repository\u003c/span\u003e\n$ sudo tee /etc/apt/sources.list.d/kubernetes.list \u003cspan class=\"s\"\u003e\u0026lt;\u0026lt;-\u0026#39;EOF\u0026#39;\n\u003c/span\u003e\u003cspan class=\"s\"\u003edeb https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main\n\u003c/span\u003e\u003cspan class=\"s\"\u003eEOF\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# Update apt package index, install kubelet, kubeadm and kubectl\u003c/span\u003e\n$ sudo apt-get update\n$ sudo apt-get install -y kubelet kubeadm kubectl\n$ sudo apt-mark hold kubelet kubeadm kubectl\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"创建master节点\"\u003e创建master节点\u003c/h2\u003e\n\u003cp\u003e这是最关键的一步\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ sudo kubeadm init --apiserver-advertise-address\u003cspan class=\"o\"\u003e=\u003c/span\u003e192.168.50.175 --pod-network-cidr\u003cspan class=\"o\"\u003e=\u003c/span\u003e10.244.0.0/16 --image-repository registry.aliyuncs.com/google_containers\n\u003cspan class=\"o\"\u003e[\u003c/span\u003einit\u003cspan class=\"o\"\u003e]\u003c/span\u003e Using Kubernetes version: v1.25.0\n\u003cspan class=\"o\"\u003e[\u003c/span\u003epreflight\u003cspan class=\"o\"\u003e]\u003c/span\u003e Running pre-flight checks\n\u003cspan class=\"o\"\u003e[\u003c/span\u003epreflight\u003cspan class=\"o\"\u003e]\u003c/span\u003e Pulling images required \u003cspan class=\"k\"\u003efor\u003c/span\u003e setting up a Kubernetes cluster\n\u003cspan class=\"o\"\u003e[\u003c/span\u003epreflight\u003cspan class=\"o\"\u003e]\u003c/span\u003e This might take a minute or two, depending on the speed of your internet connection\n\u003cspan class=\"o\"\u003e[\u003c/span\u003epreflight\u003cspan class=\"o\"\u003e]\u003c/span\u003e You can also perform this action in beforehand using \u003cspan class=\"s1\"\u003e\u0026#39;kubeadm config images pull\u0026#39;\u003c/span\u003e\n...\n\nYour Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p \u003cspan class=\"nv\"\u003e$HOME\u003c/span\u003e/.kube\n  sudo cp -i /etc/kubernetes/admin.conf \u003cspan class=\"nv\"\u003e$HOME\u003c/span\u003e/.kube/config\n  sudo chown \u003cspan class=\"k\"\u003e$(\u003c/span\u003eid -u\u003cspan class=\"k\"\u003e)\u003c/span\u003e:\u003cspan class=\"k\"\u003e$(\u003c/span\u003eid -g\u003cspan class=\"k\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$HOME\u003c/span\u003e/.kube/config\n\nAlternatively, \u003cspan class=\"k\"\u003eif\u003c/span\u003e you are the root user, you can run:\n\n  \u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eKUBECONFIG\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/etc/kubernetes/admin.conf\n\nYou should now deploy a pod network to the cluster.\nRun \u003cspan class=\"s2\"\u003e\u0026#34;kubectl apply -f [podnetwork].yaml\u0026#34;\u003c/span\u003e with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join 192.168.50.175:6443 --token 89yinf.x0qkzypt93f7o456 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e\t--discovery-token-ca-cert-hash sha256:dea38ffb2e70723ecf808bec225e222affa13c5061a83b3ac9b215a8be946af5\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e如果要重新init，需要先停止服务，否则就会报错端口被占用，还要删除\u003ccode\u003e$HOME/.kube\u003c/code\u003e文件夹\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# 需要sudo\u003c/span\u003e\nsudo kubeadm reset\nsudo rm -rf \u003cspan class=\"nv\"\u003e$HOME\u003c/span\u003e/.kube\nsudo rm -rf /var/lib/etcd\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e复制kubeconfig\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ mkdir -p \u003cspan class=\"nv\"\u003e$HOME\u003c/span\u003e/.kube\n$ sudo cp -i /etc/kubernetes/admin.conf \u003cspan class=\"nv\"\u003e$HOME\u003c/span\u003e/.kube/config\n$ sudo chown \u003cspan class=\"k\"\u003e$(\u003c/span\u003eid -u\u003cspan class=\"k\"\u003e)\u003c/span\u003e:\u003cspan class=\"k\"\u003e$(\u003c/span\u003eid -g\u003cspan class=\"k\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$HOME\u003c/span\u003e/.kube/config\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"安装网络通信插件\"\u003e安装网络通信插件\u003c/h2\u003e\n\u003cp\u003e以Flannel为例：\u003c/p\u003e\n\u003cp\u003e首先解除master的污点，使其也可以调度pod\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003ekubectl taint nodes --all node-role.kubernetes.io/control-plane-\nkubectl taint nodes --all node-role.kubernetes.io/master-\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e一开始创建的时候声明为\u003ccode\u003e10.244.0.0/16\u003c/code\u003e，这里就不需要改\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003ewget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml\n\n\u003cspan class=\"c1\"\u003e# 安装flannel\u003c/span\u003e\nkubectl create -f kube-flannel.yml\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ kubectl get nodes -o wide\nNAME     STATUS   ROLES           AGE     VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME\nmaster   Ready    control-plane   3m58s   v1.25.0   192.168.50.174   \u0026lt;none\u0026gt;        Ubuntu 20.04.5 LTS   5.15.0-46-generic   containerd://1.6.8\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"slave节点加入\"\u003eslave节点加入\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ sudo kubeadm join 192.168.50.175:6443 --token 89yinf.x0qkzypt93f7o456 \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e\t--discovery-token-ca-cert-hash sha256:dea38ffb2e70723ecf808bec225e222affa13c5061a83b3ac9b215a8be946af5\n\u003cspan class=\"o\"\u003e[\u003c/span\u003epreflight\u003cspan class=\"o\"\u003e]\u003c/span\u003e Running pre-flight checks\n\u003cspan class=\"o\"\u003e[\u003c/span\u003epreflight\u003cspan class=\"o\"\u003e]\u003c/span\u003e Reading configuration from the cluster...\n\u003cspan class=\"o\"\u003e[\u003c/span\u003epreflight\u003cspan class=\"o\"\u003e]\u003c/span\u003e FYI: You can look at this config file with \u003cspan class=\"s1\"\u003e\u0026#39;kubectl -n kube-system get cm kubeadm-config -o yaml\u0026#39;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e[\u003c/span\u003ekubelet-start\u003cspan class=\"o\"\u003e]\u003c/span\u003e Writing kubelet configuration to file \u003cspan class=\"s2\"\u003e\u0026#34;/var/lib/kubelet/config.yaml\u0026#34;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e[\u003c/span\u003ekubelet-start\u003cspan class=\"o\"\u003e]\u003c/span\u003e Writing kubelet environment file with flags to file \u003cspan class=\"s2\"\u003e\u0026#34;/var/lib/kubelet/kubeadm-flags.env\u0026#34;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e[\u003c/span\u003ekubelet-start\u003cspan class=\"o\"\u003e]\u003c/span\u003e Starting the kubelet\n\u003cspan class=\"o\"\u003e[\u003c/span\u003ekubelet-start\u003cspan class=\"o\"\u003e]\u003c/span\u003e Waiting \u003cspan class=\"k\"\u003efor\u003c/span\u003e the kubelet to perform the TLS Bootstrap...\n\nThis node has joined the cluster:\n* Certificate signing request was sent to apiserver and a response was received.\n* The Kubelet was informed of the new secure connection details.\n\nRun \u003cspan class=\"s1\"\u003e\u0026#39;kubectl get nodes\u0026#39;\u003c/span\u003e on the control-plane to see this node join the cluster.\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e主节点\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# 查看已加入的节点\u003c/span\u003e\n$ kubectl get nodes -o wide\nNAME             STATUS   ROLES           AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME\nengine-macmini   Ready    control-plane   21m   v1.25.0   192.168.50.175   \u0026lt;none\u0026gt;        Ubuntu 18.04.6 LTS   5.4.0-132-generic   containerd://1.6.9\nmaster           Ready    \u0026lt;none\u0026gt;          52s   v1.25.0   192.168.50.174   \u0026lt;none\u0026gt;        Ubuntu 20.04.5 LTS   5.15.0-56-generic   containerd://1.6.10\n\n\u003cspan class=\"c1\"\u003e# 查看集群状态\u003c/span\u003e\n$ kubectl get cs\nWarning: v1 ComponentStatus is deprecated in v1.19+\nNAME                 STATUS    MESSAGE                         ERROR\nscheduler            Healthy   ok\ncontroller-manager   Healthy   ok\netcd-0               Healthy   \u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;health\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;reason\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ kubectl get pods --all-namespaces\nNAMESPACE      NAME                                     READY   STATUS    RESTARTS   AGE\nkube-flannel   kube-flannel-ds-kx57t                    1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e          11m\nkube-flannel   kube-flannel-ds-ps82g                    1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e          26m\nkube-system    coredns-565d847f94-v5574                 1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e          31m\nkube-system    coredns-565d847f94-vg6p5                 1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e          31m\nkube-system    etcd-engine-macmini                      1/1     Running   \u003cspan class=\"m\"\u003e1\u003c/span\u003e          31m\nkube-system    kube-apiserver-engine-macmini            1/1     Running   \u003cspan class=\"m\"\u003e1\u003c/span\u003e          31m\nkube-system    kube-controller-manager-engine-macmini   1/1     Running   \u003cspan class=\"m\"\u003e1\u003c/span\u003e          31m\nkube-system    kube-proxy-49bq9                         1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e          11m\nkube-system    kube-proxy-hc858                         1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e          31m\nkube-system    kube-scheduler-engine-macmini            1/1     Running   \u003cspan class=\"m\"\u003e1\u003c/span\u003e          31m\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"k8s-dashboard配置\"\u003ek8s dashboard配置\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/web-ui-dashboard/\"\u003ehttps://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/web-ui-dashboard/\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003ekubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.0/aio/deploy/recommended.yaml\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"创建用户\"\u003e创建用户\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md\"\u003ehttps://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ vim dashboard-adminuser.yaml\n\u003cspan class=\"c1\"\u003e# 写入以下内容\u003c/span\u003e\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: admin-user\n  namespace: kubernetes-dashboard\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: admin-user\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cluster-admin\nsubjects:\n- kind: ServiceAccount\n  name: admin-user\n  namespace: kubernetes-dashboard\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003ekubectl apply -f dashboard-adminuser.yaml\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003ekubectl -n kubernetes-dashboard create token admin-user\n\u003cspan class=\"c1\"\u003e# 会输出一长串token，复制登录即可\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://github.com/kubernetes/dashboard/raw/master/docs/images/signin.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e如果要删除用户：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003ekubectl -n kubernetes-dashboard delete serviceaccount admin-user\nkubectl -n kubernetes-dashboard delete clusterrolebinding admin-user\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# 开启proxy，设置address使得非本机也可以访问\u003c/span\u003e\n$ nohup kubectl proxy --address\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;0.0.0.0\u0026#39;\u003c/span\u003e --port\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e8001\u003c/span\u003e --accept-hosts\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;.*\u0026#39;\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\n$ nohup kubectl port-forward -n kubernetes-dashboard --address 0.0.0.0 service/kubernetes-dashboard 8080:443 \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"本机访问\"\u003e本机访问\u003c/h3\u003e\n\u003cp\u003e只能http\u003c/p\u003e\n\u003cp\u003ehttp://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/\u003c/p\u003e\n\u003ch3 id=\"局域网访问\"\u003e局域网访问\u003c/h3\u003e\n\u003cp\u003e只能https\u003c/p\u003e\n\u003cp\u003e修改service kubernetes-dashboard，最后的ClusterIP改为NodePort。查看Service：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ get svc --all-namespaces\nNAMESPACE              NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT\u003cspan class=\"o\"\u003e(\u003c/span\u003eS\u003cspan class=\"o\"\u003e)\u003c/span\u003e                  AGE\ndefault                kubernetes                  ClusterIP   10.96.0.1        \u0026lt;none\u0026gt;        443/TCP                  13h\nk8s-learning           nginx                       ClusterIP   None             \u0026lt;none\u0026gt;        80/TCP                   7h28m\nkube-system            kube-dns                    ClusterIP   10.96.0.10       \u0026lt;none\u0026gt;        53/UDP,53/TCP,9153/TCP   13h\nkubernetes-dashboard   dashboard-metrics-scraper   ClusterIP   10.103.123.173   \u0026lt;none\u0026gt;        8000/TCP                 13h\nkubernetes-dashboard   kubernetes-dashboard        NodePort    10.105.70.41     \u0026lt;none\u0026gt;        443:30659/TCP            \u003cspan class=\"m\"\u003e13\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e这里映射到了30659，访问：\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ehttps://\u0026lt;master_ip\u0026gt;:30659\u003c/code\u003e即可\u003c/p\u003e\n\u003cp\u003e如果是Chrome可能在点击详情看不到不安全仍然访问的按钮，而是直接报错连接不私密。此时任意点击网页中的空白的地方，然后输入\u003ccode\u003ethisisunsafe\u003c/code\u003e，回车就可以访问了。\u003c/p\u003e\n\u003ch3 id=\"公网ip云服务器访问\"\u003e公网ip云服务器访问\u003c/h3\u003e\n\u003cp\u003e如果是在有公网IP的云服务器搭建，则无法通过http登录，但是不在一个局域网直接https也不行，有两种方式：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e简单\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e转发到8001之后，本地转发云端的8081到本地的8081\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003essh -L localhost:8001:localhost:8001 -NT ubuntu@ip\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e然后本机访问\nhttp://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/\n即可\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e配置HTTPS证书\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e这个复杂一些，之后如果实际经历了再写\u003c/p\u003e\n\u003cp\u003e登录的话将之前的token复制进去即可登录\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1663857908/k8s-dashboard-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"延长token过期时间\"\u003e延长token过期时间\u003c/h3\u003e\n\u003cp\u003edashboard的token默认15分钟就会过期，不太方便，可以修改从而延长过期时间。\u003c/p\u003e\n\u003cp\u003e取Deployment找到kubernetes-dashboard，进行修改：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-YAML\" data-lang=\"YAML\"\u003e\u003cspan class=\"nt\"\u003espec\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"l\"\u003e...\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nt\"\u003econtainers\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e- \u003cspan class=\"nt\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ekubernetes-dashboard\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"l\"\u003ekubernetesui/dashboard:v2.6.1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"nt\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"l\"\u003e...\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e      \u003c/span\u003e- \u003cspan class=\"s1\"\u003e\u0026#39;--token-ttl=43200\u0026#39;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e这样就将token延长到了43200秒，也就是12小时\u003c/p\u003e\n\u003ch2 id=\"安装过程中的一些报错\"\u003e安装过程中的一些报错\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003eThe connection to the server 192.168.50.175:6443 was refused - did you specify the right host or port?\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003emaster节点重启，可能会报这个错。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ sudo swapoff -a\n$ strace -eopenat kubectl version\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003e[ERROR CRI]: container runtime is not running: output: E0812\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ sudo rm -rf /etc/containerd/config.toml\n$ systemctl restart containerd\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003ecoredns一直pending，无法调度\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003ekube-system    coredns-565d847f94-99kh9         0/1     Pending   \u003cspan class=\"m\"\u003e0\u003c/span\u003e          4m55s\nkube-system    coredns-565d847f94-rhmr4         0/1     Pending   \u003cspan class=\"m\"\u003e0\u003c/span\u003e          4m55s\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e检查对应的pod：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ kubectl describe pods -n kube-system coredns-565d847f94-99kh9\n...\nWarning  FailedScheduling  3m9s \u003cspan class=\"o\"\u003e(\u003c/span\u003ex2 over 8m26s\u003cspan class=\"o\"\u003e)\u003c/span\u003e  default-scheduler  0/1 nodes are available: \u003cspan class=\"m\"\u003e1\u003c/span\u003e node\u003cspan class=\"o\"\u003e(\u003c/span\u003es\u003cspan class=\"o\"\u003e)\u003c/span\u003e had untolerated taint \u003cspan class=\"o\"\u003e{\u003c/span\u003enode.kubernetes.io/disk-pressure: \u003cspan class=\"o\"\u003e}\u003c/span\u003e. preemption: 0/1 nodes are available: \u003cspan class=\"m\"\u003e1\u003c/span\u003e Preemption is not helpful \u003cspan class=\"k\"\u003efor\u003c/span\u003e scheduling.\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e看到这里是遇到了\u003ccode\u003enode.kubernetes.io/disk-pressure\u003c/code\u003e，主机磁盘空间不足，进行空间清理\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003ecoredns一直Container Creating，查看发现报错是 plugin type=\u0026quot;calico\u0026quot; failed (add): error getting ClusterInformation: Get \u0026quot;https://10.96.0.1:443/apis/crd.projectcalico.org/v1/clusterinformations/default\u0026quot;: dial tcp 10.96.0.1:443: i/o timeout\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003ecalico没卸干净，先卸载br开头的、calico的、Tunl0的网卡\u003c/p\u003e\n\u003cp\u003e网卡相关的错误，很多可以通过卸载网卡来解决，卸载掉比如br开头的，以及calico、flannel相关的网卡（如果要卸载的话）\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003esu\nip a\nifconfig \u0026lt;网卡id\u0026gt; down\nip link delete \u0026lt;网卡id\u0026gt;\nrm -rf /var/lib/cni/\nrm -f /etc/cni/net.d/*\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e然后去\u003ccode\u003e/etc/cni/net.d/\u003c/code\u003e把所有calico相关的都删掉\u003c/p\u003e\n\u003cp\u003e参考 \u003ca href=\"https://qiaolb.github.io/remove-calico.html\"\u003ehttps://qiaolb.github.io/remove-calico.html\u003c/a\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003edashboard失败，报错failed to set bridge addr: \u0026quot;cni0\u0026quot; already has an IP address different from 10.244.1.1/24\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e此时是master或者node已经有cni0网卡，但是和flannel冲突，一般是node的问题，去node删除cni0网卡。此时dashboard正常，但是这样又造成了coredns的网卡被挤掉了\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ kubectl get pods --all-namespaces\nNAMESPACE              NAME                                         READY   STATUS    RESTARTS      AGE\nkube-flannel           kube-flannel-ds-kx57t                        1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e             22m\nkube-flannel           kube-flannel-ds-ps82g                        1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e             36m\nkube-system            coredns-565d847f94-v5574                     0/1     Running   \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e84s ago\u003cspan class=\"o\"\u003e)\u003c/span\u003e   42m\nkube-system            coredns-565d847f94-vg6p5                     0/1     Running   \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e74s ago\u003cspan class=\"o\"\u003e)\u003c/span\u003e   42m\nkube-system            etcd-engine-macmini                          1/1     Running   \u003cspan class=\"m\"\u003e1\u003c/span\u003e             42m\nkube-system            kube-apiserver-engine-macmini                1/1     Running   \u003cspan class=\"m\"\u003e1\u003c/span\u003e             42m\nkube-system            kube-controller-manager-engine-macmini       1/1     Running   \u003cspan class=\"m\"\u003e1\u003c/span\u003e             42m\nkube-system            kube-proxy-49bq9                             1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e             22m\nkube-system            kube-proxy-hc858                             1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e             42m\nkube-system            kube-scheduler-engine-macmini                1/1     Running   \u003cspan class=\"m\"\u003e1\u003c/span\u003e             42m\nkubernetes-dashboard   dashboard-metrics-scraper-748b4f5b9d-vm4xj   1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e             9m16s\nkubernetes-dashboard   kubernetes-dashboard-5dff5767b9-rtkc6        1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e             9m16s\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e此时delete掉两个coredns即可恢复。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e $ kubectl delete pod -n kube-system coredns-565d847f94-v5574                         \npod \u003cspan class=\"s2\"\u003e\u0026#34;coredns-565d847f94-v5574\u0026#34;\u003c/span\u003e deleted\n$ dashboard kubectl delete pod -n kube-system coredns-565d847f94-vg6p5                        \npod \u003cspan class=\"s2\"\u003e\u0026#34;coredns-565d847f94-vg6p5\u0026#34;\u003c/span\u003e deleted\n$  dashboard kubectl get pods --all-namespaces                         \nNAMESPACE              NAME                                         READY   STATUS    RESTARTS   AGE\nkube-flannel           kube-flannel-ds-kx57t                        1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e          22m\nkube-flannel           kube-flannel-ds-ps82g                        1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e          37m\nkube-system            coredns-565d847f94-fdflx                     1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e          9s\nkube-system            coredns-565d847f94-vhddz                     1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e          21s\nkube-system            etcd-engine-macmini                          1/1     Running   \u003cspan class=\"m\"\u003e1\u003c/span\u003e          42m\nkube-system            kube-apiserver-engine-macmini                1/1     Running   \u003cspan class=\"m\"\u003e1\u003c/span\u003e          42m\nkube-system            kube-controller-manager-engine-macmini       1/1     Running   \u003cspan class=\"m\"\u003e1\u003c/span\u003e          42m\nkube-system            kube-proxy-49bq9                             1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e          22m\nkube-system            kube-proxy-hc858                             1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e          42m\nkube-system            kube-scheduler-engine-macmini                1/1     Running   \u003cspan class=\"m\"\u003e1\u003c/span\u003e          42m\nkubernetes-dashboard   dashboard-metrics-scraper-748b4f5b9d-vm4xj   1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e          9m53s\nkubernetes-dashboard   kubernetes-dashboard-5dff5767b9-rtkc6        1/1     Running   \u003cspan class=\"m\"\u003e0\u003c/span\u003e          9m53s\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e","date":1662705239,"description":"","fuzzywordcount":3000,"kind":"page","lang":"zh","lastmod":1675142639,"objectID":"243d4bf6e0e8ec2b2e0af13b0f3fc54c","publishdate":1662705239,"relpermalink":"/posts/k8s-kubeadm-setup/","section":"posts","summary":"准备硬件环境 k8s搭建的一些难点： 需要多台服务器，贵 搭建时需要科学上网 搭建比较复杂，学习起来也比较复杂 如果是学习阶段，也接触不到大型集群，可以在本地局域网进行搭","tags":["Kubernetes","分布式","Docker","Linux"],"title":"通过kubeadm搭建Kubernetes集群","url":"https://blog.engine.wang/posts/k8s-kubeadm-setup/","wordcount":2996},{"categories":"posts","content":"\u003ch2 id=\"前言\"\u003e前言\u003c/h2\u003e\n\u003cp\u003e一般来说，除了一些企业高校等机构，国内绝大部分普通人没有ipv4的公网ip且极难申请到，毕竟用一个少一个，并且由于一些原因，国内ipv6也不太可能普及的起来，这么多年基本没什么发展。我们在学校、家庭的路由器都是运营商通过NAT等方式转接，都处于内网之中，需要在局域网内才能访问到相关的服务。\u003c/p\u003e\n\u003cp\u003e但如果我们在外面有访问内网web服务、远程ssh内网服务器、远程访问内网NAS等需求的话，该怎么办呢？内网穿透可以在一定程度上解决这个需求。所谓内网穿透，也称为NAT穿透，要想了解其具体原理，首先要了解NAT技术。\u003c/p\u003e\n\u003ch2 id=\"nat技术\"\u003eNAT技术\u003c/h2\u003e\n\u003cp\u003eNAT（Network Address Translation，网络地址转换）是一个将内部私有的网络地址翻译成合法ip地址的技术。\u003c/p\u003e\n\u003cp\u003eNAT分为三种：静态NAT、动态地址NAT、网络地址端口转换NAPT。\u003c/p\u003e\n\u003ch3 id=\"静态nat\"\u003e静态NAT\u003c/h3\u003e\n\u003cp\u003e静态NAT就是内网和公网IP一一对应，这个方式用的很少\u003c/p\u003e\n\u003ch3 id=\"动态地址nat\"\u003e动态地址NAT\u003c/h3\u003e\n\u003cp\u003eNAT网关有多个公网IP，内网机器发送IP报文的时候，NAT设备（通常是路由器或者防火墙）会分配一个可用的公网IP将源地址进行替换，目标地址不变\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://pic3.zhimg.com/80/v2-f3736378c423302b81ad889642ceb587_720w.jpg?source=1940ef5c\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e之后路由器在自己的NAT表中增加一个私有网络到公网地址映射的记录项，之后如果收到了server的回复，就将这个报文转发给私有网络中的客户端。这里私有网络IP和公网IP也是对应的，只是可以动态变化。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://picx.zhimg.com/80/v2-dc2a84984269febe7eb626b5f4a69861_720w.jpg?source=1940ef5c\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"网络地址端口转换napt\"\u003e网络地址端口转换NAPT\u003c/h3\u003e\n\u003cp\u003eNAT技术中，使用最普遍的是NAPT，它指的是将内部的地址映射到外部网络的一个IP的不同端口上，可以将一个小型的网络隐藏在一个合法的IP地址后面。\u003c/p\u003e\n\u003cp\u003e比起前面的两种公网私网ip一一对应的方式，NAPT可以将非常多的私有地址映射到一个公共IP上，国内基本都使用这种方式解决公网IP不够的问题（当然ipv6更好，但是国内并不会推，因为有其他的原因），\u003c/p\u003e\n\u003cp\u003e私有网内部的主机发送IP包经过NAT网关，私网IP与NAT网关的公共IP的一个端口进行关联然后转发到公网，此时的IP包不再含有任何私有网络的信息。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://picx.zhimg.com/80/v2-34da92151023c595b9bbad1e180fde15_720w.jpg?source=1940ef5c\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e这样一个私有网络（比如10.0.0.1:1024）会被映射到一个公共网络ip+端口上（比如219.134.180.11:2001）\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://pic2.zhimg.com/80/v2-51c40f6df15710213bedcb6d7e21976e_720w.jpg?source=1940ef5c\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e路由器收到目标服务器返回的报文后，也查表进行转换，替换目标地址为私网内的ip。\u003c/p\u003e\n\u003cp\u003e完整的一个过程如下图所示：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1663343308/nat-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e当然NAT还可以细分为对称NAT、限制锥型NAT（ip限制/端口限制）、完全锥型NAT等，这里就不深入了。\u003c/p\u003e\n\u003ch2 id=\"内网穿透原理及工具\"\u003e内网穿透原理及工具\u003c/h2\u003e\n\u003cp\u003e内网穿透，就是解决如何访问内网ip的技术，因为处于内网的设备可以借助NAT访问外网，却很难被外网设备有效访问，比如在内网部署了一个web服务，而外面的客户端根本不知道对应NAT的ip和端口好，也就无法访问。\u003c/p\u003e\n\u003cp\u003e内网穿透就是通过对地址进行转换，将公共的网络地址转变为私有网络地址，采用一种路由的方式将一台有公网的计算机变成路由器的功能，实现了两个不同局域网下的计算机的沟通。\u003c/p\u003e\n\u003cp\u003e不同的内网穿透工具实现的技术细节略有不同，内网穿透工具，包括一些知名的开源项目，比如frp、ngrok等，以及一些给予frp和ngrok的二次开发的商用产品，比如花生壳等。ngrok是通过反向代理的方式，在公共端点和本地运行的 Web 服务器之间建立一个安全的通道，实现内网主机的服务可以暴露给外网。\u003c/p\u003e\n\u003cp\u003e而这里重点介绍和使用的是frp，它也是目前使用最广泛的一个开源内网穿透工具。\u003c/p\u003e\n\u003ch2 id=\"frp\"\u003efrp\u003c/h2\u003e\n\u003cp\u003efrp是一个用Go语言编写的，专注于内网穿透的高性能的反向代理应用，支持 TCP、UDP、HTTP、HTTPS 等多种协议。可以将内网服务以安全、便捷的方式通过具有公网 IP 节点的中转暴露到公网。\u003c/p\u003e\n\u003cp\u003efrp的github地址：\u003ca href=\"https://github.com/fatedier/frp\"\u003ehttps://github.com/fatedier/frp\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003efrp包括以下特性：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e客户端服务端通信支持 TCP、KCP 以及 Websocket 等多种协议。\u003c/li\u003e\n\u003cli\u003e采用 TCP 连接流式复用，在单个连接间承载更多请求，节省连接建立时间。\u003c/li\u003e\n\u003cli\u003e代理组间的负载均衡。\u003c/li\u003e\n\u003cli\u003e端口复用，多个服务通过同一个服务端端口暴露。\u003c/li\u003e\n\u003cli\u003e多个原生支持的客户端插件（静态文件查看，HTTP、SOCK5 代理等），便于独立使用 frp 客户端完成某些工作。\u003c/li\u003e\n\u003cli\u003e高度扩展性的服务端插件系统，方便结合自身需求进行功能扩展。\u003c/li\u003e\n\u003cli\u003e服务端和客户端 UI 页面。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"frp的组成\"\u003efrp的组成\u003c/h3\u003e\n\u003cp\u003efrp包含：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e服务端frps（有公网ip的机器，起转发作用）\u003c/li\u003e\n\u003cli\u003e客户端frpc（内网中需要做穿透的机器，提供服务供外面访问）\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"https://github.com/fatedier/frp/raw/dev/doc/pic/architecture.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"frp的工作流程\"\u003efrp的工作流程\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e首先，frpc 启动之后，会连接 frps，并且发送一个请求 login()，之后保持住这个长连接，如果断开了，就重试\u003c/li\u003e\n\u003cli\u003efrps 收到请求之后，会建立一个 listener 监听来自公网的请求\u003c/li\u003e\n\u003cli\u003e当 frps 接受到请求之后，会在本地看是否有可用的连接( frp 可以设置连接池)，如果没有，就下发一个 msg.StartWorkConn 并且 等待来自 frpc 的请求\u003c/li\u003e\n\u003cli\u003efrpc 收到之后，对 frps 发起请求，请求的最开始会指名这个连接是去向哪个 proxy 的\u003c/li\u003e\n\u003cli\u003efrps 收到来自 frpc 的连接之后，就把新建立的连接与来自公网的连接进行流量互转\u003c/li\u003e\n\u003cli\u003e如果请求断开了，那么就把另一端的请求也断开\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://jiajunhuang.com/articles/img/frp_flow.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"nginx和frp的区别\"\u003enginx和frp的区别\u003c/h3\u003e\n\u003cp\u003e前面提到了frp的本质是反向代理，而我们熟知的nginx也基于反向代理，但是nginx主要用于负载均衡，而frp用于内网穿透。nginx的逻辑如下：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://jiajunhuang.com/articles/img/nginx_flow.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"frp配置记录\"\u003efrp配置记录\u003c/h2\u003e\n\u003ch3 id=\"frps\"\u003efrps\u003c/h3\u003e\n\u003cp\u003efrps需要配置在有公网ip的服务器上，可以去腾讯云、阿里云、华为云等云服务商租服务器，这里我用的是腾讯云。\u003c/p\u003e\n\u003cp\u003e新用户的话很推荐腾讯云的服务器特惠活动，应该是目前几家大厂里最便宜的，一年只需要50多就可以搞到2核2G的服务器，可以点击下面的图片进入腾讯云特惠活动：\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://url.cn/W6cMbMm6\"\u003e\u003cimg src=\"https://s2.loli.net/2022/11/25/NtOMw7gYr32veXb.jpg\" alt=\"腾讯云特惠服务器\"\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e先购买一台服务器，推荐选择同地域的Ubuntu或者CentOS（因为我是老用户，所以会贵很多，而且界面可能跟特惠不太一样，不过逻辑差不多），这里我选的是常用的Ubuntu，当然CcentOS也基本一样，只需要修改少量的命令。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://s2.loli.net/2022/11/25/TxkczZs8BPaVviq.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e然后查看它的公网ip，如果想在本地终端连接的话，需要设一下ubuntu账户的ssh密码（下面的重置密码）或者通过密钥连接（需要去密钥管理里上传本机的ssh密钥，这里就不说了）：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://s2.loli.net/2022/11/25/32pMZSOGTh9fYba.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e远程ssh连接到服务器：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003essh ubuntu@\u0026lt;你的公网ip\u0026gt;\n\u003cspan class=\"c1\"\u003e# 密码是刚刚设置的密码\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e// 更新一波，并且装点常用软件\n$ sudo apt-get update\n$ sude apt-get upgrade\n$ sudo apt-get install wget vim git\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e开始配置frps，可以先创建一个目录：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ mkdir frp\n$ \u003cspan class=\"nb\"\u003ecd\u003c/span\u003e frp\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e本机去frp的releases页面：https://github.com/fatedier/frp/releases 找一下最新版本的链接，在服务器端下载对应版本（linux_amd64）并解压：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ wget https://github.com/fatedier/frp/releases/download/v0.45.0/frp_0.45.0_linux_amd64.tar.gz\n$ tar -zxvf frp_0.45.0_linux_amd64.tar.gz\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e修改里面的\u003ccode\u003efrps.ini\u003c/code\u003e：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"k\"\u003e[common]\u003c/span\u003e\n\u003cspan class=\"na\"\u003ebind_addr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e0.0.0.0\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# frp监听的端口，默认是7000，比较建议修改成其他的\u003c/span\u003e\n\u003cspan class=\"na\"\u003ebind_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026lt;port\u0026gt;\u003c/span\u003e\n\u003cspan class=\"na\"\u003ebind_udp_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e7001\u003c/span\u003e\n\u003cspan class=\"na\"\u003evhost_http_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e8080\u003c/span\u003e\n\u003cspan class=\"na\"\u003evhost_https_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e4433\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# frp的UI管理后台端口，请按自己需求更改\u003c/span\u003e\n\u003cspan class=\"na\"\u003edashboard_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e7500\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# frp的UI管理后台用户名和密码，请改成自己的\u003c/span\u003e\n\u003cspan class=\"na\"\u003edashboard_user\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003eadmin\u003c/span\u003e\n\u003cspan class=\"na\"\u003edashboard_pwd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026lt;设置你的密码\u0026gt;\u003c/span\u003e\n\u003cspan class=\"na\"\u003eenable_prometheus\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etrue\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# frp日志配置\u003c/span\u003e\n\u003cspan class=\"na\"\u003elog_file\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e/home/ubuntu/frp/frps.log\u003c/span\u003e\n\u003cspan class=\"na\"\u003elog_level\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003einfo\u003c/span\u003e\n\u003cspan class=\"na\"\u003elog_max_days\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e3\u003c/span\u003e\n\u003cspan class=\"na\"\u003edisable_log_color\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003efalse\u003c/span\u003e\n\u003cspan class=\"na\"\u003edetailed_errors_to_client\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etrue\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# token，用于内网穿透验证，最简单的验证方式\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 下面配置的token不要泄露，否则别人也可以用你的服务器进行内网穿透，也会造成安全隐患\u003c/span\u003e\n\u003cspan class=\"na\"\u003eauthentication_method\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etoken\u003c/span\u003e\n\u003cspan class=\"na\"\u003etoken\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026lt;设置你的token\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e还可以使用OIDC来验证，配置会更复杂，我没有试过，可以参考 \u003ca href=\"https://tools.ietf.org/html/rfc6749#section-4.4\"\u003eClient Credentials Grant\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e另外还需要去腾讯云后台把相关端口全部打开，暴力的话可以在腾讯云创建安全组，允许全部端口，当然这里最好是只开放相关的端口。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://s2.loli.net/2022/11/25/jTU5VYGheHC93go.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e以及关闭防火墙：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003esudo systemctl stop firealld\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e采用systemd的方式来配置frps服务，这样使用服务会更加方便，可以让服务运行在后台而且开机自启。\u003c/p\u003e\n\u003cp\u003e创建 /etc/systemd/system/frps.service并写入以下内容：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"k\"\u003e[Unit]\u003c/span\u003e\n\u003cspan class=\"na\"\u003eDescription\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eFrps\u003c/span\u003e\n\u003cspan class=\"na\"\u003eAfter\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003enetwork.target syslog.target\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003e[Service]\u003c/span\u003e\n\u003cspan class=\"na\"\u003eType\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003esimple\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 根据实际路径自行调整\u003c/span\u003e\n\u003cspan class=\"na\"\u003eExecStart\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e/home/ubuntu/frp/frps -c /home/ubuntu/frp/frps.ini\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003e[Install]\u003c/span\u003e\n\u003cspan class=\"na\"\u003eWantedBy\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003emulti-user.target\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e然后就可以通过systemctl的方式对frps服务进行操作了\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ sudo systemctl daemon-reload\n$ sudo systemctl stop frps\n$ sudo systemctl start frps\n$ sudo systemctl status frps\n frps.service - Frps\n   Loaded: loaded \u003cspan class=\"o\"\u003e(\u003c/span\u003e/etc/systemd/system/frps.service\u003cspan class=\"p\"\u003e;\u003c/span\u003e enabled\u003cspan class=\"p\"\u003e;\u003c/span\u003e vendor preset: enabled\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n   Active: active \u003cspan class=\"o\"\u003e(\u003c/span\u003erunning\u003cspan class=\"o\"\u003e)\u003c/span\u003e since Fri 2022-09-16 07:01:55 CST\u003cspan class=\"p\"\u003e;\u003c/span\u003e 1s ago\n Main PID: \u003cspan class=\"m\"\u003e3413\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003efrps\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n    Tasks: \u003cspan class=\"m\"\u003e3\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003elimit: 2366\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n   CGroup: /system.slice/frps.service\n           └─3413 /home/ubuntu/frp/frps -c /home/ubuntu/frp/frps.ini\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e前往\u003cip\u003e:7500并进行登录就可以访问到frp dashboard：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1663351907/frp_dashboard_1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e至此我们的服务器frps就配置好了，是比较简单的。\u003c/p\u003e\n\u003ch2 id=\"frpc配置\"\u003efrpc配置\u003c/h2\u003e\n\u003cp\u003e在需要穿透出去的内网本机上配置frpc。\u003c/p\u003e\n\u003cp\u003e也是同样去下载frp，需要下载跟frps相同版本的，然后修改frpc.ini配置文件：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"c1\"\u003e# 常规配置，这几个要与frps对应\u003c/span\u003e\n\u003cspan class=\"k\"\u003e[common]\u003c/span\u003e\n\u003cspan class=\"na\"\u003eserver_addr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026lt;server_ip\u0026gt;\u003c/span\u003e\n\u003cspan class=\"na\"\u003eserver_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026lt;port\u0026gt;\u003c/span\u003e\n\u003cspan class=\"na\"\u003etoken\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026lt;token\u0026gt;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# 后面的根据自己的需求写，比如ssh、web前后端、路由器、samba、nas、私有网盘服务等，后面一个一个举例\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e后面的内容根据实际的需求进行添加，这里并不需要再修改frps，只要服务端的remote_port是允许访问的即可（需要去腾讯云的控制台和用命令行关闭相关防火墙开放这些端口）\u003c/p\u003e\n\u003cp\u003e当然如果也是Linux的话，我们也可以使用systemd来管理\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ sudo vim /usr/lib/systemd/system/frpc.service\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"k\"\u003e[Unit]\u003c/span\u003e\n\u003cspan class=\"na\"\u003eDescription\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eFRP Server Daemon\u003c/span\u003e\n\u003cspan class=\"na\"\u003eAfter\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003enetwork.target\u003c/span\u003e\n\u003cspan class=\"na\"\u003eWants\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003enetwork.target\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003e[Service]\u003c/span\u003e\n\u003cspan class=\"na\"\u003eType\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003esimple\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 根据frp所在的实际路径进行调整\u003c/span\u003e\n\u003cspan class=\"na\"\u003eExecStart\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e/home/engine/Projects/frp/frpc -c /home/engine/Projects/frp/frpc.ini\u003c/span\u003e\n\u003cspan class=\"na\"\u003eRestart\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003ealways\u003c/span\u003e\n\u003cspan class=\"na\"\u003eRestartSec\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e2s\u003c/span\u003e\n\u003cspan class=\"na\"\u003eUser\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003enobody\u003c/span\u003e\n\u003cspan class=\"na\"\u003eLimitNOFILE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003einfinity\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003e[Install]\u003c/span\u003e\n\u003cspan class=\"na\"\u003eWantedBy\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003emulti-user.target\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# 更新配置\u003c/span\u003e\n$ systemctl daemon-reload\n\u003cspan class=\"c1\"\u003e# 启动服务\u003c/span\u003e\n$ systemctl start frpc\n\u003cspan class=\"c1\"\u003e# 设置开机启动\u003c/span\u003e\n$ systemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e frpc\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e如果是其他的系统或者路由器，修改frpc.ini然后常规启动就可以\u003c/p\u003e\n\u003ch3 id=\"ssh穿透\"\u003essh穿透\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"k\"\u003e[ssh]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e127.0.0.1\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e22\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 映射到远程的端口可以自己选定，选大一点的端口，自己记住就行了\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 记不住也没事，可以去web UI管理界面查\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026lt;remote_ip\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e在外面就可以远程ssh连接寝室的服务器了，当然这里要用-p指示端口：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ sudo ssh -p \u0026lt;remote_ip\u0026gt; \u0026lt;内网用户\u0026gt;@\u0026lt;server_ip\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"内网web穿透\"\u003e内网web穿透\u003c/h3\u003e\n\u003cp\u003e比如在本机部署了一个前后端的web，这里将本机前端的8080映射到服务器的8001端口。直接访问的话前端是不能跟后端连上的，所以后端也需要进行穿透。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"k\"\u003e[frontend]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e127.0.0.1\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e8080\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e8001\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003e[backend]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e127.0.0.1\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e7439\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e7439\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"cloudreve私有云存储\"\u003eCloudreve私有云存储\u003c/h3\u003e\n\u003cp\u003e可以用Cloudreve搭建私有云，不仅可以当做一个不限速的大容量网盘使用，也可以通过导入本地磁盘当做nas使用。\u003c/p\u003e\n\u003cp\u003e先安装Cloudreve\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e#解压获取到的主程序\u003c/span\u003e\n$ tar -zxvf cloudreve_VERSION_OS_ARCH.tar.gz\n\u003cspan class=\"c1\"\u003e# 赋予执行权限\u003c/span\u003e\n$ chmod +x ./cloudreve\n\u003cspan class=\"c1\"\u003e# 启动 Cloudreve\u003c/span\u003e\n$ ./cloudreve\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e会打印初始管理员账号和随机密码，要记住，之后需要登录。\u003c/p\u003e\n\u003cp\u003e可以通过systemd进行进程守护：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# 编辑配置文件\u003c/span\u003e\n$ vim /usr/lib/systemd/system/cloudreve.service\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e写入：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"k\"\u003e[Unit]\u003c/span\u003e\n\u003cspan class=\"na\"\u003eDescription\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eCloudreve\u003c/span\u003e\n\u003cspan class=\"na\"\u003eDocumentation\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003ehttps://docs.cloudreve.org\u003c/span\u003e\n\u003cspan class=\"na\"\u003eAfter\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003enetwork.target\u003c/span\u003e\n\u003cspan class=\"na\"\u003eAfter\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003emysqld.service\u003c/span\u003e\n\u003cspan class=\"na\"\u003eWants\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003enetwork.target\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003e[Service]\u003c/span\u003e\n\u003cspan class=\"na\"\u003eWorkingDirectory\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e/PATH_TO_CLOUDREVE\u003c/span\u003e\n\u003cspan class=\"na\"\u003eExecStart\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e/PATH_TO_CLOUDREVE/cloudreve\u003c/span\u003e\n\u003cspan class=\"na\"\u003eRestart\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003eon-abnormal\u003c/span\u003e\n\u003cspan class=\"na\"\u003eRestartSec\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003e5s\u003c/span\u003e\n\u003cspan class=\"na\"\u003eKillMode\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003emixed\u003c/span\u003e\n\n\u003cspan class=\"na\"\u003eStandardOutput\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003enull\u003c/span\u003e\n\u003cspan class=\"na\"\u003eStandardError\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003esyslog\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003e[Install]\u003c/span\u003e\n\u003cspan class=\"na\"\u003eWantedBy\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003emulti-user.target\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# 更新配置\u003c/span\u003e\nsystemctl daemon-reload\n\u003cspan class=\"c1\"\u003e# 启动服务\u003c/span\u003e\nsystemctl start cloudreve\n\u003cspan class=\"c1\"\u003e# 设置开机启动\u003c/span\u003e\nsystemctl \u003cspan class=\"nb\"\u003eenable\u003c/span\u003e cloudreve\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003ecloudreve的frpc.ini配置：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"k\"\u003e[cloudreve]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e127.0.0.1\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e5212\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e5212\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e通过本地的大容量硬盘，就可以有一个私有云+nas了。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1663391988/cloudreve-4.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"路由器\"\u003e路由器\u003c/h3\u003e\n\u003cp\u003e如果在外面需要配置路由器的后台情况，或者觉得直接访问内网服务器不安全，需要借助第三方机器对局域网内的机器进行连接，就可以将路由器进行内网穿透。\u003c/p\u003e\n\u003cp\u003e路由器相关的配置见我的这篇文章 \u003ca href=\"http://blog.engine.wang/posts/router-1/\"\u003e路由器折腾记录\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e这里对刷了梅林固件的路由器后台进行了配置，比较推荐刷了Koolshare梅林固件或者openwrt固件的路由器，可玩性比较强。\u003c/p\u003e\n\u003cp\u003e去软件中心安装Frpc内网穿透，然后配置：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"c1\"\u003e# frpc custom configuration\u003c/span\u003e\n\u003cspan class=\"k\"\u003e[common]\u003c/span\u003e\n\u003cspan class=\"na\"\u003eserver_addr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026lt;server_ip\u0026gt;\u003c/span\u003e\n\u003cspan class=\"na\"\u003eserver_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026lt;frps_port\u0026gt;\u003c/span\u003e\n\u003cspan class=\"na\"\u003etoken\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026lt;token\u0026gt;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# ssh穿透\u003c/span\u003e\n\u003cspan class=\"k\"\u003e[merlin_ssh]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e127.0.0.1\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e22\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026lt;merlin_ssh_remote_port\u0026gt;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# 路由器后台穿透\u003c/span\u003e\n\u003cspan class=\"k\"\u003e[merlin_center]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e127.0.0.1\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e80\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026lt;merlin_center_remote_port\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://s2.loli.net/2022/11/25/bhMZiXfIFNtx6OW.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e就可以在外面通过 \u003ccode\u003ehttp://\u0026lt;server_ip\u0026gt;:\u0026lt;merlin_center_remote_port\u0026gt;/\u003c/code\u003e 访问路由器后台了。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1663389718/merlin-frpc-2.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"群晖nas内网穿透\"\u003e群晖NAS内网穿透\u003c/h2\u003e\n\u003cp\u003e群晖自带quickconnect内网穿透，并且配置了域名，但是quickconnect速度感人并且需要手机号验证，一些服务可能还无法使用，所以这里我们自己穿透。\u003c/p\u003e\n\u003cp\u003e因为没有自带的frpc客户端，去docker里找一个：（只有x86芯片的群晖才能用Docker，也就是型号带+的，型号带j的无法使用docker）\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://s2.loli.net/2022/10/24/OLfX7nsrodVPKlt.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://s2.loli.net/2022/10/24/UxqNTjztEoC24Zm.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e写一下frpc的配置，上传到群晖的某个文件夹，我这里是\u003ccode\u003e/docker/frpc/frpc.ini\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e后面一些是我的配置，包括dsm登录、webdav、emby、plex等\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e32\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e33\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e34\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e35\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e36\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e37\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e38\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e39\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e40\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e41\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e42\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e43\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e44\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e45\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e46\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e47\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e48\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e49\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e50\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e51\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e52\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e53\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e54\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e55\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e56\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e57\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e58\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e59\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e60\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e61\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e62\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e63\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e64\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e65\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e66\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e67\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e68\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e69\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e70\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e71\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e72\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e73\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"k\"\u003e[common]\u003c/span\u003e\n\u003cspan class=\"na\"\u003eserver_addr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026lt;server_ip\u0026gt;\u003c/span\u003e\n\u003cspan class=\"na\"\u003eserver_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026lt;frps_port\u0026gt;\u003c/span\u003e\n\u003cspan class=\"na\"\u003etoken\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026lt;token\u0026gt;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003e[nas_ssh]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e192.168.50.99\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e22\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e2333\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003e[dsm]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e192.168.50.99\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e5001\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e5001\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003e[ds_file]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e192.168.50.99\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e5001\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e5002\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003e[https_webdav]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e192.168.50.99\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e5006\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e5006\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003e[http_webdav]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e192.168.50.99\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e5004\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e5004\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003e[emby]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e192.168.50.99\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e8097\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e8097\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003e[emby_8096]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e192.168.50.99\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e8096\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e8096\u003c/span\u003e\n\n\n\u003cspan class=\"k\"\u003e[plex_28888]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e192.168.50.99\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e28888\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e28888\u003c/span\u003e\n\n\n\u003cspan class=\"k\"\u003e[plex_32400]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e192.168.50.99\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e32400\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e32400\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003e[nas_samba_445]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e192.168.50.99\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e445\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e4455\u003c/span\u003e\n\n\n\u003cspan class=\"k\"\u003e[nas_cloudreve_5212]\u003c/span\u003e\n\u003cspan class=\"na\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003etcp\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_ip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e192.168.50.99\u003c/span\u003e\n\u003cspan class=\"na\"\u003elocal_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e5212\u003c/span\u003e\n\u003cspan class=\"na\"\u003eremote_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e5212\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eDSM：\n\u003cimg src=\"https://s2.loli.net/2022/10/24/jdxFe6R3iI5abs4.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eCloudreve:\n\u003cimg src=\"https://s2.loli.net/2022/11/25/RDUAeOkNvEqdZJT.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eEmby\n\u003cimg src=\"https://s2.loli.net/2022/11/25/qKIMdsyAP9DHV3U.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003ePlex:\n\u003cimg src=\"https://s2.loli.net/2022/11/25/SIQErDdzaZNhyYR.png\" alt=\"\"\u003e\u003c/p\u003e\n","date":1658036618,"description":"","fuzzywordcount":5100,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"bd90a2da7d7b2b675c87f45a9f4be276","publishdate":1658036618,"relpermalink":"/posts/frp-notes/","section":"posts","summary":"前言 一般来说，除了一些企业高校等机构，国内绝大部分普通人没有ipv4的公网ip且极难申请到，毕竟用一个少一个，并且由于一些原因，国内ipv6也不太可能普及的起来","tags":["内网穿透","frp","Linux"],"title":"frp内网穿透原理及配置记录","url":"https://blog.engine.wang/posts/frp-notes/","wordcount":5002},{"categories":"posts","content":"\u003cp\u003eGo web中最底层的库就是Go自带的http库，下面对这个库的源码进行解析，简单而言，http分为两个部分：Server与Client。\u003c/p\u003e\n\u003cp\u003ego http包的执行流程如下图所示：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1659262064/net-http-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e首先会创建一个Listen Socket，对指定的端口进行监听。Listen socket接受客户端的请求，得到Client socket，Client socket将负责与客户端的通信。\u003c/p\u003e\n\u003cp\u003eclient socket读取HTTP请求头的内容，如果是POST还有读取提交的数据，然后交给相应的handler进行处理，再通过client socket返回给客户端。\u003c/p\u003e\n\u003cp\u003e这里主要对\u003ccode\u003eListenAndServe\u003c/code\u003e的执行过程源码进行解析。\u003c/p\u003e\n\u003cp\u003e使用一个最简单的helloWorld的例子：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"nx\"\u003ehelloHandler\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ew\u003c/span\u003e \u003cspan class=\"nx\"\u003ehttp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eResponseWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ereq\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003ehttp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003eio\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteString\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;Hello, world!\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ehttp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eHandleFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;/hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ehelloHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ehttp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eListenAndServe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;:8080\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e首先将路由和handle函数进行绑定，使得访问这个路由的时候调用handle进行处理，然后最核心的部分就是\u003ccode\u003eListenAndServer\u003c/code\u003e方法，下面一步一步来看发生了什么。\u003c/p\u003e\n\u003ch2 id=\"handlefunc\"\u003ehandleFunc\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003eHandleFunc\u003c/code\u003e将handler函数注册到对应pattern的路由中\u003c/p\u003e\n\u003cp\u003epattern是string类型的路由\nhandler函数的参数包括一个ResponseWriter和*Request\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003enet/http/server.go\u003c/code\u003e，会直接调用\u003ccode\u003eDefaultServeMux\u003c/code\u003e的HandleFunc方法\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003eHandleFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epattern\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ehandler\u003c/span\u003e \u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eResponseWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eDefaultServeMux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eHandleFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epattern\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ehandler\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e官方是直接用DefaultServerMux路由的，先介绍一下这个简单的路由\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eServeMux\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003emu\u003c/span\u003e    \u003cspan class=\"nx\"\u003esync\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eRWMutex\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003em\u003c/span\u003e     \u003cspan class=\"kd\"\u003emap\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"nx\"\u003emuxEntry\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ees\u003c/span\u003e    \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"nx\"\u003emuxEntry\u003c/span\u003e \u003cspan class=\"c1\"\u003e// slice of entries sorted from longest to shortest.\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nx\"\u003ehosts\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e       \u003cspan class=\"c1\"\u003e// whether any patterns contain hostnames\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003emuxEntry\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eh\u003c/span\u003e       \u003cspan class=\"nx\"\u003eHandler\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003epattern\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003eDefaultServeMux\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003edefaultServeMux\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003edefaultServeMux\u003c/span\u003e \u003cspan class=\"nx\"\u003eServeMux\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e核心就是一个map存储从pattern到muxEntry的映射，从而很方便的能找到对应的handler，另外还有个es数组，从长到短存储muxEntry，每次匹配的时候首先查是否就在map中，不在的话从长到短查最匹配哪个路由。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emux\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eServeMux\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003ematch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epath\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eh\u003c/span\u003e \u003cspan class=\"nx\"\u003eHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epattern\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// Check for exact match first.\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nx\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eok\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eok\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003epattern\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Check for longest valid match.  mux.es contains all patterns\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// that end in / sorted from longest to shortest.\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ee\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ees\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003estrings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eHasPrefix\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003epattern\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003epattern\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e回过头来看默认mux的HandleFunc：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emux\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eServeMux\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eHandleFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epattern\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ehandler\u003c/span\u003e \u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eResponseWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ehandler\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nb\"\u003epanic\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;http: nil handler\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epattern\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nf\"\u003eHandlerFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ehandler\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e会转到\u003ccode\u003eHandle\u003c/code\u003e函数上，这个是核心函数\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emux\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eServeMux\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epattern\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ehandler\u003c/span\u003e \u003cspan class=\"nx\"\u003eHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 因为要操作map什么的，需要上读写锁\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003emu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003emu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUnlock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 一些错误的情况\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003epattern\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nb\"\u003epanic\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;http: invalid pattern\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ehandler\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nb\"\u003epanic\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;http: nil handler\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 如果之前已经注册过一个pattern了，再注册就会报错\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eexist\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003epattern\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e \u003cspan class=\"nx\"\u003eexist\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nb\"\u003epanic\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;http: multiple registrations for \u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003epattern\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 如果之前都是空的，就初始创建这个map\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003emake\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kd\"\u003emap\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"nx\"\u003emuxEntry\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 创建muxEntry并记录在map和有序数组中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nx\"\u003ee\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003emuxEntry\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nx\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003ehandler\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epattern\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003epattern\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003epattern\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ee\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003epattern\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epattern\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"sc\"\u003e\u0026#39;/\u0026#39;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ees\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eappendSorted\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ees\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003epattern\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"sc\"\u003e\u0026#39;/\u0026#39;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ehosts\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"listenandserve\"\u003eListenAndServe\u003c/h2\u003e\n\u003cp\u003e首先会创建一个server实例，然后调用server的ListenAndServer\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003eListenAndServe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eaddr\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ehandler\u003c/span\u003e \u003cspan class=\"nx\"\u003eHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eserver\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003eServer\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nx\"\u003eAddr\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eaddr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003ehandler\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003eserver\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eListenAndServe\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e这里我们的addres是\u0026quot;:8080\u0026quot;，handler是nil，因为我们没有对主页创建handler。\u003c/p\u003e\n\u003cp\u003e首先看server结构体\u003c/p\u003e\n\u003ch3 id=\"server\"\u003eServer\u003c/h3\u003e\n\u003cp\u003e首先会通过给出的端口和handler创建一个Serer类，Server类的定义如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eServer\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 端口号，默认为80\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nx\"\u003eAddr\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 指定handler，如果是nil就是http.DefaultServeMux\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nx\"\u003eHandler\u003c/span\u003e \u003cspan class=\"nx\"\u003eHandler\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eTLSConfig\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003etls\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eConfig\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 接下来是一些timeout\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nx\"\u003eReadTimeout\u003c/span\u003e \u003cspan class=\"nx\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eDuration\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eReadHeaderTimeout\u003c/span\u003e \u003cspan class=\"nx\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eDuration\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eWriteTimeout\u003c/span\u003e \u003cspan class=\"nx\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eDuration\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eIdleTimeout\u003c/span\u003e \u003cspan class=\"nx\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eDuration\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// request header的最大字节数\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nx\"\u003eMaxHeaderBytes\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 省略若干...\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nx\"\u003emu\u003c/span\u003e         \u003cspan class=\"nx\"\u003esync\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMutex\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003elisteners\u003c/span\u003e  \u003cspan class=\"kd\"\u003emap\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003enet\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eListener\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"kd\"\u003estruct\u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eactiveConn\u003c/span\u003e \u003cspan class=\"kd\"\u003emap\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"kd\"\u003estruct\u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003edoneChan\u003c/span\u003e   \u003cspan class=\"kd\"\u003echan\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eonShutdown\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e然后调用Server类的同名方法\u003ccode\u003eListenAndServe\u003c/code\u003e：\u003c/p\u003e\n\u003cp\u003e首先会调用\u003ccode\u003enet.Listen\u003c/code\u003e监听相应的端口，返回对这个端口进行监听的listener实例，然后对这个listener进行serve\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003esrv\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eServer\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eListenAndServe\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003esrv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eshuttingDown\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003eErrServerClosed\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eaddr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003esrv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eAddr\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eaddr\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003eaddr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;:http\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// ln是监听该端口的listener\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nx\"\u003eln\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003enet\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eListen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;tcp\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eaddr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003esrv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eServe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eln\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e那么首先来看一下\u003ccode\u003enet.Listen\u003c/code\u003e的代码\u003c/p\u003e\n\u003ch3 id=\"listen\"\u003elisten\u003c/h3\u003e\n\u003cp\u003elisten包含两个参数，分别是network和address，netword是诸如\u0026quot;tcp\u0026quot;，address是端口\u003c/p\u003e\n\u003cp\u003e初始化了一个listenConfig实例，然后调用它的Listen方法。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"c1\"\u003e// dial.go\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003eListen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eaddress\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eListener\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003elc\u003c/span\u003e \u003cspan class=\"nx\"\u003eListenConfig\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003elc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eListen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBackground\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"nx\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eaddress\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eListenConfig的Listen方法，又对address的方法进行分流，如果是TCP则调用listenTCP方法：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"c1\"\u003e// dial.go\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003elc\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eListenConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eListen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ectx\u003c/span\u003e \u003cspan class=\"nx\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eaddress\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eListener\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eaddrs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003eDefaultResolver\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eresolveAddrList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;listen\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eaddress\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003eOpError\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nx\"\u003eOp\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;listen\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eNet\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eSource\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eAddr\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eErr\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003esl\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003esysListener\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003eListenConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003elc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e      \u003cspan class=\"nx\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003eaddress\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e      \u003cspan class=\"nx\"\u003eaddress\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003el\u003c/span\u003e \u003cspan class=\"nx\"\u003eListener\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ela\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003eaddrs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003efirst\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eisIPv4\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"nx\"\u003ela\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ela\u003c/span\u003e\u003cspan class=\"p\"\u003e.(\u003c/span\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eTCPAddr\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003esl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003elistenTCP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ela\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eUnixAddr\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003esl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003elistenUnix\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ela\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003eOpError\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nx\"\u003eOp\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;listen\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eNet\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003esl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eSource\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eAddr\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003ela\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eErr\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003eAddrError\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nx\"\u003eErr\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;unexpected address type\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eAddr\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eaddress\u003c/span\u003e\u003cspan class=\"p\"\u003e}}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003eOpError\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nx\"\u003eOp\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;listen\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eNet\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003esl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eSource\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eAddr\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003ela\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eErr\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"c1\"\u003e// l is non-nil interface containing nil pointer\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e然后会通过\u003ccode\u003e syscall.SOCK_STREAM\u003c/code\u003e系统调用创建一个文件标识符实例fd，后面的就是底层的创建socket，就不涉及了。\u003c/p\u003e\n\u003cp\u003e这里返回的结构体TCPListener就包含了一个listener的fd和一个ListenConfig。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"c1\"\u003e// tcpsock_posix.go\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003esl\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003esysListener\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003elistenTCP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ectx\u003c/span\u003e \u003cspan class=\"nx\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eladdr\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eTCPAddr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eTCPListener\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nf\"\u003einternetSocket\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003esl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eladdr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003esyscall\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSOCK_STREAM\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;listen\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003esl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eListenConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eControl\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003eTCPListener\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nx\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003elc\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003esl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eListenConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e接着看一下serve部分\u003c/p\u003e\n\u003ch3 id=\"serve\"\u003eServe\u003c/h3\u003e\n\u003cp\u003e通过调用Server实例的Serve方法进行serve，只需要传入一个listener作为参数：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"nx\"\u003esrv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eServe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eln\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eServe会通过listener来接受连接，对于每一个新的service都建立一个goroutine，service goroutine会读取request和通过Handler进行处理和返回。\u003c/p\u003e\n\u003cp\u003e首先下面的逻辑通过一个for循环嵌套，即listener一旦接受了请求，就创建一个goroutine进行连接和处理\u003c/p\u003e\n\u003cp\u003eServe方法如下，关键部分做了注释：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"c1\"\u003e// http/server.go\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003esrv\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eServer\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eServe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003el\u003c/span\u003e \u003cspan class=\"nx\"\u003enet\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eListener\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ectx\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWithValue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ebaseCtx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eServerContextKey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003esrv\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 无限循环，一直监听\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 如果监听到了有事件，获取这个conn连接\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"c1\"\u003e// 当然如果没有访问这个端口的请求，会一直阻塞在这里\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAccept\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 错误处理\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003econnCtx\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ectx\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ecc\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003esrv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eConnContext\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ecc\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nx\"\u003econnCtx\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003ecc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003econnCtx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003econnCtx\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"nb\"\u003epanic\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;ConnContext returned nil\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003etempDelay\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 建立这个conn\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"nx\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003esrv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003enewConn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003esetState\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003erwc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eStateNew\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003erunHooks\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 对于每个conn，创建一个新的goroutine来处理这个连接\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"k\"\u003ego\u003c/span\u003e \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eserve\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003econnCtx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e然后是conn的server函数，比较复杂，只写关键的部分：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eserve\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ectx\u003c/span\u003e \u003cspan class=\"nx\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eremoteAddr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003erwc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRemoteAddr\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eString\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ectx\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWithValue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eLocalAddrContextKey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003erwc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLocalAddr\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n    \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003einFlightResponse\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eresponse\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}()\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// HTTPS TLS的部分先省略\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// HTTP\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 首先读取conn的内容\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"nx\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ereadRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eremain\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eserver\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003einitialReadLimitSize\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// If we read any bytes off the wire, we\u0026#39;re active.\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e            \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003esetState\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003erwc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eStateActive\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003erunHooks\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 没报错的话，获取req的内容\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"c1\"\u003e// req包含请求的各种信息，比如Method、Host、Url等\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"nx\"\u003ereq\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ereq\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecurReq\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStore\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 核心的ServeHTTP逻辑\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"nx\"\u003eserverHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eserver\u003c/span\u003e\u003cspan class=\"p\"\u003e}.\u003c/span\u003e\u003cspan class=\"nf\"\u003eServeHTTP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e下面则是\u003ccode\u003ehandler\u003c/code\u003e的ServeHTTP方法，任何结构只要实现了ServeHTTP方法就可以作为Handler对象，就可以直接用\u003ccode\u003eListenAndServe\u003c/code\u003e方法，如果没有实现的话会调用默认的DefaultServeMux\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003esh\u003c/span\u003e \u003cspan class=\"nx\"\u003eserverHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eServeHTTP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e \u003cspan class=\"nx\"\u003eResponseWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ereq\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ehandler\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003esh\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esrv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eHandler\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// handler如果是nil的话就默认用DefaultServeMux\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ehandler\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ehandler\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eDefaultServeMux\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eRequestURI\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;*\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nx\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMethod\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;OPTIONS\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ehandler\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eglobalOptionsHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eURL\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nx\"\u003estrings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContains\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eURL\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eRawQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;;\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003eallowQuerySemicolonsInUse\u003c/span\u003e \u003cspan class=\"kt\"\u003eint32\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ereq\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWithContext\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWithValue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"nx\"\u003esilenceSemWarnContextKey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStoreInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003eallowQuerySemicolonsInUse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}))\u003c/span\u003e\n        \u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLoadInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003eallowQuerySemicolonsInUse\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"nx\"\u003esh\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esrv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003elogf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;http: URL query contains semicolon, which is no longer a supported separator; parts of the query may be stripped when parsed; see golang.org/issue/25192\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ehandler\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eServeHTTP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emux\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eServeMux\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eServeHTTP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ew\u003c/span\u003e \u003cspan class=\"nx\"\u003eResponseWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003er\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eRequestURI\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;*\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eProtoAtLeast\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"nx\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eHeader\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eSet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Connection\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;close\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteHeader\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eStatusBadRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eServeHTTP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e这里的mux.Handler就通过路由的match来通过路径找到已注册的handler，上面的h就是我们自己写的方法本身\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emux\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eServeMux\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003ehandler\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ehost\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epath\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eh\u003c/span\u003e \u003cspan class=\"nx\"\u003eHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epattern\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003emu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRLock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003emu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRUnlock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\n\t\u003cspan class=\"c1\"\u003e// Host-specific pattern takes precedence over generic ones\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ehosts\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epattern\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ematch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ehost\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eh\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epattern\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ematch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eh\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epattern\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eNotFoundHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emux\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eServeMux\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003ematch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epath\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eh\u003c/span\u003e \u003cspan class=\"nx\"\u003eHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003epattern\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"c1\"\u003e// Check for exact match first.\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"nx\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eok\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nx\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eok\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003epattern\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\t\u003cspan class=\"c1\"\u003e// Check for longest valid match.  mux.es contains all patterns\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"c1\"\u003e// that end in / sorted from longest to shortest.\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ee\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"nx\"\u003emux\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ees\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003estrings\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eHasPrefix\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003epattern\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003epattern\u003c/span\u003e\n\t\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e找到了handlerFunc之后直接进入到自己写的handleFunc之中去处理路径对应的业务逻辑\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ef\u003c/span\u003e \u003cspan class=\"nx\"\u003eHandlerFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eServeHTTP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ew\u003c/span\u003e \u003cspan class=\"nx\"\u003eResponseWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003er\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nf\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e","date":1656338176,"description":"","fuzzywordcount":3400,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"963ec7b668937dba0abd29dced6f925c","publishdate":1656338176,"relpermalink":"/posts/net-http-source-code/","section":"posts","summary":"Go web中最底层的库就是Go自带的http库，下面对这个库的源码进行解析，简单而言，http分为两个部分：Server与Client。 go http包的执行流程如下","tags":["Golang","HTTP"],"title":"Go net/http 源码解析","url":"https://blog.engine.wang/posts/net-http-source-code/","wordcount":3371},{"categories":"posts","content":"\u003ch2 id=\"docker的基石\"\u003eDocker的基石\u003c/h2\u003e\n\u003cp\u003e容器本质上是一种沙盒技术，像一个集装箱，将应用装起来。\n这样应用与应用不会互相干扰，装进集装箱的应用也可以非常方便的迁移，在不同的地方也能保持一样的环境。\u003c/p\u003e\n\u003cp\u003e如何实现这个边界？\u003c/p\u003e\n\u003cp\u003e一个简单的程序编译后式一段二进制文件和一些外部的输入文件，运行的时候变成了寄存器的值、内存中的数据、堆栈中的指令、被打开的文件等等，总和就是\u003cstrong\u003e进程\u003c/strong\u003e。\u003c/p\u003e\n\u003cp\u003e容器的核心功能，就是通过约束和修改进程的动态表现，为其创造出一个边界。\u003c/p\u003e\n\u003cp\u003eLinux的Cgroups技术是用来制造约束的主要方法，Namespace技术是用来修改进程视图的主要方法。\u003c/p\u003e\n\u003ch2 id=\"namespace\"\u003eNamespace\u003c/h2\u003e\n\u003cp\u003eLinux Namespace是Linux提供的一种内核级别环境隔离的方法，它可以使得容器内的进程运行的时候看不到宿主机的进程，比如PID是重新计算的，每个容器的PID=1的超级父进程都是自己，看不到其他的Namespace。Namespace可以创建一个全新的进程空间，当然除了PID还有UTS、IPC、mount、PID、network、User等Namespace，可以对进程的各种上下文都进行遮挡蒙蔽。\u003c/p\u003e\n\u003ch3 id=\"namespace的系统调用\"\u003eNamespace的系统调用\u003c/h3\u003e\n\u003cp\u003e包含三个系统调用：\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eclone()\u003c/code\u003e：创建一个新的进程，通过传入参数进行隔离。这个比较重要，后面单独拿一节来讲。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eunshare()\u003c/code\u003e：将某个进程脱离某个namespace\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esetns()\u003c/code\u003e：将某个进程加入某个namespace\u003c/p\u003e\n\u003cp\u003e所以Docker实际上就是在创建容器进程时，指定了进程启动的一组Namespace参数，这样容器进程就只能看到当前Namespace限定的资源、文件、状态等，宿主机和其他Namespace的进程都看不到了。\u003c/p\u003e\n\u003cp\u003e所以其实各个应用并不是运行在Docker Engine的东西上：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645299151/docker-1.png\" alt=\"docker-1\"\u003e\u003c/p\u003e\n\u003cp\u003e而是通过Docker配置的Namespace进行了分离：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1651772357/docker-0.jpg\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e上图左边是虚拟机，是对硬件的虚拟化，右图是Docker，通过Namespace对应用进程进行隔离。\u003c/p\u003e\n\u003ch2 id=\"linux的clone系统调用\"\u003eLinux的clone系统调用\u003c/h2\u003e\n\u003cp\u003eclone系统很重要，称之为容器的基石也不为过。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eclone\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003efn\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003echild_stack\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eflags\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003earg\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e...)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eflags包括：\nCLONE_NEWIPC\nCLONE_NEWNET\nCLONE_NEWNS\nCLONE_NEWPID\nCLONE_NEWUTS\nCLONE_NEWUSER\u003c/p\u003e\n\u003cp\u003e比如\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"n\"\u003epid_t\u003c/span\u003e \u003cspan class=\"n\"\u003echild_pid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eclone\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echild_func\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003echild_stack\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWPID\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWNS\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eSIGCHLD\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e这些选项可以指定新的进程可以看到的东西。\u003c/p\u003e\n\u003cp\u003e如果没有加参数：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003echild_func\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;PID: %ld\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003egetpid\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;PPID: %ld\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003egetppid\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esystem\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;whoami\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epid_t\u003c/span\u003e \u003cspan class=\"n\"\u003echild_pid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eclone\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echild_func\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003echild_stack\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eSTACK_4M\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSIGCHLD\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;clone() = %ld\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003echild_pid\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ewaitpid\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echild_pid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e没有指定参数，这个子进程就可以看到真实的世界，比如pid，输出就是：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003eclone\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e316667\u003c/span\u003e\nPID: \u003cspan class=\"m\"\u003e316667\u003c/span\u003e\nPPID: \u003cspan class=\"m\"\u003e316666\u003c/span\u003e\nengine\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eclone返回的子进程的pid，和子进程看到的自己的pid是一样的。user id也和原来一样。\u003c/p\u003e\n\u003cp\u003e如果增加一些参数，相当于用各种遮罩将子进程遮住，它就看不见对应模块的真实世界了。\u003c/p\u003e\n\u003cp\u003e改成\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"n\"\u003epid_t\u003c/span\u003e \u003cspan class=\"n\"\u003echild_pid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eclone\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echild_func\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003echild_stack\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eSTACK_4M\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSIGCHLD\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e现在再运行：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003eclone\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e317773\u003c/span\u003e\nPID: \u003cspan class=\"m\"\u003e1\u003c/span\u003e\nPPID: \u003cspan class=\"m\"\u003e0\u003c/span\u003e\nnobody\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e子进程就不知道外面的世界了。父进程是知道子进程的pid的，但是子进程不知道外面的一切。\u003c/p\u003e\n\u003cp\u003e子进程增加：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"n\"\u003epid_t\u003c/span\u003e \u003cspan class=\"n\"\u003epid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efork\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;/bin/bash\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003cspan class=\"n\"\u003eexecv\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e也就是说会fork一个新的进程并启动一个bash，就会直接进入一个新的bash：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003eengine@dev code\u003cspan class=\"o\"\u003e]\u003c/span\u003e$ ./pid_test\nclone\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e318630\u003c/span\u003e\nPID: \u003cspan class=\"m\"\u003e1\u003c/span\u003e\nPPID: \u003cspan class=\"m\"\u003e0\u003c/span\u003e\nnobody\n\u003cspan class=\"o\"\u003e[\u003c/span\u003enobody@dev workspace\u003cspan class=\"o\"\u003e]\u003c/span\u003e$\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e进入后会发现大部分环境就像一个全新的世界，和宿主机没关系，但是\u003ccode\u003eps\u003c/code\u003e、\u003ccode\u003etop\u003c/code\u003e等指令还是可以看到外面的世界，因为这些是通过挂载于/proc的文件系统获取的，所以需要加上\u003ccode\u003eCLONE_NEWNS\u003c/code\u003e，还需要重新挂载proc。\u003c/p\u003e\n\u003cp\u003e这样就没问题了：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"n\"\u003epid_t\u003c/span\u003e \u003cspan class=\"n\"\u003echild_pid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eclone\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echild_func\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003echild_stack\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eSTACK_4M\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eCLONE_NEWNS\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWPID\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWUSER\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eSIGCHLD\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003echild_fn\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;PID: %ld\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003egetpid\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;PPID: %ld\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003egetppid\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003emount_point\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;/proc\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emkdir\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emount_point\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mo\"\u003e0555\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emount\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;proc\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emount_point\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;proc\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;error when mount\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003epid_t\u003c/span\u003e \u003cspan class=\"n\"\u003epid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efork\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epid\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;/bin/bash\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eexecv\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ewait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"cgroups\"\u003eCgroups\u003c/h2\u003e\n\u003cp\u003e然而由于多个容器之间使用的还是宿主系统的操作系统内核，隔离的并不彻底。\u003c/p\u003e\n\u003cp\u003e如果只采用Namespace，还是无法运行跨平台的容器。\u003c/p\u003e\n\u003cp\u003e会有以下的问题：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eLinux内核中有很多资源和对象不能被Namespace化，比如时间。如果某个容器进程修改了时间，那么会影响宿主。\u003c/li\u003e\n\u003cli\u003e同时也会带来安全问题，很容易从容器中攻击到宿主机。\u003c/li\u003e\n\u003cli\u003e隔离的不够彻底，比如各个容器之间还会争夺宿主机资源。\n...\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eLinux Cgroups（Linux Control Group）就是Linux内核中用来为进程设置资源限制的一个功能，可以设置进程的资源上限，包括CPU、带宽、内存、磁盘等。\u003c/p\u003e\n\u003cp\u003eCgroups以文件和目录的方式组织在\u003ccode\u003e/sys/fs/cgroup\u003c/code\u003e下。可以用\u003ccode\u003emount -t cgroup\u003c/code\u003e展示：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# CentOS 8.2\u003c/span\u003e\n$ mount -t cgroup\ncgroup on /sys/fs/cgroup/systemd \u003cspan class=\"nb\"\u003etype\u003c/span\u003e cgroup \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,nosuid,nodev,noexec,relatime,xattr,release_agent\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr/lib/systemd/systemd-cgroups-agent,name\u003cspan class=\"o\"\u003e=\u003c/span\u003esystemd\u003cspan class=\"o\"\u003e)\u003c/span\u003e\ncgroup on /sys/fs/cgroup/rdma \u003cspan class=\"nb\"\u003etype\u003c/span\u003e cgroup \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,nosuid,nodev,noexec,relatime,rdma\u003cspan class=\"o\"\u003e)\u003c/span\u003e\ncgroup on /sys/fs/cgroup/freezer \u003cspan class=\"nb\"\u003etype\u003c/span\u003e cgroup \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,nosuid,nodev,noexec,relatime,freezer\u003cspan class=\"o\"\u003e)\u003c/span\u003e\ncgroup on /sys/fs/cgroup/cpu,cpuacct \u003cspan class=\"nb\"\u003etype\u003c/span\u003e cgroup \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,nosuid,nodev,noexec,relatime,cpu,cpuacct\u003cspan class=\"o\"\u003e)\u003c/span\u003e\ncgroup on /sys/fs/cgroup/net_cls,net_prio \u003cspan class=\"nb\"\u003etype\u003c/span\u003e cgroup \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,nosuid,nodev,noexec,relatime,net_cls,net_prio\u003cspan class=\"o\"\u003e)\u003c/span\u003e\ncgroup on /sys/fs/cgroup/blkio \u003cspan class=\"nb\"\u003etype\u003c/span\u003e cgroup \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,nosuid,nodev,noexec,relatime,blkio\u003cspan class=\"o\"\u003e)\u003c/span\u003e\ncgroup on /sys/fs/cgroup/memory \u003cspan class=\"nb\"\u003etype\u003c/span\u003e cgroup \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,nosuid,nodev,noexec,relatime,memory\u003cspan class=\"o\"\u003e)\u003c/span\u003e\ncgroup on /sys/fs/cgroup/devices \u003cspan class=\"nb\"\u003etype\u003c/span\u003e cgroup \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,nosuid,nodev,noexec,relatime,devices\u003cspan class=\"o\"\u003e)\u003c/span\u003e\ncgroup on /sys/fs/cgroup/pids \u003cspan class=\"nb\"\u003etype\u003c/span\u003e cgroup \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,nosuid,nodev,noexec,relatime,pids\u003cspan class=\"o\"\u003e)\u003c/span\u003e\ncgroup on /sys/fs/cgroup/cpuset \u003cspan class=\"nb\"\u003etype\u003c/span\u003e cgroup \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,nosuid,nodev,noexec,relatime,cpuset\u003cspan class=\"o\"\u003e)\u003c/span\u003e\ncgroup on /sys/fs/cgroup/hugetlb \u003cspan class=\"nb\"\u003etype\u003c/span\u003e cgroup \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,nosuid,nodev,noexec,relatime,hugetlb\u003cspan class=\"o\"\u003e)\u003c/span\u003e\ncgroup on /sys/fs/cgroup/perf_event \u003cspan class=\"nb\"\u003etype\u003c/span\u003e cgroup \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,nosuid,nodev,noexec,relatime,perf_event\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e/sys/fs/cgroup下面挂载了很多诸如cpu、pids、memory、systemd这样的子目录。表示这些资源都可以被Cgroup所限制。\u003c/p\u003e\n\u003cp\u003e每个资源子目录下是各种控制组，比如cpu的：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ ls /sys/fs/cgroup/cpu\ncgroup.clone_children  cpuacct.usage_all          cpuacct.usage_user  cpu.shares         release_agent\ncgroup.procs           cpuacct.usage_percpu       cpu.cfs_period_us   cpu.stat           system.slice\ncgroup.sane_behavior   cpuacct.usage_percpu_sys   cpu.cfs_quota_us    init.scope         tasks\ncpuacct.stat           cpuacct.usage_percpu_user  cpu.rt_period_us    notify_on_release  user.slice\ncpuacct.usage          cpuacct.usage_sys          cpu.rt_runtime_us   onion              YunJing\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e这里各个文件是全局配置，但是里面的文件夹是控制组，比如这里腾讯云的YunJing文件夹，里面是控制组内的各种配置\u003c/p\u003e\n\u003cp\u003e各个文件是各种配置，比如\u003ccode\u003ecpu.cfs_quota_us\u003c/code\u003e限制cpu资源，默认是-1不限制，如果写入10000，就表示每100ms cpu的时间中，该控制组限制的进程只能使用10ms，最高只能使用10%的cpu。\u003c/p\u003e\n\u003cp\u003e如何将进程加入控制组，只需要将pid写入tasks即可。\u003c/p\u003e\n\u003cp\u003e所以可以把Cgroups理解为一个子系统目录+一组资源限制文件\u003c/p\u003e\n\u003cp\u003eDocker只需要为每个容器创建一个控制组，启动之后将进程的pid填入对应控制组的tasks中即可。\u003c/p\u003e\n\u003cp\u003eDocker运行容器时的参数也就是会指定这些控制组的资源文件的内容，比如：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ docker run -it --cpu-period\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e100000\u003c/span\u003e ubuntu /bin/bash\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e运行之后，去对应容器控制组的cpu资源限制文件里查：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ cat /sys/fs/cgroup/cpu/docker/5d5c9f67d/cpu.cfs_period_us\n\u003cspan class=\"m\"\u003e100000\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eCgroups的一个问题就是\u003ccode\u003e/proc\u003c/code\u003e文件系统是不清楚Cgroups的，也就是说在容器中运行top显示的还是宿主机的资源使用情况。\u003c/p\u003e\n\u003ch2 id=\"总结\"\u003e总结\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003e容器的本质是一种特殊的进程\u003c/strong\u003e。\u003cstrong\u003e一个正在运行的 Docker 容器，其实就是一个启用了多个 Linux Namespace 的应用进程，而这个进程能够使用的资源量，则受 Cgroups 配置的限制。\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e每个Docker容器都是单进程的，一个容器中不能运行两个应用。\u003c/p\u003e\n\u003cp\u003e容器相当于被Namespace蒙蔽了双眼，只能看到自己的一小片天地，误以为世界就这么大。又被Cgroups限制了资源，只能拥有一部分规定的资源。它发挥着唯一的意义，就是和里面运行的应用程序同生共死。多么悲壮的一生！\u003c/p\u003e\n","date":1651824512,"description":"","fuzzywordcount":2600,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"25be32697e6d1ba400fa1c05ebe94b1f","publishdate":1651824512,"relpermalink":"/posts/docker-namespace-cgroups/","section":"posts","summary":"Docker的基石 容器本质上是一种沙盒技术，像一个集装箱，将应用装起来。 这样应用与应用不会互相干扰，装进集装箱的应用也可以非常方便的迁移，在不同的地方也能保持一","tags":["Docker"],"title":"深入Docker：Namespace与Cgroups","url":"https://blog.engine.wang/posts/docker-namespace-cgroups/","wordcount":2595},{"categories":"posts","content":"\u003cp\u003e有并发的时候，需要锁来控制资源的访问规则。\u003c/p\u003e\n\u003cp\u003eMySQL的锁分为全局锁、表级锁和行锁。\u003c/p\u003e\n\u003ch2 id=\"全局锁\"\u003e全局锁\u003c/h2\u003e\n\u003cp\u003e对整个数据库实例进行加锁，加完锁后数据库处于只读状态，一般用于全量备份的场景。虽然毫无疑问会对业务有很大的影响。\u003c/p\u003e\n\u003cp\u003e全局锁的命令是： (FTWRL)\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"n\"\u003eFlush\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003etables\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ewith\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eread\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003elock\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e但是如果不加全局锁那么就会造成问题，比如依次备份表A和表B，刚好备份完表A的时候有个操作同时修改了两张表，然后备份表B，这就造成了两个表内容的不一致。\u003c/p\u003e\n\u003cp\u003e如果引擎支持事务（如InnoDB），那么导数据之前启动一个事务，拿到一致性视图，依靠MVCC，就可以在边导出的时候还能更新数据。\n但如果使用了不支持事务的引擎（如MyISAM），就只能采用FTWRL。\u003c/p\u003e\n\u003ch2 id=\"表级锁\"\u003e表级锁\u003c/h2\u003e\n\u003cp\u003e表级锁包括表锁和元数据锁。\u003c/p\u003e\n\u003cp\u003e表锁\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"k\"\u003elock\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003etables\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003e…\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eread\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"k\"\u003ewrite\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e元数据锁（MDL）访问一个表的时候会自动加上。\u003c/p\u003e\n\u003cp\u003e增删改查的时候加MDL读锁，对表结构进行变更的时候加MDL写锁。\n读锁之间不互斥，但是读写和写写之间互斥，需要串行执行，否则会出现数据不一致。\u003c/p\u003e\n\u003ch3 id=\"如何安全地给表加字段\"\u003e如何安全地给表加字段\u003c/h3\u003e\n\u003cp\u003e事务需要提交才会释放锁，试想这样一个场景，某个表经常被频繁访问，事务A发起查询，加MDL读锁，事务B增加一个字段，但是被阻塞，因为读锁没释放，之后又来了很多事务发起查询，都被阻塞了。\u003c/p\u003e\n\u003cp\u003e如何解决？\n可以先查询长事务，在information_schema 库的 innodb_trx 表中查找长事务，可以先kill掉长事务。\u003c/p\u003e\n\u003cp\u003e如果访问过于频繁，可以在alter table的设置等待时间，如果在一段时间内还抢不到MDL写锁，就自动放弃。以免阻塞后面的事务。\u003c/p\u003e\n\u003ch2 id=\"行锁\"\u003e行锁\u003c/h2\u003e\n\u003cp\u003e行锁由具体的引擎自行实现，MyISAM就不支持航说，InnoDB支持。\u003c/p\u003e\n\u003cp\u003e行锁的粒度比较细，只有当两个事务都同时更新某一行的时候才会生效，并且在事务提交之后才会释放，其他需要操作同一行数据的事务会被阻塞。\u003c/p\u003e\n\u003cp\u003e如果事务需要锁多个行，把最可能造成锁冲突的尽量放后面。\u003c/p\u003e\n\u003cp\u003e比如先来的事务A操作一系列其他的表和表C的m行，后来的事务B也操作其他的表和表C的m行，在表C的m行会触发行锁，最好的方法是事务A最后才更改表C的m行，然后直接提交释放锁，因为这样的话事务A持有锁的时间会短很多，提高并发效率。\u003c/p\u003e\n\u003ch2 id=\"死锁和死锁检测\"\u003e死锁和死锁检测\u003c/h2\u003e\n\u003cp\u003e不同线程陷入循环资源依赖，比如事务A先访问某表的行m，加行锁，事务B访问行n，此时事务A要访问行n，事务B要访问行m。由于两个事务都没有提交，所以锁都没释放，陷入死锁。\u003c/p\u003e\n\u003cp\u003e解决死锁的办法：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e设置超时时间\u003c/li\u003e\n\u003cli\u003e死锁检测，如果检测到死锁就主动回滚某个事务，等其他事务先执行完。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eInnoDB的超时时间默认是50s，过大会浪费时间，可能花费快一分钟陷入死锁，很多场景无法接受。过小则容易误伤。\u003c/p\u003e\n\u003cp\u003e更好的方式是死锁检测，innoDB本身也开启了死锁检测，但是有额外的CPU负担。但是如果为解决死锁而大量地进行死锁检测，如果对于某一行有非常庞大的并发线程，那么检测死锁的代价会很高。\u003c/p\u003e\n\u003cp\u003e有以下的解决思路：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e在业务本身设计的时候规避死锁的问题，从而不需要死锁检测。当然这样比较困难。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e控制并发度。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e将一行的逻辑改为多行，从而减少锁冲突。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"幻读\"\u003e幻读\u003c/h2\u003e\n\u003cp\u003e幻读指的是一个事务在前后两次查询同一个范围的时候，后一次查询看到了前一次查询没有看到的行，前一次读取的数据状态不能支撑后续的事务操作。\u003c/p\u003e\n\u003cp\u003e但不是所有两次读取不一样就叫幻读。举个具体的例子，比如select查询发现某个记录没有，然后插入这个记录的时候又发现该记录已存在，和幻觉一样。\u003c/p\u003e\n\u003cp\u003e在可重复读的隔离级别下，查询的读用的是快照，所以不能看到别的事务插入的数据，幻读在RU/RC/RR级别下都会出现，在SERIALIZABLE事务级别则不会出现。\u003c/p\u003e\n\u003cp\u003e假设表为：\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eid\u003c/th\u003e\n\u003cth\u003ec\u003c/th\u003e\n\u003cth\u003ed\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e0\u003c/td\u003e\n\u003ctd\u003e0\u003c/td\u003e\n\u003ctd\u003e0\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e5\u003c/td\u003e\n\u003ctd\u003e5\u003c/td\u003e\n\u003ctd\u003e5\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e10\u003c/td\u003e\n\u003ctd\u003e10\u003c/td\u003e\n\u003ctd\u003e10\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e事务A三次执行\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"k\"\u003eselect\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ewhere\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eupdate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1647179345/mysql-11.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e看起来似乎没问题。\u003c/p\u003e\n\u003cp\u003e但是语义上，事务A在T1的时刻应该会有行锁将d=5的行都锁住，这样就会破坏这个语义。\u003c/p\u003e\n\u003cp\u003e从数据一致性角度来看，如果事务A在选择d=5的所有行之后对其数据有更改，比如A的T1改为：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"k\"\u003eselect\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ewhere\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eupdate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003eupdate\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eset\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e100\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ewhere\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e但是A是最后才提交的，也就是binlog记录的这个修改时最后才执行的，那么id=0,1,5的d字段都会变成100，从而造成了数据不一致。\u003c/p\u003e\n\u003cp\u003e如何解决幻读？\u003c/p\u003e\n\u003cp\u003e如果把所有的行都加行锁，这样事务B正常，但是事务C的插入还是导致幻读无法避免。因为行锁只能锁住行，但是插入记录更新的是记录之间的间隙，所以InnoDB引入间隙锁，执行：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"k\"\u003eselect\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ewhere\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eupdate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e的时候，会给数据库的所有记录都加行锁，然后给字段d存在的4个间隙都加间隙锁，间隙锁会阻塞在间隙中插入新的记录的操作。\u003c/p\u003e\n\u003cp\u003e间隙锁和行锁合称为next-key lock，比如上面的例子就是：$(-\\infin, 0], (0, 5], (5, 10], (10, +\\infin)$\u003c/p\u003e\n\u003cp\u003e不过并发事务的多个间隙锁之间可能会导致死锁\u003c/p\u003e\n","date":1648389376,"description":"","fuzzywordcount":1900,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"9b861d869d4e3eb4a6e252bab9de95b9","publishdate":1648389376,"relpermalink":"/posts/mysql-advanced-5-lock/","section":"posts","summary":"有并发的时候，需要锁来控制资源的访问规则。 MySQL的锁分为全局锁、表级锁和行锁。 全局锁 对整个数据库实例进行加锁，加完锁后数据库处于只读状态，一般用于全量备份的","tags":["MySQL"],"title":"MySQL进阶（五）锁","url":"https://blog.engine.wang/posts/mysql-advanced-5-lock/","wordcount":1870},{"categories":"posts","content":"\u003ch2 id=\"索引的概念与意义\"\u003e索引的概念与意义\u003c/h2\u003e\n\u003cp\u003e索引是数据库中最重要的概念之一，它是一种特殊的查询表，可以被数据库搜索引擎用来加速数据的检索。\u003c/p\u003e\n\u003cp\u003e索引可大大提高SELECT和WHERE的查询速度，不过会降低UPDATE和INSERT的速度。\u003c/p\u003e\n\u003cp\u003e可以理解为查阅某本书的章节名，目录就是一个索引，可以通过目录快速找到有没有自己想要的内容，而不必翻遍这本书。\u003c/p\u003e\n\u003cp\u003e通过\u003ccode\u003eCREATE INDEX\u003c/code\u003e创建索引：\u003c/p\u003e\n\u003ch2 id=\"索引的多种实现方式\"\u003e索引的多种实现方式\u003c/h2\u003e\n\u003cp\u003e索引有很多种实现方式，其中叫为简单的有哈希表、有序数组、搜索树。\u003c/p\u003e\n\u003ch3 id=\"哈希表\"\u003e哈希表\u003c/h3\u003e\n\u003cp\u003e哈希表的概念不做介绍，理论上它可以在$O(1)$时间内找到这个key对应的元素，然而多个key在hash之后出现同一个值的话，也就是哈希冲突，会挂在后面退化成链表，这个倒是有解决方法。\u003c/p\u003e\n\u003cp\u003e但是哈希表不能自持快速的范围查询，比如查询[a,b]之间的数据，哈希表就只能$O(n)$\u003c/p\u003e\n\u003cp\u003e哈希表做等值kv查询的效率不错，比如NoSQL、Memcached的一些，但是范围查询表现不佳。\u003c/p\u003e\n\u003ch3 id=\"有序数组\"\u003e有序数组\u003c/h3\u003e\n\u003cp\u003e有序数组字在等值和范围查询的效率都很高，但是缺点也非常明显，插入和删除的复杂度很高。\u003c/p\u003e\n\u003cp\u003e适用于很少插入删除但是查询很多的场景，也就是静态存储，比如往年的一些数据，很少修改经常查询的，可以使用有序数组。\u003c/p\u003e\n\u003ch3 id=\"二叉搜索树\"\u003e二叉搜索树\u003c/h3\u003e\n\u003cp\u003e二叉搜索树的查询复杂度是$O(log N)$，当然为了保持这个效率还需要维持平衡，更新的复杂度也是$O(log N)$\u003c/p\u003e\n\u003cp\u003e但是大部分实际情况都不会用二叉搜索树，因为实际数据量较大时，会造成二叉树高度过高，底部节点的访问需要读取很多数据块。\u003c/p\u003e\n\u003cp\u003e更多的是使用N叉树。\u003c/p\u003e\n\u003ch3 id=\"跳表\"\u003e跳表\u003c/h3\u003e\n\u003cp\u003eRedis用的就是跳表，跳表的原理见\u003ccode\u003e跳表.md\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"b树\"\u003eB+树\u003c/h3\u003e\n\u003cp\u003eMySQL的InnoDB采用的就是B+树，其基本原理之后再补充。\u003c/p\u003e\n\u003ch2 id=\"innodb索引结构\"\u003eInnoDB索引结构\u003c/h2\u003e\n\u003cp\u003e聚簇索引：存的是主键，叶子节点的内容是整行数据\n二次索引：存的是非主键，叶子节点的内容是主键\u003c/p\u003e\n\u003cp\u003e每个索引都会新建一个B+树来存储。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e如果查询语句是关于主键的查询\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e比如：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"k\"\u003eselect\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003etable\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ewhere\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eID\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e就需要查找聚簇索引\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e如果查询的是非主键\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e比如：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"k\"\u003eselect\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003etable\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ewhere\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ec1\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e就需要先去查找c1这个字段的索引，得到主键值，然后回聚簇索引里搜索具体的一行数据。这个过程称为\u003cstrong\u003e回表\u003c/strong\u003e。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e如果范围查询非主键\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e比如：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"k\"\u003eselect\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003etable\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ewhere\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ec1\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ebetween\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eand\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e首先会在字段c1的索引表上找c1=1的记录，取得主键ID，然后回聚簇索引里取对应的行，接下来找c1索引的下一个值，取得主键ID...一直找到c1索引的c1值大于3，循环结束。\u003c/p\u003e\n\u003cp\u003e这种范围查询的情况会产生很多次回表。\u003c/p\u003e\n\u003cp\u003e这也说明了，我们应该尽量用主键进行查询。\u003c/p\u003e\n\u003ch2 id=\"联合索引\"\u003e联合索引\u003c/h2\u003e\n\u003cp\u003e联合多个键进行索引，好处有：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e减少开销，根据最左匹配匹配，创建一个联合索引相当于建立了多个索引\u003c/li\u003e\n\u003cli\u003e如果是覆盖，也就是只通过一些索引的列选取索引的其他列，可以不用回表，提高性能\u003c/li\u003e\n\u003cli\u003e如果是where...and查询，只有单条索引就需要筛选很多元素然后回表，但是联合索引可以让筛选出的量大大减少。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"一些补充\"\u003e一些补充\u003c/h2\u003e\n\u003ch3 id=\"覆盖索引\"\u003e覆盖索引\u003c/h3\u003e\n\u003cp\u003e覆盖索引（Covering Index）就是可以从非主键索引中就能查到的记录，而不需要回表。从而提升性能。\u003c/p\u003e\n\u003cp\u003e比如我们有一个需求就是通过查询c1获得c2的内容，如果正常的建立c1和主键ID的索引，那么每次查询一行都要回表。\u003c/p\u003e\n\u003cp\u003e而可以建立联合索引：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"k\"\u003eALTER\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTABLE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eDROP\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eINDEX\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ec1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003eALTER\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTABLE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eADD\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eINDEX\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eI_c1_c2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ec2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e之后再通过c1查询c2的话：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"k\"\u003eselect\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ecol1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003ecol2\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003etest\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ewhere\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ecol1\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eand\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ecol2\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e在联合索引上找到c1，就可以直接返回c2\u003c/p\u003e\n\u003ch3 id=\"关于自增主键\"\u003e关于自增主键\u003c/h3\u003e\n\u003cp\u003e表中可以定义自增主键：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"k\"\u003eNOT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNULL\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ePRIMARY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eKEY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eAUTO_INCREMENT\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e插入记录不需要指定ID，数据库会自动获取ID最大值+1作为其主键然后插入。\u003c/p\u003e\n\u003cp\u003e很多业务都可以用自增主键，节约空间从而提高效率。\u003c/p\u003e\n\u003cp\u003e除了kv场景，一般用业务字段做主键。\u003c/p\u003e\n\u003ch3 id=\"前缀索引\"\u003e前缀索引\u003c/h3\u003e\n\u003cp\u003e可以通过\u003ccode\u003ecol(n)\u003c/code\u003e的语法来为该列的前n个字符创建索引，这样创建的索引文件会小很多。对\u003ccode\u003eBLOB\u003c/code\u003e和\u003ccode\u003eTEXT\u003c/code\u003e创建索引也必须采用这种方式。\u003c/p\u003e\n\u003ch3 id=\"最左前缀原则\"\u003e最左前缀原则\u003c/h3\u003e\n\u003cp\u003e建立\u003cstrong\u003e联合索引\u003c/strong\u003e的时候，索引内的字段顺序，可以通过调整顺序来少维护索引，但是必须保持最左前缀原则。\u003c/p\u003e\n\u003cp\u003e比如该表：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"k\"\u003eCREATE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eTABLE\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003etest\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"w\"\u003e         \u003c/span\u003e\u003cspan class=\"nb\"\u003eINT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNOT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003elast_name\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nb\"\u003eCHAR\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e30\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNOT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"n\"\u003efirst_name\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"nb\"\u003eCHAR\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e30\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNOT\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003ePRIMARY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eKEY\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"k\"\u003eINDEX\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elast_name\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003efirst_name\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e为\u003ccode\u003elast_name\u003c/code\u003e和\u003ccode\u003efirst_name\u003c/code\u003e创建了一个联合索引\u003ccode\u003ename\u003c/code\u003e，这个索引支持\u003ccode\u003elast_name\u003c/code\u003e和\u003ccode\u003efirst_name\u003c/code\u003e的联合查询，也支持只有\u003ccode\u003elast_name\u003c/code\u003e的查询，但是不支持只有\u003ccode\u003efirst_name\u003c/code\u003e的查询\u003c/p\u003e\n\u003cp\u003e联合索引的任何一个索引的最左前缀都会被优化器用于查找列。比如，一个包含三列的联合索引 (col1, col2, col3)，索引会生效于 (col1), (col1, col2), and (col1, col2, col3)，但是其他情况的组合则不会生效。\u003c/p\u003e\n\u003ch3 id=\"索引下推\"\u003e索引下推\u003c/h3\u003e\n\u003cp\u003eMySQL5.6之后引入索引下推，在遍历的过程中可以直接过滤掉不满足条件的记录，从而减少回表次数。\u003c/p\u003e\n\u003ch3 id=\"字符串字段的前缀索引\"\u003e字符串字段的前缀索引\u003c/h3\u003e\n\u003cp\u003e正常情况来说，给字符串字段加索引，会给整个字符串建立索引，但有有些时候字符串很长，比较浪费空间，我们没必要全部存，存一部分即可。\u003c/p\u003e\n\u003cp\u003e比如有\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e123454@gmail.com\n123455@gmail.com\n123456@gmail.com\n123457@gmail.com\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e我们只需要将前缀存在索引里，比如对于这个情况，我们存前6位即可区分出所有数据，这样既可以节约空间，又可以提高匹配效率。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"k\"\u003ealter\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003etable\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eadd\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eindex\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eindex1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eemail\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e6\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e如果出现数据不同只是前缀一样的情况，回表的时候会多访问一些次数，所以最好这种情况不要占比太多，也就是说前缀长度的选取有讲究。\u003c/p\u003e\n\u003cp\u003e比如可以通过下面的sql参看选取各个长度的索引的不同值，设定一个可接受的比例然后选取合适的前缀长度。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"k\"\u003eselect\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edistinct\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eemail\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"err\"\u003e）\u003c/span\u003e\u003cspan class=\"k\"\u003eas\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eL4\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edistinct\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eemail\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"err\"\u003e）\u003c/span\u003e\u003cspan class=\"k\"\u003eas\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eL5\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edistinct\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eemail\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e6\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"err\"\u003e）\u003c/span\u003e\u003cspan class=\"k\"\u003eas\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eL6\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edistinct\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eleft\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eemail\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"mi\"\u003e7\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"err\"\u003e）\u003c/span\u003e\u003cspan class=\"k\"\u003eas\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eL7\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e除了前缀索引之外，如果一些字符串是后面的不一样前面的一样，比如一个地区的身份证，那么可以考虑倒序存储，每次存的时候倒过来存，查的时候再倒回来。\n另一个方式是使用哈希字段，也就在表上再增加一个字段，这个字段是我们需要做索引的字段的哈希值。我们在这个哈希值字段上做索引，这样索引的长度就变成了四个字节。\u003c/p\u003e\n\u003cp\u003e但是倒序和哈希的缺点是不再支持范围查询。\u003c/p\u003e\n","date":1647498074,"description":"","fuzzywordcount":2400,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"989c79d88f6a182d2be4639696b0592c","publishdate":1647498074,"relpermalink":"/posts/mysql-advanced-4-index/","section":"posts","summary":"索引的概念与意义 索引是数据库中最重要的概念之一，它是一种特殊的查询表，可以被数据库搜索引擎用来加速数据的检索。 索引可大大提高SELECT和WHERE的查询速度，","tags":["MySQL"],"title":"MySQL进阶（四）索引","url":"https://blog.engine.wang/posts/mysql-advanced-4-index/","wordcount":2351},{"categories":"posts","content":"\u003ch2 id=\"事务的概念与意义\"\u003e事务的概念与意义\u003c/h2\u003e\n\u003cp\u003e一个行为可能涉及到多个操作，如果进行到中途系统忽然崩溃，那么可能会造成巨大的损失。\u003c/p\u003e\n\u003cp\u003e我们想要保证一系列的数据库操作，要么全部成功，要么全部失败。这就是事务。\u003c/p\u003e\n\u003cp\u003eMySQL的InnoDB支持事务，而MyISAM不支持，所以我们这里谈的MySQL事务都基于InnoDB引擎。\u003c/p\u003e\n\u003ch2 id=\"acid\"\u003eACID\u003c/h2\u003e\n\u003cp\u003e事务的ACID\u003c/p\u003e\n\u003cp\u003eAtomicity：原子性\nConsistency：一致性\nIsolation：隔离性\nDurability：持久性\u003c/p\u003e\n\u003ch2 id=\"隔离级别\"\u003e隔离级别\u003c/h2\u003e\n\u003cp\u003e隔离的越少，越容易出现问题，隔离的越严密，效率越低。\u003c/p\u003e\n\u003cp\u003e这就有点像分布式系统对一致性的追求，我们需要根据实际场景来选择隔离等级。\u003c/p\u003e\n\u003cp\u003e不同的隔离级别会有不同的结果。SQL的隔离等级有读未提交、读提交、可重复读和串行化，它们的并行效率依次降低，安全性依次提高。下面通过一个具体的例子来了解它们。\u003c/p\u003e\n\u003cp\u003e假设数据库中有一个值，目前是1，有两个事务A、B：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645642362/mysql-tran-1.png\" alt=\"mysql-tran-1\"\u003e\u003c/p\u003e\n\u003ch3 id=\"读未提交-ru\"\u003e读未提交 RU\u003c/h3\u003e\n\u003cp\u003e一个事务还没提交就能被另一个事务看到。\u003c/p\u003e\n\u003cp\u003e也就是B还没提交的时候，A就能读到修改的值，此时V1=2，V2=2，V3=2\u003c/p\u003e\n\u003cp\u003e读未提交就是每次直接返回记录中最新的值。\u003c/p\u003e\n\u003ch3 id=\"读提交-rc\"\u003e读提交 RC\u003c/h3\u003e\n\u003cp\u003e一个事务提交之后就能被另一个事务看到。\u003c/p\u003e\n\u003cp\u003e如果是读提交，需要在提交之后才能读到修改，此时V1=1，V2=2，V3=2\u003c/p\u003e\n\u003cp\u003e对于读提交，数据库会创建一个视图，访问时以视图的逻辑为准，在每次SQL语句开始执行的时候创建。\u003c/p\u003e\n\u003ch3 id=\"可重复读-rr\"\u003e可重复读 RR\u003c/h3\u003e\n\u003cp\u003eRR是InnoDB的默认事务隔离级别。\u003c/p\u003e\n\u003cp\u003e事务执行过程中看到的数据和启动时看到的一致\u003c/p\u003e\n\u003cp\u003e如果是可重复读，事务的整个过程读到的数据都一样，V1=1，V2=1，执行完之后就不需要一样，V3=2\u003c/p\u003e\n\u003cp\u003e对于读提交，数据库会创建一个视图，在每次事务启动的时候创建。\u003c/p\u003e\n\u003ch3 id=\"串行化-serializable\"\u003e串行化 Serializable\u003c/h3\u003e\n\u003cp\u003e同一行记录读和写都会加锁，不允许任何并行读写\u003c/p\u003e\n\u003cp\u003e如果是串行化，B在执行修改操作时被锁住，等到A事务执行完，B才继续执行，此时V1=1，V2=1，V3=2\u003c/p\u003e\n\u003cp\u003e串行化是通过加锁的方式来避免一切并行访问。\u003c/p\u003e\n\u003ch3 id=\"配置隔离级别\"\u003e配置隔离级别\u003c/h3\u003e\n\u003cp\u003e事实上每一种隔离级别都要对应的使用场景，如果要配置的话，可以设置启动参数 transaction-isolation 的值\u003c/p\u003e\n\u003cp\u003e比如改为READ-COMMITTED：读提交\u003c/p\u003e\n\u003ch2 id=\"事务隔离的实现mvcc\"\u003e事务隔离的实现：MVCC\u003c/h2\u003e\n\u003cp\u003e前面我们说了undo log，记录回滚的日志。\u003c/p\u003e\n\u003cp\u003eMVCC（Multi-Version Concurrency Control）即多版本并发控制，可以避免同一个数据在不同事务之间的竞争。通过MVCC机制，只有写写才会阻塞，读读、读写、写读都可以并行，从而大大提高效率，同时允许多个版本同时存在。\u003c/p\u003e\n\u003cp\u003e前面提到的读提交和可重复度用到了MVCC。\u003c/p\u003e\n\u003cp\u003e在介绍MVCC之前，先引出ReadView的概念。\u003c/p\u003e\n\u003ch3 id=\"readview\"\u003eReadView\u003c/h3\u003e\n\u003cp\u003e是数据库某一时刻所有未提交事务的快照。\u003c/p\u003e\n\u003cp\u003e如果是读提交RC，每次开始查询时都会生成一个ReadView。\n如果是可重复读RR，事务在第一次读取数据的时候就生成一个ReadView，之后再也不会生成。\u003c/p\u003e\n\u003cp\u003e包括几个参数：\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e参数\u003c/th\u003e\n\u003cth\u003e说明\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003ecreator_trx_id\u003c/td\u003e\n\u003ctd\u003e当前事务Id\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003em_ids\u003c/td\u003e\n\u003ctd\u003e生成ReadView时，系统中活跃的读写事务的事务Id列表\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003emin_trx_id\u003c/td\u003e\n\u003ctd\u003e生成ReadView时，系统中活跃的读写事务的最小事务Id\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003emax_trx_id\u003c/td\u003e\n\u003ctd\u003e生成ReadView时，将在下一次分配的事务Id\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e当一个事务创建的瞬间，已提交的事务、正在活跃但还未提交的事务、未开始的事务构成了这个事务的ReadView。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645776219/mysql-tran-2.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"隐藏列\"\u003e隐藏列\u003c/h3\u003e\n\u003cp\u003eInnoDB存储引擎对于每一个聚类索引都包含了两个隐藏列：\u003c/p\u003e\n\u003cp\u003etrx_id：事务Id，把改变某条聚簇索引的事务Id记录到这个列\u003c/p\u003e\n\u003cp\u003eroll_pointer：回滚指针，也就是指向对应undo log的指针\u003c/p\u003e\n\u003cp\u003e通过roll_pointer可以串成一个undo log链表，称为事务链\u003c/p\u003e\n\u003ch3 id=\"判断事务使用的版本\"\u003e判断事务使用的版本\u003c/h3\u003e\n\u003cp\u003e如果被访问的trx_id小于ReadView的低水位Id，即落在上图的绿色区域。那么说明该版本的事务在生成ReadView之前就提交了，所以可以被当前事务访问。\u003c/p\u003e\n\u003cp\u003e如果被访问的trx_id大于ReadView的高水位Id，即落在上图的红色区域。那么说明该版本事务在生成ReadView之后才生成，不能被当前事务访问。\u003c/p\u003e\n\u003cp\u003e如果介于最小Id和最大Id值之间，即落在上图的蓝色区域。需要判断trx_id是否在m_ids列表中，如果在的话说明创建ReadView时该版本事务还活跃，不能访问。如果不在的话说明创建ReadView时该版本已经提交，可以访问。\u003c/p\u003e\n\u003ch2 id=\"长事务的问题\"\u003e长事务的问题\u003c/h2\u003e\n\u003cp\u003e所谓长事务，也就是运行时间比较长，长时间没有提交的事务，长事务会导致阻塞、占用锁资源、影响性能，应该尽量避免使用长事务。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003einformation_schema.innodb_trx\u003c/code\u003e表包含当前innoDB正在运行的事务信息，包含了事务的开始时间。\u003c/p\u003e\n\u003cp\u003e可以通过以下命令查看时间超过一分钟的长事务，然后kill掉。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"k\"\u003eselect\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003efrom\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003einformation_schema\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einnodb_trx\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003ewhere\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"n\"\u003eTIME_TO_SEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etimediff\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enow\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\u003cspan class=\"n\"\u003etrx_started\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"mi\"\u003e60\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e","date":1646618411,"description":"","fuzzywordcount":1900,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"63c246c0af7864010386f96ff3df4138","publishdate":1646618411,"relpermalink":"/posts/mysql-advanced-3-transaction/","section":"posts","summary":"事务的概念与意义 一个行为可能涉及到多个操作，如果进行到中途系统忽然崩溃，那么可能会造成巨大的损失。 我们想要保证一系列的数据库操作，要么全部成功，要么全部失败。这","tags":["MySQL"],"title":"MySQL进阶（三）再谈事务","url":"https://blog.engine.wang/posts/mysql-advanced-3-transaction/","wordcount":1870},{"categories":"posts","content":"\u003ch2 id=\"日志的概念与意义\"\u003e日志的概念与意义\u003c/h2\u003e\n\u003cp\u003e日志在各种软件都不可或缺，尤其是数据库应用，可以看作是飞机的黑匣子，记录着发生的一切。\u003c/p\u003e\n\u003cp\u003e其意义在于：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e分析历史记录\u003c/li\u003e\n\u003cli\u003e定位问题\u003c/li\u003e\n\u003cli\u003e错误复盘\u003c/li\u003e\n\u003cli\u003e误操作，借助日志恢复到某个之前的状态\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"mysql日志\"\u003eMySQL日志\u003c/h2\u003e\n\u003cp\u003eMySQL有一个很神奇的特性，它可以恢复为半个月之内任意一秒的状态。这要仰仗它的日志系统中的redo log和bin log。\u003c/p\u003e\n\u003ch3 id=\"redo-log\"\u003eredo log\u003c/h3\u003e\n\u003cp\u003e每一次的更新操作不可能都直接写进磁盘里，这样IO成本过高，效率太低。InnoDB使用WAL（Write-ahead Logging）技术，也就是先写日志，然后等不忙的时候才写磁盘。\u003c/p\u003e\n\u003cp\u003e一条更新记录会先写入redo log，然后写入内存，之后等系统空闲的时候再写入磁盘。如果log写满了就只能先将里面的一部分写入磁盘，再擦掉log。InnoDB的redo log大小是固定的，一组4个文件，每个文件大小为1G。\u003c/p\u003e\n\u003cp\u003eredo log记录的是这个页做了什么改动。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645639120/mysql-2.png\" alt=\"mysql02\"\u003e\u003c/p\u003e\n\u003cp\u003e这里write_pos就是目前在写的位置，checkpoint就是当前在擦除的位置，checkpoint到write_pos之间的是写入内容的redo log，而write_pos到checkpoint之间的就是空闲的区域。\u003c/p\u003e\n\u003cp\u003e通过redo log，即使数据库发生异常，之前提交的记录依然存放在log里，也不会丢失，这个能力称为\u003cstrong\u003ecrash-safe\u003c/strong\u003e。\u003c/p\u003e\n\u003ch4 id=\"redo-log的两阶段提交\"\u003eredo log的两阶段提交\u003c/h4\u003e\n\u003cp\u003e两阶段提交的目的是让redo log和bin log之间的逻辑一致。\u003c/p\u003e\n\u003cp\u003e如果不采用两阶段提交，不论redo log和bin log的先后记录顺序，如果在两个log写的间隙时崩溃，都会导致binlog恢复的库与原库的值不同。两阶段提交可以让这两个的状态保持一致。\u003c/p\u003e\n\u003ch4 id=\"redo-log的底层原理\"\u003eredo log的底层原理\u003c/h4\u003e\n\u003cp\u003eInnoDB是Write Ahead Log机制，也就是先写log再写磁盘，处理一条更新语句时，首先会把记录写到redo log buffer中，然后更新内存数据，此时是脏页，最终会刷入磁盘中覆盖原有的数据。\u003c/p\u003e\n\u003ch3 id=\"undo-log\"\u003eundo log\u003c/h3\u003e\n\u003cp\u003e数据修改的时候，会记录相应的回滚值。\u003c/p\u003e\n\u003cp\u003eundo log和bin log记录的类型一样，都是逻辑，不过undo log记录一个相反的操作，比如delete一条记录，undo log就会记录insert这条记录。a的b字段从1update为2，那么undo log就会记录a的b从2update为1。\u003c/p\u003e\n\u003cp\u003e后面的事务MVCC会用到undo log\u003c/p\u003e\n\u003ch3 id=\"bin-log\"\u003ebin log\u003c/h3\u003e\n\u003cp\u003ebin log是二进制日志，存储所有数据库表结构变更和表数据修改的所有操作。\u003c/p\u003e\n\u003cp\u003eredo log是InnoDB存储引擎特有的log，而bin log是Server层的，所有引擎都支持。\u003c/p\u003e\n\u003cp\u003e它用于记录原始的逻辑日志，可以追加写入。\u003c/p\u003e\n\u003cp\u003e也就是记录的是每次执行语句的原始逻辑，比如给ID=1的c字段设置为5。\u003c/p\u003e\n\u003cp\u003eredo log是循环写，空间用完后会覆盖之前的日志。bin log是追加写，不会覆盖以前的日志。\u003c/p\u003e\n\u003ch3 id=\"如何依靠日志恢复到历史的某个点\"\u003e如何依靠日志恢复到历史的某个点\u003c/h3\u003e\n\u003cp\u003e假如现在的时刻时C，在之前的某个B时刻执行错误了某个操作（比如误删表），想要恢复到B操作之前的状态，那么应该先去找在B之前的最近的一次全量备份A，先恢复到A时刻的数据，然后将A-B这个时间段的binlog取出，依次执行命令。\u003c/p\u003e\n\u003ch2 id=\"一条sql更新语句的执行过程\"\u003e一条SQL更新语句的执行过程\u003c/h2\u003e\n\u003cp\u003e假设执行这样一条update语句：\n\u003ccode\u003eupdate T set c=5 where ID=1;\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e那么流程如下：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645640253/mysql-3.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e蓝色表示在InnoDB存储引擎中执行，红色表示在执行器中执行。\u003c/p\u003e\n\u003ch2 id=\"抖动\"\u003e抖动\u003c/h2\u003e\n\u003cp\u003e实际工程中，大部分SQL执行都很快，但是有时候同样的一条SQL忽然就很慢，而且这种随机情况还很难复现。这种情况称为抖动\u003c/p\u003e\n\u003cp\u003e每次修改的记录顺序，都是从内存 - redo log - 硬盘存储的过程。\u003c/p\u003e\n\u003cp\u003e在把内存里的数据写入磁盘的过程称为flush\u003c/p\u003e\n\u003cp\u003e内存数据页和磁盘不一致的时候，这个内存页称为脏页，写入到磁盘后二者一致，内存页称为干净页\u003c/p\u003e\n\u003cp\u003e平时操作很快，是在写内存和日志，而某一条忽然抖一下，很有可能是在进行flush，\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e什么时候会进行flush呢？\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003col\u003e\n\u003cli\u003eredo log写满了，再写入新的日志就需要把早的一部分日志对应的脏数据flush到硬盘，然后擦掉，留出空间写新的redo log。\u003c/li\u003e\n\u003cli\u003e内存不足，此时也只能淘汰一些老的内存页，在这之前先flush到硬盘。\u003c/li\u003e\n\u003cli\u003emysql认为当前空闲，进行flush。如果一直都很忙也要找时间刷一点脏页\u003c/li\u003e\n\u003cli\u003eMySQL的关闭，在关闭之前需要将所有的脏页都flush到磁盘，这样下次启动就从磁盘直接读取。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e其中前两种情况对性能的影响比较大。\u003c/p\u003e\n\u003cp\u003e第一种情况redo log满，此时数据库将不再接受更新，直到flush完。\u003c/p\u003e\n\u003cp\u003e第二种情况内存满，InnoDB的缓冲池中的内存页游三种状态：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e还未被使用\u003c/li\u003e\n\u003cli\u003e使用了，是干净页\u003c/li\u003e\n\u003cli\u003e使用了，是脏页\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e读入的数据不在内存中，就需要从内存中申请一个数据页，如果没有未被使用的内存页，就需要淘汰最久未使用的数据页。如果是干净页可以直接删掉，如果是脏页的话就要flush。\u003c/p\u003e\n\u003cp\u003e那么如果一个查询要淘汰很多脏页，就会导致抖动卡住的时间非常长，需要避免这种情况。\u003c/p\u003e\n\u003cp\u003e所以InnoDB需要控制脏页的比例。\u003c/p\u003e\n\u003cp\u003e首先需要告诉InnoDB主机的IO能力，设置\u003ccode\u003einnodb_io_capacity\u003c/code\u003e这个参数，通过\u003ccode\u003efio\u003c/code\u003e命令可以测出本机的IOPS：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003efio -filename\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$filename\u003c/span\u003e -direct\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e -iodepth \u003cspan class=\"m\"\u003e1\u003c/span\u003e -thread -rw\u003cspan class=\"o\"\u003e=\u003c/span\u003erandrw -ioengine\u003cspan class=\"o\"\u003e=\u003c/span\u003epsync -bs\u003cspan class=\"o\"\u003e=\u003c/span\u003e16k -size\u003cspan class=\"o\"\u003e=\u003c/span\u003e500M -numjobs\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e10\u003c/span\u003e -runtime\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e10\u003c/span\u003e -group_reporting -name\u003cspan class=\"o\"\u003e=\u003c/span\u003emytest\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eInnoDB会考虑脏页比例和redo log的写盘速度，计算得到，按照\u003ccode\u003eR%\u003c/code\u003e的速度来刷脏页\u003c/p\u003e\n","date":1645970309,"description":"","fuzzywordcount":2100,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"a11976c9eb363c3bd41d50abe75288cc","publishdate":1645970309,"relpermalink":"/posts/mysql-advanced-2-log/","section":"posts","summary":"日志的概念与意义 日志在各种软件都不可或缺，尤其是数据库应用，可以看作是飞机的黑匣子，记录着发生的一切。 其意义在于： 分析历史记录 定位问题 错误复盘 误操作，借助日志恢","tags":["MySQL"],"title":"MySQL进阶（二）日志","url":"https://blog.engine.wang/posts/mysql-advanced-2-log/","wordcount":2079},{"categories":"posts","content":"\u003ch2 id=\"mysql底层架构\"\u003eMySQL底层架构\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1646895283/mysql-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eMySQL包含一个Server层和一个存储逻辑层，大部分核心功能和内置函数、所有跨存储引擎的功能都在Server层实现。\u003c/p\u003e\n\u003cp\u003e存储引擎层负责数据存储和提取，支持InnoDB、MylSAM、Memory等多种存储引擎，目前默认用的是InnoDB，除非在创建表的时候通过\u003ccode\u003eengine=xxx\u003c/code\u003e来手动选择。后面如果没做特殊说明，都指的是InnoDB引擎。\u003c/p\u003e\n\u003ch2 id=\"查询sql的执行过程\"\u003e查询SQL的执行过程\u003c/h2\u003e\n\u003ch3 id=\"1-连接器\"\u003e1. 连接器\u003c/h3\u003e\n\u003cp\u003e我们都知道，在启动mysql server后，通过如下的mysql的连接命令进行连接：\n\u003ccode\u003emysql -h ip -P port -u user -p\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e首先会和连接器打交道，连接器负责鉴权和建立连接。\u003c/p\u003e\n\u003cp\u003e和MySQL建立连接的方式是TCP/IP或者socket（取决于是连接远程服务器的MySQL还是本地的）\u003c/p\u003e\n\u003cp\u003e建立连接后，MySQL会检查权限表，查看该用户有没有权限连接到MySQL实例。验证通过之后会将用户的权限信息缓存起来，之后都基于缓存中的权限信息来执行sql。\u003c/p\u003e\n\u003cp\u003e连接后如果超过\u003ccode\u003ewait_timeout\u003c/code\u003e（默认是8小时）一直都没有操作，就会自动断开。下一次就要重连。\u003c/p\u003e\n\u003ch3 id=\"2-查询缓存\"\u003e2. 查询缓存\u003c/h3\u003e\n\u003cp\u003e把之前查询过的语句和结果通过k-v对的形式缓存在内存中，如果之后某次的查询在缓存中找到了，就直接返回。\n不过实际上这个功能并不好，只要表被更新了就会失效，而且还占缓存，除非是经常不更新的表，所以MySQL8.0直接删除了查询缓存。\u003c/p\u003e\n\u003ch3 id=\"3-分析器\"\u003e3. 分析器\u003c/h3\u003e\n\u003cp\u003eMySQL需要解析这条语句，先做词法分析，再做语法分析。\n从而理解这条语句的需求。属于编译原理的内容，这里就不细说。\u003c/p\u003e\n\u003ch3 id=\"4-优化器\"\u003e4. 优化器\u003c/h3\u003e\n\u003cp\u003e在分析好了SQL语句后，MySQL就了解了具体的需求，但是在实际执行之前还需要进入优化器进行优化。\u003c/p\u003e\n\u003cp\u003e在表里有多张索引的时候，决定使用哪个索引，或者比较复杂的查询语句，有多种查询的嵌套方式，优化器的作用就是选择一种最佳方案来执行，从而提高效率\u003c/p\u003e\n\u003ch3 id=\"5-执行器\"\u003e5. 执行器\u003c/h3\u003e\n\u003cp\u003e首先判断用户是否有权限使用这张表。最前面的连接器鉴权是判断是够能够连接MySQL实体，而这里是精确到表的权限。\u003c/p\u003e\n\u003cp\u003e然后根据对应表的引擎定义，使用存储引擎的接口执行查询。\u003c/p\u003e\n\u003cp\u003e执行器会维护一个结果集，在查询的过程中如果查询到了符合要求的记录，就会追加进结果表，最后将这个结果表返回给用户。\u003c/p\u003e\n\u003cp\u003e至此就完成了一条SQL查询语句的执行。\u003c/p\u003e\n\u003ch2 id=\"innodb引擎架构简述\"\u003eInnoDB引擎架构简述\u003c/h2\u003e\n\u003cp\u003eMySQL默认的存储引擎是InnoDB，其架构图如下：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://static001.geekbang.org/infoq/bf/bf3d9fb7acbf4482434107aba9731eb8.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e因为确实非常复杂，也不是专门研究数据库，所以不会讲解非常详细，只是简单的提一下InnoDB的架构。\u003c/p\u003e\n\u003cp\u003e主要包括内存池、后台线程和存储文件。\u003c/p\u003e\n\u003cp\u003e内存池包括：磁盘缓存、redo log缓存等\n后台线程包括Master Thread、IO Thread和Pruge Thread\n存储文件包括：表结构文件.frm、共享表空间文件ibdata1、独占表空间文件ibd、日志文件redo文件等\u003c/p\u003e\n\u003ch3 id=\"缓冲池\"\u003e缓冲池\u003c/h3\u003e\n\u003cp\u003eBuffer Pool（缓冲池）是主内存的一块区域，由于直接从磁盘读取数据会造成性能瓶颈，InnoDB在访问数据的时候，会将数据页缓存到缓冲池中，从而加快速度。缓冲池的目的就是为了提高数据库的读写性能。\u003c/p\u003e\n\u003cp\u003e缓冲池会把数据页链接为链表，通过LRU或者其他缓存代替算法来替换掉老的缓存。\u003c/p\u003e\n\u003cp\u003e对于修改数据的情况，也会先修改缓冲池的数据，然后通过Master Thread刷到磁盘上。\u003c/p\u003e\n\u003cp\u003eredo log也会先放入缓冲区，然后刷到redo log文件中。\u003c/p\u003e\n\u003ch3 id=\"后台线程\"\u003e后台线程\u003c/h3\u003e\n\u003cp\u003eMaster Thread负责将缓冲池的数据异步刷新到磁盘中，IO Thread负责IO，Purge Thread用户回收已经提交的undo log。\u003c/p\u003e\n\u003ch3 id=\"存储文件\"\u003e存储文件\u003c/h3\u003e\n\u003cp\u003e逻辑存储结构从打到小依次是表空间（TableSpace）、段（Segment）、区（Extent）、页（Page）、行（Row）\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1647268687/innodb-2.jpg\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e表空间\u003c/strong\u003e分为共享表空间（ibdata1）和独占表空间，默认会全部放在共享表空间中，也可以设置\u003ccode\u003einnodb_file_per_table = 1\u003c/code\u003e来开启独立表空间模式，这一模式下所有的表都有自己的独立空间。\u003c/p\u003e\n\u003cp\u003e表空间由\u003cstrong\u003e段\u003c/strong\u003e组成，段分为数据段、索引段、回滚段等，InnoDB采用B+树作为索引的底层数据结构，B+树的非叶子结点就是索引段，叶子节点就是数据段。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e区\u003c/strong\u003e是表空间的单元结构，每个区的大小是1Mb\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e页\u003c/strong\u003e是组成区的最小单元，也是InnoDB磁盘管理的最小大单元，每个页为16Kb\u003c/p\u003e\n\u003cp\u003e数据按\u003cstrong\u003e行\u003c/strong\u003e进行存放，每个页最多允许存放7992行\u003c/p\u003e\n","date":1645234337,"description":"","fuzzywordcount":1800,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"7c9ae496b04ec865749cf042d4794c84","publishdate":1645234337,"relpermalink":"/posts/mysql-advanced-1-architecture/","section":"posts","summary":"MySQL底层架构 MySQL包含一个Server层和一个存储逻辑层，大部分核心功能和内置函数、所有跨存储引擎的功能都在Server层实现。 存储引擎层负责数据存储","tags":["MySQL"],"title":"MySQL进阶（一）MySQL架构","url":"https://blog.engine.wang/posts/mysql-advanced-1-architecture/","wordcount":1725},{"categories":"posts","content":"\u003ch2 id=\"服务器模型\"\u003e服务器模型\u003c/h2\u003e\n\u003ch3 id=\"cs模型\"\u003eC/S模型\u003c/h3\u003e\n\u003cp\u003e即传统的Client/Server模型，客户端通过访问服务器来获取所需的资源。\u003c/p\u003e\n\u003cp\u003e串行效率非常低下，服务器需要同时保持多个客户端的监听和提供请求。\u003c/p\u003e\n\u003cp\u003e比如通过\u003ccode\u003eselect\u003c/code\u003e系统调用的C/S模型工作流：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1644203796/linux-io-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"p2p模型\"\u003eP2P模型\u003c/h3\u003e\n\u003cp\u003eC/S模型的缺点在于，如果访问量非常大，服务器会受到比较高的压力，并且如果主服务器宕机会影响整个服务，当然通过分布式可以解决这些问题，另一种解决的模型是Peer to Peer点对点模型，这种网络中每个主机的地位是等同的，每台机器在消耗服务的同时也在为他人提供服务，既是客户端也是服务端。\u003c/p\u003e\n\u003cp\u003e当然需要有一台发现服务器，用于资源的发现，有些也可以提供内容，从而使得各个客户能够查找自己所需资源的位置。\u003c/p\u003e\n\u003ch2 id=\"服务器编程框架\"\u003e服务器编程框架\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1644206009/linux-io-2.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e模块\u003c/th\u003e\n\u003cth\u003e单服务器\u003c/th\u003e\n\u003cth\u003e服务器集群\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eI/O处理单元\u003c/td\u003e\n\u003ctd\u003e处理客户连接，读写网络数据\u003c/td\u003e\n\u003ctd\u003e接入服务器，实现负载均衡\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e逻辑单元\u003c/td\u003e\n\u003ctd\u003e业务进程\u003c/td\u003e\n\u003ctd\u003e逻辑服务器\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e网络存储单元\u003c/td\u003e\n\u003ctd\u003e本地数据库、文件、缓存\u003c/td\u003e\n\u003ctd\u003e数据库服务器\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e请求队列\u003c/td\u003e\n\u003ctd\u003e单元之间的通信\u003c/td\u003e\n\u003ctd\u003e服务器之间的通信\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e对于I/O来说，非阻塞I/O和I/O多路复用技术是高性能网络编程的常见技术，下面聊一聊非常重要的I/O模型。\u003c/p\u003e\n\u003ch2 id=\"阻塞io与非阻塞io\"\u003e阻塞I/O与非阻塞I/O\u003c/h2\u003e\n\u003cp\u003eI/O分为阻塞I/O和非阻塞I/O，socket在创建的时候默认是阻塞的，可以通过设置\u003ccode\u003eSOCK_NONBLOCK\u003c/code\u003e或者系统调用\u003ccode\u003eF_SETFL\u003c/code\u003e来将其设置为非阻塞的。\u003c/p\u003e\n\u003ch3 id=\"阻塞io\"\u003e阻塞I/O\u003c/h3\u003e\n\u003cp\u003e阻塞I/O没有完成时会被系统挂起，直到等待的事件完成。可能会被阻塞的系统调用包括\u003ccode\u003eaccept\u003c/code\u003e、\u003ccode\u003esend\u003c/code\u003e、\u003ccode\u003erecv\u003c/code\u003e、\u003ccode\u003econnect\u003c/code\u003e等，也就是在发送请求后没有收到返回，那么请求就会挂起，直到收到确认报文后才会唤醒该调用。\u003c/p\u003e\n\u003ch3 id=\"非阻塞io\"\u003e非阻塞I/O\u003c/h3\u003e\n\u003cp\u003e非阻塞I/O则总是立即返回，而不管事件是否已经发生。如果没有立即发生就返回error，需要通过errno来区别是没接收到立即的返回还是出错。如果只是单纯的使用非阻塞I/O是没有意义的，直接得到结果但是无法真正处理事件，所以非阻塞I/O需要配合I/O通知机制一起使用，等事件就绪了再处理，I/O通知机制包括I/O复用和SIGIO信号。在后面会详细介绍。\u003c/p\u003e\n\u003ch2 id=\"同步io与异步io\"\u003e同步I/O与异步I/O\u003c/h2\u003e\n\u003ch3 id=\"同步io\"\u003e同步I/O\u003c/h3\u003e\n\u003cp\u003e同步I/O指的是I/O的读写操作都在I/O事件发生之后，应用程序完成。同步I/O需要由用户自己来执行I/O操作。向应用程序通知的是I/O就绪事件。\u003c/p\u003e\n\u003cp\u003e前面提到的阻塞I/O、I/O复用、SIGIO信号都是同步I/O\u003c/p\u003e\n\u003ch3 id=\"异步io\"\u003e异步I/O\u003c/h3\u003e\n\u003cp\u003e异步I/O用户可以直接执行I/O读写，读写操作总是立即返回，而不管I/O是否是阻塞的。异步I/O直接由内核执行I/O操作。向应用程序通知的是I/O完成事件。\u003c/p\u003e\n\u003ch2 id=\"事件处理模式\"\u003e事件处理模式\u003c/h2\u003e\n\u003cp\u003e高效的事件处理模式包括Reactor和Proactor，其中同步I/O主要实现Reactor，异步I/O主要实现Proactor。\u003c/p\u003e\n\u003ch3 id=\"reactor\"\u003eReactor\u003c/h3\u003e\n\u003cp\u003e主线程只负责监听I/O处理单元上是否有事件发生，有的话就通知逻辑单元上的工作线程，剩下的都交给工作线程来完成。\u003c/p\u003e\n\u003cp\u003e工作流程如下图所示：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1644212725/linux-io-3.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e同步I/O实现的Reactor模型流程如下：\n（I/O复用以epoll为例）\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e主线程向epoll事件表中注册socket的读就绪事件\u003c/li\u003e\n\u003cli\u003e主线程调用epoll_wait等待socket上有数据可读\u003c/li\u003e\n\u003cli\u003e一旦socket上有数据可读，epool_wait就通知主线程，主线程将socket可读事件放入请求队列\u003c/li\u003e\n\u003cli\u003e在请求队列上睡眠的某个对应工作线程会唤醒，然后从socket中读取数据并处理客户请求，然后向epoll事件表注册socket的写就绪事件\u003c/li\u003e\n\u003cli\u003e主线程调用epoll_wait等待socket上有数据可写\u003c/li\u003e\n\u003cli\u003e一旦socket上有数据可写，epool_wait就通知主线程，主线程将socket可写事件放入请求队列\u003c/li\u003e\n\u003cli\u003e在请求队列上睡眠的某个对应工作线程会唤醒，然后从socket中写入用户请求的结果\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e对于一次请求流程来说，是先读取socket上的用户请求的数据，然后写回结果到socket。实际上对于主线程来说read和write也没有本质区别，只需要通过判断事件类型然后放入请求队列唤醒对应的工作线程即可。\u003c/p\u003e\n\u003ch3 id=\"proactor\"\u003eProactor\u003c/h3\u003e\n\u003cp\u003eProactor模式下，所有的I/O操作都交给主线程和内核来处理，工作线程只负责业务逻辑。主线程epoll_wait只监听socket的连接请求事件，不能用于检测socket的读写，之后的I/O处理都交给内核。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1644212725/linux-io-4.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e异步I/O实现Proactive的流程：\u003c/p\u003e\n\u003cp\u003e1、 主线程调用aio_read向内核注册socket的读完成事件，并告诉内核用户读缓冲区的位置和读操作完成时的通知应用程序的方式\n2. 主线程继续处理其他逻辑\n3. socket数据读入用户缓冲区后，内核向应用程序发送信号，通知数据可用\n4. 应用程序根据已经定义好的信号处理函数选择工作线程处理用户请求，工作线程处理完后调用aio_write向内核注册socket写完成事件，并告诉内核用户写缓冲区的位置和写操作完成时的通知应用程序的方式\n5. 主线程继续处理其他逻辑\n6. 用户缓冲区数据写入socket后，内核向应用程序发送信号，通知数据已发送完\n7. 应用程序根据已经定义好的信号处理函数选择一个工作线程做善后处理，如是否关闭socket\u003c/p\u003e\n\u003ch2 id=\"并发编程模式\"\u003e并发编程模式\u003c/h2\u003e\n\u003ch3 id=\"半同步半异步模式\"\u003e半同步/半异步模式\u003c/h3\u003e\n\u003cp\u003e这里和之前的同步异步I/O完全不同，这里的同步表示程序完全按照代码的顺序执行，异步表示程序执行需要由系统事件来驱动。\u003c/p\u003e\n\u003cp\u003e同步线程逻辑简单，但是效率低、实时性差\n异步线程执行效率高、实时性强，但是逻辑复杂、不适合大量的并发\u003c/p\u003e\n\u003cp\u003e同时使用同步线程和异步线程，就能既做到有较好的实时性，也能同时处理多个客户端的请求。\u003c/p\u003e\n\u003cp\u003e同步线程用来处理客户逻辑，异步线程用来处理I/O事件。异步线程监听到客户请求后，就封装为请求对象然后插入到请求队列中，请求队列会通知运行在同步模式的工作线程来处理这个请求。\u003c/p\u003e\n\u003cp\u003e一个用的多的变体实例是半同步/半反应堆模式，主线程为唯一的异步线程，监听socket上的事件：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1644218925/linux-io-5.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"领导者追随者模式\"\u003e领导者/追随者模式\u003c/h3\u003e\n\u003cp\u003e多个工作线程轮流获得事件源集合，进行轮流监听、分发和处理事件。\u003c/p\u003e\n\u003cp\u003e同时只能有一个领导者线程来复杂监听I/O事件，其他的都是追随者，如果监听到了I/O事件，就先从追随者里选出新的领导者，此时新的领导者继续监听I/O事件，然后旧的领导者开始处理之前监听到的事件。\u003c/p\u003e\n\u003cp\u003e线程的状态转移：（Processing表示正在处理事件）\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1644218925/linux-io-6.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"高性能编程的一些其他手段\"\u003e高性能编程的一些其他手段\u003c/h2\u003e\n\u003ch3 id=\"池\"\u003e池\u003c/h3\u003e\n\u003cp\u003e相比于空间，响应时间对于大多数服务来说更重要，池（Pool）就是通过空间换时间。\u003c/p\u003e\n\u003cp\u003e池是一组资源的集合，服务器启动的时候就初始化好，完成静态资源分配，之后如果需要相关的资源可以直接从池中获取，而不需要重新创建，从而节约系统资源分配的时间。\u003c/p\u003e\n\u003cp\u003e初始化时无法确定具体需要多少资源，所以就分配足够多的资源。\u003c/p\u003e\n\u003cp\u003e根据不同的资源类型，池可以分为内存池、进程池、线程池、连接池。\u003c/p\u003e\n\u003ch3 id=\"数据复制\"\u003e数据复制\u003c/h3\u003e\n\u003cp\u003e高性能服务器需要避免不必要的复制，尤其是用户代码和内核之间的复制，比如ftp服务器不需要将文件读入到应用程序缓冲区然后调用send函数发送，而是直接可以通过调用sendfile从内核直接发送给客户端。\u003c/p\u003e\n\u003ch2 id=\"io复用\"\u003eI/O复用\u003c/h2\u003e\n\u003cp\u003eI/O复用是最常见的I/O通知机制，指的是应用程序通过I/O复用函数向内核注册一系列事件，内核通过I/O复用函数将就绪的事件返回给应用程序。\u003c/p\u003e\n\u003cp\u003eI/O复用使得程序可以同时监听多个文件描述符（包括socket、用户IO等），从而提高程序性能，比如：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e同时处理多个socket\u003c/li\u003e\n\u003cli\u003e同时处理用户输入和网络连接（比如聊天室）\u003c/li\u003e\n\u003cli\u003e同时监听和连接socket（使用最多的场合）\u003c/li\u003e\n\u003cli\u003e同时处理TCP和UDP连接\u003c/li\u003e\n\u003cli\u003e同时监听多个端口\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e需要注意的是，I/O复用函数本身是阻塞的，多个文件描述符就绪时也只能串行处理，I/O复用依靠同时监听多个I/O事件来达到高效率。\u003c/p\u003e\n\u003cp\u003e如果还要实现多个就绪文件描述符的并发处理，就只能采用多进程或多线程并发，这个后面再讲。\u003c/p\u003e\n\u003cp\u003eLinux中最常见的I/O复用有select、poll和epoll。\u003c/p\u003e\n\u003ch3 id=\"select\"\u003eselect\u003c/h3\u003e\n\u003cp\u003eI/O多路复用指的是一个线程处理多个IO流，也就是常说的selct/epoll机制。\u003c/p\u003e\n\u003cp\u003e可以把标准输入、套接字都看作I/O的一路，多路复用就是在任何一路有I/O事件的地方通知程序去处理相应的I/O事件。\n如果有标准输入，就直接从标准输入中读取数据，如果有套接字数据可以读，就直接读出数据。\u003c/p\u003e\n\u003cp\u003eselect是常见的一个I/O多路复用机制，采用事件轮询机制，最大的缺点就是，支持的文件描述符的最大个数是1024个。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eint select(int nfds, fd_set *readset, fd_set *writeset, fd_set *exceptset, const struct timeval *timeout)\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003enfds：被监听的文件描述符的总数\nreadset：读描述符集合\nwriteset：写描述符集合\nexceptset：异常描述符集合\ntimeout：select函数的超时时间\u003c/p\u003e\n\u003cp\u003e描述符集合的作用是通知内核哪些数据可以读/写/异常等，理解为一个0/1构成的向量。fd_set结构体是一个整型数组，每个bit标记一个文件描述符。\u003c/p\u003e\n\u003cp\u003e通过\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eFD_ZERO\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd_set\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003efdset\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e　　　　　　\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eFD_SET\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efd_set\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003efdset\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e　　\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eFD_CLR\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efd_set\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003efdset\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e　　　\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e  \u003cspan class=\"nf\"\u003eFD_ISSET\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efd_set\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003efdset\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e这几个宏进行设置，其中\u003ccode\u003eFD_ZERO\u003c/code\u003e会将向量的所有元素设为0，\u003ccode\u003eFD_SET\u003c/code\u003e会将对应fd的元素位置设为1, \u003ccode\u003eFD_CLR\u003c/code\u003e将对应fd的元素位置设为0,\u003ccode\u003eFD_ISSET\u003c/code\u003e会查找fd是0还是1。0代表不处理，1代表要处理。\u003c/p\u003e\n\u003cp\u003eselect的返回值：成功时返回就绪文件描述符综述，如果超时还没有任何一个就绪就返回0，失败则返回-1和errno。\u003c/p\u003e\n\u003ch3 id=\"poll\"\u003epoll\u003c/h3\u003e\n\u003cp\u003epoll和select类似，也是轮询一定数量的文件描述符，查看是否有就绪状态的。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eint poll(struct polld *fds, nfds_t nfds, int timeout)\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003efds：pollfd结构的数组，包括文件描述符的可读可写异常等事件\u003c/p\u003e\n\u003cp\u003e相比于select将三种事件描述符集合都分开作为三个参数，poll的pollfd放入了全部的文件描述符和事件，被统一处理，从而使得编程更简洁，用户通过pollfd.events传入感兴趣的事件，内核通过修改pollfd.revents反馈就绪的事件。\u003c/p\u003e\n\u003cp\u003e返回值的含义和select一样，poll的改进比较有限。\u003c/p\u003e\n\u003ch3 id=\"epoll重点\"\u003eepoll（重点）\u003c/h3\u003e\n\u003cp\u003eepoll是Linux特有的I/O复用函数，在2.6的内核版本才引入，是目前Linux最优秀的多路复用机制，也是本篇的重点内容。\u003c/p\u003e\n\u003cp\u003eepoll相比于select的改进：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e没有1024个线程的限制\u003c/li\u003e\n\u003cli\u003eselect采用轮询的方式，效率低下，epoll使用回调函数，效率更高\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eepoll使用一组函数来完成任务，将各个文件描述符的事件统一放在一个事件表里，而不是向select或者poll那样每次调用都要重复传入文件描述符或者事件集。\u003c/p\u003e\n\u003cp\u003e不过epoll需要一个额外的文件描述符来标识内核中的事件表。\u003c/p\u003e\n\u003cp\u003e首先通过\u003ccode\u003eepoll_create\u003c/code\u003e来创建这个文件描述符：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eepoll_create\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003esize是事件表的大小，返回的描述符将被用于其他所有epoll调用的第一个参数，从而能够定位这个事件表。\u003c/p\u003e\n\u003cp\u003e通过\u003ccode\u003eepoll_ctl\u003c/code\u003e函数修改事件表：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"n\"\u003eepoll_ctl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eepfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eop\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eepoll_event\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eevent\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e其中第一个参数就是\u003ccode\u003eepoll_create\u003c/code\u003e返回的事件表的文件描述符，因为需要对于每个文件描述符绑定响应事件。\u003c/p\u003e\n\u003cp\u003eop有三种：\n\u003ccode\u003eEPOLL_CTL_ADD\u003c/code\u003e：往事件表注册fd上的事件\n\u003ccode\u003eEPOLL_CTL_MOD\u003c/code\u003e：修改fd上的注册事件\n\u003ccode\u003eEPOLL_CTL_DEL\u003c/code\u003e：删除fd上的注册事件\u003c/p\u003e\n\u003cp\u003efd就是要操作的文件描述符\u003c/p\u003e\n\u003cp\u003eevent是指定的事件\u003c/p\u003e\n\u003cp\u003eepoll的核心调用接口是\u003ccode\u003eepoll_wait\u003c/code\u003e：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eepoll_wait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eepfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eepoll_event\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eevents\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003emaxevents\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003etimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e它在一段时间之内等待一组文件描述符的事件，maxevent指最多监听的事件个数。\u003c/p\u003e\n\u003cp\u003e如果检测到事件，就将就绪的事件从epfd指定的事件表中复制到events指定的数组中。\u003c/p\u003e\n\u003cp\u003e和前面采用轮询机制的的select和poll相比，epoll采用回调机制，轮询的复杂度是$O(n)$，回调是$O(1)$，不过如果活动连接较多，\u003ccode\u003eepoll_wait\u003c/code\u003e的回调函数触发过于频繁，造成性能下降。所以epoll适用于连接数较多但是活动连接较少的情况。\u003c/p\u003e\n\u003ch3 id=\"三者的对比\"\u003e三者的对比\u003c/h3\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e\u003c/th\u003e\n\u003cth\u003eselect\u003c/th\u003e\n\u003cth\u003epoll\u003c/th\u003e\n\u003cth\u003eepoll\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e事件集合\u003c/td\u003e\n\u003ctd\u003e三个参数分别对应可读、可写与异常事件集合\u003c/td\u003e\n\u003ctd\u003e统一处理所有事件类型，传入一个事件集参数即可\u003c/td\u003e\n\u003ctd\u003e内核通过一个事件表管理所有事件，每个事件绑定回调函数\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e内核实现方式\u003c/td\u003e\n\u003ctd\u003e采用轮询来检测就绪事件，$O(n)$\u003c/td\u003e\n\u003ctd\u003e采用轮询来检测就绪事件，$O(n)$\u003c/td\u003e\n\u003ctd\u003e采用回调函数来检测就绪事件，$O(1)$\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e最大连接数\u003c/td\u003e\n\u003ctd\u003e1024\u003c/td\u003e\n\u003ctd\u003e不限\u003c/td\u003e\n\u003ctd\u003e不限\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n","date":1644648692,"description":"","fuzzywordcount":4900,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"4cf11b9dc522ca41d6534452f34670d3","publishdate":1644648692,"relpermalink":"/posts/linux-network-programming-3/","section":"posts","summary":"服务器模型 C/S模型 即传统的Client/Server模型，客户端通过访问服务器来获取所需的资源。 串行效率非常低下，服务器需要同时保持多个客户端的监听和提供请求","tags":["Linux","TCP/IP"],"title":"Linux网络编程（三）高性能网络编程","url":"https://blog.engine.wang/posts/linux-network-programming-3/","wordcount":4858},{"categories":"posts","content":"\u003ch2 id=\"概述\"\u003e概述\u003c/h2\u003e\n\u003cp\u003e数据链路层、网络层和传输层的协议都是在操作系统内核中完成的，实现网络的系统调用的api目前最主流的就是socket。\u003c/p\u003e\n\u003cp\u003esocket是应用层与TCP/IP协议之间的软件抽象，将复杂的TCP/IP协议隐藏在socket后面，用户只需要调用合适的socket api，socket就会组织对应的协议进行通信。\u003c/p\u003e\n\u003cp\u003e最基本的客户端-服务器网络模型：\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643894720/client-server-1.png\" alt=\"client-server-1\"\u003e\u003c/p\u003e\n\u003cp\u003e运行的单位都是进程。\u003c/p\u003e\n\u003cp\u003e一个连接可以通过客户端-服务端的ip和端口号唯一确定，被称为套接字对：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e(clientAddr:clientPort, serverAddr, serverPort)\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643894720/client-server-2.png\" alt=\"client-server-2\"\u003e\u003c/p\u003e\n\u003ch2 id=\"tcp网络\"\u003eTCP网络\u003c/h2\u003e\n\u003cp\u003e下图是客户端-服务端TCP网络的核心逻辑\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643896619/socket-1.jpg\" alt=\"socket-1\"\u003e\u003c/p\u003e\n\u003cp\u003e客户端和服务端建立TCP通信的过程：\u003c/p\u003e\n\u003cp\u003e服务端：初始化socket，bind绑定到ip和port上然后listen等待\n客户端：初始化socket，通过connect发起连接请求，与服务端通过\u003cstrong\u003eTCP三次握手\u003c/strong\u003e建立连接。\u003c/p\u003e\n\u003cp\u003e连接建立好之后，数据可以双向传输，之后通过客户端的close发起关闭连接请求。处于半关闭状态，服务器收到后也执行close，进入全关闭。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003esocket是用来建立网络连接，传输数据的唯一途径\u003c/strong\u003e，成为网络互连的标准。\u003c/p\u003e\n\u003cp\u003e可以将TCP的网络交互理解为打电话，socket是电话机，bind的过程就是把电话机连上线。listen的过程就是在家听到了铃响，accept的过程就是拿起听筒开始应答。\u003c/p\u003e\n\u003cp\u003eTCP的三次握手相当于，客户端说：你好，我是客户端。服务器说：确实是你，我是服务端。客户端说：确实是你，服务器收到了。\u003c/p\u003e\n\u003cp\u003e然后就进入了连接的过程，任意一方说话相当于write，接收到电话的相当于read，可以双向交流。\u003c/p\u003e\n\u003cp\u003e拨打电话的结束之后，挂断电话，即close。\u003c/p\u003e\n\u003ch2 id=\"udp网络\"\u003eUDP网络\u003c/h2\u003e\n\u003cp\u003eUDP面向数据报，不基于连接，不保障顺序性、可靠性、没有拥塞控制、重传机制等。在IP协议的基础上增加的部分很有限。\u003c/p\u003e\n\u003cp\u003e但是在很多不需要完全可靠和完全顺序性的场景，如DNS、多人聊天、直播等。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643899709/socket-3.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e服务端创建和绑定socket之后，客户端和服务端之间直接通过\u003ccode\u003esendto\u003c/code\u003e和\u003ccode\u003erecvfrom\u003c/code\u003e来传递数据，没有建立连接的过程。\u003c/p\u003e\n\u003ch2 id=\"c语言补充\"\u003eC语言补充\u003c/h2\u003e\n\u003cp\u003e这里只记录一些后面遇到的C语言相关的一些补充。\u003c/p\u003e\n\u003ch3 id=\"环境搭建\"\u003e环境搭建\u003c/h3\u003e\n\u003cp\u003eLinux需要安装编译环境：\u003c/p\u003e\n\u003cp\u003eUbuntu\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003esudo apt-get install gcc g++ make cmake\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eCentOS\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003esudo yum install gcc g++ make cmake\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003emac也可以，用clion的话，需要先安装Xcode command line developer tools（不需要完整的Xcode）\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"n\"\u003excode\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003eselect\u003c/span\u003e \u003cspan class=\"o\"\u003e--\u003c/span\u003e\u003cspan class=\"n\"\u003einstall\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e表明安装成功\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u0026gt; clang --version\nApple clang version 12.0.0 \u003cspan class=\"o\"\u003e(\u003c/span\u003eclang-1200.0.32.29\u003cspan class=\"o\"\u003e)\u003c/span\u003e\nTarget: x86_64-apple-darwin19.6.0\nThread model: posix\nInstalledDir: /Library/Developer/CommandLineTools/usr/bin\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e然后去clion配置好gcc（C编译器）和g++（C++编译器）的路径即可\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://resources.jetbrains.com/help/img/idea/2021.3/cl_toolchain_detectok.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"一些c语言补充的内容\"\u003e一些C语言补充的内容\u003c/h3\u003e\n\u003cp\u003eC语言中，uintx_t表示的是有x/8个字节的数据类型。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"kt\"\u003euint8_t\u003c/span\u003e\n\u003cspan class=\"kt\"\u003euint16_t\u003c/span\u003e\n\u003cspan class=\"kt\"\u003euint32_t\u003c/span\u003e\n\u003cspan class=\"kt\"\u003euint64_t\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e几个表示size的类型\n\u003ccode\u003esize_t\u003c/code\u003e就是unsigned long（64位）或者unsigned int （32位）\n\u003ccode\u003essize_t\u003c/code\u003e是long或者int，有符号\u003c/p\u003e\n\u003ch2 id=\"socket数据结构\"\u003esocket数据结构\u003c/h2\u003e\n\u003cp\u003e首先看一下socket的通用结构：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"c1\"\u003e// 描述地址类型\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003etypedef\u003c/span\u003e \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eshort\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esa_family_t\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"cm\"\u003e/* 描述通用套接字地址  */\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esa_family_t\u003c/span\u003e \u003cspan class=\"n\"\u003esa_family\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"cm\"\u003e/* 地址族.  16-bit*/\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003esa_data\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e14\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e   \u003cspan class=\"cm\"\u003e/* 具体的地址值 112-bit */\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e地址族就是说明这个socket是属于哪种类型的地址。比如IPv4、iPv6、本地地址等。\u003c/p\u003e\n\u003cp\u003e包括AF_和PF_，其中AF_是地址族，PF_是协议族，一一对应，比如ipv4的就是AF_INET和PF_INET。ipv6的就是AF_INET6和PF_INET6，本地的就是AF_LOCAL和PF_LOCAL。它们也是互相对应相等的。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"cp\"\u003e#define PF_LOCAL\t1\t\u003c/span\u003e\u003cspan class=\"cm\"\u003e/* Local to host (pipes and file-domain).  #define PF_FILE\t\tPF_LOCAL /* Another non-standard name for PF_LOCAL\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e#define PF_INET\t\t2\t/* IP protocol family.  */\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e#define PF_INET6\t10\t\u003c/span\u003e\u003cspan class=\"cm\"\u003e/* IP version 6.  */\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#define AF_LOCAL\tPF_LOCAL\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e#define AF_FILE\t\tPF_FILE\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e#define AF_INET\t\tPF_INET\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e#define AF_INET6\tPF_INET6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eIPv4套接字格式：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"c1\"\u003e// 地址为4个字节，32个bit\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 因为ipv4的ip形式最高是255.255.255.255，每一段需要8bit，1字节，总共需要4个字节，32bit\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003etypedef\u003c/span\u003e \u003cspan class=\"kt\"\u003euint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003ein_addr_t\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ein_addr\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ein_addr_t\u003c/span\u003e \u003cspan class=\"n\"\u003es_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// port是两个字节，16bit，因为2^16=65526，所以port是从0-25535\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003etypedef\u003c/span\u003e \u003cspan class=\"kt\"\u003euint16_t\u003c/span\u003e \u003cspan class=\"n\"\u003ein_port_t\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"cm\"\u003e/* 描述 IPV4 的套接字地址格式  */\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr_in\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esa_family_t\u003c/span\u003e \u003cspan class=\"n\"\u003esin_family\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"cm\"\u003e/* 地址族 16-bit */\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ein_port_t\u003c/span\u003e \u003cspan class=\"n\"\u003esin_port\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e     \u003cspan class=\"cm\"\u003e/* 端口口  16-bit*/\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ein_addr\u003c/span\u003e \u003cspan class=\"n\"\u003esin_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"cm\"\u003e/* Internet address. 32-bit */\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eIPv6的地址结构：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e9\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"cm\"\u003e/* 描述 IPV6 的套接字地址格式  */\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr_in6\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esa_family_t\u003c/span\u003e \u003cspan class=\"n\"\u003esin6_family\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"cm\"\u003e/*地址族 16-bit */\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ein_port_t\u003c/span\u003e \u003cspan class=\"n\"\u003esin6_port\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"cm\"\u003e/* 传输端口号 # 16-bit */\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003euint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003esin6_flowinfo\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"cm\"\u003e/* IPv6 流控信息 32-bit 先不管*/\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ein6_addr\u003c/span\u003e \u003cspan class=\"n\"\u003esin6_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"cm\"\u003e/* IPv6 地址 从32位升级到128位，提升非常巨大 128-bit */\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003euint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003esin6_scope_id\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"cm\"\u003e/* IPv6 域 ID 32-bit  先不管*/\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e除了英特网套接字外，还有本地套接字\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"cm\"\u003e/* 描述本地套接字的￥地址格式  */\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr_un\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eshort\u003c/span\u003e \u003cspan class=\"n\"\u003esun_family\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"cm\"\u003e/* 固定为 AF_LOCAL */\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003esun_path\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e108\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e   \u003cspan class=\"cm\"\u003e/* 路径名 */\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e有一些保留端口，比如常见的ftp的21端口，ssh的22端口，http的80端口，一般来说大于5000的端口可以自己用。\u003c/p\u003e\n\u003cp\u003e下图是各个地址族的结构\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643894800/socket-2.png\" alt=\"socket-2\"\u003e\u003c/p\u003e\n\u003ch2 id=\"转换函数\"\u003e转换函数\u003c/h2\u003e\n\u003ch3 id=\"ip地址转换\"\u003eIP地址转换\u003c/h3\u003e\n\u003cp\u003e平常习惯使用十进制来描述ipv4的ip，用十六进制描述ipv6的ip，然而实际计算机都要转换为二进制。如果输出日志，为了可理解性又需要转换为合适的十进制或者十六进制。\u003c/p\u003e\n\u003cp\u003eLinux内置了二者互相转换的函数：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003einet_aton\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ecp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ein_addr\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003einp\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nf\"\u003einet_ntoa\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ein_addr\u003c/span\u003e \u003cspan class=\"n\"\u003ein\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003ccode\u003einet_aton\u003c/code\u003e可以将点分十进制字符串表示的ipv4 ip转换为网络字节序表示的\u003ccode\u003ein_addr\u003c/code\u003e结构\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003einet_ntoa\u003c/code\u003e则相反，将网络字节序表示的\u003ccode\u003ein_addr\u003c/code\u003e结构转换为点分十进制字符串表示的ipv4 ip\u003c/p\u003e\n\u003cp\u003e一对更好的函数是\u003ccode\u003einet_pton\u003c/code\u003e和\u003ccode\u003einet_ntop\u003c/code\u003e，这个对于ipv4和ipv6通用。以inet_pton为例：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"cp\"\u003e# 将string类型的十进制字符串表示的ip写成二进制的网络字节序作为server_address的sin_addr\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003einet_pton\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAF_INET\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eip\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eserver_address\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esin_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"主机地址到网络地址\"\u003e主机地址到网络地址\u003c/h3\u003e\n\u003cp\u003e计算机硬件有两种存储方式大端字节序和小端字节序，比如数值\u003ccode\u003e0x1234\u003c/code\u003e，用大端字节序表示符合人类习惯，就是\u003ccode\u003e0x1234\u003c/code\u003e，高位是\u003ccode\u003e0x12\u003c/code\u003e，低位是\u003ccode\u003e0x34\u003c/code\u003e，而用小端字节序的话，各个字节的顺序就要反过来，高位是\u003ccode\u003e0x34\u003c/code\u003e，低位是\u003ccode\u003e0x12\u003c/code\u003e。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1644291229/big-endian-little-endian-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e因为计算机电路先处理低位字节的效率比较高，所以计算机内部处理都是用的小端字节序，但是除了内部处理，其他场合比如网络传输、文件存储，还是使用的人类更容易理解的大端字节序。\u003c/p\u003e\n\u003cp\u003e所以主机字节序采用小端字节序和网络字节序采用大端字节序，需要进行一个转换。\u003c/p\u003e\n\u003cp\u003e转换函数如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;arpa/inet.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 16/32位的主机字节序转换为网络字节序\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 其实就是字节的高低位互换\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003euint16_t\u003c/span\u003e \u003cspan class=\"n\"\u003ehtons\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint16_t\u003c/span\u003e \u003cspan class=\"n\"\u003ehostlong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"kt\"\u003euint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003ehtonl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003ehostlong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 16/32位的网络字节序转换为主机字节序\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003euint16_t\u003c/span\u003e \u003cspan class=\"n\"\u003entohs\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint16_t\u003c/span\u003e \u003cspan class=\"n\"\u003ehostlong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"kt\"\u003euint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003entohs\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint32_t\u003c/span\u003e \u003cspan class=\"n\"\u003ehostlong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"socket编程api\"\u003esocket编程api\u003c/h2\u003e\n\u003ch3 id=\"socket的创建\"\u003esocket的创建\u003c/h3\u003e\n\u003cp\u003e通过\u003ccode\u003esocket()\u003c/code\u003e函数创建一个socket，具体参数如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esocket\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003edomain\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eprotocol\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003edomain是地址族，指PF_INET、PF_INET6、PF_LOCAL这种\ntype指的是类型，比如\u003ccode\u003eSOCK_STREAM\u003c/code\u003e表示字节流，对应TCP，\u003ccode\u003eSOCK_DGRAM\u003c/code\u003e表示数据报，对应UDP，\u003ccode\u003eSOCK_RAW\u003c/code\u003e表示原始套接字\n第三个protocol现在已经废弃，默认填0即可，一般只需要前两个参数。\u003c/p\u003e\n\u003cp\u003e这样要创建一个ipv4的TCP socket只需要：\n\u003ccode\u003esocket(PF_INET, SOCK_STREAM, 0)\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"socket绑定bind\"\u003esocket绑定：bind\u003c/h3\u003e\n\u003cp\u003ebind函数的作用是将套接字和套接字地址绑定，套接字只知道自己的具体结构类型等，并不知道具体的ip和地址。\u003c/p\u003e\n\u003cp\u003ebind函数的定义如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"n\"\u003ebind\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eaddr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esocklen_t\u003c/span\u003e \u003cspan class=\"n\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e第一个参数是套接字，第二个参数是sockaddr结构的套接字地址，第三个参数是地址长度。\u003c/p\u003e\n\u003cp\u003e需要将本地套接字格式转换为通用套接字格式。比如\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr_in\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003ebind\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esock\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e比如把ipv4的sockaddr_in结构\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr_in\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__SOCKADDR_COMMON\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esin_\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ein_port_t\u003c/span\u003e \u003cspan class=\"n\"\u003esin_port\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\t\t\t\u003cspan class=\"cm\"\u003e/* Port number.  */\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ein_addr\u003c/span\u003e \u003cspan class=\"n\"\u003esin_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\t\t\u003cspan class=\"cm\"\u003e/* Internet address.  */\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 占位符，无作用\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003esin_zero\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"k\"\u003esizeof\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\t\t   \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003e__SOCKADDR_COMMON_SIZE\u003c/span\u003e\n\t\t\t   \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ein_port_t\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\t\t   \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ein_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e)];\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e转换为通用的sockaddr结构\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__SOCKADDR_COMMON\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esa_\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\t\u003cspan class=\"cm\"\u003e/* Common data: address family and length.  */\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003esa_data\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e14\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\t\t\u003cspan class=\"cm\"\u003e/* Address data.  */\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e地址可以设置为本机的地址，但是假如说程序部署到本机，地址是本机的局域网ip 192.168.x.x，之后假如程序部署到其他机子上，需要修改为公网ip，所以需要一种通配地址的机制，来让所有目标地址是本机的请求都接收到，ipv4通过\u003ccode\u003eINADDR_ANY\u003c/code\u003e，ipv6通过\u003ccode\u003eIN6ADDR_ANY\u003c/code\u003e来设置。\u003c/p\u003e\n\u003ch3 id=\"socket监听listen\"\u003esocket监听：listen\u003c/h3\u003e\n\u003cp\u003ebind函数让套接字和地址关联，但是还需要将套接字进行监听，通过调用listen让服务处于可接听的状态。\u003c/p\u003e\n\u003cp\u003e初始化的套接字是主动套接字，可以主动发起请求，而通过listen函数之后会变成被动套接字，用来等待客户的请求。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003elisten(int socket, int backlog)\u003c/code\u003e\n第一个参数是套接字，第二个参数是未完成连接队列的大小，决定了可以接收的并发数目\u003c/p\u003e\n\u003ch3 id=\"接受连接accept\"\u003e接受连接：accept\u003c/h3\u003e\n\u003cp\u003e服务端的操作系统内核监听到了客户端的请求，类比于接电话就是此时听到了铃响，通过accept来接电话。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eaccept\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003elistensockfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ecliaddr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esocklen_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eaddrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e第一个参数是套接字，第二个参数是连接的客户端的socket地址，第三个参数是地址长度，第二和第三个参数都是传入空然后指针改变从而获取，accept会返回一个新的已连接套接字。因为不可能一个服务端只服务一个客户端。\u003c/p\u003e\n\u003ch3 id=\"发起连接connect\"\u003e发起连接：connect\u003c/h3\u003e\n\u003cp\u003e前面的是服务端的连接建立的方法，客户端的创建socket一样，不过之后要通过connect来主动连接服务端。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003econnect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esockfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eservaddr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esocklen_t\u003c/span\u003e \u003cspan class=\"n\"\u003eaddrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e第一个参数是套接字，第二个参数是指向套接字地址结构的指针和结构的大小。套接字地址结构需要包含服务端的ip和端口。\u003c/p\u003e\n\u003cp\u003e客户端不需要调用bind，在创建完socket后就可以直接调用connect，内核会随机分配一个端口给这次连接。\u003c/p\u003e\n\u003ch3 id=\"关闭连接close-shutdown\"\u003e关闭连接：close, shutdown\u003c/h3\u003e\n\u003cp\u003e关闭一个连接，实际上就是关闭连接对应的socket。\u003c/p\u003e\n\u003cp\u003e可以通过\u003ccode\u003eclose\u003c/code\u003e来关闭连接：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e但是close不是直接关闭，实际上只是把fd的引用计数-1，如果要完全关闭的话需要在子进程和父进程都调用close。\u003c/p\u003e\n\u003cp\u003e立即终止连接则应该使用\u003ccode\u003eshutdown\u003c/code\u003e：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eshutdown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esockfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ehowto\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003ccode\u003ehowto\u003c/code\u003e包括三种关闭方式：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eSHUT_RD：关闭读\u003c/li\u003e\n\u003cli\u003eSHUT_WR：关闭写\u003c/li\u003e\n\u003cli\u003eSHUT_RDWR：关闭读写\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"tcp的数据发送和接收write-send-sendmsg-read\"\u003eTCP的数据发送和接收：write, send, sendmsg, read\u003c/h3\u003e\n\u003cp\u003e建立好连接后，接下来就是发送数据。常见的发送数据的函数有write, send, sendmsg\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"n\"\u003essize_t\u003c/span\u003e \u003cspan class=\"n\"\u003ewrite\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esocketfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003essize_t\u003c/span\u003e \u003cspan class=\"n\"\u003esend\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esocketfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eflags\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"n\"\u003essize_t\u003c/span\u003e \u003cspan class=\"n\"\u003esendmsg\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esockfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003emsghdr\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003emsg\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eflags\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003ewrite就是普通的写文件，因为套接字也是文件\n如果想发送袋外数据（一种基于TCP的紧急数据），可以用带flag的send\n如果想指定多重缓冲区就需要用sendmsg，通过结构体msghdr传递数据\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"n\"\u003essize_t\u003c/span\u003e \u003cspan class=\"n\"\u003eread\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esocketfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eread将会从socket中读取最多size个字节，然后将结果存储到buffer中。\u003c/p\u003e\n\u003ch3 id=\"udp的数据发送和接收sendto-recvfrom\"\u003eUDP的数据发送和接收：sendto, recvfrom\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"n\"\u003essize_t\u003c/span\u003e \u003cspan class=\"nf\"\u003erecvfrom\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esockfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003enbytes\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eflags\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n　　　　　　　　　　\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003efrom\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esocklen_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eaddrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003essize_t\u003c/span\u003e \u003cspan class=\"nf\"\u003esendto\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esockfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ebuff\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003enbytes\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eflags\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eto\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esocklen_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eaddrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e由于UDP不会保存上下文的信息，所以还额外传递对端的地址端口等信息。TCP在accept阶段就拿到了对端的信息。UDP的每次接收和发送都是独立的上下文。\u003c/p\u003e\n","date":1644148852,"description":"","fuzzywordcount":4300,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"cb10f776a8d02e75461bb7c908633b2f","publishdate":1644148852,"relpermalink":"/posts/linux-network-programming-2/","section":"posts","summary":"概述 数据链路层、网络层和传输层的协议都是在操作系统内核中完成的，实现网络的系统调用的api目前最主流的就是socket。 socket是应用层与TCP/IP协议之","tags":["Linux","TCP/IP"],"title":"Linux网络编程（二） socket网络编程基础","url":"https://blog.engine.wang/posts/linux-network-programming-2/","wordcount":4260},{"categories":"posts","content":"\u003ch2 id=\"重温计算机网络\"\u003e重温计算机网络\u003c/h2\u003e\n\u003cp\u003eTCP/IP协议是目前互联网的主流协议簇，早在计算机网络中我们就已经学习过大部分的内容，现在我们从协议的角度出发再次重温计算机网络的内容，作为后续内容的基础。\u003c/p\u003e\n\u003cp\u003e在物理传输媒介的基础上的四层网络模型，自底向上分别是数据链路层、网络层、传输层、应用层，各层包含的协议如图所示：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643112994/TCP-IP-1.png\" alt=\"tcp-ip-1\"\u003e\u003c/p\u003e\n\u003cp\u003e实体通信用实线表示，逻辑通信用虚线表示。链路层封装了物理传输的细节，网络层封装了路由逐条通信的细节，传输层开始就是端到端的协议\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643164972/TCP-IP-2.png\" alt=\"tcp-ip-2\"\u003e\u003c/p\u003e\n\u003cp\u003e具体的内容在前面的计算机网络基础中已经做了详细的介绍，这里只讨论各层的一部分重要协议。\u003c/p\u003e\n\u003cp\u003eARP协议：链路层协议，完成IP地址到MAC地址的转换\nIP协议：网络层协议，完成IP数据报的投递，确定通信路径\nICMP协议：网络层协议，IP协议的补充，用于检测网络连接\nTCP协议：传输层协议，提供可靠的、面向连接的基于流的服务\nUDP协议：传输层协议，提供不可靠的、无连接的基于数据报的服务\nDNS协议：应用层协议，完成域名到IP地址的转换\u003c/p\u003e\n\u003ch2 id=\"封装与分用\"\u003e封装与分用\u003c/h2\u003e\n\u003cp\u003e封装指的是上层协议的数据沿协议栈往下传递，每经过一个协议栈就加上头部信息，最终合成以太网帧或令牌环帧在物理层上传递：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643166755/TCP-IP-3.png\" alt=\"tcp-ip-2\"\u003e\u003c/p\u003e\n\u003cp\u003e分用指的是帧到了目的地后的从底向上传递的过程，每个协议栈取出自己的头部，将信息往上传递。头部包含了具体的类型参数，根据头部信息递交给不同的上层。\u003c/p\u003e\n\u003cp\u003e比如以太帧用2字节的类型字段来区分IP或ARP\nIP数据报根据头部的16位协议编码区分TCP、UDP和ICMP\nTCP和UDP通过头部的端口号来区分具体的应用\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643167303/TCP-IP-4.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e对于顶层应用而言，好像封装和分用没有发生过。\u003c/p\u003e\n\u003ch2 id=\"arp协议\"\u003eARP协议\u003c/h2\u003e\n\u003cp\u003eARP实现的是网络层IP地址到物理网卡MAC地址的转换，原理是主机向网络广播一个ARP请求，包含目标主机的IP地址，只有被请求到的目标机器才会返回一个ARP应答，包含其物理地址。\u003c/p\u003e\n\u003cp\u003e具体的请求和应答的报文格式就不详述，这里ARP会维护一个高速缓存，包含经常访问的机器的IP地址到MAC地址的映射，从而提高效率，避免重复请求。\u003c/p\u003e\n\u003cp\u003eUnix（Linux、macOS）可以通过\u003ccode\u003earp\u003c/code\u003e相关命令来管理arp缓存。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003earp -a\u003c/code\u003e：查看所有arp缓存，左边括号内为IP地址，右边为MAC地址。\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e? (169.254.72.54) at 60:6d:c7:c6:4c:e5 on en0 [ethernet]\n? (169.254.100.233) at 94:e9:79:ff:aa:eb on en0 [ethernet]\nfile-center.lan (192.168.50.1) at f8:32:e4:84:16:60 on en0 ifscope [ethernet]\n? (192.168.50.43) at 3e:cc:9e:13:e6:a4 on en0 ifscope [ethernet]\n...\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003ccode\u003earp -d \u0026lt;ip\u0026gt;\u003c/code\u003e：删除某个ip的arp缓存\n\u003ccode\u003earp -s \u0026lt;ip\u0026gt; \u0026lt;mac\u0026gt;\u003c/code\u003e：添加某个ip到mac的arp缓存\u003c/p\u003e\n\u003ch2 id=\"dns协议\"\u003eDNS协议\u003c/h2\u003e\n\u003cp\u003eDNS协议将域名转换为IP地址，它是一套分布式的域名服务系统，每个DNS服务器都存放大量的域名-IP地址映射，且动态更新。\u003c/p\u003e\n\u003cp\u003eUnix下在\u003ccode\u003e/etc/resolv.conf\u003c/code\u003e保存了DNS服务器的地址，该文件是随着网络连接状态自动更新的。\u003c/p\u003e\n\u003cp\u003e比如连接wifi后，为\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003esearch lan\nnameserver 192.168.50.1\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e这里\u003ccode\u003e192.168.50.1\u003c/code\u003e是路由器的ip，即依靠局域网的路由器搜索DNS\u003c/p\u003e\n\u003cp\u003e而连接了热点之后就立刻变为了\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003enameserver 2409:8938:1610:7763::18\nnameserver 192.168.109.2\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e断网之后该文件内容变为空。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ehost -t A \u0026lt;host\u0026gt;\u003c/code\u003e：查询某个域名的IP地址，如\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003ewww.baidu.com is an alias for www.a.shifen.com.\nwww.a.shifen.com has address 36.152.44.96\nwww.a.shifen.com has address 36.152.44.95\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"ip协议\"\u003eIP协议\u003c/h2\u003e\n\u003cp\u003eIP协议是网络层协议，是TCP/UDP的基础，它为上层提供无连接、不可靠、无状态的服务。\u003c/p\u003e\n\u003ch3 id=\"ipv4的ip头部与分片传输\"\u003eipv4的IP头部与分片传输\u003c/h3\u003e\n\u003cp\u003eipv4的IP头部：\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643256162/TCP-IP-5.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eIP的长度超过mtu时会被分片传输，然后在接收端整合，以太帧的mtu通常是1500字节，去掉20字节的头部，还有1480字节可以放数据，数据如果超过1480字节则必须分片传输。\u003c/p\u003e\n\u003cp\u003e比如1481字节的ICMP报文，需要分两片来传输：\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643256162/TCP-IP-6.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"ip路由机制\"\u003eIP路由机制\u003c/h3\u003e\n\u003cp\u003eIP协议的核心是路由，即从源机器如何通过网络转发给目标机器。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643261497/TCP-IP-7.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e接受到了来自链路层的IP数据报后，先通过CRC校验，然后判断是否是发给本机网络或者广播的数据报，如果是的话就依据具体的头部信息传递给TCP/UDP/ICMP模块。如果不是的话就转发给下一跳，具体转发方式是路由协议的内容，比如RIP、OSPF算法等，这个在之前的计算机网络中已经学过了，就不在此细说了。\u003c/p\u003e\n\u003ch2 id=\"tcp协议\"\u003eTCP协议\u003c/h2\u003e\n\u003cp\u003eTCP的特征：一对一、全双工、先建立连接、字节流传输、可靠传输\u003c/p\u003e\n\u003cp\u003e其他几个很简单，提一下字节流传输，TCP使用字节流传输，而UDP使用数据报传输，字节流的特点就是：发送端执行的写操作次数和接收端执行的读操作次数没有任何数量关系，因为发送缓冲区和接受缓冲区的存在。\u003c/p\u003e\n\u003ch3 id=\"发送缓冲区与接收缓冲区\"\u003e发送缓冲区与接收缓冲区\u003c/h3\u003e\n\u003cp\u003eTCP三次握手建立之后，内核会为每一个连接建立配套的基础设施，其中就包括发送缓冲区。\u003c/p\u003e\n\u003cp\u003e发送缓冲区的大小可以通过套接字的选项来调整，假如客户端调用write，实际上是将数据从应用程序拷贝到内核中的发送缓冲区中，而不是通过socket。\u003c/p\u003e\n\u003cp\u003e如果发送缓冲区足够大，那么write调用成功返回写入的字节数。\n如果数据还没发送完，或者缓冲区不够大，内核并不会返回或者报错，而是被阻塞。直到发送完。\u003c/p\u003e\n\u003cp\u003e缓冲区类似一条流水线，每次都能不断将数据封装打包为TCP的MSS和IP的MTU包然后从数据链路层打包出去，缓冲区就会空一部分，可以继续搬一部分数据到缓冲区，所以最终总能搬完所有的数据。然后write阻塞就会调用返回，write返回的时候，数据并不是已经发送过去了，而是还有一部分会在缓冲区里，之后会发过去。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643272895/TCP-IP-9.png\" alt=\"TCP-IP-9\"\u003e\u003c/p\u003e\n\u003cp\u003e缓冲区也是TCP字节流传输和UDP数据报传输的一个区别：\u003c/p\u003e\n\u003cp\u003eTCP字节流传输：\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643272895/TCP-IP-10.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eUDP数据报传输：\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643272895/TCP-IP-11.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"tcp的建立三次握手\"\u003eTCP的建立：三次握手\u003c/h3\u003e\n\u003cp\u003e著名的TCP三次握手：\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643272895/TCP-IP-8.png\" alt=\"tcp三次握手-1\"\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e客户端协议栈向服务端发送SYN包，并表明当前发送序列号为j，客户端进入SYN_SENT状态\u003c/li\u003e\n\u003cli\u003e服务端的协议栈收到了这个包之后，对客户端的这个SYN进行应答，值为j+1，同时服务器也发送一个SYN包，内容是k，服务器进入SYNC_RCVD状态\u003c/li\u003e\n\u003cli\u003e客户端协议栈收到了ACK之后，应用程序的connect调用返回，客户端到服务端的单向通信建立成功。并进入ESTABLISH状态，同时对服务端进行ACK应答，应答值为k+1\u003c/li\u003e\n\u003cli\u003e应答包到达服务器，服务器协议端的accept阻塞调用返回，服务器到客户端的单向通信也建立成功。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003e思考一下为什么是三次。\n我的理解是，如果A到B的传输连接要成功，至少需要两步，A尝试传一个信息到B，B再返回一个应答。这样就说明了A到B的单向没有问题。反过来也一样。正常来说应该需要四次握手，不过在服务端应答客户端的时候服务端顺便发送请求包，这样节省了一步。所以说最少是三次握手，两次必然不能保证一定连接成功，四次则多浪费了一次。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"tcp的关闭四次挥手与time_wait\"\u003eTCP的关闭：四次挥手与TIME_WAIT\u003c/h3\u003e\n\u003cp\u003eTCP是全双工的，所以存在一种半关闭状态，也就是A可以接受B发送来的数据，但是A不再发送数据给B，也就是说一端可以告诉对方自己发送的数据已经发完了，但仍然可以接受对方发送的数据，进入半关闭状态，如果对方也发送完了，就进入关闭状态。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643272895/TCP-IP-12.png\" alt=\"time_wait-1\"\u003e\u003c/p\u003e\n\u003cp\u003e一个完整的建立和关闭的过程：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643549232/TCP-IP-14.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"time_wait\"\u003eTIME_WAIT\u003c/h3\u003e\n\u003cp\u003e这里提一下TIME_WAIT状态。假设是主机一发送FIN到主机二，在收到FIN n的时候，主机一会进入TIME_WAIT的状态，停留时间是固定的。Linux下是两个最长份节生命周期的时间（即2MSL）。只有发起连接终止的一方会进入TIME_WAIT状态。\u003c/p\u003e\n\u003cp\u003e为什么有TIME_WAIT？因为TCP要考虑各种错误情况，假如最后一次挥手客户端的ACK没有传到服务端，那么服务端之后会重发FIN报文。此时如果客户端没有维护TIME_WAIT而是直接关闭，就会失去上下文。坚持2MSL，使得这次连接所有的迟到的报文来得及被丢弃\u003c/p\u003e\n\u003cp\u003e但是TIME_WAIT过多，会导致端口资源被占用，有时候可能由于TIME_WAIT导致性能下降。\u003c/p\u003e\n\u003ch3 id=\"tcp状态转移\"\u003eTCP状态转移\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643273832/TCP-IP-13.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e虚线为服务端，粗实线为客户端。\u003c/p\u003e\n\u003ch3 id=\"tcp超时重传策略\"\u003eTCP超时重传策略\u003c/h3\u003e\n\u003cp\u003e每个TCP报文都维护了一个重传定时器，如果超过时间没有收到对方的应答，发送方就会重传TCP报文并reset定时器。\u003c/p\u003e\n\u003cp\u003e一般每次重传都比之前的时间间隔更长（比如是上一次的两倍），并且设置最多重传次数，超过这个次数就放弃。\u003c/p\u003e\n\u003ch3 id=\"tcp拥塞控制\"\u003eTCP拥塞控制\u003c/h3\u003e\n\u003cp\u003e由于链路层的承载量有限，需要进行控制。\u003c/p\u003e\n\u003cp\u003eSWND（Send WiNDow，发送窗口）：指的是发送端向网络一次性发送的数据量。\u003c/p\u003e\n\u003cp\u003e如果RWND过小，则延迟会比较大。如果RWND过大，则容易网络拥塞。\u003c/p\u003e\n\u003cp\u003eRWND（Receive WiNDow，接收窗口）：指的是接收端一次性能接收的数据量。\u003c/p\u003e\n\u003cp\u003eCWND（Congestion WiNDow，拥塞窗口）：不造成拥塞的最大数据量\u003c/p\u003e\n\u003cp\u003e实际的 $\\text{SWND} = \\min(\\text{RWND}, \\text{CWND})$\u003c/p\u003e\n\u003cp\u003e启动阶段包括以下两种算法：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e慢启动\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e设置了一个慢启动门限ssthresh，最开始启动的时候CWND设置一个较小的值（2-4个SMSS），然后慢慢按照指数方式增大CWND的值，直到超过这个门限，然后进入拥塞避免控制。\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e拥塞避免\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e每经过一个轮次，线性增加其大小而不是加倍，让其缓慢增大，出现一次超时后（发生拥塞），就让慢开始门限等于当前cwnd的一半，cwnd重新设为1\u003c/p\u003e\n\u003cp\u003ecwnd \u0026gt; ssthresh: 慢启动\ncwnd \u0026lt; ssthresh: 拥塞避免\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643557367/TCP-IP-15.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e拥塞处理包括以下两种算法：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e快重传\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e当发送方连续收到三个重复的ACK报文时，直接重传对方尚未收到的报文段，而不必等待那个报文段设置的重传计时器超时。\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e快恢复\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e快恢复前面和避免算法一样，不同之处是它把cwnd的值设置为慢开始门限ssthresh改变后的数值，然后开始执行拥塞避免算法\u003c/p\u003e\n\u003ch2 id=\"代理服务器\"\u003e代理服务器\u003c/h2\u003e\n\u003cp\u003e客户机和目标服务器之间通常需要一些中转服务器进行代理中转访问。\u003c/p\u003e\n\u003ch3 id=\"正向代理\"\u003e正向代理\u003c/h3\u003e\n\u003cp\u003e代理服务器的信息需要由客户端设置，每次请求都发送到代理服务器上，然后由代理服务器请求目标资源。\n目标服务器并不清楚具体的客户端。\n比如科学上网经典的shadowsocks就是这种方式。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643610218/TCP-IP-17.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"反向代理\"\u003e反向代理\u003c/h3\u003e\n\u003cp\u003e反向代理由服务端设置，代理服务器接收客户端的连接，然后转发给目标服务器，获得结果后返回给客户端，对外表现就像是目标服务器一样。\n客户端并不清楚具体的服务器。很多大型网站都使用反向代理，用户访问该网站，会访问相同地域的反向代理服务器，从而节约时间。以及做负载均衡的nginx、CDN等等。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643559177/TCP-IP-16.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"http通信\"\u003eHTTP通信\u003c/h2\u003e\n\u003ch3 id=\"http请求\"\u003eHTTP请求\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643611443/TCP-IP-18.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"tcp应答\"\u003eTCP应答\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643698156/HTTP%E7%8A%B6%E6%80%81%E7%A0%81.png\" alt=\"HTTP状态码\"\u003e\u003c/p\u003e\n","date":1643697853,"description":"","fuzzywordcount":4000,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"63fe9f3dcd129091475c5e4d3bd0e0fa","publishdate":1643697853,"relpermalink":"/posts/linux-network-programming-1/","section":"posts","summary":"重温计算机网络 TCP/IP协议是目前互联网的主流协议簇，早在计算机网络中我们就已经学习过大部分的内容，现在我们从协议的角度出发再次重温计算机网络的内容，作为后续","tags":["Linux","TCP/IP"],"title":"Linux网络编程（一） 从TCP/IP协议开始","url":"https://blog.engine.wang/posts/linux-network-programming-1/","wordcount":3961},{"categories":"posts","content":"\u003ch2 id=\"protobuf\"\u003eprotobuf\u003c/h2\u003e\n\u003cp\u003e是Protocol Buffers的简称，由Google开源，是一种轻便高效的结构化数据存储语言，定位是类似xml、json这样的数据描述语言。protobuf可以跨语言和跨平台。\u003c/p\u003e\n\u003cp\u003e官方页面：https://developers.google.com/protocol-buffers\u003c/p\u003e\n\u003cp\u003e对等的： dubbo、rmi、hessian、messagepack等协议\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://s2.loli.net/2023/01/31/xFMfsWeLJPvlhpB.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"protobuf基础\"\u003eprotobuf基础\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://developers.google.com/protocol-buffers/docs/proto3\"\u003ehttps://developers.google.com/protocol-buffers/docs/proto3\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e目前都使用proto3版本，下面讲解如何编写proto文件来定义我们的结构。\u003c/p\u003e\n\u003cp\u003e注释还是\u003ccode\u003e//\u003c/code\u003e和\u003ccode\u003e/**/\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"nv\"\u003esyntax\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;proto3\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\npackage proto\u003cspan class=\"p\"\u003e;\u003c/span\u003e\noption \u003cspan class=\"nv\"\u003ego_package\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\nservice HelloService \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  rpc Hello\u003cspan class=\"o\"\u003e(\u003c/span\u003eHelloRequest\u003cspan class=\"o\"\u003e)\u003c/span\u003e returns \u003cspan class=\"o\"\u003e(\u003c/span\u003eHelloResponse\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{}\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\nmessage HelloRequest \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  string \u003cspan class=\"nv\"\u003erequest\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e 1\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\nmessage HelloResponse \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  string \u003cspan class=\"nv\"\u003eresponse\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e 1\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e第一行指明版本，目前是第三版。\u003c/p\u003e\n\u003cp\u003e后面通过service定义一个服务，通过message关键字定义了一个包含一个或多个Feild的结构体，message定义一个消息格式，每个字段都有一个唯一的数值标签。\u003c/p\u003e\n\u003ch4 id=\"通用字段类型\"\u003e通用字段类型\u003c/h4\u003e\n\u003cp\u003e\u003ca href=\"https://developers.google.com/protocol-buffers/docs/proto3#scalar\"\u003ehttps://developers.google.com/protocol-buffers/docs/proto3#scalar\u003c/a\u003e\u003c/p\u003e\n\u003ch4 id=\"字段修饰符\"\u003e字段修饰符\u003c/h4\u003e\n\u003cp\u003esingular表示有0或1个，通常不写\nrepeated表示字段可以包含0-N个元素\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"nx\"\u003emessage\u003c/span\u003e \u003cspan class=\"nx\"\u003eWorld\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nx\"\u003ename\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nx\"\u003emessage\u003c/span\u003e \u003cspan class=\"nx\"\u003eHelloRequest\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003erepeated\u003c/span\u003e \u003cspan class=\"nx\"\u003eWorld\u003c/span\u003e \u003cspan class=\"nx\"\u003eworlds\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e注意这里的Field包含不同的id\u003c/p\u003e\n\u003ch4 id=\"嵌套类型\"\u003e嵌套类型\u003c/h4\u003e\n\u003cp\u003e可以在message中嵌套其他message结构体\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"nx\"\u003emessage\u003c/span\u003e \u003cspan class=\"nx\"\u003eA\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nx\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"nx\"\u003emessage\u003c/span\u003e \u003cspan class=\"nx\"\u003eB\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003eA\u003c/span\u003e \u003cspan class=\"nx\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch4 id=\"oneof\"\u003eoneof\u003c/h4\u003e\n\u003cp\u003e希望消息体包含多个字段，但同时只允许一个字段\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"nx\"\u003emessage\u003c/span\u003e \u003cspan class=\"nx\"\u003eA\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003eoneof\u003c/span\u003e \u003cspan class=\"nx\"\u003ename\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nx\"\u003enick_name\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"nx\"\u003etrue_name\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch4 id=\"map\"\u003emap\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"nx\"\u003emessage\u003c/span\u003e \u003cspan class=\"nx\"\u003eA\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"kd\"\u003emap\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nx\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch4 id=\"option-go_package\"\u003eoption go_package\u003c/h4\u003e\n\u003cp\u003e比如说\u003ccode\u003eoption go_package = \u0026quot;./proto;user\u0026quot;;\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e是什么意义，其中分号之前的表示生成的文件放在什么目录下面\u003c/p\u003e\n\u003ch3 id=\"生成pbgo\"\u003e生成pb.go\u003c/h3\u003e\n\u003cp\u003e下面简单讲解一下在Golang中如何使用Protocol Buffer\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003eprotoc --go_out\u003cspan class=\"o\"\u003e=\u003c/span\u003e./ --micro_out\u003cspan class=\"o\"\u003e=\u003c/span\u003e./ ./*.proto\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"生成的pbgo内容解读\"\u003e生成的pb.go内容解读\u003c/h3\u003e\n\u003cp\u003e这里先从一个最简单的讲起，proto文件如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"nv\"\u003esyntax\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;proto3\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\npackage proto\u003cspan class=\"p\"\u003e;\u003c/span\u003e\noption \u003cspan class=\"nv\"\u003ego_package\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;/\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\nservice HelloService \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  rpc Hello\u003cspan class=\"o\"\u003e(\u003c/span\u003eHelloRequest\u003cspan class=\"o\"\u003e)\u003c/span\u003e returns \u003cspan class=\"o\"\u003e(\u003c/span\u003eHelloResponse\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{}\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\nmessage HelloRequest \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  string \u003cspan class=\"nv\"\u003erequest\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e 1\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\nmessage HelloResponse \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  string \u003cspan class=\"nv\"\u003eresponse\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e 1\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e首先先会为在\u003ccode\u003eproto\u003c/code\u003e中定义的mesage结构生成结构体，并增加三个都有的字段：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eHelloRequest\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003estate\u003c/span\u003e         \u003cspan class=\"nx\"\u003eprotoimpl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMessageState\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003esizeCache\u003c/span\u003e     \u003cspan class=\"nx\"\u003eprotoimpl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSizeCache\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003eunknownFields\u003c/span\u003e \u003cspan class=\"nx\"\u003eprotoimpl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eUnknownFields\u003c/span\u003e\n\n\t\u003cspan class=\"nx\"\u003eRequest\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"s\"\u003e`protobuf:\u0026#34;bytes,1,opt,name=request,proto3\u0026#34; json:\u0026#34;request,omitempty\u0026#34;`\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e对于rpc方法，生成服务端和客户端的对应方法，首先是服务端接口：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"c1\"\u003e// HelloService的Server端接口，包含一个在proto里定义的Hello方法\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 这里参数符合grpc，分别是context和*req，返回的是*rep和err\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eHelloServiceServer\u003c/span\u003e \u003cspan class=\"kd\"\u003einterface\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nf\"\u003eHello\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eHelloRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eHelloResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e服务端注册：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003eRegisterHelloServiceServer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003es\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003egrpc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eServer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003esrv\u003c/span\u003e \u003cspan class=\"nx\"\u003eHelloServiceServer\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003es\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRegisterService\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003e_HelloService_serviceDesc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003esrv\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e然后是客户端接口以及方法的实现：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"c1\"\u003e// 这里不一样的是多了一个option参数，这里可以传递一些选项\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eHelloServiceClient\u003c/span\u003e \u003cspan class=\"kd\"\u003einterface\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nf\"\u003eHello\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ectx\u003c/span\u003e \u003cspan class=\"nx\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ein\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eHelloRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eopts\u003c/span\u003e \u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"nx\"\u003egrpc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eCallOption\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eHelloResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003ehelloServiceClient\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eHello\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ectx\u003c/span\u003e \u003cspan class=\"nx\"\u003econtext\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ein\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eHelloRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eopts\u003c/span\u003e \u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"nx\"\u003egrpc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eCallOption\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eHelloResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003eout\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eHelloResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ecc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInvoke\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;/proto.HelloService/Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ein\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eopts\u003c/span\u003e\u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e参考：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"https://developers.google.com/protocol-buffers/docs/gotutorial\"\u003ehttps://developers.google.com/protocol-buffers/docs/gotutorial\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","date":1643174769,"description":"","fuzzywordcount":1100,"kind":"page","lang":"zh","lastmod":1675142918,"objectID":"f6f4e2957e24f1ade446fc68decb2c30","publishdate":1643174769,"relpermalink":"/posts/protobuf-basic/","section":"posts","summary":"protobuf 是Protocol Buffers的简称，由Google开源，是一种轻便高效的结构化数据存储语言，定位是类似xml、json这样的数据描述语言。protobuf","tags":["Protobuf","RPC","分布式"],"title":"Protobuf基础","url":"https://blog.engine.wang/posts/protobuf-basic/","wordcount":1081},{"categories":"posts","content":"\u003ch2 id=\"rpc的概念\"\u003eRPC的概念\u003c/h2\u003e\n\u003cp\u003eRPC（Romote Procedure Call），全称是远程过程调用，作为分布式系统中不同节点之间的通信方式，是分布式系统的基石之一，RPC不是具体的方法，而是一种解决不同服务之间调用的设计。\u003c/p\u003e\n\u003cp\u003e基于RPC开发的框架可以称为RPC框架，典型的有谷歌的gRPC、阿里的Dubbo、Facebook的Thrift等，当然成熟的RPC框架还会有服务注册与发现、服务治理、负载均衡等功能。\u003c/p\u003e\n\u003ch2 id=\"为何需要rpc\"\u003e为何需要RPC\u003c/h2\u003e\n\u003cp\u003e大公司的服务往往部署在不同的机器上，调用其他机器的服务如果每次都要走网络通信会给业务开发带来复杂，希望能够将网络通信进行封装，使得远程调用和本地调用一样简单，于是诞生了RPC。\u003c/p\u003e\n\u003cp\u003eRPC对应的一个概念就是本地调用，比如最常见的函数调用，当然远程调用比本地调用复杂的多。我们最终的目的就是通过封装调用的底层过程，让远程调用和本地调用一样方便，请求方调用服务方的某个方法就像是调用本地方法一样。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e为什么不采用基于HTTP的Restful api而采用RPC呢？\n实际上，广义的RPC也包括了基于HTTP的Restful api，不过默认指的是中间传输形式为二进制流的跨机器通信方式。基于HTTP协议的restful api更通用、可读性更好，但是报文比较冗余，性能不如二进制传输的RPC。RCP更接近直接调用，也更容易拓展和集成一些功能（如注册中心、负载均衡等）应该视具体情况选择，对性能要求非常高的场景可以使用RPC。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"rpc的核心问题\"\u003eRPC的核心问题\u003c/h2\u003e\n\u003ch3 id=\"寻址问题\"\u003e寻址问题\u003c/h3\u003e\n\u003cp\u003e如果是本地运行，直接可以获得函数的指针，但是远程的不行，一个方法是Server和Client分别维护一个函数\u0026lt;-\u0026gt;call id的映射表。服务器需要将提供的服务接口进行注册，从而让请求方可以获取到。\u003c/p\u003e\n\u003ch3 id=\"编码方式\"\u003e编码方式\u003c/h3\u003e\n\u003cp\u003e比如常见的可读性高的JSON、XML或者性能更好的protobuf。\u003c/p\u003e\n\u003ch3 id=\"序列化和反序列化\"\u003e序列化和反序列化\u003c/h3\u003e\n\u003cp\u003eClient：\n① tcp/http连接\n② 对象结构数据序列化\n③ 发送json\n④ 等待结果\n⑤ 解析结果，反序列化为需要的对象结构\u003c/p\u003e\n\u003cp\u003eServer：\n① 监听对应端口\n② 读取数据\n③ 反序列化为需要的对象结构\n④ 运行对应的函数处理\n⑤ 序列化\n⑥ 将结果传输返回\u003c/p\u003e\n\u003cp\u003e实际上解决好了之后，语言也不重要了，都可以使用不同的语言。\u003c/p\u003e\n\u003ch3 id=\"网络传输协议\"\u003e网络传输协议\u003c/h3\u003e\n\u003cp\u003e比如考虑tcp是用长连接还是短连接，http1.0中，对方返回结果之后，会自动断开，下次连接会比较慢。http2.0可以保持长连接，所以gRPC直接用了http2.0。\n可以走http，也可以自己基于tcp协议封装一个长连接。\u003c/p\u003e\n\u003ch2 id=\"rpc的四个要素\"\u003eRPC的四个要素\u003c/h2\u003e\n\u003ch3 id=\"client\"\u003eClient\u003c/h3\u003e\n\u003cp\u003e服务调用的发起方\u003c/p\u003e\n\u003ch3 id=\"client-stub\"\u003eClient Stub\u003c/h3\u003e\n\u003cp\u003e用于存储要调用的服务器地址、以及将要请求的数据信息打包，通过网络请求发送给Server Stub，然后阻塞，直到接受到返回的数据，然后进行解析。\u003c/p\u003e\n\u003ch3 id=\"server\"\u003eServer\u003c/h3\u003e\n\u003cp\u003eServer，包含要调用的方法\u003c/p\u003e\n\u003ch3 id=\"server-stub\"\u003eServer Stub\u003c/h3\u003e\n\u003cp\u003e用于接受Client Stub发送的请求数据包并进行解析，完成功能调用，最后将结果进行打包并返回给Client Stub。在没有接受到请求数据包时则处于阻塞状态。\u003c/p\u003e\n\u003cp\u003e封装了Client Stub和Server Stub后，从Client的角度来看，似乎和本地调用一样。从Server的角度看，似乎就是客户直接调用。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1643108079/rpc-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1665216103/rpc-3.jpg\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"rpc的具体通信步骤\"\u003eRPC的具体通信步骤\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eClient以类似本地调用的方式调Client Stub\u003c/li\u003e\n\u003cli\u003eClient Stub序列化生成消息，然后调用本地操作系统的通信模块， Stub阻塞\u003c/li\u003e\n\u003cli\u003e本地操作系统与远程Server进行通信，消息传输到远程操作系统\u003c/li\u003e\n\u003cli\u003e远程操作系统将消息传递给Server Stub\u003c/li\u003e\n\u003cli\u003eServer Stub进行反序列化，然后调用Server的对应方法\u003c/li\u003e\n\u003cli\u003eServer程序执行方法，将结果传递给Server Stub\u003c/li\u003e\n\u003cli\u003eServer Stub将结果进行序列化，然后传递给Server操作系统\u003c/li\u003e\n\u003cli\u003eServer操作系统将结果传递给Client\u003c/li\u003e\n\u003cli\u003eClient操作系统将其交给Client Stub， Stub从阻塞状态恢复\u003c/li\u003e\n\u003cli\u003eClient Stub对结果进行反序列化，并将值返回给Client程序\u003c/li\u003e\n\u003cli\u003eClient程序获得返回结果\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eRPC就是把2-10步进行了封装。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://pic1.zhimg.com/80/v2-619633f1a8ff09c38a0611b1a0d62afc_1440w.jpg\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e一些RPC框架可以通过一个接口定义语言（IDL）定义接口和数据类型，然后自动生成各种语言的stub代码。\u003c/p\u003e\n\u003ch2 id=\"go的rpcnetrpc\"\u003eGo的RPC：net/rpc\u003c/h2\u003e\n\u003ch3 id=\"使用\"\u003e使用\u003c/h3\u003e\n\u003cp\u003eGo语言的标准库也提供了一个简单的RPC实现:\u003ccode\u003enet/rpc\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eGo的RPC规则：\u003cstrong\u003e方法只能有两个序列化参数，其中第二个参数是指针类型，并且只能返回一个error类型，同时必须是公开的方法。\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e即形式只能为：\u003ccode\u003efunc (t *T) MethodName(argType T1, replyType *T2) error\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e其中第一个参数是调用者收到的参数，第二个参数是方法返回的参数。如果\u003c/p\u003e\n\u003cp\u003eRPC的Hello World：\n（ip和端口可视情况调整，Server和Client可以在不同机器上运行）\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"c1\"\u003e// Server.go\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 先声明Service结构\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003ehelloService\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 定义一个方法，注意只能两个参数，第二个为指针，返回一个error\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ep\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003ehelloService\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eHello\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003erequest\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ereply\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003ereply\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;Hello, \u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003erequest\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 要注册一个名字\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"nx\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003erpc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRegisterName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;HelloService\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ehelloService\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\t\u003cspan class=\"c1\"\u003e// 采用tcp通信\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"nx\"\u003elistener\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003enet\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eListen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;tcp\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;:1234\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003elistener\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAccept\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003erpc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eServeConn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"c1\"\u003e// Client.go\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003eClient\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003erpc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDial\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;tcp\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;192.168.50.174:1234\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ereply\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003eClient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCall\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;HelloService.Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;engine\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003ereply\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ereply\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e做一些改进，一方面，Server应该是持续保持连接，并且支持多个Client共同连接，不能Client运行完就断开。另一方面，Client做一些封装，比较方便：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e9\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"c1\"\u003e// Server.go\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e//...\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003elistener\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAccept\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ego\u003c/span\u003e \u003cspan class=\"nx\"\u003erpc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eServeConn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"c1\"\u003e// Client.go\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003eHelloServiceName\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;HelloService\u0026#34;\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eHelloServiceClient\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003erpc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eClient\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003eHelloServiceDial\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eaddress\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eHelloServiceClient\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003eClient\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003erpc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDial\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enetwork\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eaddress\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003eHelloServiceClient\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nx\"\u003eClient\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eClient\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eh\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eHelloServiceClient\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eHello\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003erequest\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ereply\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003eh\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eClient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCall\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eHelloServiceName\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;.Hello\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003erequest\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ereply\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003ehs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nf\"\u003eHelloServiceDial\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;tcp\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;192.168.50.174:1234\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ereply\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ehs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eHello\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;engine\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003ereply\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ereply\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e标准库的rpc采用go语言特有的gob编码，如果需要跨语言的客户端，则可以采用一种通用的编码格式，比如json，Server端可以通过：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"c1\"\u003e// go rpc.ServeConn(conn)\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003ego\u003c/span\u003e \u003cspan class=\"nx\"\u003erpc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eServeCodec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ejsonrpc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eNewServerCodec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e而客户端可以使用：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"nx\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003enet\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDial\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;tcp\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;localhost:1234\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;dial error\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eclient\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003erpc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eNewClientWithCodec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ejsonrpc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eNewClientCodec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e","date":1642656554,"description":"","fuzzywordcount":2400,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"e47844a4f786a2256e88e77be3858be8","publishdate":1642656554,"relpermalink":"/posts/rpc-basics/","section":"posts","summary":"RPC的概念 RPC（Romote Procedure Call），全称是远程过程调用，作为分布式系统中不同节点之间的通信方式，是分布式系统的基石之一，RPC不是具体的方法，而是一种","tags":["RPC","分布式","Golang"],"title":"RPC基础","url":"https://blog.engine.wang/posts/rpc-basics/","wordcount":2370},{"categories":"posts","content":"\u003ch2 id=\"信息论基础\"\u003e信息论基础\u003c/h2\u003e\n\u003cp\u003e信息是事物运动状态或存在方式的不确定性的描述\u003c/p\u003e\n\u003cp\u003e通信系统形式上传递的就是信息，需求来源于：\u003c/p\u003e\n\u003cp\u003e① 需要告知某信息给对方\u003c/p\u003e\n\u003cp\u003e② 需要接受某种信息。通信的结果就是消除不确定性或者获得信息。\u003c/p\u003e\n\u003cp\u003e信息论研究的目的在于：通过探索信息传输的规律，提高信息传输的有效性、可靠性和保密性，使得信息系统达到最优化。\u003c/p\u003e\n\u003cp\u003e数据：传送信息的实体\u003c/p\u003e\n\u003cp\u003e信号：数据的电气或电磁表现，数据在传输过程中的存在形式\n（连续变化的称为模拟数据/信号，离散变化的数据称为数字数据/信号）\u003c/p\u003e\n\u003cp\u003e码元：用一个固定时长的信号波形代表一位k进制数字\u003c/p\u003e\n\u003cp\u003e信源：产生和发送数据的源头\u003c/p\u003e\n\u003cp\u003e信道：信号的传输媒介\ns\n信宿：接收数据的终点\u003c/p\u003e\n\u003cp\u003e速率：数据的传输速率，表示单位时间内传输的数据量，码元传输速率单位是波特（Baud），信息运输速率单位是 比特/秒 (b/s)\u003c/p\u003e\n\u003cp\u003e$$比特/秒 = 波特 \\times \\log_2电平数$$\u003c/p\u003e\n\u003cp\u003e波特：每秒内信息改变的次数，一波特就表示数字通道系统一秒钟传输一个码元\u003c/p\u003e\n\u003cp\u003e带宽：指信号具有的频带宽度，单位是赫兹（Hz），表示单位时间内从网络某一点到另一点所能通过的最高数据率，此时单位是bit/s\u003c/p\u003e\n\u003ch2 id=\"信息量\"\u003e信息量\u003c/h2\u003e\n\u003cp\u003e信息量 = 不确定性的减少量 = 收信前的不确定性 - 收信后的不确定性\u003c/p\u003e\n\u003cp\u003e某个事件发生的信息量是该事件发生的先验概率的函数：\u003c/p\u003e\n\u003cp\u003e$$I(a_i) = f[P(a_i)]$$\u003c/p\u003e\n\u003cp\u003e有$I(a_0 = 0) = \\infty, I(a_0 = 1) = 0$\u003c/p\u003e\n\u003cp\u003e独立事件的联合信息量等于各自的信息量之和\u003c/p\u003e\n\u003cp\u003e自信息量的计算公式为：\u003c/p\u003e\n\u003cp\u003e$$\nI(a_i) = \\log \\frac{1}{P(a_i)}\n$$\u003c/p\u003e\n\u003cp\u003e以2为底，单位为比特；以e为底，单位为奈特；以10为底，单位为哈特。\u003c/p\u003e\n\u003ch2 id=\"熵\"\u003e熵\u003c/h2\u003e\n\u003cp\u003e反应了信源整体的不确定度\u003c/p\u003e\n\u003cp\u003e$$\nH(x) = -\\sum_x p(x)\\log p(x)\n$$\u003c/p\u003e\n\u003cp\u003e联合熵：\n$$\nH(X, Y) = -\\sum_{x,y} p(x,y)\\log p(x,y)\n$$\u003c/p\u003e\n\u003cp\u003e条件熵：\n$$\nH(X | Y) = - \\sum_y H(X|Y=y) p(y) = -\\sum_{y} \\sum_{x} p(x \\mid y) p(y) \\log p(x \\mid y)\n$$\u003c/p\u003e\n\u003cp\u003e互信息：\n$$\nI(X;Y) = \\sum_{x,y} p(x,y) \\log \\frac{p(x,y)}{p(x)p(y)}\n$$\u003c/p\u003e\n\u003cp\u003e两个独立的随机变量的互信息等于0\u003c/p\u003e\n\u003ch2 id=\"信源编码与信道编码\"\u003e信源编码与信道编码\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641283110/xxl-1.png\" alt=\"xxl-1\"\u003e\u003c/p\u003e\n\u003cp\u003e信号先经过信源编码，然后进入信道前经过信道编码。\u003c/p\u003e\n\u003cp\u003e信源编码的作用：信息量的压缩，减少原信号的冗余\u003c/p\u003e\n\u003cp\u003e信道编码的作用：信息量的增加，用于增加可靠性\u003c/p\u003e\n\u003cp\u003e带宽受限且有高斯白噪声干扰的信道的极限、无差错的信息传输速率\u003c/p\u003e\n\u003ch3 id=\"无线通信系统\"\u003e无线通信系统\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641799607/transceiver-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e源信号依次经过信源编码、加密、信道编码、调制然后发送出去，接受时依次经过解调、信道解码、解密、信源解码然后接受。\u003c/p\u003e\n\u003ch2 id=\"调制\"\u003e调制\u003c/h2\u003e\n\u003cp\u003e调制：将某个信息嵌入到另一个信号的过程，比如模拟信号通过采样、量化、数字化编码到数字信号的过程。\u003c/p\u003e\n\u003cp\u003e之所以要调制，是为了提高频率，从而让让信号客户要传播的更远，大气层对低频段的损耗非常高。\u003c/p\u003e\n\u003cp\u003e信源的信号有很多低频或者直流成分，很多信道不能直接传输。一方面需要调制成高频信号便于天线发射，一方面可以通过多路传输不同的基带信号，如果频率一样可能会干扰（广播的频率不一样就可以同时发射互不干扰）。\u003c/p\u003e\n\u003cp\u003e载波调制就是利用载波进行调制，把基带信号的频率搬移到较高的频段。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://img-blog.csdnimg.cn/img_convert/ba2f942c2de172e4e5e707738f3d08f4.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"码元调制\"\u003e码元调制\u003c/h2\u003e\n\u003cp\u003e码间串扰：在接收端收到的信号波形就失去了码元和符号之间的清晰的界限。\u003c/p\u003e\n\u003cp\u003e进行码元/符号调制的目的：用一个码元代表多个比特，在码元速率一定的情况下提高数据传输速率\u003c/p\u003e\n\u003ch3 id=\"nyquist定理\"\u003eNyquist定理\u003c/h3\u003e\n\u003cp\u003e在绝对理想的信道中，极限码元传输速率为$2W$ \u003cem\u003eBaud\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e$W$是理想低通信道的带宽，单位为Hz\n$V$是每个码元离散电平的数目，$V$个电平就需要$log_2V$个二进制位\u003c/p\u003e\n\u003cp\u003e理想状态下的极限数据传输率 = $2Wlog_2V$ （单位 \u003cem\u003eb/s\u003c/em\u003e）\u003c/p\u003e\n\u003cp\u003e超过这个界限就会出现严重的码间串扰\u003c/p\u003e\n\u003ch3 id=\"香农定理\"\u003e香农定理\u003c/h3\u003e\n\u003cp\u003e信道的极限数据传输速率 = $Wlog_2(1+S/N)$\u003c/p\u003e\n\u003cp\u003e$S$是信道传输的平均功率\n$N$为信道内部的高斯噪声功率\u003c/p\u003e\n\u003ch3 id=\"例子\"\u003e例子\u003c/h3\u003e\n\u003cblockquote\u003e\n\u003col\u003e\n\u003cli\u003e带宽为6MHz，量化等级为4，无噪声，求最大传输速率\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e解：使用Nyquist定理，$C = 2 * W * log_2V = 2 * 6 * log_24 = 24Mbps$\u003c/p\u003e\n\u003cblockquote\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e带宽为3MHz，信噪比为20dB，二进制，求最大数据传输速率\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e解：使用香农定理\u003c/p\u003e\n\u003cp\u003e先化$S/N$的单位，$10lg(S/N) = 20 \\to S/N = 100 $\u003c/p\u003e\n\u003cp\u003e$C= W * log_2{(1+S/N)} = 3 * log_2{(1+100)} \\approx 20Kbps$\u003c/p\u003e\n\u003ch2 id=\"无线信道\"\u003e无线信道\u003c/h2\u003e\n\u003cp\u003e传播的时候会遇到很多复杂的情况，造成信号的衰弱，根据信号传播的距离分为大尺度衰弱和小尺度衰弱。\u003c/p\u003e\n\u003ch3 id=\"大尺度衰弱\"\u003e大尺度衰弱\u003c/h3\u003e\n\u003cp\u003e大尺度衰弱是发射和接受信号的距离较长，数百数千米\u003c/p\u003e\n\u003cp\u003e大尺度衰弱包括路径损耗和阴影效应：\u003c/p\u003e\n\u003cp\u003e路径损耗：随着路径长度的平方衰减，和方向等参数无关\u003c/p\u003e\n\u003cp\u003e阴影损耗：遇到障碍物时，后面的阴影区信号场比较弱，会造成损耗\u003c/p\u003e\n\u003ch3 id=\"小尺度衰弱\"\u003e小尺度衰弱\u003c/h3\u003e\n\u003cp\u003e小尺度衰弱是数个或者数十个波长的距离\u003c/p\u003e\n\u003cp\u003e小尺度衰弱更为重要，其中造成小尺度衰弱的主要原因有多径效应和多普勒效应\u003c/p\u003e\n\u003cp\u003e包括频率选择性衰弱和时变特性\u003c/p\u003e\n\u003cp\u003e多径效应：由于电波传递的过程中有各种反射散射等，会导致到达时的信号是由多个状态叠加的，随机分布的幅度、相位、入角等合成之后使得接收到的信号删除衰弱和失真，比如极端情况刚好差半个波长然后刚好抵消（实际基本不可能，但是能说明其影响）\u003c/p\u003e\n\u003cp\u003e多普勒效应：是由于接收端和发射端之间的相对移动产生的\u003c/p\u003e\n\u003ch3 id=\"蜂窝网络\"\u003e蜂窝网络\u003c/h3\u003e\n\u003cp\u003e单基站覆盖：早期的移动通信是利用高塔上的天线大功率发射，但是业务通道很少\u003c/p\u003e\n\u003cp\u003e蜂窝通信网络：减少单个基站的发射功率，多小区覆盖，不同小区之间频率复用（频率复用是蜂窝移动通信的基石）\u003c/p\u003e\n\u003cp\u003e同频段小区之间可能会干扰，需要增加同频段小区之间的距离\u003c/p\u003e\n\u003cp\u003e不同簇之间使用相同频率的小区的最小距离$D$称为频率再用比例（就是两个相同频率的，看最接近的路径是多大）\u003c/p\u003e\n\u003cp\u003e小区切换，设定某个切换门限，低于门限值则进行切换，需要设定一个时间，持续低于这段时间再切换，从而避免乒乓球切换。\u003c/p\u003e\n\u003cp\u003e同频组网\u003c/p\u003e\n\u003cp\u003e单工：指的是只有一个方向的交互而没有反方向的交互\n半双工：双方都可以发送信息，但是不能同时发送或者接受\u003c/p\u003e\n\u003cp\u003e半双工分为FDD（频分双工）和TDD（时分双工），FDD就是在不同的频率上同时发送，TDD用时间片轮转。\u003c/p\u003e\n\u003cp\u003e全双工：双方可以同时发送和接收消息\u003c/p\u003e\n\u003ch3 id=\"多址接入方式\"\u003e多址接入方式\u003c/h3\u003e\n\u003cp\u003e复用：同样的频谱如何重复使用\n多址：同样的频谱如何分给不同用户\u003c/p\u003e\n\u003cp\u003e多址其实就是要去找一种方式来分割为多个正交的数据流，从而将它们分开。\u003c/p\u003e\n\u003cp\u003e频分多址（FDMA）：在频域复用多个数据流，用于多个用户\n时分多址（TDMA）：在时域复用多个数据流，用于多个用户\n\u003cstrong\u003e码分多址（CDMA）\u003c/strong\u003e：在码域复用多个数据流，用于多个用户\n空分多址（SDMA）：在空间上用于多个用户\u003c/p\u003e\n\u003cp\u003e把每个频谱比作一个房间，FDMA就是不同的用户去不同的方向聊天，TDMA就是依次排队去房间聊天，CDMA就是一窝蜂的一起说话，但是说的语言不同，只要认准自己的语言就能分开从而交流。\u003c/p\u003e\n\u003cp\u003e码片序列，将一个比特时间划分成m个短的间隔，称为码片。每个站被指派一个唯一的m bit码片序列，1则为自己的码片，0则发送自己的反码。\u003c/p\u003e\n\u003cp\u003e每个站分配的码片序列必须各不相同且相互正交\u003c/p\u003e\n\u003cp\u003e扩频技术，之前的一个bit变成了m个bit，发送的数据率是之前的m倍，宽度也提高到m倍\u003c/p\u003e\n\u003cp\u003e扩频通信采用直接序列扩频或者跳频扩频\n直接序列扩频DSSS是通过比特率高很多的伪码序列对信号进行二次调频的技术\u003c/p\u003e\n\u003cp\u003eOFDM：正交频分复用，运行载波之间紧密相邻甚至部分重合，可以实现很高的频谱效率。通过IFFT，人为建立载波间正交性\u003c/p\u003e\n\u003cp\u003eOFDM发射机的两个核心模块：IFFT和加入循环前缀CP\u003c/p\u003e\n\u003ch3 id=\"mimo与波束赋型\"\u003eMIMO与波束赋型\u003c/h3\u003e\n\u003ch2 id=\"传输途径的分类\"\u003e传输途径的分类\u003c/h2\u003e\n\u003cp\u003e基站和终端的传输途径有SISO、MISO、SIMO、MIMO。\u003c/p\u003e\n\u003cp\u003eMISO是基站多个天线发出相同信号，在终端合成一路，是发送分集技术。\u003c/p\u003e\n\u003cp\u003eSIMO是一个天线通过两路路径发送信号，终端收到两个信号，数据也一样，是接受分集技术。\nMIMO（Multiple Input Multiple Output，多进多出）\n实现多路数据并行发送，获得空间复用增益。\n实现多个字信号的有效合并，获得空间分集增益。\u003c/p\u003e\n\u003ch2 id=\"分集与复用\"\u003e分集与复用\u003c/h2\u003e\n\u003ch3 id=\"分集\"\u003e分集\u003c/h3\u003e\n\u003cp\u003e分集就是把多个独立衰弱的副本提供给接收机，接受机将同一数据流的不同版本进行合并和恢复。减少深度衰弱的概率，从而提高性能。（提高鲁棒性）\u003c/p\u003e\n\u003cp\u003e分为空间分集（同一个信息从多根天线上发射出去）、时间分集（同一个信号以超过相干时间间隔重复发送）\u003c/p\u003e\n\u003cp\u003e频率分集就是在多个频域上对同一信号进行重复发送\u003c/p\u003e\n\u003cp\u003e分集又分为简单分集（完全相同）、编码分集（不同的版本）、选择分集（选择一个信道较好的天线发送）、波束分集等\u003c/p\u003e\n\u003cp\u003e空间分集的算法：\n空时块码（STBC，Alamouti空时分组码），各个发射天线上的码字满足正交性。因为正交，所以接收端只需要简单处理。\u003c/p\u003e\n\u003cp\u003e接收机是2路发送信号与噪声的线性叠加\u003c/p\u003e\n\u003ch3 id=\"复用\"\u003e复用\u003c/h3\u003e\n\u003cp\u003e空分复用就是在多条独立的路径上传输不同的数据，提高系统容量。（提高吞吐率）\n高速流分为几个低速数据流分别进行编码和调制，然后在不同的天线发送，接收机将不同天线上接受到的数据流进行合并\u003c/p\u003e\n","date":1642066440,"description":"","fuzzywordcount":3300,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"45b659a1d8d75d72dfe2f5ac3a2ea07a","publishdate":1642066440,"relpermalink":"/posts/wireless-network-basic/","section":"posts","summary":"信息论基础 信息是事物运动状态或存在方式的不确定性的描述 通信系统形式上传递的就是信息，需求来源于： ① 需要告知某信息给对方 ② 需要接受某种信息。通信的结果就是消除不确","tags":["通信"],"title":"无线网络基础","url":"https://blog.engine.wang/posts/wireless-network-basic/","wordcount":3280},{"categories":"posts","content":"\u003cp\u003e包括无约束优化问题、带等式约束和不等式约束的凸优化问题的求解\u003c/p\u003e\n\u003ch2 id=\"无约束优化问题\"\u003e无约束优化问题\u003c/h2\u003e\n\u003cp\u003e无约束优化问题：\u003c/p\u003e\n\u003cp\u003e$$\n\\text { minimize } f_0(x)\n$$\u003c/p\u003e\n\u003cp\u003e对于凸问题而言，只有一个条件\u003c/p\u003e\n\u003cp\u003e$$\n\\nabla f (x^{\\star}) = 0\n$$\u003c/p\u003e\n\u003ch3 id=\"强凸性\"\u003e强凸性\u003c/h3\u003e\n\u003cp\u003e存在一个大于0的$m$，使得\u003c/p\u003e\n\u003cp\u003e$$\\forall x \\in C, \\nabla ^2 f(x) \\geq mI$$\n$$\nf(y) = f(x) + \\nabla f(x)^T (y-x) + \\frac{m}2||x-y||_2^2 \\newline\nf(x) - p^{\\star} \\leq \\frac{1}{2m} ||\\nabla f(x)||_2^2\n$$\u003c/p\u003e\n\u003cp\u003e强凸性的性质：任何梯度足够小的点都是近似最优解（结束条件）\u003c/p\u003e\n\u003ch3 id=\"下降法\"\u003e下降法\u003c/h3\u003e\n\u003cp\u003e通用的求解方法都是迭代的下降方法，所谓下降，也就是每次迭代，后一个值都比前一个值对应的目标函数值要低，所以是下降。对于前一个值$x^{k}$，寻找一个方向$d^k$和步长$\\alpha^k$，下一个值就是$x^{k+1} = x^k + \\alpha^k d^k $，初始点、搜索方向、迭代步长也称为迭代搜索法的三要素。\u003c/p\u003e\n\u003cp\u003e由于无约束条件，初始点满足以下两项即可：\n① $x^0 \\in dom f$\n② 下水平集是一个闭集\u003c/p\u003e\n\u003cp\u003e初始点确定之后，还需要选择下降方向、步长、终止条件等\u003c/p\u003e\n\u003ch3 id=\"线搜索\"\u003e线搜索\u003c/h3\u003e\n\u003cp\u003e$$\nx^{k+1} = x^k + \\alpha^k d^k\n$$\u003c/p\u003e\n\u003cp\u003e$d^{k}$是搜索方向。\u003c/p\u003e\n\u003cp\u003e希望能在这个方向上有个最大的下降，也就是找到\n$$\n\\alpha^k = \\text{argmin}_{\\alpha} f(x^k + \\alpha^k d^k)\n$$\n但是实际上相当于每次下降都引入了一个新的优化问题，虽然效果好但是计算量很大。\u003c/p\u003e\n\u003ch3 id=\"带backtracing的线搜索\"\u003e带Backtracing的线搜索\u003c/h3\u003e\n\u003cp\u003e算法：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e令步长$t$为允许的最大步长\u003c/li\u003e\n\u003cli\u003e如果$f(x^k + t \\Delta x) \u0026gt; f(x^k) + \\alpha t \\nabla f(x^k) \\Delta x$（也就是说步长太大了，导致下降的一段比$\\alpha * $斜率的长度还小，那就减少步长，右式后面是负数）\u003c/li\u003e\n\u003cli\u003e让$t = \\beta t$\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e通常$\\alpha $取0.5，$\\beta$取一个0-1之间的数\u003c/p\u003e\n\u003cp\u003e这样就能找到一个比较合适的步长，而不需要非常高的计算量。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641534854/convex-12.png\" alt=\"convex-12\"\u003e\u003c/p\u003e\n\u003ch3 id=\"梯度下降法最速下降法\"\u003e梯度下降法（最速下降法）\u003c/h3\u003e\n\u003cp\u003e思想很简单，沿着梯度（梯度方向是函数值增加的方向）的反方向走，就可以使目标函数不断减少。\u003c/p\u003e\n\u003cp\u003e就像是下山，每次都沿着下降最快的方向走，最后一定能走到局部最低点（如果是凸函数就是全局最低点）\u003c/p\u003e\n\u003cp\u003e至于搜索步长，则选择这个一维方向搜索的最佳步长，因此，最速下降法的两个相邻迭代点的函数梯度相互垂直\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641534854/convex-13.png\" alt=\"convex-13\"\u003e\u003c/p\u003e\n\u003cp\u003e优点是可以沿着最快的方向，缺点是关注不到全局的情况，不关注下一个点的情况。\u003c/p\u003e\n\u003cp\u003e梯度下降法步骤：\n输入：目标函数，目标函数梯度\n输出：极小点\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e初始化$x^0$\u003c/li\u003e\n\u003cli\u003e计算搜索方向$d^k = - \\nabla f(x^{k})$\u003c/li\u003e\n\u003cli\u003e如果小于$\\epsilon$就停止迭代，否则就沿着$d^k$进行一维搜索，求最佳步长$\\lambda^k$：\n$$\nf(x^k + \\lambda^k d^k) = \\min_{\\lambda \\geq 0} f(x^k + \\lambda d^k)\n$$\u003c/li\u003e\n\u003cli\u003e令$x^{k+1} = x^k + \\lambda^k d^k$，转步骤2\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e选择最优步长的计算代价比较高\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e用最速下降法求目标函数$f(x) = x_1^2 + 25x_2^2$在$[2,2]^T$处的最速下降方向和步长\n解：取初始点$x^0 = [2,2]^T$\n初始点函数值和梯度分别为：\n$f(x^0) = 104$\n$\\nabla f(x^0) = [4, 100]^T$\n沿负梯度方向进行一维搜索：\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e$$x^1 = x^0 - \\alpha^0 \\nabla f(x^0) = [2-4\\alpha^0, 2-100\\alpha^0]^T$$\u003c/p\u003e\n\u003cp\u003e$\\alpha^0$需要满足极值条件：\u003c/p\u003e\n\u003cp\u003e$$\n\\min_\\alpha f(x^1) = \\min_\\alpha ((2-4\\alpha)^2 + 25 (2-100\\alpha)^2)\n$$\u003c/p\u003e\n\u003cp\u003e解得$\\alpha_0 = 0.02003$\u003c/p\u003e\n\u003ch3 id=\"牛顿法\"\u003e牛顿法\u003c/h3\u003e\n\u003cp\u003e牛顿法（Newton's Method）是一个非常有效的非线性方差的求根方法，主要用于求方程的根和求解最优化问题。\u003c/p\u003e\n\u003cp\u003e利用牛顿法，可以迭代求解非常复杂的方程的根：\n$$\nf(x) = f(x_0) + f'(x_0)(x-x_0) + O((x-x_0)^2)\\newline\n$$\n忽略截断误差后令$f(x)=0$可解得：\n$$\nx_1 = x_0 - \\frac{f(x_0)}{f'(x_0)}\n$$\n$x_1$一定比$x_0$更接近真实根，从而不断迭代\u003c/p\u003e\n\u003cp\u003e对于最优化问题的求解\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e牛顿法的推导\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e当前点$v$，下降向量$v$，下降后的值为：\u003c/p\u003e\n\u003cp\u003e$$\nf(x+v) \\approx f(x)+\\nabla f(x)^{T} v+\\frac{1}2 v^{T} \\nabla^2 f(x) v\n$$\u003c/p\u003e\n\u003cp\u003e要使该值最小，且$x$已经固定，关于$v$求偏导：\u003c/p\u003e\n\u003cp\u003e$$\n\\nabla f(x)+\\nabla^2 f(x) v=0\n$$\u003c/p\u003e\n\u003cp\u003e得到：\u003c/p\u003e\n\u003cp\u003e$$\n\\Delta x_{nt} = v=-\\nabla^2 f(x)^{-1} \\nabla f(x)\n$$\u003c/p\u003e\n\u003cp\u003e从而推出\u003cstrong\u003e牛顿法的迭代公式：\u003c/strong\u003e\n$$\nx^{k+1} = x^k + \\Delta x_{nt} = x^k -\\nabla^2 f(x)^{-1} \\nabla f(x)\n$$\u003c/p\u003e\n\u003cp\u003e$\\nabla^2 f(x)$是$f(x)$的Hessian矩阵\u003c/p\u003e\n\u003cp\u003e一维时有：\n$$\nx^{k+1} = x^k - \\frac{f'(x^k)}{f''(x^k)}\n$$\u003c/p\u003e\n\u003cp\u003e多元函数保留到二次项得到：\n$$\nf(x) = f(x^k) + \\nabla f(x^k)^T(x-x^k) + \\frac{1}2 (x-x^k)^T \\nabla^2 f(x^k)(x-x^k)\n$$\n其中$\\nabla^2 f(x^k)$是点$x^k$处的海森矩阵\n通过求导得到平稳点，解得\n$$\nx^{k+1} = x^k - [\\nabla^2 f(x^k)]^{-1}\\nabla f(x^k)\n$$\u003c/p\u003e\n\u003cp\u003e求解无约束优化问题\u003c/p\u003e\n\u003cp\u003e牛顿法用二阶海森矩阵的逆矩阵求解，收敛更快但是每次迭代的计算时间更长\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e求目标函数$f(x) = x_1^2 + 25x_2^2$在$[2,2]^T$处的牛顿方向\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e解：初始点梯度$\\nabla f(x_0) = [2x_1\\ 50x_2]^T = [4\\ 100]^T$\n$$\n\\nabla^2 f(x^0)=\\left[\\begin{array}{cc}\n2 \u0026amp; 0 \\newline\n0 \u0026amp; 50\n\\end{array}\\right]\n$$\n$$\n[\\nabla^2 f(x^0)]^{-1}=\\left[\\begin{array}{cc}\n\\frac{1}2 \u0026amp; 0 \\newline\n0 \u0026amp; \\frac{1}{50}\n\\end{array}\\right]\n$$\n牛顿方向为\n$$- [\\nabla^2 f(x^k)]^{-1}\\nabla f(x^k) = -\\left[\\begin{array}{cc}\n\\frac{1}2 \u0026amp; 0 \\newline\n0 \u0026amp; \\frac{1}{50}\n\\end{array}\\right] \\left[\\begin{array}{cc}\n4 \\newline\n100\n\\end{array}\\right] = \\left[\\begin{array}{cc}\n-2 \\newline\n-2\n\\end{array}\\right]$$\u003c/p\u003e\n\u003ch3 id=\"阻尼牛顿法\"\u003e阻尼牛顿法\u003c/h3\u003e\n\u003cp\u003e增加了沿牛顿方向的一维搜索，步长$\\lambda_k$由一维搜索得到，每次迭代必然下降，不过会增大计算量\u003c/p\u003e\n\u003ch3 id=\"共轭梯度法\"\u003e共轭梯度法\u003c/h3\u003e\n\u003cp\u003e$A$是对称正定矩阵，如果有两个方向$d^i, d^j$满足$(d^{i})^T A d^j$，则称这组方向是$A$共轭的\n（如果$A$是单位阵，则称两个方向正交）\u003c/p\u003e\n\u003cp\u003e依次沿着$d^i$和$d^j$进行一维搜索，经过两次迭代必定到达极小点\u003c/p\u003e\n\u003ch3 id=\"拟牛顿法\"\u003e拟牛顿法\u003c/h3\u003e\n\u003cp\u003e计算海森矩阵的逆比较复杂，通过一个$n$阶矩阵来近似代替，就是拟牛顿法的思想。\u003c/p\u003e\n\u003cp\u003e$p^k \\approx \\nabla^2 f(x^{k+1})^{-1}q^k$\u003c/p\u003e\n\u003ch2 id=\"带等式约束的凸优化问题\"\u003e带等式约束的凸优化问题\u003c/h2\u003e\n\u003cp\u003e对于带等式约束的凸优化问题：\n$$\n\\begin{array}{ll}\n\\text{ minimize } \u0026amp; f_0(x) \\newline\n\\text { subject to } \u0026amp; Ax = b\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e带等式约束的凸优化问题通常可以采用下面三种方法进行求解：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e消除等式约束\u003c/li\u003e\n\u003cli\u003e利用无约束优化方法求解对偶问题\u003c/li\u003e\n\u003cli\u003e拓展的Newton法\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"消除等式约束\"\u003e消除等式约束\u003c/h3\u003e\n\u003cp\u003e等式约束为$Ax = b$\u003c/p\u003e\n\u003cp\u003e满足此约束的$x$可以写为$Fy + \\hat{x}$的形式，最后变成了：\n$$\n\\text{ minimize } f_0(Fy + \\hat{x})\n$$\u003c/p\u003e\n\u003cp\u003e的无约束优化问题，解得最优解$y^{\\star}$之后，就可以通过$x^{\\star} = Fy^{\\star} + \\hat{x}$计算出$x^{\\star}$\u003c/p\u003e\n\u003cp\u003e比如：\n$$\n\\begin{array}{ll}\n\\text{ minimize } \u0026amp; f_{1}\\left(x_{1}\\right)+f_2\\left(x_2\\right)+\\cdots+f_{n}\\left(x_{n}\\right) \\newline\n\\text { subject to } \u0026amp; x_{1}+x_2+\\cdots+x_{n}=b\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e可以通过 $x_n = b - x_1 - ... - x_{n-1}$\n令$\\hat{x} = b e_n$, $F = \\left[\\begin{array}{c}\nI \\newline\n-\\mathbf{1}^{T}\n\\end{array}\\right] \\in \\mathbf{R}^{n \\times(n-1)}$\u003c/p\u003e\n\u003cp\u003e问题变为：\u003c/p\u003e\n\u003cp\u003e$$\n\\text{minimize}\\  f_{1}\\left(x_{1}\\right)+\\cdots+f_{n-1}\\left(x_{n-1}\\right)+f_{n}\\left(b-x_{1}-\\cdots-x_{n-1}\\right)\n$$\u003c/p\u003e\n\u003ch3 id=\"通过对偶的方式转换为无约束问题\"\u003e通过对偶的方式转换为无约束问题\u003c/h3\u003e\n\u003cp\u003e也就是前面对偶的解法\u003c/p\u003e\n\u003cp\u003e$$g(v) = -b^T + \\inf_x (f(x) + v^T Ax) = -b^Tv - f^{\\star} (-A^T v)$$\u003c/p\u003e\n\u003cp\u003e其中$f^{\\star}$是$f$的共轭，通过解对偶问题：\u003c/p\u003e\n\u003cp\u003e$$\n\\text{maximize}\\ -b^T v - f^{\\star} (-A^T v)\n$$\u003c/p\u003e\n\u003cp\u003e就可以使用无约束的优化方法来求解\u003c/p\u003e\n\u003cp\u003e通过KKT条件可以知道，最优解$x^{\\star}$满足：\n$$\nAx^{\\star} = b \\newline\n\\nabla f(x^{\\star}) + A^T v^{\\star} = 0\n$$\u003c/p\u003e\n\u003ch3 id=\"拓展newton法\"\u003e拓展Newton法\u003c/h3\u003e\n\u003cp\u003e牛顿法除了求解无约束优化问题外，也可以用于求解带等式约束的凸优化问题。\u003c/p\u003e\n\u003cp\u003e在此之前先讨论等式约束凸二次规划问题：\n$$\n\\begin{array}{ll}\n\\text{ minimize } \u0026amp; f(x)=(1 / 2) x^{T} P x+q^{T} x+r \\newline\n\\text { subject to } \u0026amp; A x=b,\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e其KKT条件是：\n$Ax^{\\star} = b, Px^{\\star} + q + A^T v^{\\star} = 0$\u003c/p\u003e\n\u003cp\u003e可以写成矩阵形式：\n$$\n\\left[\\begin{array}{cc}\nP \u0026amp; A^{T} \\newline\nA \u0026amp; 0\n\\end{array}\\right]\\left[\\begin{array}{l}\nx^{\\star} \\newline\n\\nu^{\\star}\n\\end{array}\\right]=\\left[\\begin{array}{c}\n-q \\newline\nb\n\\end{array}\\right]\n$$\u003c/p\u003e\n\u003cp\u003e也称为KKT矩阵\u003c/p\u003e\n\u003cp\u003e这里有等式约束的拓展牛顿法与无约束的牛顿法不同的是需要保证牛顿方向$\\Delta x_{nt}$是可行的，也就是：$A \\Delta x_{nt} = 0$\u003c/p\u003e\n\u003cp\u003e等式约束问题：\n$$\n\\begin{array}{ll}\n\\text{ minimize } \u0026amp; f(x) \\newline\n\\text { subject to } \u0026amp; Ax = b\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e在可行点$x$处的牛顿方向$\\Delta x_{nt}$，目标函数转换为二阶近似：\n$$\n\\begin{array}{ll}\n\\text{ minimize } \u0026amp; f(x+v) = f(x) + \\nabla f(x)^T v + (1/2) v^T \\nabla^2 f(x) v\\newline\n\\text { subject to } \u0026amp; A(x+v) = b\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e这里的KKT矩阵是：\u003c/p\u003e\n\u003cp\u003e$$\n\\left[\\begin{array}{cc}\n\\nabla^2 f(x) \u0026amp; A^{T} \\newline\nA \u0026amp; 0\n\\end{array}\\right]\\left[\\begin{array}{c}\n\\Delta x_{\\mathrm{nt}} \\newline\nw\n\\end{array}\\right]=\\left[\\begin{array}{c}\n-\\nabla f(x) \\newline\n0\n\\end{array}\\right]\n$$\u003c/p\u003e\n\u003cp\u003e等式约束的牛顿减量定义为：\n$$\n\\lambda(x)=\\left(\\Delta x_{\\mathrm{nt}}^{T} \\nabla^2 f(x) \\Delta x_{\\mathrm{nt}}\\right)^{1 / 2}\n$$\u003c/p\u003e\n\u003cp\u003e等式约束优化问题的牛顿法：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e计算牛顿方向$\\Delta x_{nt}$和牛顿减量$\\lambda(x)$\u003c/li\u003e\n\u003cli\u003e如果$\\frac{\\lambda^2}2 \\leq \\epsilon$就退出\u003c/li\u003e\n\u003cli\u003e直线搜索确定步长\u003c/li\u003e\n\u003cli\u003e$x = x+t \\Delta x_{nt}$\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"带不等式约束的凸优化问题\"\u003e带不等式约束的凸优化问题\u003c/h2\u003e\n\u003cp\u003e带不等式约束的凸优化问题，通过障碍法将不等式约束加入目标函数，从而把问题转换为带等式约束的优化问题，从而可以使用上一节的方法进行求解。\u003c/p\u003e\n\u003cp\u003e对于凸优化问题：\n$$\n\\begin{array}{ll}\n\\text{ minimize } \u0026amp; f_0(x) \\newline\n\\text { subject to } \u0026amp; f_{i}(x) \\leq 0, \\quad i=1, \\ldots, m \\newline\n\u0026amp; Ax = b\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e对数障碍法：\u003c/p\u003e\n\u003cp\u003e将其转换为等式约束问题：\n$$\n\\begin{array}{ll}\n\\text{ minimize } \u0026amp; f_0(x) + \\sum_{i=0}^m I_-(f_i(x)) \\newline\n\\text { subject to } \u0026amp; Ax = b\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e其中\n$$I_- (x) = \\left \\{  \\begin{array}{ll} 0 \u0026amp; \\text{if } x \\leq 0 \\newline \\infty \u0026amp; \\text{otherwise} \\end{array}   \\right . $$\u003c/p\u003e\n\u003cp\u003e也就是说不满足不等式约束的话，就让目标函数无限大，否则就没影响。\n但是这个函数不可导，所以采用一个对数函数来近似：\u003c/p\u003e\n\u003cp\u003e$$I_- (x) = -\\frac{1}{t} log(-x)$$\u003c/p\u003e\n\u003cp\u003e定义$\\phi(x) =  - \\sum_{i=1}^m \\log(-f_i(x))$为对数障碍函数，其梯度为：\n$$\n\\nabla \\phi(x) = \\sum_{i=1}^m \\frac{1}{-f_i(x)} \\nabla f_i(x)\n$$\n其Hessian矩阵为：\n$$\n\\nabla^2 \\phi(x)=\\sum_{i=1}^{m} \\frac{1}{-f_{i}(x)} \\nabla^2 f_{i}(x)+\\sum_{i=1}^{m} \\frac{1}{f_{i}(x)^2} \\nabla f_{i}(x) \\nabla f_{i}(x)^{T}\n$$\u003c/p\u003e\n\u003ch2 id=\"例题\"\u003e例题\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003e给定函数$f(x)=(6+x_1+x_2)^2+(2-3x_1-3x_2-x_1x_2)^2$，求在点$(\\hat{X}=(-4,6)^T)$处的牛顿方向$d$\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e$$\n\\nabla^T f(x) = \\left [ \\begin{array}{cc} 2(6 + x_1 + x_2) + 2(2-3x_1 - 3x_2 - x_1 x_2 )(-3-x_2) \\newline 2(6 + x_1 + x_2) + 2(2-3x_1 - 3x_2 - x_1 x_2 )(-3-x_2) \\end{array} \\right ] = \\left [ \\begin{array}{cc} -344 \\newline 56 \\end{array} \\right ]\n$$\u003c/p\u003e\n\u003cp\u003e$$\n\\nabla^2 f(x) = \\left [ \\begin{array}{cc} 2 + 2(3+x_2)^2 \u0026amp; 2 + 2(3+x_1)(3+x_2) -2 (2-3x_1 - 3x_2 -x_1 x_2)\\newline 2 + 2(3+x_2)(3+x_1) -2 (2-3x_1 - 3x_2 -x_1 x_2) \u0026amp; 2 + 2(3+x_1)^2 \\end{array} \\right ] = \\left [ \\begin{array}{cc} 164 \u0026amp; -56 \\newline -56 \u0026amp; 4 \\end{array} \\right ]\n$$\u003c/p\u003e\n\u003cp\u003e$$\n[\\nabla^2 f(x)]^{-1} = -\\frac{1}{2480} \\left [ \\begin{array}{cc} 4 \u0026amp; 56 \\newline 56 \u0026amp; 164 \\end{array} \\right ]\n$$\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\n\\triangle x_{nt} \u0026amp;= -(\\nabla^2 f(x))^{-1} \\nabla f^T(x)\\newline\n\u0026amp;=\\frac{1}{2480} \\left [ \\begin{array}{cc} 4 \u0026amp; 56 \\newline 56 \u0026amp; 164 \\end{array} \\right ] \\left [ \\begin{array}{cc} -344 \\newline 56 \\end{array} \\right ] = \\left [ \\begin{array}{cc} -0.709677 \\newline 4.064516 \\end{array} \\right ]\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e牛顿方向为$d = \\left [ \\begin{array}{cc} -0.709677 \\newline 4.064516 \\end{array} \\right ]$\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e利用牛顿法求解$\\min f(x) = (x_1 - 4)^2 + x_2^4$并给出迭代过程，初始点为$[0\\ 1]^T$\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e第一次迭代：\n$$\n\\nabla^T f(x^0) = \\left [ \\begin{array}{cc} 2(x_1 -4)\\newline 4x_2^3 \\end{array} \\right ] = \\left [ \\begin{array}{cc} -8 \\newline 4 \\end{array} \\right ]\n$$\u003c/p\u003e\n\u003cp\u003e$$\n\\nabla^2 f(x^0) = \\left [ \\begin{array}{cc} 2 \u0026amp; 0\\newline 0 \u0026amp; 12x_2^2 \\end{array} \\right ] = \\left [ \\begin{array}{cc} 2 \u0026amp; 0\\newline 0 \u0026amp; 12 \\end{array} \\right ]\n$$\u003c/p\u003e\n\u003cp\u003e$$\n[\\nabla^2 f(x^0)]^{-1} = \\left [ \\begin{array}{cc} \\frac{1}2 \u0026amp; 0 \\newline 0 \u0026amp; \\frac{1}{12} \\end{array} \\right ]\n$$\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\nx^1 \u0026amp;= x^0 + \\triangle x^0_{nt} = x^0 -(\\nabla^2 f(x^0))^{-1} \\nabla f^T(x^0)\\newline\n\u0026amp;=\\left [ \\begin{array}{cc} 0 \\newline 1 \\end{array} \\right ] - \\left [ \\begin{array}{cc} \\frac{1}2 \u0026amp; 0 \\newline 0 \u0026amp; \\frac{1}{12} \\end{array} \\right ]  \\left [ \\begin{array}{cc} -8 \\newline 4 \\end{array} \\right ] = \\left [ \\begin{array}{cc} 4 \\newline \\frac2{3} \\end{array} \\right ]\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e第二次迭代：\u003c/p\u003e\n\u003cp\u003e$$\n\\nabla^T f(x^1) = \\left [ \\begin{array}{cc} 2(x_1 -4)\\newline 4x_2^3 \\end{array} \\right ] = \\left [ \\begin{array}{cc} 0 \\newline \\frac{32}{27} \\end{array} \\right ]\n$$\u003c/p\u003e\n\u003cp\u003e$$\n\\nabla^2 f(x^1) = \\left [ \\begin{array}{cc} 2 \u0026amp; 0\\newline 0 \u0026amp; 12x_2^2 \\end{array} \\right ] = \\left [ \\begin{array}{cc} 2 \u0026amp; 0\\newline 0 \u0026amp; \\frac{16}{3} \\end{array} \\right ]\n$$\u003c/p\u003e\n\u003cp\u003e$$\n[\\nabla^2 f(x^1)]^{-1} = \\left [ \\begin{array}{cc} \\frac{1}2 \u0026amp; 0 \\newline 0 \u0026amp; \\frac{3}{16} \\end{array} \\right ]\n$$\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\nx^2 \u0026amp;= x^1 + \\triangle x^1_{nt} = x^1 -(\\nabla^2 f(x^1))^{-1} \\nabla f^T(x^1)\\newline\n\u0026amp;=\\left [ \\begin{array}{cc} 4 \\newline \\frac2{3} \\end{array} \\right ] - \\left [ \\begin{array}{cc} \\frac{1}2 \u0026amp; 0 \\newline 0 \u0026amp; \\frac{3}{16} \\end{array} \\right ]  \\left [ \\begin{array}{cc} 0 \\newline \\frac{32}{27} \\end{array} \\right ] = \\left [ \\begin{array}{cc} 4 \\newline \\frac{4}{9} \\end{array} \\right ]\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e第三次迭代：\n同理\n$$\n\\begin{array}{ll}\nx^3 \u0026amp;= x^2 + \\triangle x^2_{nt} = x^2 -(\\nabla^2 f(x^2))^{-1} \\nabla f^T(x^2)\\newline\n\u0026amp;=\\left [ \\begin{array}{cc} 4 \\newline \\frac{4}{9} \\end{array} \\right ] - \\left [ \\begin{array}{cc} \\frac{1}2 \u0026amp; 0 \\newline 0 \u0026amp; \\frac{27}{64} \\end{array} \\right ]  \\left [ \\begin{array}{cc} 0 \\newline \\frac{256}{729} \\end{array} \\right ] = \\left [ \\begin{array}{cc} 4 \\newline \\frac{8}{27} \\end{array} \\right ]\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e之后同理\u003c/p\u003e\n","date":1641834552,"description":"","fuzzywordcount":3700,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"a3bcbc491c86547facf1d3dc009dc361","publishdate":1641834552,"relpermalink":"/posts/convex-5/","section":"posts","summary":"包括无约束优化问题、带等式约束和不等式约束的凸优化问题的求解 无约束优化问题 无约束优化问题： $$ \\text { minimize } f_0(x) $$ 对于凸问题而言，只有一个条件 $$ \\nabla f (x^{\\star}) = 0 $$ 强凸性 存在一个","tags":["凸优化","数学"],"title":"凸优化（五）算法","url":"https://blog.engine.wang/posts/convex-5/","wordcount":3697},{"categories":"posts","content":"\u003ch2 id=\"lagrange函数\"\u003eLagrange函数\u003c/h2\u003e\n\u003cp\u003e原优化问题：\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\n\\text{ minimize } \u0026amp; f_0(x) \\newline\n\\text { subject to } \u0026amp; f_{i}(x) \\leq 0, \\quad i=1, \\ldots, m \\newline\n\u0026amp; h_i(x) = 0, \\quad i=1, \\ldots, p\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003eLagrange函数是在优化目标中考虑约束条件，添加约束条件的加权和：\u003c/p\u003e\n\u003cp\u003e$$L(x, \\lambda, v) = f_0(x) + \\sum^m_{i=1}\\lambda_if_i(x) + \\sum^p_{i=1}v_i h_i(x)$$\u003c/p\u003e\n\u003cp\u003e其中包含三个自变量，$x$是原来优化问题的自变量，$\\lambda$对应不等式约束，向量维度和不等式约束个数相同，$v$对应等式约束，向量维度和等式约束个数相同\u003c/p\u003e\n\u003cp\u003e如果$x$确定了，对于$\\lambda$和$v$相当于线性函数\u003c/p\u003e\n\u003ch2 id=\"拉格朗日对偶函数\"\u003e拉格朗日对偶函数\u003c/h2\u003e\n\u003cp\u003e拉格朗日对偶函数的形式为：\u003c/p\u003e\n\u003cp\u003e$$g(\\lambda, v) = \\inf_{x \\in \\mathcal{D}} L(x, \\lambda, v) = \\inf_{x \\in \\mathcal{D}}(f_0(x) + \\sum^m_{i=1}\\lambda_if_i(x) + \\sum^p_{i=1}v_i h_i(x))$$\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. 不管原问题是什么问题，对偶函数一定是凹函数\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e因为是取inf的分段线性函数\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. 对偶函数构成了原优化问题的下界，也就是$g(\\lambda, v) \\leq p^\\star $\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e$p^\\star $是原优化问题的最优值\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e证明：\n假设最优解为$x^\\star $，对应的最优值是$f_0(x^\\star ) = p^\\star $，最优解必然满足约束：\n$$\nf_i(x) \\leq 0, g_i(x) = 0 \\to\n\\sum^m_{i=1}\\lambda_if_i(x) + \\sum^p_{i=1}v_i h_i(x) \\leq 0\n$$\n将最优解$x^\\star $代入拉格朗日函数：\n$$\n\\begin{array}{ll}\nL(x^\\star , \\lambda, v) \u0026amp;=  f_0(x^\\star ) + \\sum^m_{i=1}\\lambda_if_i(x^\\star ) + \\sum^p_{i=1}v_i h_i(x^\\star ) \\newline \u0026amp;\\leq p^\\star  g(\\lambda, v) \\leq L(x^\\star , \\lambda, v) \\leq p^\\star\n\\end{array}\n$$\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e为了获得最大的下界，可以对$g$求极大，极大化凹函数也是一个凸问题。也就是将原问题转变为求解它的对偶函数：\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\n\\text{ maximize } \u0026amp; g(\\lambda, v) \\newline\n\\text { subject to } \u0026amp; \\lambda \\geq 0\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e拉格朗日对偶问题的最优解$d^\\star $，对应的解称为最优拉格朗日乘子$\\lambda^\\star , v^\\star $\n原问题的最优解$p^\\star $，有以下式子成立：\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\nd^\\star  \\leq p^\\star\n\\end{array}\n$$\u003c/p\u003e\n\u003ch3 id=\"例\"\u003e例\u003c/h3\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\n\\text { minimize } \u0026amp; x^T x \\newline\n\\text { subject to } \u0026amp; Ax = b\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e其拉格朗日函数为：（这里没有不等式约束，所以没有$\\lambda$只有$v$）\n$$\nL(x, v) = x^T x + v^T(Ax - b )\n$$\u003c/p\u003e\n\u003cp\u003e拉格朗日对偶函数为\n$$\ng(v) = \\inf_{x \\in \\mathcal{D}} L(x, v) = \\inf_{x \\in \\mathcal{D}} x^T x + v^T Ax - v^T b\n$$\u003c/p\u003e\n\u003cp\u003e求极小值有：\u003c/p\u003e\n\u003cp\u003e$$\\frac{\\partial L(x, v)}{\\partial x} = 2x + A^T v = 0 \\to x = - \\frac{A^T v}2$$\u003c/p\u003e\n\u003cp\u003e代入$x$有\u003c/p\u003e\n\u003cp\u003e$$\n\\frac{v^T AA^Tv}{4} - \\frac{v^T AA^Tv}2 - v^Tb = -\\frac{v^T AA^Tv}{4} - bv^T\n$$\u003c/p\u003e\n\u003cp\u003e变成了一个关于$v$的凹二次函数\u003c/p\u003e\n\u003ch3 id=\"例-1\"\u003e例\u003c/h3\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\n\\text { minimize } \u0026amp; c^T x \\newline\n\\text { subject to } \u0026amp; Ax = b \\newline\n\u0026amp; x \\geq 0\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e先转换为标准形式：\n$$\n\\begin{array}{ll}\n\\text { minimize } \u0026amp; c^T x \\newline\n\\text { subject to } \u0026amp; Ax - b = 0 \\newline\n\u0026amp;  -x \\leq 0\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e拉格朗日函数为：\n$$\nL(x, \\lambda, v) = c^T x - \\lambda^T x + v^T(Ax-b) = -b^Tv + (c + A^T v - \\lambda)x\n$$\u003c/p\u003e\n\u003cp\u003e是$x$的线性函数，如果$x$系数是0，那么极小值就是$-b^Tv$，如果不是0，那么就是$-\\infty$\u003c/p\u003e\n\u003cp\u003e拉格朗日对偶函数为：\n$$\ng(\\lambda, v) = \\inf_x L(x, \\lambda, v) = \\begin{cases}\n-b^T v , \u0026amp; \\text{if } A^Tv + c - \\lambda = 0\\newline\n-\\infty, \u0026amp; \\text{otherwise } \\end{cases} $$\u003c/p\u003e\n\u003cp\u003e上面是仿射函数，加上其他情况的负无穷拓展是凹函数\u003c/p\u003e\n\u003cp\u003e要求它的极大值，负无穷的情况可以直接不考虑，也就是原问题转换为：\n$$\n\\begin{array}{ll}\n\\text { max } \u0026amp; -b^T v \\newline\n\\text { subject to } \u0026amp; \\lambda \\geq 0 \\newline\n\u0026amp; A^Tv + c - \\lambda = 0\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e即：\n$$\n\\begin{array}{ll}\n\\text { max } \u0026amp; -b^T v \\newline\n\\text { subject to } \u0026amp; A^Tv + c \\geq 0\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e和原问题的最优解相同，最优值不同\u003c/p\u003e\n\u003ch3 id=\"例-2\"\u003e例\u003c/h3\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\n\\text { minimize } \u0026amp; f_0(x) \\newline\n\\text { subject to } \u0026amp; Ax \\leq b \\newline\n\u0026amp; cx = d\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e拉格朗日函数为：\n$$\nL(x, \\lambda, v) = f_0(x) + \\lambda^T(Ax-b) + v^T(cx-d)\n$$\u003c/p\u003e\n\u003cp\u003e对$x$求极小\u003c/p\u003e\n\u003cp\u003e$$\ng(\\lambda, v) = \\inf_{x\\in dom f} L(x, \\lambda, v) = \\inf_{x\\in dom f} f_0(x) + \\lambda^T(Ax-b) + v^T(cx-d)\n$$\u003c/p\u003e\n\u003cp\u003e之后可以使用共轭函数（略）\u003c/p\u003e\n\u003ch2 id=\"强对偶与弱对偶\"\u003e强对偶与弱对偶\u003c/h2\u003e\n\u003cp\u003e之前说，对偶问题的最优解$d^\\star $必然小于等于原问题的最优解$p^\\star $\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e弱对偶\u003c/strong\u003e：满足$p^\\star  \\geq d^\\star $，原问题不管是否为凸，该式总成立\n\u003cstrong\u003e强对偶\u003c/strong\u003e：满足$p^\\star  = d^\\star $，需要满足一些条件才能达到强对偶\u003c/p\u003e\n\u003cp\u003e在凸优化问题中，能够保证强对偶成立的条件被称为constraint qualiﬁcations\u003c/p\u003e\n\u003cp\u003e其中一种就是Slater条件\u003c/p\u003e\n\u003ch2 id=\"slater条件\"\u003eSlater条件\u003c/h2\u003e\n\u003cp\u003e有时简称为SCQ，该条件表述为：\u003c/p\u003e\n\u003cp\u003e对于凸优化问题：\n$$\n\\begin{array}{ll}\n\\text{ minimize } \u0026amp; f_0(x) \\newline\n\\text { subject to } \u0026amp; f_{i}(x) \\leq 0, \\quad i=1, \\ldots, m \\newline\n\u0026amp; Ax = b\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e如何存在可行解$x \\in int \\mathcal{D}$，使得：\n$$\nAx = b, f_i(x) \u0026lt; 0, i = 1, ...m\n$$\n那么就能保证强对偶性\u003c/p\u003e\n\u003ch2 id=\"kkt条件\"\u003eKKT条件\u003c/h2\u003e\n\u003cp\u003eKKT条件给出了最优解需要满足的必要条件，是求解优化问题最优解的一个重要方式。\u003c/p\u003e\n\u003cp\u003e对偶问题是：\n$$\nd^\\star  = \\sup_{\\lambda, v} \\inf_{x} L(x,\\lambda, v)\n$$\u003c/p\u003e\n\u003cp\u003e原问题是：\n$$\np^\\star  = \\inf_x \\sup_{\\lambda, v} L(x, \\lambda, v)\n$$\u003c/p\u003e\n\u003cp\u003e弱对偶性实际上就是max-min不等式：\n$$\n\\sup_{\\lambda, v} \\inf_{x} L(x,\\lambda, v) \\leq \\inf_x \\sup_{\\lambda, v} L(x, \\lambda, v)\n$$\u003c/p\u003e\n\u003cp\u003e强对偶性就是：\n$$\n\\sup_{\\lambda, v} \\inf_{x} L(x,\\lambda, v) = \\inf_x \\sup_{\\lambda, v} L(x, \\lambda, v) = L(x^\\star , \\lambda^\\star , v^\\star )\n$$\u003c/p\u003e\n\u003cp\u003e$x^\\star , \\lambda^\\star , v^\\star $也就是拉格朗日函数的鞍点，强对偶性下，$f_0(x^\\star ) = g(\\lambda^\\star , v^\\star )$\u003c/p\u003e\n\u003cp\u003e有：\u003c/p\u003e\n\u003cp\u003e$$\nf_0(x^\\star ) = g(\\lambda^\\star , v^\\star ) = \\inf_x (f_0(x) + \\lambda^{\\star T}f(x) + v^{\\star T}h(x)) \\leq f_0(x) + \\lambda^{\\star T}f(x) + v^{\\star T}h(x) \\leq f_0(x^\\star )\n$$\u003c/p\u003e\n\u003cp\u003e也就是要让这两个$\\leq$都变成$=$\u003c/p\u003e\n\u003cp\u003e第一个不等号取等号的条件是：\n$$\n\\nabla_{x}\\left(f_0(x)+\\lambda^{\\star T} f(x)+\\nu^{\\star T} h(x)\\right)=0\n$$\u003c/p\u003e\n\u003cp\u003e第二个不等式取等号的条件是：\n$$\n\\lambda_i^{\\star T} f_i(x) = 0, \\forall i\n$$\u003c/p\u003e\n\u003cp\u003e上面一个条件共同构成了KKT条件：\u003c/p\u003e\n\u003ch3 id=\"1-原始约束\"\u003e1. 原始约束\u003c/h3\u003e\n\u003cp\u003e$f_i(x) \\leq 0, i = 0, ..., m$\n$h_i(x) = 0, i = 1, ..., p$\u003c/p\u003e\n\u003ch3 id=\"2-对偶约束\"\u003e2. 对偶约束\u003c/h3\u003e\n\u003cp\u003e$\\lambda \\geq 0$\u003c/p\u003e\n\u003ch3 id=\"3-互补松弛性\"\u003e3. 互补松弛性\u003c/h3\u003e\n\u003cp\u003e$\\lambda_i f_i(x) = 0, i, ..., m$\u003c/p\u003e\n\u003ch3 id=\"4-极值条件稳定性条件\"\u003e4. 极值条件（稳定性条件）\u003c/h3\u003e\n\u003cp\u003e$\\nabla_{x}\\left(f_0(x)+\\lambda_i f_i(x)+\\nu_i h_i(x)\\right)=0$\u003c/p\u003e\n\u003cp\u003e对于一般情况而言，KKT条件只是必要条件。\n但对于凸优化问题而言，如果有强对偶性，即满足Slater条件，则KKT条件是最优化性的\u003cstrong\u003e充要条件\u003c/strong\u003e\u003c/p\u003e\n\u003ch2 id=\"例题\"\u003e例题\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003e注水问题，将值为1的总功率分配给不同的信道，使得总的通信功率最大，即考虑如下优化问题：\n$$\n\\begin{array}{ll}\n\\text { minimize } \u0026amp; -\\sum_{i=1}^{n} \\log (x_{i}+\\alpha_{i}) \\newline\n\\text { subject to } \u0026amp; x \\succcurlyeq 0 \\newline\n\u0026amp; 1^{T} x=1\n\\end{array}\n$$\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e拉格朗日函数为：\n$$\nL(x, \\lambda, v) = -\\sum_{i=1}^{n} \\log s(x_{i}+\\alpha_{i}) - \\lambda^T x + v^T(1^T x - 1)\n$$\n拉格朗日对偶函数为：\n$$\ng(\\lambda, v) = \\inf_{x\\in D} L(x, \\lambda, v) = \\inf_{x\\in D} (-\\sum_{i=1}^{n} \\log s(x_{i}+\\alpha_{i}) - \\lambda^T x + v^T(1^T x - 1))\n$$\nKKT条件为：\n$$\nx \\succcurlyeq 0 \\newline\n1^{T} x=1 \\newline\n\\lambda \\succcurlyeq 0 \\newline\n\\lambda_i^T x_i = 0, i = 1, ... ,n \\newline\n\\frac{1}{x_i + \\alpha_i} + \\lambda_i = v, i = 1, ... ,n \\newline\n$$\n如果$v \\geq \\frac{1}{\\alpha_i}$，那么只有可能$x_i = 0$\n如果$v \u0026lt; \\frac{1}{\\alpha_i}$，那么$\\lambda_i = 0$，$x = \\frac{1}{v} - \\alpha_i$\n最后有：\n$$\nx^{\\star}=\\left\\{\\begin{array}{l}\n1 / v^{\\star}-\\alpha_{i} \\quad v^{\\star}\u0026lt;1 / \\alpha_{i} \\newline\n0 \\quad v^{\\star} \\geq 1 / \\alpha_{i}\n\\end{array}\\right.\n$$\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e考虑问题：\n$$\n\\begin{array}{ll}\n\\underset{\\boldsymbol{x} \\in \\mathbb{R}^{n}}{\\operatorname{minimize}} \u0026amp; f(\\boldsymbol{x})=\\boldsymbol{c}^{T} \\boldsymbol{x} \\newline\n\\text { subject to } \u0026amp; \\boldsymbol{A} \\boldsymbol{x} \\geq \\boldsymbol{b} \\newline\n\u0026amp; \\boldsymbol{x} \\geq \\mathbf0\n\\end{array}\n$$\n分别基于集合约束$x \\in X=\\left\\{\\boldsymbol{x} \\in \\mathbb{R}^{n} \\mid \\boldsymbol{x} \\geq \\mathbf0\\right\\}$和$x \\in X=\\mathbb{R}^{n}$写出该问题的对偶问题。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e首先看第一个集合约束，此时第二个约束因为已经在集合约束里了，不需要单独考虑了，拉格朗日函数为：\n$$\nL(x, \\lambda) = c^T x + \\lambda(b - Ax) = (c^T - \\lambda^T A)x + \\lambda^T b\n$$\n对偶函数$$\ng(\\lambda) = \\inf_x L(x, \\lambda)\n$$\u003c/p\u003e\n\u003cp\u003e因为$x \\geq 0$，如果$c^T - \\lambda^T A \u0026lt; 0$的话，只要取$x = + \\infty$，就会使得对偶函数为$- \\infty$，因此对偶问题要增加约束$c^T - \\lambda^T A \\geq 0$，在此约束下，需要取$x=0$使得$g(\\lambda)$最小，值为$\\lambda^T b$\u003c/p\u003e\n\u003cp\u003e对偶问题为：\n$$\\begin{array}{ll}\\underset{\\boldsymbol{\\lambda} \\in \\mathbb{R}^m}{\\operatorname{maximize}} \u0026amp; \\boldsymbol{b}^{T} \\boldsymbol{\\lambda} \\newline \\text { subject to } \u0026amp; \\boldsymbol{\\lambda}^{T} \\boldsymbol{A} \\leq \\boldsymbol{c}^{T} \\newline \u0026amp; \\boldsymbol{\\lambda} \\geq \\mathbf0\\end{array}$$\u003c/p\u003e\n\u003cp\u003e第二个集合约束，没有对$x$的限制，拉格朗日函数为：\n$$\nc^T x + \\lambda_1(b-Ax) - \\lambda_2 x = (c^T - \\lambda_1^T A -\\lambda_2)x +\\lambda_1^T b\n$$\n对偶函数$$\ng(\\lambda_1, \\lambda_2) = \\inf_x L(x, \\lambda_1, \\lambda_2)\n$$\u003c/p\u003e\n\u003cp\u003e如果$c \\neq 0$，那么$g(\\lambda_1, \\lambda_2)$就是$- \\infty$，所以对偶问题为：\n$$\\begin{array}{ll}\\underset{\\boldsymbol{\\lambda_1, \\lambda_2} \\in \\mathbb{R}^m}{\\operatorname{maximize}} \u0026amp; \\boldsymbol{b}^{T} \\boldsymbol{\\lambda_1} \\newline \\text { subject to } \u0026amp; \\boldsymbol{c^T} - \\boldsymbol{\\lambda_1^T A} -\\boldsymbol{\\lambda_2} = 0\\newline \u0026amp; \\boldsymbol{\\lambda_1, \\lambda_2} \\geq \\mathbf0\\end{array}$$\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e一般线性规划的对偶，求解线性规划\n$$\n\\begin{array}{ll}\n\\operatorname{minimize} \u0026amp; c^{T} x \\newline\n\\text { subject to } \u0026amp; G x \\preceq h \\newline\n\u0026amp; A x=b\n\\end{array}\n$$\n的对偶函数，并将隐式等式约束显式表达\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e拉格朗日函数：\n$$\nL(x, \\lambda, v) = c^T x + \\lambda^T(Gx - h) + v^T(Ax - b)\n$$\u003c/p\u003e\n\u003cp\u003e对偶函数：\u003c/p\u003e\n\u003cp\u003e$$\ng(\\lambda, v) = \\inf_{x \\in D} L(x, \\lambda, v) = \\inf_{x \\in D} (c^T x + \\lambda^T(Gx - h) + v^T(Ax - b)) $$\u003c/p\u003e\n\u003cp\u003e$$= \\left \\{ \\begin{array}{ll} -\\lambda^T h - v^T b \u0026amp; \\text{if}\\ c+G^T \\lambda + A^T v = 0\\newline -\\infty \u0026amp; \\text{otherwise}  \\end{array} \\right .\n$$\u003c/p\u003e\n\u003cp\u003e对偶问题变为：\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\n\\text { maximize } \u0026amp; g(\\lambda, \\nu) \\newline\n\\text { subject to } \u0026amp; \\lambda \\geq 0\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e由于不能取负无穷的其他情况，所以增加的约束为：\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\n\\text { maximize} \u0026amp; -\\lambda^{T} h-\\nu^{T} b \\newline\n\\text { subject to } \u0026amp; c+G^{T} \\lambda+A^{T} \\nu=0 \\newline\n\u0026amp; \\lambda \\geq 0\n\\end{array}\n$$\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e解析中心，考虑优化问题：\n$$\n\\text {minimize} -\\sum_{i=1}^m \\log(b_i - a_i^T x)\n$$\n其定义域为${ x | a_i^T x \u0026lt; b_i, i = 1, ..., m }$，推导其对偶问题\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e代入$y_i = b_i - a_i^T x$ 得：\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\n\\text { maximize} \u0026amp; -\\sum_{i=1}^m \\log y_i \\newline\n\\text { subject to } \u0026amp; y_i = b_i - a_i^T x , i = 1, ... m\\newline\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e拉格朗日函数为：\u003c/p\u003e\n\u003cp\u003e$$\nL(x, y, v) = -\\sum_{i=1}^m \\log y_i + \\sum_{i=1}^n v^T(y_i - b_i + a_i x)\n$$\u003c/p\u003e\n\u003cp\u003e对偶函数为：\n$$\ng(v) = \\inf_{x, y}(-\\sum_{i=1}^m \\log y_i + \\sum_{i=1}^n v^T(y_i - b_i + a_i x))\n$$\u003c/p\u003e\n\u003cp\u003e如果$\\sum_{i=1}^m v^T a_i \\neq 0$，那么$x$可以让$g(v)$取$-\\infty$，如果$v \\leq 0$，那么$y$可以让$g(v)$取$-\\infty$，取最大时$y_i = \\frac{1}{v_i}$\u003c/p\u003e\n\u003cp\u003e有：\u003c/p\u003e\n\u003cp\u003e$$\ng(v) = \\left \\{ \\begin{array}{ll} \\sum_{i=1}^m (\\log v_i) -v^T b + m \u0026amp; \\sum_{i=1}^m v^T a_i = 0, v \u0026gt; 0\\newline -\\infty \u0026amp; \\text{otherwise}  \\end{array} \\right .\n$$\u003c/p\u003e\n\u003cp\u003e对偶问题为：\n$$\n\\begin{array}{ll}\n\\text { maximize} \u0026amp; \\sum_{i=1}^m (\\log v_i) -v^T b + m \\newline\n\\text { subject to } \u0026amp; \\sum_{i=1}^m v_i^T a_i = 0 , i = 1, ... m\\newline\n\u0026amp; v \u0026gt; 0, i = 1, ... m\\newline\n\\end{array}\n$$\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e写出下面优化问题的KKT条件，并求出最优解\n$$\n\\begin{array}{ll}\n\\text { minimize } \u0026amp; -3 x_{1}^2+x_2^2+2 x_{3}^2+2\\left(x_{1}+x_2+x_{3}\\right) \\newline\n\\text { subject to } \u0026amp; x_{1}^2+x_2^2+x_{3}^2=1\n\\end{array}\n$$\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eKKT条件：\u003c/p\u003e\n\u003cp\u003e1、原始约束：$x_{1}^2+x_2^2+x_{3}^2=1$\u003c/p\u003e\n\u003cp\u003e2、对偶约束：无\u003c/p\u003e\n\u003cp\u003e3、互补松弛性约束：无\u003c/p\u003e\n\u003cp\u003e4、稳定性条件：$(-3+v)x_1 + 1 = 0, (1+v)x_2 + 1 = 0, (2+v)x_3 + 1 = 0$\u003c/p\u003e\n\u003cp\u003e通过稳定性条件将$x_1, x_2, x_3$全部替换成$v$然后代入原始约束，解出四个解：\n$v = -3.15, v = 0.22, v = 1.89, v = 4.04$\u003c/p\u003e\n\u003cp\u003e代入，最大的是$(v, x_1, x_2, x_3) = (-3.15, 0.16, 0.47, -0.87)$，$f_0^\\star(x^\\star) = 1.17$\u003c/p\u003e\n","date":1641734705,"description":"","fuzzywordcount":3400,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"63e7004a2822cf1303875896aab13498","publishdate":1641734705,"relpermalink":"/posts/convex-4/","section":"posts","summary":"Lagrange函数 原优化问题： $$ \\begin{array}{ll} \\text{ minimize } \u0026amp; f_0(x) \\newline \\text { subject to } \u0026amp; f_{i}(x) \\leq 0, \\quad i=1, \\ldots, m \\newline \u0026amp; h_i(x) = 0, \\quad i=1, \\ldots, p \\end{array} $$ Lagrange函数是在优化目标中考虑约束条件，添加约束条件的加","tags":["凸优化","数学"],"title":"凸优化（四）对偶","url":"https://blog.engine.wang/posts/convex-4/","wordcount":3358},{"categories":"posts","content":"\u003ch2 id=\"基本形式\"\u003e基本形式\u003c/h2\u003e\n\u003cp\u003e一般的优化问题的形式：\n$$\n\\begin{array}{ll}\n\\text { minimize } \u0026amp; f_0(x) \\newline\n\\text { subject to } \u0026amp; f_{i}(x) \\leq 0, \\quad i=1, \\ldots, m \\newline\n\u0026amp; h_{i}(x)=0, \\quad i=1, \\ldots, p\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e其中$x$是优化变量，$f_0(x)$是目标函数 ，$f_i(x)\\leq 0$是不等式约束，$h_i(x) = 0$是等式约束。如果$m=p=0$，就是无约束问题。\u003c/p\u003e\n\u003cp\u003e定义域为\n$$\n\\mathcal{D}=\\bigcap_{i=0}^{m} \\operatorname{dom} f_{i} \\cap \\bigcap_{i=1}^{p} \\operatorname{dom} h_{i}\n$$\u003c/p\u003e\n\u003cp\u003e如果满足目标函数是凸函数，不等式约束也是凸函数，等式约束函数是仿射函数。就是凸优化问题。\n$$\n\\begin{array}{ll}\n\\text{ minimize } \u0026amp; f_0(x) \\newline\n\\text { subject to } \u0026amp; f_{i}(x) \\leq 0, \\quad i=1, \\ldots, m \\newline\n\u0026amp; a_{i}^{T} x=b_{i}, \\quad i=1, \\ldots, p\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e定义域为：\n$$\n\\mathcal{D}=\\bigcap_{i=0}^{m} \\operatorname{dom} f_{i}\n$$\u003c/p\u003e\n\u003cp\u003e可行解集（feasible set），即在目标函数的定义域中的满足所有约束的解集：\n$$\nX_f = \\{x | x满足所有约束\\}\n$$\u003c/p\u003e\n\u003cp\u003e问题的最优值（optimal value），如果可行解集不是空集，总能在可行解集中找到一个值，使目标函数最小，这个解就是最优解：\n$$p^\\star  = inf\\{f_0(x)|x \\in X_f\\}$$\u003c/p\u003e\n\u003cp\u003e这里inf是下确界的意思，和min类似但是不完全相同。有可能有下确界但是无限趋近取不到，也就是有inf没有min。\u003c/p\u003e\n\u003cp\u003e凸优化问题的最重要性质（为什么要研究凸优化，为什么要转换为凸优化问题）：\u003cstrong\u003e局部最优 = 全局最优\u003c/strong\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e证明凸优化问题的局部最优=全局最优：\n$$\\newline$$\n一句话说明就是反证法假设在局部最优之外还能找到一个全局最优，根据凸函数的性质，就可以在局部最优的领域内找到更低的点，从而与局部最优矛盾，具体过程如下：\n$$\\newline$$\n反证法：假设局部最优解x不是全局最优解y。\n$$\\newline$$\n因为局部最优，所以一定能找到一个正数$R$，使得在$R$的范围内，$f_0(x)$是最小的，即：\n$$ \\exists R \u0026gt; 0 , f_0(x) = inf { f_0(z), ||x-z||_2\\leq R }$$\n假设全局最优解是$y$\n$$y \\neq x, f_0(y) \u0026lt; f_0(x), ||y-x||_2 \u0026gt; R$$\n由于是凸函数，在$x、y$中间的一点$ z= (1-\\theta) x + \\theta y$，有:\n$$f_0(z) \\leq (1-\\theta)f_0(x) + \\theta f_0(y)$$\n令$\\theta = \\frac{R}{2||y-x||_2}$\n因为可行域是凸集，z一定是可行解。\n计算得$||z-x||_2 = \\frac{R}2$（实际上前面取$\\theta$等于那个的目的就是为了让这里 z在x的邻域内）\n因为在邻域内x一定最优，所以$f_0(z) \u0026gt; f_0(x)$。最优点y的$f_0(y) \u0026lt; f_0(x)$\n结合前面的式子，有$f_0(z) \\leq (1-\\theta)f_0(x) + \\theta f_0(y) \u0026lt; f_0(z) $，矛盾了，找不到z，也就是说局部最优就是全局最优。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e可微的目标函数的最优解x，当且仅当：\n$$\\triangledown f_0(x)^T (y-x) \\geq 0\\ \\ \\ \\text{for all feasible}\\ y$$\u003c/p\u003e\n\u003cp\u003e用凸函数的一阶等价定义$f(y) \\geq f(x) + \\triangledown f^T(x) (y-x)$即可直接证明\u003c/p\u003e\n\u003ch2 id=\"等价问题\"\u003e等价问题\u003c/h2\u003e\n\u003ch3 id=\"box-constraint\"\u003eBox constraint\u003c/h3\u003e\n\u003cp\u003e例：\n$$\n\\begin{array}{ll}\n\\text { minimize } \u0026amp; f_0(x) \\newline\n\\text { subject to } \u0026amp; l_i \\leq x \\leq u_i, i = 1, ... ,n\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e改写为标准形式为\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\n\\text { minimize } \u0026amp; f_0(x) \\newline\n\\text { subject to } \u0026amp; l_i - x \\leq 0, i = 1, ... ,n \\newline\n\u0026amp; x - u_i \\leq 0, i = 1, ... ,n\n\\end{array}\n$$\u003c/p\u003e\n\u003ch3 id=\"函数等价变换\"\u003e函数等价变换\u003c/h3\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:center\"\u003e$\\psi_0$\u003c/th\u003e\n\u003cth style=\"text-align:center\"\u003e$R \\to R$\u003c/th\u003e\n\u003cth style=\"text-align:center\"\u003e单增\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center\"\u003e$\\psi_1, \\dots \\psi_m$\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e$R \\to R$\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e$\\psi_{i}(u) \\leq 0 \\Leftrightarrow u \\leq 0$\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center\"\u003e$ϱ_1,\\dots ϱ_p$\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e$R \\to R$\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e$ϱ_{i}(u) = 0 \\Leftrightarrow u = 0$\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e变为：\n$$\n\\begin{array}{lll}\n\\min \u0026amp; \\psi_0\\left(f_0(x)\\right) \u0026amp; \\newline\n\\text { s.t. } \u0026amp; \\psi_{i}\\left(f_{i}(x)\\right) \\leq 0 \u0026amp; i=1, \\ldots, m \\newline\n\u0026amp; \\varrho_{i}\\left(h_{i}(x)\\right)=0 \u0026amp; i=1, \\ldots, p\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e比如\n$$\n\\min |A x-b|_2 \\Leftrightarrow|A x-b|_2^2\n$$\u003c/p\u003e\n\u003ch3 id=\"消除或引入等式约束\"\u003e消除或引入等式约束\u003c/h3\u003e\n\u003cp\u003e比如\n$$\n\\begin{array}{ll}\n\\text { minimize } \u0026amp; f_0(x) \\newline\n\\text { subject to } \u0026amp; f_i (x) \\leq 0, i = 1, ... ,m \\newline\n\u0026amp; Ax = b\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e可以等价于：\n$$\n\\begin{array}{ll}\n\\text { minimize } \u0026amp; f_0(Fz + x_0) \\newline\n\\text { subject to } \u0026amp; f_i (Fz + x_0) \\leq 0, i = 1, ... ,m\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e从而消除一个等式约束，也可以从下往上，增加一个等式约束\u003c/p\u003e\n\u003ch3 id=\"松弛变量\"\u003e松弛变量\u003c/h3\u003e\n\u003cp\u003e将不等号通过松弛变量变为等号\n比如\n$$\n\\begin{array}{ll}\n\\text { minimize } \u0026amp; f_0(x) \\newline\n\\text { subject to } \u0026amp; a^T_i (x) \\leq b, i = 1, ... ,m \\newline\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e可以等价于：\n$$\n\\begin{array}{ll}\n\\text { minimize } \u0026amp; f_0(Fz + x_0) \\newline\n\\text { subject to } \u0026amp; a^T_i (x) + s_i = b, i = 1, ... ,m \\newline\n\u0026amp; s_i \\geq 0, i = 1, ... ,m\n\\end{array}\n$$\u003c/p\u003e\n\u003ch2 id=\"如何把实际问题转换为标准凸优化问题形式\"\u003e如何把实际问题转换为标准凸优化问题形式\u003c/h2\u003e\n\u003cp\u003e极大化一个凹目标函数，实际上就是凸优化问题\u003c/p\u003e\n\u003ch2 id=\"典型的凸优化问题\"\u003e典型的凸优化问题\u003c/h2\u003e\n\u003ch3 id=\"线性规划\"\u003e线性规划\u003c/h3\u003e\n\u003cp\u003e目标函数、等式约束、不等式约束均为线性\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\n\\text{ minimize } \u0026amp; c^{T} x+d \\newline\n\\text { subject to } \u0026amp; G x \\preceq h \\newline\n\u0026amp; A x=b\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e至少有一个最优解在顶点上\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641474386/convex-10.png\" alt=\"convex-10\"\u003e\u003c/p\u003e\n\u003ch3 id=\"二次规划\"\u003e二次规划\u003c/h3\u003e\n\u003cp\u003e目标是二次凸函数，约束函数均为线性\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\n\\text{ minimize } \u0026amp; (1 / 2) x^{T} P x+q^{T} x+r \\newline\n\\text { subject to } \u0026amp; G x \\preceq h \\newline\n\u0026amp; A x=b\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641474386/convex-11.png\" alt=\"convex-11\"\u003e\u003c/p\u003e\n\u003ch2 id=\"例题\"\u003e例题\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003e考虑优化问题：\n$$\n\\begin{array}{ll}\n\\text { minimize} \u0026amp; f_0\\left(x_{1}, x_2\\right) \\newline\n\\text { subject to } \u0026amp; 2 x_{1}+x_2 \\geqslant 1 \\newline\n\u0026amp; x_{1}+3 x_2 \\geqslant 1 \\newline\n\u0026amp; x_{1} \\geqslant 0, \\quad x_2 \\geqslant 0\n\\end{array}\n$$\n对下面每个目标函数给出最优解和最优值\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e（a）\n最优解$x^* = (\\frac2{5}, \\frac{1}{5})$\n最优值$f(x^*) = \\frac{3}{5}$\u003c/p\u003e\n\u003cp\u003e（b）\n目标函数没有下界\u003c/p\u003e\n\u003cp\u003e（c）\n最优解为$x^* = (0, x_2), x_2 \\geq 1$\n最优值$f(x^*) = 0$\u003c/p\u003e\n\u003cp\u003e（d）\n最优解$x^* = (\\frac{1}{3}, \\frac{1}{3})$\n最优值$f(x^*) = \\frac{1}{3}$\u003c/p\u003e\n\u003cp\u003e（e）\n最优解$x^* = (\\frac{1}2, \\frac{1}{6})$\n最优值$f(x^*) = \\frac{1}2$\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e考虑线性规划\n$$\n\\begin{array}{ll}\n\\text { minimize } \u0026amp; c^{T} A^{-1} y \\newline\n\\text { subject to } \u0026amp; y \\preceq b\n\\end{array}\n$$\nA是方阵且不奇异，说明其最优值由：\n$$\np^{\\star}= \\begin{cases}c^{T} A^{-1} b \u0026amp; A^{-T} c \\preceq 0 \\newline -\\infty \u0026amp; \\text { 其他情况 }\\end{cases}\n$$\n给出\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e令$Ax = y$，则有$x = A^{-1}y$\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\n\\text { minimize } \u0026amp; c^{T} A^{-1} y \\newline\n\\text { subject to } \u0026amp; y \\preceq b\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e如果$A^{-T} c \\preceq 0$，最优解即为$y=b$，否则y取$- \\infty$，函数无下界。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e网络流问题，网络总费用为$C = \\sum_{1,j=1}^n c_{ij}x_{ij}$，每个边流量$x_{ij}$同时收到下界$l_{ij}$和上界$u_{ij}$的约束，流出和流入的流量守恒。建模成一个线性规划问题\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e目标函数为：\n$$\n\\text{minimize}\\ C = \\sum_{1,j=1}^n c_{ij}x_{ij}\n$$\n约束有：\n$$\n\\left \\{  \\begin{array}{ll}\nl_{ij} \\leq x_{ij} \\leq u_{ij} \\newline\nb_i + \\sum_{j=1}^n x_{ij} - \\sum_{j=1}^n x_{ji} = 0\n\\end{array} \\right .\n$$\u003c/p\u003e\n\u003cp\u003e线性规划即为：\n$$\n\\begin{array}{ll}\n\\text { minimize } \u0026amp; C = \\sum_{1,j=1}^n c_{ij}x_{ij} \\newline\n\\text { subject to } \u0026amp; l_{ij} \\leq x_{ij} \\leq u_{ij} \\newline\n\u0026amp; b_i + \\sum_{j=1}^n x_{ij} - \\sum_{j=1}^n x_{ji} = 0， i = 1, ... n\n\\end{array}\n$$\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eGauss广播信道的最优功率与带宽配置，建模为凸优化问题\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e目标函数为：\n$$\n\\sum_{i=1}^{n} u_{i}\\left(R_{i}\\right) = \\sum_{i=1}^{n} u_{i}(\\alpha_{i} W_{i} \\log \\left(1+\\beta_{i} P_{i} / W_{i}\\right))\n$$\u003c/p\u003e\n\u003cp\u003e约束有：\n$$\n\\left \\{ \\begin{array}{ll}\n\\sum P_{i=1}^n = P_{tol}\\newline\n\\sum W_{i=1}^n = W_{tol}\\newline\n\\end{array} \\right .\n$$\u003c/p\u003e\n\u003cp\u003eR的Hassain矩阵为$$\n\\nabla^2 R_{i}=\\frac{-\\alpha_{i} \\beta_{i}^2}{W_{i}\\left(1+\\beta_{i} P_{i} / W_{i}\\right)^2}\\left[\\begin{array}{c}\n1 \\newline\n-P_{i}\n\\end{array}\\right]\\left[\\begin{array}{c}\n1 \\newline\n-P_{i}\n\\end{array}\\right]^{T}$$\n是负定的，说明$R_i$是凹的。总效用是凹函数的和，也是凹函数。\u003c/p\u003e\n","date":1641475505,"description":"","fuzzywordcount":2100,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"e3054796edf99919170537470d759e9a","publishdate":1641475505,"relpermalink":"/posts/convex-3/","section":"posts","summary":"基本形式 一般的优化问题的形式： $$ \\begin{array}{ll} \\text { minimize } \u0026amp; f_0(x) \\newline \\text { subject to } \u0026amp; f_{i}(x) \\leq 0, \\quad i=1, \\ldots, m \\newline \u0026amp; h_{i}(x)=0, \\quad i=1, \\ldots, p \\end{array} $$ 其中$x$是优化变量，$f_0(x)$是目标函数 ，$f_i(x)\\l","tags":["凸优化","数学"],"title":"凸优化（三）凸优化问题","url":"https://blog.engine.wang/posts/convex-3/","wordcount":2098},{"categories":"posts","content":"\u003ch2 id=\"凸函数的定义\"\u003e凸函数的定义\u003c/h2\u003e\n\u003ch3 id=\"定义一基本定义\"\u003e定义一（基本定义）\u003c/h3\u003e\n\u003cp\u003e函数$f: R^n \\to R$是凸函数，当且仅当：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e$f$的定义域是凸集\u003c/li\u003e\n\u003cli\u003e$\\forall x_1, x_2 \\in dom(f), \\forall \\theta \\in [0,1]$\n$f(\\theta x_1+(1-\\theta)x_2) \\leq \\theta f(x_1) + (1-\\theta)f(x_2)$\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e该式也叫Jenson不等式：\n$$f(\\theta x + (1-\\theta) y) \\leq \\theta f(x) + (1-\\theta)f(y)$$\u003c/p\u003e\n\u003cp\u003e拓展，对于任意随机变量z，有\n$$f(Ez) \\leq Ef(z)$$\u003c/p\u003e\n\u003cp\u003e通俗来讲，就是函数上任取两点，它们之间的连线都在函数的上面\u003c/p\u003e\n\u003cp\u003e如果2的$\\leq$换成$\u0026lt;$就是严格凸函数\u003c/p\u003e\n\u003ch3 id=\"定义二降至一维\"\u003e定义二（降至一维）\u003c/h3\u003e\n\u003cp\u003e函数$f: R^n \\to R$是凸函数，当且仅当：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e$f$的定义域是凸集\u003c/li\u003e\n\u003cli\u003e$\\forall x \\in dom\\ f, \\forall v, g(t) = f(x+tv)$为凸函数，$dom\\ g \\in dom\\ f$\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e相当于从高维降到一维，可以通过证明一维的函数$g(t)$来反证原函数$f(x)$，当然这个定义用的不多\u003c/p\u003e\n\u003ch3 id=\"定义三凸函数的一阶条件\"\u003e定义三（凸函数的一阶条件）\u003c/h3\u003e\n\u003cp\u003e若$f: R^n \\to R$一阶可微，则它是凸函数，当且仅当：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e$f$的定义域是凸集\u003c/li\u003e\n\u003cli\u003e$\\forall x, y \\in dom(f), f(y) \\geq f(x) + \\triangledown f(x)^T (y-x)$\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e通俗来讲，就是任何一点的切线，切线上的任何一点都小于等于函数\u003c/p\u003e\n\u003cp\u003e证明定义三：\u003c/p\u003e\n\u003cp\u003e充分性：首先因为是凸函数，定义域为凸集。代入$y \\to x+$即可\n必要性：构造$z = \\theta x + (1-\\theta)y$，然后代入f(x)和f(y)的一阶不等式到$\\theta f(x) + (1-\\theta) f(y)$中即可得到结果。\u003c/p\u003e\n\u003ch3 id=\"定义四凸函数的二阶条件\"\u003e定义四（凸函数的二阶条件）\u003c/h3\u003e\n\u003cp\u003e实际上用的最多，前提是二阶可微\u003c/p\u003e\n\u003cp\u003e若$f: R^n \\to R$二阶可微，则它是凸函数，当且仅当：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e$f$的定义域是凸集\u003c/li\u003e\n\u003cli\u003e$\\forall x \\in dom(f), \\triangledown f^2(x) \\geq 0$，即$f$的Hessian矩阵半正定（特征值均$\\geq 0$）\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003e如何判断矩阵的正定或负定？\n$$\\newline$$\n方法一、正定矩阵的顺序主子式均为正\n$$\\newline$$\n例：\n$$\n\\begin{array}{ccc}\n\\end{array}\n\\left |\n\\begin{array}{ccc}\n6 \u0026amp; -3 \u0026amp; 1 \\newline\n-3 \u0026amp; 2 \u0026amp; 0 \\newline\n1 \u0026amp; 0 \u0026amp; 4 \\newline\n\\end{array}\n\\right |\n$$\n三个顺序主子式依次为：\n$$\n\\left |\n\\begin{array}{ccc}\n6 \\newline\n\\end{array}\n\\right | = 6 \u0026gt; 0\n$$\n$$\n\\left |\n\\begin{array}{ccc}\n6 \u0026amp; -3 \\newline\n-3 \u0026amp; 2 \\newline\n\\end{array}\n\\right | = 3 \u0026gt; 0\n$$\n$$\n\\left |\n\\begin{array}{ccc}\n6 \u0026amp; -3 \u0026amp; 1 \\newline\n-3 \u0026amp; 2 \u0026amp; 0 \\newline\n1 \u0026amp; 0 \u0026amp; 4 \\newline\n\\end{array}\n\\right | = 10 \u0026gt; 0\n$$\n所以为正定矩阵\n$$\\newline$$\n方法二：$x^T H x \\geq 0$\n（一般用来求二阶的情况，高阶不好求。）\n$$\\newline$$\n例：\n$$\nH =\n\\begin{array}{ccc}\n\\end{array}\n\\left [\n\\begin{array}{ccc}\n3 \u0026amp; 2 \\newline\n2 \u0026amp; 1 \\newline\n\\end{array}\n\\right ]\n$$\n对于任意$x$，构造\n$$\nx^T \\begin{array}{ccc}\n\\end{array}\n\\left [\n\\begin{array}{ccc}\n3 \u0026amp; 1 \\newline\n1 \u0026amp; 1 \\newline\n\\end{array}\n\\right ] x = 3x_1^2 + 2x_1 x_2 + x_2^2 = 2x_1^2 + (x_1+x_2)^2 \\geq 0\n$$\n所以是半正定的\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e\u003cstrong\u003e注意，使用该方法时需要定义域是凸集，且二阶可微\u003c/strong\u003e，比如$f(x)=\\frac{1}{x^2}$，即使二阶导数$\\geq0$，因为在0不连续，定义域不是凸集，所以不是凸函数。\u003c/p\u003e\n\u003cp\u003e第一个要判断的就是定义域是否为凸集。然后看定义域内是否可导，比如某分段函数的某点是尖不可导，当然不能说一定凸/非凸，只是说不能用这个定义判断，要用基本定义来求。\u003c/p\u003e\n\u003cp\u003e如果取$\u0026gt;$，那么是严格凸的，但是并不是凸函数都能取$\u0026gt;$，比如$x^4$在0处的二阶导就是0\u003c/p\u003e\n\u003ch3 id=\"凸函数拓展\"\u003e凸函数拓展\u003c/h3\u003e\n\u003cp\u003e如果$f(x)$是凸函数，那么凸函数的拓展\u003c/p\u003e\n\u003cp\u003e$$\n\\bar{f}(x)= \\begin{cases}f(x) \u0026amp; x \\in \\operatorname{dom}(f) \\newline \\infty \u0026amp; x \\notin \\operatorname{dom}(f)\\end{cases}\n$$\u003c/p\u003e\n\u003cp\u003e也是凸函数，比较直观\u003c/p\u003e\n\u003ch2 id=\"常见的凸函数\"\u003e常见的凸函数\u003c/h2\u003e\n\u003ch3 id=\"仿射函数\"\u003e仿射函数\u003c/h3\u003e\n\u003cp\u003e$ f(x) = Ax + b$\u003c/p\u003e\n\u003cp\u003e$\\nabla^{2} f(x) = 0$\n仿射函数既是凸函数，又是凹函数\u003c/p\u003e\n\u003ch3 id=\"指数函数\"\u003e指数函数\u003c/h3\u003e\n\u003cp\u003e$f(x) = e^{ax}$\u003c/p\u003e\n\u003cp\u003e$\\nabla^{2} f(x) = a^2 e^{ax} \u0026gt; 0$\u003c/p\u003e\n\u003ch3 id=\"幂函数\"\u003e幂函数\u003c/h3\u003e\n\u003cp\u003e$f(x) = x^a$\u003c/p\u003e\n\u003cp\u003e分情况讨论\u003c/p\u003e\n\u003cp\u003e$$\\nabla^{2} f(x)=a(a-1) x^{a-2}=\\left\\{\\begin{array}{ll}\\geq 0 \u0026amp; a \\geq 1, a \\leq 0 \u0026amp; 凸\\newline \\leq 0 \u0026amp; a \\in[0,1]\u0026amp; 凹\\end{array}\\right.$$\u003c/p\u003e\n\u003ch3 id=\"绝对值幂函数\"\u003e绝对值幂函数\u003c/h3\u003e\n\u003cp\u003e$f(x) = |x|^p$\u003c/p\u003e\n\u003cp\u003e$$\nf^{\\prime \\prime}(x)= \\begin{cases}p(p-1) x^{p-2} \u0026amp; x \\geq 0 \\newline -p(p-1)(-x)^{p-2} \u0026amp; x\u0026lt;0\\end{cases}\n$$\u003c/p\u003e\n\u003cp\u003e情况比较复杂，需要对$p$分类讨论。\u003c/p\u003e\n\u003ch3 id=\"范数\"\u003e范数\u003c/h3\u003e\n\u003cp\u003e$R^n$空间的范数$P(x)$\u003c/p\u003e\n\u003cp\u003e有如下性质：\n① $P(ax) = |a|P(x)$\n② $P(x+y) \\leq P(x) + P(y)$\n③ $P(x) = 0 \\Leftrightarrow x = 0$\u003c/p\u003e\n\u003cp\u003e范数是凸函数，按照定义用性质②即可证明（零范数除外，零范数不满足①）\u003c/p\u003e\n\u003ch3 id=\"极大值函数\"\u003e极大值函数\u003c/h3\u003e\n\u003cp\u003e$f(x) = max\\{x_1, x_2, ...x_n\\}$\u003c/p\u003e\n\u003cp\u003e极大值函数是凸函数，所以会有极小极大问题，即极小化一个极大值函数\u003c/p\u003e\n\u003ch3 id=\"共轭函数\"\u003e共轭函数\u003c/h3\u003e\n\u003ch2 id=\"保凸运算\"\u003e保凸运算\u003c/h2\u003e\n\u003ch3 id=\"非负加权和\"\u003e非负加权和\u003c/h3\u003e\n\u003cp\u003e$f_1, ..., f_m$为凸，$\\omega_i \\geq 0$，则$f = \\sum_{i=1}^{m} \\omega_i f_i$为凸\u003c/p\u003e\n\u003ch3 id=\"仿射映射\"\u003e仿射映射\u003c/h3\u003e\n\u003cp\u003e$f: R^n \\to R$为凸，则$g(x) = f(Ax+b)$为凸\u003c/p\u003e\n\u003ch3 id=\"凸函数的逐点最大\"\u003e凸函数的逐点最大\u003c/h3\u003e\n\u003cp\u003e$f_1, f_2$为凸，则$f = \\max{{f_1(x), f_2(x)}}$为凸\u003c/p\u003e\n\u003cp\u003e可以用定义一证明，可以推广到无数个\u003c/p\u003e\n\u003cp\u003e比如分段线性函数就是凸函数\u003c/p\u003e\n\u003ch3 id=\"复合函数\"\u003e复合函数\u003c/h3\u003e\n\u003cp\u003e$f(x) = h(g(x))$\u003c/p\u003e\n\u003cp\u003e$\nf^{\\prime \\prime}(x)=h^{\\prime \\prime}(g(x)) g^{\\prime 2}(x)+h^{\\prime}(g(x)) g^{\\prime \\prime}(x)\n$\u003c/p\u003e\n\u003cp\u003e然后分情况讨论\u003c/p\u003e\n\u003ch2 id=\"拟凸函数与拟凹函数\"\u003e拟凸函数与拟凹函数\u003c/h2\u003e\n\u003cp\u003e$\\alpha$-下水平集：$$\nC_{\\alpha}={x \\in \\operatorname{dom} f \\mid f(x) \\leq \\alpha}\n$$\u003c/p\u003e\n\u003cp\u003e指的是\u003cstrong\u003e定义域\u003c/strong\u003e是凸集！\u003c/p\u003e\n\u003cp\u003e如果作一条水平线，交点数\u0026gt;2，必然不是拟凸\u003c/p\u003e\n\u003cp\u003e考虑函数的$\\alpha-$下水平集，凸函数的所有$\\alpha$-下水平集是凸集，但是$\\alpha$-下水平集是凸集的函数不一定是凸函数\u003c/p\u003e\n\u003cp\u003e拟凸有时候也称为单模态函数，如下图左图为拟凸函数，右图则不是拟凸函数\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640604308/convex-7.png\" alt=\"convex-7\"\u003e\u003c/p\u003e\n\u003cp\u003e定义函数$f: R^n \\to n$是拟凸函数，如果其定义域和所有$\\alpha$-下水平集都是凸集：\n$$S_\\alpha = { x\\in dom f | f(x) \\leq \\alpha }$$\u003c/p\u003e\n\u003cp\u003e对于拟凸函数$f$，有：（Jensen不等式）\n$$f(\\theta x + (1-\\theta)y) \\leq max{ f(x), f(y)}, 0 \\leq \\theta \\leq 1$$\u003c/p\u003e\n\u003cp\u003e凸函数一定是拟凸函数，但是拟凸函数不一定是凸函数。\u003c/p\u003e\n\u003cp\u003e拟凹函数同理，即为上水平集均为凸的函数。\u003c/p\u003e\n\u003ch2 id=\"例题\"\u003e例题\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003e假设$f :R \\to R$是凸函数，$$a,b \\in \\textbf{dom} f, a \u0026lt; b$$\n（a）证明对于任意$x\\in [a,b]$，下式成立：\n$$\nf(x) \\leq \\frac{b-x}{b-a} f(a)+\\frac{x-a}{b-a} f(b)\n$$\n（b）证明对于任意$x \\in (a,b)$，下式成立（并画一个草图说明）：\n$$\n\\frac{f(x)-f(a)}{x-a} \\leq \\frac{f(b)-f(a)}{b-a}\\leq \\frac{f(b)-f(x)}{b-x}\n$$\n（c）假设$f$可微，利用（b）的结论证明：\n$$\nf'(a) \\leq \\frac{f(b)-f(a)}{b-a} \\leq f'(b)\n$$\n（d）假设$f$二次可微，利用（c）的结论证明$f''(a)\\geq 0$和$f''(b)\\geq 0$\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e（a）\n由凸函数的定义可知，定义域上任意两点$x, y$，对任意$\\theta \\in [0,1]$有：\n$f(\\theta x + (1-\\theta)y) \\leq \\theta f(x) + (1-\\theta)f(y)$\u003c/p\u003e\n\u003cp\u003e$a, b \\in dom f, x\\in[a,b]$\n取$\\theta = \\frac{b-x}{b-a} \\in dom f$\n有$f(x) = f(\\frac{b-x}{b-a}a + \\frac{x-a}{b-a}b) \\leq \\frac{b-x}{b-a} f(a)+\\frac{x-a}{b-a} f(b)$\u003c/p\u003e\n\u003cp\u003e（b）\n（a）中的式子左右两边都减去$f(a)$，即可得到$\\frac{f(x)-f(a)}{x-a} \\leq \\frac{f(b)-f(a)}{b-a}$，左右两边都减去$f(b)$，即可得到$\\frac{f(b)-f(a)}{b-a} \\leq \\frac{f(b)-f(x)}{b-x}$\n草图如下：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641472076/convex-homework-1.png\" alt=\"convex-homwork-1\"\u003e\u003c/p\u003e\n\u003cp\u003e不等式描述了斜率：$\\overline{ax} \\leq \\overline{ab} \\leq \\overline{xb}$\u003c/p\u003e\n\u003cp\u003e（c）\n取$x \\to a+$，代入（b）的前半部分即有$f'(a) = \\lim_{x\\to a+} \\frac{f(x)-f(a)}{x-a} \\leq \\frac{f(b)-f(a)}{b-a}$，同理，取$x \\to b-$，代入（b）的后半部分即有$\\frac{f(b)-f(a)}{b-a} \\leq \\lim_{x\\to b-} = f'(b)$\u003c/p\u003e\n\u003cp\u003e（d）\u003c/p\u003e\n\u003cp\u003e（c）的结果为：\n$f'(a) \\leq \\frac{f(b)-f(a)}{b-a} \\leq f'(b)$\u003c/p\u003e\n\u003cp\u003e在此基础上令$b \\to a+$\n$f''(a) = \\lim_{b\\to a+} \\frac{f'(b) - f'(a)}{b-a} \\geq 0 $\u003c/p\u003e\n\u003cp\u003e同理可得$f''(b) \\geq 0$\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e证明连续函数$f: R^n \\to R$是凸函数的充要条件是，对于任意线段，函数在线段上的平均值不大于线段端点函数值的平均，也就是对于任意$x, y \\in R^n$，下式成立：\n$$\n\\int_{0}^{1} f(x+\\lambda(y-x)) d \\lambda \\leqslant \\frac{f(x)+f(y)}{2}\n$$\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e先证明必要性，如果连续函数$f$是凸函数，即任取两点$x,y$，任取$\\theta \\in [0,1]$，必然有：\n$$\\theta f(x) + (1-\\theta) f(y) \\geq f(\\theta x + (1-\\theta) y)$$\u003c/p\u003e\n\u003cp\u003e即：\u003c/p\u003e\n\u003cp\u003e$$\\int_{0}^{1} f(x+\\lambda(y-x)) d \\lambda \\leq \\int_{0}^{1}(f(x)+\\lambda(f(y)-f(x))) d \\lambda=\\frac{f(x)+f(y)}{2}$$\u003c/p\u003e\n\u003cp\u003e然后是充分性，即满足后式，必然能保证是凸函数，使用凸函数的第一定义证明：\n任取两点$x,y$，任取$\\theta \\in [0,1]$，需要证明$\\theta f(x) + (1-\\theta) f(y) \\geq f(\\theta x + (1-\\theta y))$\u003c/p\u003e\n\u003cp\u003e用反证法，也就是说函数不是凸函数，至少能找到一个$x, y \\in dom f $和$\\theta \\in [0,1]$，使得\n$$\\theta f(x) + (1-\\theta) f(y) \u0026lt; f(\\theta x + (1-\\theta) y)$$\n也就是说存在$x^*, y^*, \\theta^*$关于$\\theta$的函数：\n$$g(\\theta) = f(\\theta x + (1-\\theta) y) - \\theta f(x) - (1-\\theta) f(y) \u0026gt;0$$\u003c/p\u003e\n\u003cp\u003e由于$\\theta = 0$和$1$时上式均为0。所以一定在 $\\theta^*$的左右存在两点$p,q$，使得$g(p) = 0, g(q) = 0, g(i)_{p \\leq i \\leq q} \u0026gt; 0$\u003c/p\u003e\n\u003cp\u003e取$x = p, y =q$，在原函数上有$\\int_{0}^{1} f(p+\\theta(p-q)) d \\theta\u0026gt;\\int_{0}^{1}(f(p)+\\theta(f(p)-f(q))) d \\theta=\\frac{f(p)+f(q)}{2}$，与初始矛盾，所以反证法成立。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e判断下列函数是否为凸函数、凹函数、拟凸函数与拟凹函数：\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e（a）$f(x) = e^x - 1, \\textbf{dom}\\ f = R$\u003c/p\u003e\n\u003cp\u003e（b）$f(x_1,x_2) = x_1 x_2, \\textbf{dom}\\ f = R_{++}^2$\u003c/p\u003e\n\u003cp\u003e（c）$f(x_1,x_2) = 1/(x_1 x_2), \\textbf{dom}\\ f = R_{++}^2$\u003c/p\u003e\n\u003cp\u003e（d）$f(x_1,x_2) = x_1 / x_2, \\textbf{dom}\\ f = R_{++}^2$\u003c/p\u003e\n\u003cp\u003e（e）$f(x_1,x_2) = x_1^2/ x_2, \\textbf{dom}\\ f = R \\times R_{++}$\u003c/p\u003e\n\u003cp\u003e（f）$f(x_1,x_2) = x_1^{\\alpha} x_2^{1-\\alpha}, 0 \\leq \\alpha \\leq 1, \\textbf{dom}\\ f = R_{++}^2$\u003c/p\u003e\n\u003cp\u003e（a）\n由于原函数二阶可导\n$f''(x) = e^x \u0026gt; 0$\n为凸函数，凸函数也一定是拟凸函数，同时还是拟凹函数\u003c/p\u003e\n\u003cp\u003e（b）\u003c/p\u003e\n\u003cp\u003eHessain矩阵为：$$\n\\nabla^{2} f(x)=\\left[\\begin{array}{ll}\n0 \u0026amp; 1 \\newline\n1 \u0026amp; 0\n\\end{array}\\right]\n$$\n既非正定，又非负定，所以不是凸函数也不是凹函数。\u003c/p\u003e\n\u003cp\u003e$\\alpha$-上水平集为凸集，是拟凹函数，下水平集不是凸集，所以不是拟凸函数\u003c/p\u003e\n\u003cp\u003e（c）\nHessain矩阵为：\n$$\n\\nabla^{2} f(x)=\\frac{1}{x_{1} x_{2}}\\left[\\begin{array}{cc}\n2 /\\left(x_{1}^{2}\\right) \u0026amp; 1 /\\left(x_{1} x_{2}\\right) \\newline\n1 /\\left(x_{1} x_{2}\\right) \u0026amp; 2 / x_{2}^{2}\n\\end{array}\\right] \\geq 0\n$$\n是正定的，所以是凸函数，也是拟凸函数。不是凹函数，也不是拟凹函数。\u003c/p\u003e\n\u003cp\u003e（d）\nHessain矩阵为：\n$$\n\\nabla^{2} f(x)=\\left[\\begin{array}{cc}\n0 \u0026amp; -1 / x_{2}^{2} \\newline\n-1 / x_{2}^{2} \u0026amp; 2 x_{1} / x_{2}^{3}\n\\end{array}\\right]\n$$\n既非正定，又非负定，所以不是凸函数也不是凹函数。\n上水平集和下水平集均为半空间，所以既是拟凸的又是拟凹的。\u003c/p\u003e\n\u003cp\u003e（e）\n$$\n\\nabla^{2} f(x)=\\left[\\begin{array}{cc}\n2 / x_{2} \u0026amp; -2 x_{1} / x_{2}^{2} \\newline\n-2 x_{1} / x_{2}^{2} \u0026amp; 2 x_{1}^{2} / x_{2}^{3}\n\\end{array}\\right] \\geq 0\n$$\n是凸函数，也是拟凸函数，不是拟凹函数\u003c/p\u003e\n\u003cp\u003e（f）\n$$\n\\nabla^{2} f(x)=\\left[\\begin{array}{cc}\n\\alpha(\\alpha-1) x_{1}^{\\alpha-2} x_{2}^{1-\\alpha} \u0026amp; \\alpha(1-\\alpha) x_{1}^{\\alpha-1} x_{2}^{-\\alpha} \\newline\n\\alpha(1-\\alpha) x_{1}^{\\alpha-1} x_{2}^{-\\alpha} \u0026amp; (1-\\alpha)(-\\alpha) x_{1}^{\\alpha} x_{2}^{-\\alpha-1}\n\\end{array}\\right] \\leq 0\n$$\u003c/p\u003e\n\u003cp\u003e是凹函数，也是拟凹函数。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e函数的积或比，证明以下结论：\n$$\\newline$$\n（a）在某区间上的函数$f$和$g$都是凸函数，且都非减（或者都非增），二者都大于0，则函数$fg$在此区间上也是凸函数\n$$\\newline$$\n（b）函数$f$和$g$都是凹函数，一个非减，一个非增，二者都大于0，则函数$fg$是凹函数\n$$\\newline$$\n（c）函数$f$是凸函数，非减且大于0，$g$是凹函数，非增且大于0，那么函数$f/g$是凸函数\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e要证明$fg$的凹凸性，根据定义，则要证明：\n$$\\theta f(x)g(x) + (1-\\theta) f(y)g(y) 和 f(\\theta x + (1-\\theta)y)g(\\theta x + (1-\\theta)y) 的关系$$\u003c/p\u003e\n\u003cp\u003e要证明$f/g$的凹凸性，根据定义，则要证明：\n$$\\theta f(x)/g(x) + (1-\\theta) f(y)/g(y) 和 f(\\theta x + (1-\\theta)y)/g(\\theta x + (1-\\theta)y) 的关系$$\u003c/p\u003e\n\u003cp\u003e（a）\u003c/p\u003e\n\u003cp\u003e都凸，所以对于$x, y \\in dom$， $\\theta \\in [0,1]$\n$$\\begin{array}{ll} f(\\theta x + (1-\\theta)y)g(\\theta x + (1-\\theta)y) \u0026amp;\\leq (\\theta f(x)+(1-\\theta) f(y))(\\theta g(x)+(1-\\theta) g(y)) \\newline \u0026amp; = \\theta^2 f(x) g(x) + (1-\\theta)^2 f(y) g(y) + \\theta(1-\\theta)(f(y)-f(x))(g(x)-g(y)) \\end{array}$$\u003c/p\u003e\n\u003cp\u003e且非减且大于0，即$\\theta(1-\\theta)(f(y)-f(x))(g(x)-g(y)) \\leq 0$，有：\n$$\n\\theta(1-\\theta)(f(y)-f(x))(g(x)-g(y)) \\leq 0\n$$\n有\n$$\\theta f(x)g(x) + (1-\\theta) f(y)g(y) \\geq f(\\theta x + (1-\\theta)y)g(\\theta x + (1-\\theta)y)$$\u003c/p\u003e\n\u003cp\u003e即$fg$为凸函数\u003c/p\u003e\n\u003cp\u003e（b）\u003c/p\u003e\n\u003cp\u003e都凹，所以对于$x, y \\in dom$， $\\theta \\in [0,1]$\n$$\\begin{array}{ll} f(\\theta x + (1-\\theta)y)g(\\theta x + (1-\\theta)y) \u0026amp;\\geq (\\theta f(x)+(1-\\theta) f(y))(\\theta g(x)+(1-\\theta) g(y)) \\newline \u0026amp; = \\theta^2 f(x) g(x) + (1-\\theta)^2 f(y) g(y) + \\theta(1-\\theta)(f(y)-f(x))(g(x)-g(y)) \\end{array}$$\u003c/p\u003e\n\u003cp\u003e一个非减一个非增，有\n$$\n\\theta(1-\\theta)(f(y)-f(x))(g(x)-g(y)) \\geq 0\n$$\n有\n$$\\theta f(x)g(x) + (1-\\theta) f(y)g(y) \\leq f(\\theta x + (1-\\theta)y)g(\\theta x + (1-\\theta)y)$$\u003c/p\u003e\n\u003cp\u003e$fg$为凹函数\u003c/p\u003e\n\u003cp\u003e（c）\u003c/p\u003e\n\u003cp\u003e因为$f$为凸，非减且大于0，$g$为凹，非增且大于0，有\n$$\\begin{array}{ll} f(\\theta x + (1-\\theta)y)/g(\\theta x + (1-\\theta)y) \u0026amp;\\leq (\\theta f(x)+(1-\\theta) f(y))/(\\theta g(x)+(1-\\theta) g(y)) \\newline \u0026amp; \\leq \\theta f(x)/g(x) + (1-\\theta) f(y)/g(y) \\end{array}$$\u003c/p\u003e\n\u003cp\u003e有\n$$\\theta f(x)/g(x) + (1-\\theta) f(y)/g(y) \\geq f(\\theta x + (1-\\theta)y)/g(\\theta x + (1-\\theta)y)$$\u003c/p\u003e\n\u003cp\u003e$f/g$为凸函数\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e证明凸函数的二阶条件，也就是凸函数的充要条件是Hessian矩阵半正定\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e先证充分性，即凸函数可以推导出Hessain矩阵半正定：\u003c/p\u003e\n\u003cp\u003e根据凸函数的一阶定义\n$$\nf(y) \\geq f(x) + \\nabla f(x)(y-x) \\newline\nf(x) \\geq f(y) + \\nabla f(y)(x-y)\n$$\u003c/p\u003e\n\u003cp\u003e有：\u003c/p\u003e\n\u003cp\u003e$$\\nabla f(x) (y-x) \\leq f(y) - f(x) \\leq \\nabla f(y)(y-x)$$\u003c/p\u003e\n\u003cp\u003e可得\u003c/p\u003e\n\u003cp\u003e$$\\frac{\\nabla f(y) - \\nabla f(x)}{y-x} \\geq 0$$\u003c/p\u003e\n\u003cp\u003e取$y \\to x^+$，得：\u003c/p\u003e\n\u003cp\u003e$$\\nabla^2 f(x) \\geq 0$$\u003c/p\u003e\n\u003cp\u003e证明必要性，这里先考虑$n=1$的情况\u003c/p\u003e\n\u003cp\u003e取$x \u0026lt; y$，根据分部积分法，有：\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\n0 \u0026amp; \\leq \\int_{x}^{y} f^{\\prime \\prime}(z)(y-z) dz \\newline\n\u0026amp;= \\left.\\left(f^{\\prime}(z)(y-z)\\right)\\right|_{z=x} ^{z=y} + \\int_x^y f^{\\prime}(z) dz \\newline\n\u0026amp;=-f^{\\prime}(x)(y-x)+f(y)-f(x),\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e注： 第一个等号是分部积分法，即\n$$f(x)g(x) = \\int( f'(x)g(x) + f(x)g'(x)) \\newline\n\\int f'(x)g(x) = f(x)g(x) - \\int f(x)g'(x)\n$$\u003c/p\u003e\n\u003cp\u003e有$$\nf(y) \\geq f(x) + f'(x)(y-x)\n$$\n通过一阶条件可知是凸函数\u003c/p\u003e\n\u003cp\u003e然后拓展到$n\u0026gt;1$的情况，根据凸函数的第二定义，如果$g(t) = f(x_0 + vt)$对于每个$x_0$和$v$而言都是凸函数的话，就可以得到$f(x)$是凸函数。\u003c/p\u003e\n\u003cp\u003e$g(t)$是凸函数也就是说它的二阶导大于等于0：\u003c/p\u003e\n\u003cp\u003e$$\ng^{\\prime \\prime}(t)=v^{T} \\nabla^{2} f\\left(x_{0}+t v\\right) v \\geq 0\n$$\u003c/p\u003e\n\u003cp\u003e因为有$\\nabla^{2} f \\geq 0$，所以上式成立，也就是说$f$是凸函数\u003c/p\u003e\n","date":1641212543,"description":"","fuzzywordcount":4400,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"1dd73029202389dd276789d91e2ad64f","publishdate":1641212543,"relpermalink":"/posts/convex-2/","section":"posts","summary":"凸函数的定义 定义一（基本定义） 函数$f: R^n \\to R$是凸函数，当且仅当： $f$的定义域是凸集 $\\forall x_1, x_2 \\in dom(f), \\forall \\theta \\in [0,1]$ $f(\\theta x_1+(1-\\theta)x_2) \\leq \\theta f(x_1) + (1-\\theta)f(x_2)$ 该式也叫Jenson不等式： $$f(\\theta x + (1-\\theta) y) \\leq","tags":["凸优化","数学"],"title":"凸优化（二）凸函数","url":"https://blog.engine.wang/posts/convex-2/","wordcount":4351},{"categories":"posts","content":"\u003cp\u003e凸优化的笔记专栏，预计会分为五个部分，分别是：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e绪论与凸集\u003c/li\u003e\n\u003cli\u003e凸函数\u003c/li\u003e\n\u003cli\u003e凸优化问题\u003c/li\u003e\n\u003cli\u003e对偶\u003c/li\u003e\n\u003cli\u003e算法\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e参考：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eStanford《convex optimization》\u003c/li\u003e\n\u003cli\u003e中科大 凌青 凸优化\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"优化问题\"\u003e优化问题\u003c/h2\u003e\n\u003cp\u003e优化问题：从一系列可行解集合中，寻找出最优的元素\u003c/p\u003e\n\u003cp\u003e优化问题的形式：\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\n\\text{ minimize } \u0026amp; f_0(x) \\newline\n\\text { subject to } \u0026amp; f_{i}(x) \\leq b_i\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e$f_0$是目标函数（$R^n \\to R$）\u003c/p\u003e\n\u003cp\u003e优化问题在现实生活中各个领域都非常常见，深度学习中也是要使Loss最小，也是优化问题。\u003c/p\u003e\n\u003ch2 id=\"优化问题的分类\"\u003e优化问题的分类\u003c/h2\u003e\n\u003ch3 id=\"线性优化非线性优化\"\u003e线性优化/非线性优化\u003c/h3\u003e\n\u003cp\u003e（有时候也叫规划，和优化是一个意思）\u003c/p\u003e\n\u003cp\u003e目标函数由多个线性函数组合成，就是线性优化问题，否则就是非线性优化问题。\u003c/p\u003e\n\u003cp\u003e线性优化问题，最优解不是在顶点就是在整条边上\u003c/p\u003e\n\u003ch3 id=\"凸优化非凸优化\"\u003e凸优化/非凸优化\u003c/h3\u003e\n\u003cp\u003e凸优化：\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{ll}\n\\text{ minimize } \u0026amp; f_0(x) \\newline\n\\text { subject to } \u0026amp; f_{i}(x) \\leq 0, \\quad i=1, \\ldots, m \\newline\n\u0026amp; a_{i}^{T} x=b_{i}, \\quad i=1, \\ldots, p\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e优化问题里面，比较好求解的是凸优化问题，非凸优化问题难解决\u003c/p\u003e\n\u003ch3 id=\"光滑非光滑\"\u003e光滑/非光滑\u003c/h3\u003e\n\u003cp\u003e目标函数每个点都可微就是光滑的，否则是非光滑的\u003c/p\u003e\n\u003ch3 id=\"连续离散\"\u003e连续/离散\u003c/h3\u003e\n\u003cp\u003e按照可行域连续或者离散分类\u003c/p\u003e\n\u003ch3 id=\"单目标多目标\"\u003e单目标/多目标\u003c/h3\u003e\n\u003cp\u003e对多个目标进行优化\u003c/p\u003e\n\u003cp\u003e这门课只研究单目标连续光滑的凸优化问题\u003c/p\u003e\n\u003cp\u003e判断是否为凸问题的一个关键，就是看约束集合、目标函数是否是凸集。所以凸集是凸优化问题最基本的一个概念。\u003c/p\u003e\n\u003ch2 id=\"仿射集-affine-set\"\u003e仿射集 Affine set\u003c/h2\u003e\n\u003cp\u003e集合中任取两个点，形成的\u003cstrong\u003e直线\u003c/strong\u003e，如果整条线上的点也都在集合中，那么称该集合为仿射集\n要求任意两点连成的直线在集合中，也就是说\u003c/p\u003e\n\u003cp\u003e$$x_1, x_2 \\in C, \\theta\\in R \\to \\theta x_1 + (1- \\theta)x_2 \\in C$$\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640604307/convex-1.png\" alt=\"convex-1\"\u003e\u003c/p\u003e\n\u003cp\u003e仿射组合：不仅限两个点，而是多个点：\n$$x_1,...x_k \\in C , \\theta_1 + ... \\theta_k = 1 \\to \\theta_1 x_1 + ... \\theta_k x_k \\in C$$\u003c/p\u003e\n\u003cp\u003e利用\n$$\n(\\theta_1 + \\theta_2)(\\frac{\\theta_1}{\\theta_1 + \\theta_2}x_1 + \\frac{\\theta_2}{\\theta_1 + \\theta_2}x_2) + (1-\\theta_1 - \\theta_2)x_3 \\in C\n$$即可证明\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e任意线性方程组$Ax = b$的解集都是仿射集，任意仿射集都可以写成线性方程组的解集\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e假设该线性方程组有两个解$x_1, x_2$，则直线上的任意一点$\\theta x_1+(1-\\theta)x_2$代入得$A(\\theta x_1+(1-\\theta)x_2) = b$，说明也是该线性方程组的解\u003c/p\u003e\n\u003cp\u003e仿射包：从非仿射集合中构造一个最小的仿射集\u003c/p\u003e\n\u003cp\u003e比如两个点的集合不是仿射集，构造一个经过它们的直线，就是仿射集了，这条直线就是仿射包。三个不同直线的点，它们的最小的仿射包就是经过它们的二维平面。如果本身就是仿射集，那么仿射包就是它自己。\u003c/p\u003e\n\u003ch2 id=\"凸集-convex-set\"\u003e凸集 convex set\u003c/h2\u003e\n\u003cp\u003e凸集相比于仿射集条件放松，要求任意两点连成的\u003cstrong\u003e线段\u003c/strong\u003e在集合中。凸集的定义为：\u003c/p\u003e\n\u003cp\u003e$$x_1, x_2 \\in C, \\theta\\in[0,1] \\to \\theta x_1 + (1- \\theta_2)x_2 \\in C$$\u003c/p\u003e\n\u003cp\u003e仿射集必然是凸集，可以认为是一种特殊的凸集，凸集包含的更广。\u003c/p\u003e\n\u003cp\u003e凸组合：不仅限两个点，而是多个点：\n$$x_1,...x_k \\in C , \\theta_1 + ... \\theta_k = 1, \\theta_i\\in[0,1] \\to \\theta_1 x_1 + ... \\theta_k x_k \\in C$$\u003c/p\u003e\n\u003cp\u003e凸包：包含集合S的最小凸集\u003c/p\u003e\n\u003cp\u003e下图2.2，只有左边的凸多边形是凸集。不过如果右图只少了角点，是凸集，少了边上或者内部的点就不是凸集了。\u003c/p\u003e\n\u003cp\u003e下图2.3是凸包，包括一组离散点的凸包，以及非凸形状的凸包。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640604308/convex-2.png\" alt=\"convex-2\"\u003e\u003c/p\u003e\n\u003ch2 id=\"典型凸集\"\u003e典型凸集\u003c/h2\u003e\n\u003ch3 id=\"凸锥-convex-cone\"\u003e凸锥 Convex cone\u003c/h3\u003e\n\u003cp\u003e锥：$\\forall x \\in C, \\theta \\geq 0, \\theta x \\in C$（锥尖需要在原点）\u003c/p\u003e\n\u003cp\u003e凸锥：$x_1, x_2 \\in C, \\theta_1 x_1 + \\theta_2 x_2 \\in C, \\theta_1 \u0026gt; 0, \\theta_2 \u0026gt; 0$\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640604308/convex-cone-1.png\" alt=\"convex-cone-1\"\u003e\u003c/p\u003e\n\u003cp\u003e图形理解，任取两点$x_1, x_2$，如果$x_1,x_2,o$不在一条直线上，那么在$\\overset{\\frown}{x_1 o x_2}$的扇形区域内的所有的点都在凸锥集上\u003c/p\u003e\n\u003cp\u003e过原点的直线和原点发出的射线是凸锥\u003c/p\u003e\n\u003cp\u003e凸锥组合：$x_1,... x_k \\in C, \\theta_1 x_1 + ... \\theta_k x_k \\in C, \\theta_1 \u0026gt; 0, ...  \\theta_k \u0026gt; 0$\u003c/p\u003e\n\u003cp\u003e凸锥包：和前面一样，如下图所示\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640604308/convex-cone-2.png\" alt=\"convex-cone-2\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e对比一下前面几种组合：\u003c/strong\u003e\n仿射组合：$\\theta_1 + ... + \\theta_k = 1$\n凸组合：$\\theta_1 + ... + \\theta_k = 1, \\theta_1, ... , \\theta_k \u0026gt; 0$\n凸锥组合：$\\theta_1, ... , \\theta_k \\geq 0$\u003c/p\u003e\n\u003ch3 id=\"超平面-hyperplane\"\u003e超平面 Hyperplane\u003c/h3\u003e\n\u003cp\u003e${x|a^T x = b}$\u003c/p\u003e\n\u003cp\u003e是仿射集，也是凸集，不一定凸锥（除非过原点）\u003c/p\u003e\n\u003ch3 id=\"半空间-halfspace\"\u003e半空间 Halfspace\u003c/h3\u003e\n\u003cp\u003e${ x|a^T x \\leq b }$\u003c/p\u003e\n\u003cp\u003e半空间是凸集，不是仿射集，不一定凸锥（除非过原点）\u003c/p\u003e\n\u003cp\u003e下图分别为超平面和半空间：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640604308/convex-5.png\" alt=\"convex-5\"\u003e\u003c/p\u003e\n\u003cp\u003e证明：\n假设$x_1, x_2$在空间上：\n$a^T x_1 \\leq b$\n$a^T x_2 \\leq b$\n对于$x_1,x_2$上的任意一点$\\theta x_1 + (1-\\theta) x_2$有：\n$a^T(\\theta x_1 + (1-\\theta) x_2) = \\theta (a^T x_1 -b) + (1-\\theta) (a^T x_2 - b) +b \\leq b$，也在集合中，所以半空间是凸集\u003c/p\u003e\n\u003cp\u003e法线的反方向\u003c/p\u003e\n\u003ch3 id=\"空间球-euclidean-ball\"\u003e空间球 Euclidean Ball\u003c/h3\u003e\n\u003cp\u003e欧几里得球，就是一个空间球\u003c/p\u003e\n\u003cp\u003e$$\nB\\left(x_{c}, r\\right)=\\newline{x |\\ ||x-x_{c}||_2\\leq r \\newline} $$\u003c/p\u003e\n\u003cp\u003e$$=\\newline{x |\\ (x-x_{c})^{T}(x-x_{c} ) \\leq r^2\\newline}\n$$\u003c/p\u003e\n\u003cp\u003e证明：\n假设$x_1, x_2$在空间上：\n$|| x_1 - x_c ||_2 \\leq r$\n$|| x_2 - x_c ||_2 \\leq r$\n对于$x_1,x_2$上的任意一点$\\theta x_1 + (1-\\theta) x_2 $，（其中$\\theta \\in [0,1]$），有：\n$$|| \\theta x_1 + (1-\\theta) x_2 - x_c ||_r = || \\theta (x_1 - x_c) + (1-\\theta)(x_2 - x_c)||\\newline\n\\leq \\theta ||x_1 - x_c||_2 + (1-\\theta) ||x_2 - x_c||_2 \\leq r\n$$\n这里用到了范数的三角不等式\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e范数性质\n假设$x$的范数是$f(x)$，$f(x)\\geq 0$，满足下面三条性质：\n$\\text{if}\\ f(x)=0 \\to x=0$\n$kf(x) = |k|f(x)$\n$f(x+y) \\leq f(x) + f(y)$（三角不等式）\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"椭球-ellipsoids\"\u003e椭球 Ellipsoids\u003c/h3\u003e\n\u003cp\u003e$$\\mathcal{E} = \\{ x \\mid\\left(x-x_{c}\\right)^{T} P^{-1}\\left(x-x_{c}\\right) \\leq 1 \\}$$\u003c/p\u003e\n\u003cp\u003e矩阵P是一个 $n\\times n$ 的对称正定矩阵\u003c/p\u003e\n\u003cp\u003e（特征值，奇异值）\u003c/p\u003e\n\u003ch3 id=\"多面体-polyhedra\"\u003e多面体 Polyhedra\u003c/h3\u003e\n\u003cp\u003e多面体：有限个线性等式和不等式的解集\n多面体是有限个半空间和超平面的交集\u003c/p\u003e\n\u003cp\u003e$$\n\\mathcal{P}=\\newline{x \\mid a_{j}^{T} x \\leq b_{j}, j=1, \\ldots, m, c_{j}^{T} x=d_{j}, j=1, \\ldots, p\\newline}\n$$\u003c/p\u003e\n\u003ch3 id=\"范数球-norm-ball--范数锥-norm-cone\"\u003e范数球 Norm Ball \u0026amp; 范数锥 Norm Cone\u003c/h3\u003e\n\u003cblockquote\u003e\n\u003cp\u003e范数：满足以下条件的函数$||\\cdot||$\n1、$||x||\\geq 0$，$||x||=0$当且仅当$x=0$\n2、$||tx|| = t||x||$，对于任何$t\\in R$成立\n3、$||x+y|| \\leq ||x|| + ||y||$\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e$$\nC={(x, t) \\mid|x| \\leq t} \\subseteq \\mathbf{R}^{n+1}\n$$\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640604308/convex-6.png\" alt=\"convex-6\"\u003e\u003c/p\u003e\n\u003ch3 id=\"其他的例子\"\u003e其他的例子\u003c/h3\u003e\n\u003cp\u003en*n的对称矩阵组成的集合，是凸锥，也是凸集\u003c/p\u003e\n\u003cp\u003en*n的半正定矩阵组成的集合，是凸集\u003c/p\u003e\n\u003cp\u003en*n的正定矩阵组成的集合不是凸集（取值只能\u0026gt;=0，不属于正定了）\u003c/p\u003e\n\u003cp\u003e线性矩阵不等式的解集也是凸集\u003c/p\u003e\n\u003ch2 id=\"保凸运算\"\u003e保凸运算\u003c/h2\u003e\n\u003cp\u003e如果要证明是凸集可以用定义法，不过复杂情况会很难证明。\n另一种方法是证明集合是多个凸集的保凸运算的简单组合，保凸运算包括以下几个：\u003c/p\u003e\n\u003ch3 id=\"交集-intersection\"\u003e交集 Intersection\u003c/h3\u003e\n\u003cp\u003e$C_1$, $C_2$是凸集，其交集$C = C_1 \\cap C_2$也一定是凸集。\u003c/p\u003e\n\u003cp\u003e拓展到n个也是。\u003c/p\u003e\n\u003ch3 id=\"仿射函数-affine\"\u003e仿射函数 Affine\u003c/h3\u003e\n\u003cp\u003e$f$是仿射变换：$\\mathbf{R}^{n} \\rightarrow \\mathbf{R}^{m}$\u003c/p\u003e\n\u003cp\u003e如果有$S \\in R^n$是凸集，那么$f(S)=\\newline{f(x) \\mid x \\in S\\newline}$也是凸集，用定义证明即可。\n逆函数$f^{-1}(S)=\\newline{x \\mid f(x) \\in S\\newline}$也是凸集。\u003c/p\u003e\n\u003ch3 id=\"透视函数-perspective-functions\"\u003e透视函数 Perspective functions\u003c/h3\u003e\n\u003cp\u003e透视函数 $P: \\mathbf{R}^{n+1} \\rightarrow \\mathbf{R}^{n}$，相当于通过变换（所有元素除以最后一个元素）将最后一个维度的元素变为1，然后去掉这个维度的一种变换。降低一个维度。\u003c/p\u003e\n\u003cp\u003e$P(\\mathbf{X}, t) = \\mathbf{X}/t, dom P = \\newline{(\\mathbf{X}, t), t \u0026gt; 0\\newline}$\n这里t是一个标量，X是矩阵，相当于P是dom(X)+1维度的，去掉最后一个维度t，X里的每一个元素除以t。\u003c/p\u003e\n\u003cp\u003e类比于针孔相机，3维的点$(x_1, x_2, x_3)$会通过孔映射到二维的平面 $-(x_1/x_3, x_2/x_3, 1)$ 上，就是一个透视函数的过程。\u003c/p\u003e\n\u003cp\u003e任意凸集的反透视映射也是凸集\u003c/p\u003e\n\u003ch3 id=\"线性分段函数-linear-fractional\"\u003e线性分段函数 Linear-fractional\u003c/h3\u003e\n\u003cp\u003e一个Linear-fractional function是由perspective function和一个affine function组成的\u003c/p\u003e\n\u003cp\u003e$g(x)=\\left[\\begin{array}{c}A \\newline c^{T}\\end{array}\\right] x+\\left[\\begin{array}{l}b \\newline d\\end{array}\\right]$\u003c/p\u003e\n\u003ch2 id=\"超平面分离定理与支撑超平面\"\u003e超平面分离定理与支撑超平面\u003c/h2\u003e\n\u003ch3 id=\"超平面分离定理\"\u003e超平面分离定理\u003c/h3\u003e\n\u003cp\u003e如果$C$和$D$是两个不相交的凸集，那么必然存在一个超平面$\\newline{x|a^Tx = b\\newline}$能够分离$C$和$D$，这超平面被称为分割超平面\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641388051/convex-8.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"支撑超平面\"\u003e支撑超平面\u003c/h3\u003e\n\u003cp\u003e集合C边界上的点$x_0$的支撑超平面：$\\newline{x | a^Tx = a^T x_0\\newline}$\u003c/p\u003e\n\u003cp\u003e其中$a \\neq 0$，对于所有的$x \\in C$满足$a^Tx \\leq a^T x_0$\u003c/p\u003e\n\u003cp\u003e如果$C$是凸的，那么C边界上的每一个点都存在一个支撑超平面。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641388051/convex-9.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"例题\"\u003e例题\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003e设$C \\subseteq R^n$是一个凸集，证明对于任意$k$的情况，满足$\\theta_i \\geq 0, \\theta_1 + ... \\theta_k = 1$的情况下，有$\\theta_1 x_1 + ... + \\theta_k x_k \\in C$。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e证明：使用数学归纳法，\n$k=2$时，根据凸集的定义性质可知，任取$\\theta_1, \\theta_2$，满足$\\theta_1+\\theta_2=1$，有$\\theta_1 x_1 + \\theta_2 x_2 \\in C$\u003c/p\u003e\n\u003cp\u003e假设$k=n-1$时上式成立，即满足$\\theta_1+ ... +\\theta_{n-1}=1$，有$\\theta_1 x_1 + ... +  \\theta_{n-1} x_{n-1} \\in C$\u003c/p\u003e\n\u003cp\u003e下面考虑$k=n$的情况，构造下面的式子：\u003c/p\u003e\n\u003cp\u003e$$\n(\\sum_{i=1}^{k-1} \\theta_i) \\frac{\\sum_{i=1}^{k-1} \\theta_i x_i}{\\sum_{i=1}^{k-1}\\theta_i} + (1-\\sum_{i=1}^{k-1} \\theta_i)x_i\n$$\u003c/p\u003e\n\u003cp\u003e其中$\\frac{\\sum_{i=1}^{k-1} \\theta_i x_i}{\\sum_{i=1}^{k-1}\\theta_i}$完全符合$n-1$的条件，所以$\\frac{\\sum_{i=1}^{k-1} \\theta_i x_i}{\\sum_{i=1}^{k-1}\\theta_i} \\in C$，整个式子又满足$k=2$的凸集的定义，所以有：\n$$\n(\\sum_{i=1}^{k-1} \\theta_i) \\frac{\\sum_{i=1}^{k-1} \\theta_i x_i}{\\sum_{i=1}^{k-1}\\theta_i} + (1-\\sum_{i=1}^{k-1} \\theta_i)x_i \\in C\n$$\u003c/p\u003e\n\u003cp\u003e即证明了只要$k=n-1$时成立，就有$k=n$时成立，数学归纳法得证\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e判断下面的哪些集合是凸集\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e（a）平板，形如$\\newline{x \\in \\mathbf{R}^{n} \\mid \\alpha \\leqslant a^{T} x \\leqslant \\beta\\newline}\\newline$\u003c/p\u003e\n\u003cp\u003e（b）矩形，形如$\\newline{x \\in \\mathbf{R}^{n} \\mid \\alpha_i \\leqslant x_i \\leqslant \\beta_i\\ , i = 1, ..., n \\newline}$\u003c/p\u003e\n\u003cp\u003e（c）楔形，形如$\\newline{x \\in \\mathbf{R}^{n} \\mid \\alpha_1^T x \\leqslant b_1 , \\alpha_2^T x \\leqslant b_2, i = 1, ..., n \\newline}$\u003c/p\u003e\n\u003cp\u003e（d）距离给定点比距离给定集合近的点构成的集合：\n$ \\newline{ x \\mid ||x-x_0||_2 \\leq ||x-y||_2, \\forall y \\in S \\newline}$\u003c/p\u003e\n\u003cp\u003e（e）距离一个集合比另一个集合更近的点的集合：$\\newline{x \\mid \\operatorname{dist}(x, S) \\leqslant \\operatorname{dist}(x, T)\\newline}$\u003c/p\u003e\n\u003cp\u003e（f）集合$\\newline{x \\mid x + S_2 \\subseteq S_1 \\newline}$，其中$S_1, S_2 \\subseteq R^n$，并且$S_1$是凸集\u003c/p\u003e\n\u003cp\u003e（g）到 $a$ 的距离与到 $b$ 的距离之比不超过到某一固定分数$\\theta$的点的集合，即集合$\\newline{x \\mid|x-a|_2 \\leqslant \\theta |x-b|_2\\newline}$\u003c/p\u003e\n\u003cp\u003e（a）\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e用定义证明：\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e任取$x_1, x_2 \\in C$，有$\\alpha \\leqslant a^{T} x_1 \\leqslant \\beta, \\alpha \\leqslant a^{T} x_2 \\leqslant \\beta$\u003c/p\u003e\n\u003cp\u003e对于$\\theta \\in [0, 1]$，对于$ (\\theta x_1 + (1-\\theta) x_2)$，有：\n$$\\alpha = \\theta \\alpha + (1-\\theta) \\alpha \\leq \\alpha^T (\\theta x_1 + (1-\\theta) x_2) \\leq \\theta  \\beta + (1-\\theta) \\beta = \\beta$$\u003c/p\u003e\n\u003cp\u003e即$ (\\theta x_1 + (1-\\theta) x_2) \\in C$，是凸集\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e用保凸性证明：\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e因为平板是两个半空间的交集，半空间是凸集，交集是保凸运算，所以平板也是凸集\u003c/p\u003e\n\u003cp\u003e（b）\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e用定义证明：\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e任取$x_1, x_2 \\in C$，有$\\alpha_i \\leqslant x_1 \\leqslant \\beta_i, \\alpha_i \\leqslant x_2 \\leqslant \\beta_i$\u003c/p\u003e\n\u003cp\u003e对于$\\theta \\in [0, 1]$，对于$ (\\theta x_1 + (1-\\theta) x_2)$，有：\n$$\\alpha_i \\leq (\\theta x_1 + (1-\\theta) x_2) \\leq \\beta_i$$\u003c/p\u003e\n\u003cp\u003e即$ (\\theta x_1 + (1-\\theta) x_2) \\in C$，是凸集\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e用保凸性证明：\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e矩形是多个半空间的交集，半空间是凸集，交集是保凸运算，所以矩形也是凸集\u003c/p\u003e\n\u003cp\u003e（c）\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e用定义证明：\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e任取$x_1, x_2 \\in C$，有$a_1^{T} x_1 \\leqslant b_1, a_2^{T} x_1 \\leqslant b_2$、$a_1^{T} x_2 \\leqslant b_1, a_2^{T} x_2 \\leqslant b_2$\u003c/p\u003e\n\u003cp\u003e对于$\\theta \\in [0, 1]$，对于$ (\\theta x_1 + (1-\\theta) x_2)$，有：\n$$a_1^T (\\theta x_1 + (1-\\theta) x_2) \\leq \\theta b_1 + (1-\\theta) b_1 = b_1\\newline\na_2^T (\\theta x_1 + (1-\\theta) x_2) \\leq \\theta b_2 + (1-\\theta) b_2 = b_2$$\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e用保凸性证明：\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e楔形是多个半空间的交集，半空间是凸集，交集是保凸运算，所以楔形也是凸集\u003c/p\u003e\n\u003cp\u003e（d）\n对于固定的$y$而言，有：\n$$\n\\begin{array}{ll}\n\u0026amp;||x-x_0||_2 \\leqslant ||x-y||_2\\newline\n\\Leftrightarrow \u0026amp; (x-x_0)^T(x-x_0) \\leqslant (x-y)^T (x-y)\\newline\n\\Leftrightarrow \u0026amp; x^T x - 2x_0^T x + x_0^T x_0 \\leqslant x^T x - 2y^T x + y^T y\\newline\n\\Leftrightarrow \u0026amp; 2(y^T - x_0^T)x \\leqslant y^T y - x_0^T x_0 \\newline\n\\end{array}\n$$\ns\n说明该集合是多个半空间的交集，交集为保凸运算，所以该集合为凸集\u003c/p\u003e\n\u003cp\u003e（e）\n不是凸集，可以举反例，比如$S = {(x, y)|x^2 + y^2 = 1}$，$T = {(0, 0)}$，那么这个集合就是$R^2$平面挖空一个圆心在原点，半径为$\\frac{1}2$的孔，比如集合上取$(0, 1),(0, -1)$两点，取$\\theta=0.5$，$(0,0)$不在这个集合内，很显然它不是凸集。\u003c/p\u003e\n\u003cp\u003e（f）\n令$y \\in S_2$，集合相当于是多个凸集$(S_1 - y)$的交集，交集为保凸运算，所以也是凸集。\u003c/p\u003e\n\u003cp\u003e（g）\n是凸集\n$$\n\\begin{array}{ll}\n\u0026amp; ||x-a||_2 \\leqslant \\theta||x-b||_2\\newline\n\\Leftrightarrow \u0026amp; (1-\\theta^2)x^Tx - 2 (a-\\theta^2b)^Tx + (a^Ta - \\theta^2b^Tb) \\leq 0\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e如果$\\theta \\leq 1$，集合是一个球\n如果$\\theta = 1$，集合是半空间\n都是凸集\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e一些概率分布集合，令$x$为服从分布 $\\textbf{prob}(x=a_i) = p_1, i = 1, ... ,n$ 的实数随机变量，$p \\in R^n$在一个标准概率单纯形$P=\\{p \\mid \\mathbf{1}^{T} p=1, p \\succeq 0\\}$，下面哪些条件在$p$中是凸的？\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e（a）$\\alpha \\leqslant \\textbf{E} f(x) \\leqslant \\beta$\u003c/p\u003e\n\u003cp\u003e（b）$\\textbf{prob}(x\u0026gt;\\alpha) \\leqslant \\beta$\u003c/p\u003e\n\u003cp\u003e（c）$\\textbf{E} |x^3| \\leqslant \\alpha \\textbf{E} |x|$\u003c/p\u003e\n\u003cp\u003e（d）$\\textbf{E} x^2 \\leqslant \\alpha$\u003c/p\u003e\n\u003cp\u003e（e）$\\textbf{E} x^2 \\geqslant \\alpha$\u003c/p\u003e\n\u003cp\u003e（f）$\\textbf{var} (x) \\leqslant \\alpha$\u003c/p\u003e\n\u003cp\u003e（g）$\\textbf{var} (x) \\geqslant \\alpha$\u003c/p\u003e\n\u003cp\u003e（h）$\\textbf{quartile} (x) \\geqslant \\alpha$，$\\textbf{quartile} (x) = \\text{inf} \\{ \\beta | \\textbf{prob}(x\\leqslant \\beta) \\geqslant 0.25\\}$\u003c/p\u003e\n\u003cp\u003e（i）$\\textbf{quartile} (x) \\leqslant \\alpha$\u003c/p\u003e\n\u003cp\u003e$p$的约束：$p_i \\geq 0$是n个半空间，约束$\\sum_{i=1}^n = 1$是超平面，也就是说$p$是一个多面体，本身为凸集。\u003c/p\u003e\n\u003cp\u003e（a）\n$\\alpha \\leq \\sum_{i=1}^n p_i f(a_i) \\leq \\beta$\n增加线性不等式约束，仍为凸集\u003c/p\u003e\n\u003cp\u003e（b）\n$\\textbf{prob}(x\\geq \\alpha) = \\sum_{i, a_i \\geq \\alpha}p_i \\leq \\beta$\n增加线性不等式约束，仍为凸集\u003c/p\u003e\n\u003cp\u003e（c）\n$\\mathbf{E}\\left|x^{3}\\right| \\leq \\alpha \\mathbf{E}|x| \\to \\sum_{i=1}^{n} p_{i}\\left(\\left|a_{i}^{3}\\right|-\\alpha\\left|a_{i}\\right|\\right) \\leq 0$\n增加线性不等式约束，仍为凸集\u003c/p\u003e\n\u003cp\u003e（d）\n$\\sum_{i=1}^{n} p_{i} a_{i}^2 \\leq \\alpha$\n增加线性不等式约束，仍为凸集\u003c/p\u003e\n\u003cp\u003e（e）\n$\\sum_{i=1}^{n} p_{i} a_{i}^2 \\geq \\alpha$\n增加线性不等式约束，仍为凸集\u003c/p\u003e\n\u003cp\u003e（f）\n$\\textbf{var}(x)=\\mathbf{E} x^2-(\\mathbf{E} x)^2=\\sum_{i=1}^{n} p_{i} a_{i}^2-\\left(\\sum_{i=1}^{n} p_{i} a_{i}\\right)^2 \\leq \\alpha$\n不是凸集。举反例，比如$a_1 = 0, a_2 = 1, \\alpha = 0.2$，两个点$p_1 = (0, 1), p_2 = (1,0)$，有$\\textbf{var}(x) \\leq \\alpha$，但是中间的点$(\\frac{1}2, \\frac{1}2)$明显不满足。\u003c/p\u003e\n\u003cp\u003e（g）\n$\\textbf{var}(x)=\\mathbf{E} x^2-(\\mathbf{E} x)^2=\\sum_{i=1}^{n} p_{i} a_{i}^2-\\left(\\sum_{i=1}^{n} p_{i} a_{i}\\right)^2 = b^T p + p^T A p  \\geq \\alpha$\n因为$A = a a^T$是半正定的，所以是凸集\u003c/p\u003e\n\u003cp\u003e（h）\n$\\textbf{prob}\\left(x \\leq a_{k}\\right)=\\sum_{i=1}^{k} p_{i}\u0026lt;0.25$\n是一个半空间，是凸集。\u003c/p\u003e\n\u003cp\u003e（i）\n$\\sum_{i=k+1}^{n} p_{i} \\geq 0.25$\n是一个半空间，是凸集。\u003c/p\u003e\n","date":1640610631,"description":"","fuzzywordcount":5100,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"2c57d9604cb3850c626039a30baf7d74","publishdate":1640610631,"relpermalink":"/posts/convex-1/","section":"posts","summary":"凸优化的笔记专栏，预计会分为五个部分，分别是： 绪论与凸集 凸函数 凸优化问题 对偶 算法 参考： Stanford《convex optimization》 中科大 凌青 凸优化 优","tags":["凸优化","数学"],"title":"凸优化（一）绪论与凸集","url":"https://blog.engine.wang/posts/convex-1/","wordcount":5035},{"categories":"posts","content":"\u003cp\u003e第一次开博客应该是在大二的时候，也就是2018年，用的是Hexo。之后觉得配置太少，想要有发挥的空间，就用当时学的Django写了一个博客网站，再后来又改成了Go+Vue，作为一个前后端分离的单体应用，包含博客的完整的功能，还能有其他拓展。\u003c/p\u003e\n\u003cp\u003e这本来应该是博客的最终形态了，然而精力有限，不想折腾markdown渲染和其他各种功能，以及为一些前后端、运维、优化的问题所烦恼，再加上服务器成本也不少，还是希望能够纯粹的写作。\u003c/p\u003e\n\u003cp\u003e因此现在又回到了最初的起点，转回了静态网页，这次改用Hugo搭建（和hexo类似），之前的博客内容会逐步迁移过来，由于发布文章很方便，之后会增加更多的内容，敬请期待。\u003c/p\u003e\n","date":1640099320,"description":"","fuzzywordcount":300,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"e2aee69cf0508da721fcf1b13ccf2888","publishdate":1640099320,"relpermalink":"/posts/hello-world/","section":"posts","summary":"第一次开博客应该是在大二的时候，也就是2018年，用的是Hexo。之后觉得配置太少，想要有发挥的空间，就用当时学的Django写了一个博客网站，再后来又改成了G","tags":["hugo","site"],"title":"返璞归真，博客重新迁移到Hugo","url":"https://blog.engine.wang/posts/hello-world/","wordcount":292},{"categories":"posts","content":"\u003ch2 id=\"拜占庭将军问题\"\u003e拜占庭将军问题\u003c/h2\u003e\n\u003cp\u003e拜占庭将军问题是分布式领域最复杂的一个容错模型，较好地抽象了分布式系统面临的共识问题。\u003c/p\u003e\n\u003cp\u003e假如你是一位拜占庭的将军，需要与其他几个国家的军队做沟通，而信使可能会被杀，可能会被替换，可能某国军队会传递错误信息等等，抽象出来的问题就是，如何在可能有错误发生的情况下，让多个节点达成共识，保持一致。\u003c/p\u003e\n\u003cp\u003e拜占庭将军是最困难的一种情况，因为会存在恶意节点行为行为，在某些场景（比如数字货币区块链）只能使用拜占庭容错算法（Byzantine Fault Torerace，BFT），常见的拜占庭算法有口信消息型算法、签名消息型算法、PBFT算法、PoW算法等。\u003c/p\u003e\n\u003cp\u003e在计算机分布式系统中，最常使用的还是非拜占庭容错算法，也就是故障容错算法（Crash Fault Tolerance，CFT），解决的是分布式系统中存在故障，但不存在恶意节点的场景。常见的算法有Paxos算法、Raft算法、ZAB协议等，这些协议之后都会讲解。\u003c/p\u003e\n\u003cp\u003e不过对于恶性的情况，一般只在区块链中出现，算法有PBFT、PoW等。但是我并没有打算涉足区块链相关的研究，所以这些算法不在讨论范围之内。\u003c/p\u003e\n\u003ch2 id=\"共识算法的概念\"\u003e共识算法的概念\u003c/h2\u003e\n\u003cp\u003e共识算法就是用来达成一致性的方法。\u003c/p\u003e\n\u003cp\u003e需要满足三个条件：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eTermination：保证算法最后可以做出决定，不能是无限循环的\u003c/li\u003e\n\u003cli\u003eValidity：最终决议一定来自于其中一个参与的节点\u003c/li\u003e\n\u003cli\u003eAgreement：算法完成时，所有节点一定会做出相同的决定\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eFLP定理：完美的共识算法不存在。在非同步的网络环境中，就算只应付一个节点故障，也没有一个共识算法能保证完全正确。\u003c/p\u003e\n\u003cp\u003e一般的共识算法分为两类：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eSymmetric, no leader\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e所有的节点地位等同，client可以向每一个server发送请求\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eAsymmetric, leader based\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e任一时刻只会有一个leader，leader处理client的请求，其余server只接受leader的决策，client只可以向leader发送请求。\u003c/p\u003e\n\u003ch2 id=\"paxos算法\"\u003ePaxos算法\u003c/h2\u003e\n\u003cp\u003ePaxos算法是分布式共识算法的元老，目前最流行的分布式算法都是基于Paxos改进的，所以不得不提。\u003c/p\u003e\n\u003cp\u003e兰伯特Lamport提出的Paxos包含两个部分：\n一个是Basic Paxos，描述的是多个节点之间如何就一个value达成共识；\n一个是Multi-Paxos，描述的是执行多个Basic Paxos实例，为一系列value达成共识。\n这一节只说Basic Paxos，Multi-Paxos下一节\u003c/p\u003e\n\u003ch3 id=\"系统角色\"\u003e系统角色\u003c/h3\u003e\n\u003cp\u003e提议者（Proposers）：向系统里的其他节点提出v=C，希望大家达成共识。\u003c/p\u003e\n\u003cp\u003e接受者（Acceptors）：不发起proposal的节点，接受Proposers的提议。\u003c/p\u003e\n\u003cp\u003e学习者（Learner）：不参与投票的过程，被告知投票的结果，接受达成的共识存储保存数据。\u003c/p\u003e\n\u003ch3 id=\"算法流程\"\u003e算法流程\u003c/h3\u003e\n\u003cp\u003e分为两个流程：\u003c/p\u003e\n\u003cp\u003e第一步：准备阶段\u003c/p\u003e\n\u003cp\u003e在提出提案之前，先得到超过半数节点的回应，也就是有半数以上的节点愿意聆听这个Proposer。假设这次要发送的数据是v\u003c/p\u003e\n\u003cp\u003e具体的过程：Proposers向所有节点发送\u003ccode\u003ePrepare(n)\u003c/code\u003e，n包含了一些元信息，可以比较大小，Acceptors接收到后，与这一轮从其他Proposers里收到的最大的提议N比较。\u003c/p\u003e\n\u003cp\u003e准备阶段只需要发送n即可，不需要发送v。\u003c/p\u003e\n\u003cp\u003e如果$n\u0026lt;N$，也就是目前的这个提议的n比这一轮已有的最大的N还小，直接无视这个提议。\n否则，就认为当前提议更好，如果此时已经发送过了一个返回给之前最大的那个Proposer，就返回一个\u003ccode\u003eack(n, (nx, vx))\u003c/code\u003e，n是这一次的n，nx是之前最大的那个Proposer的n，vx之前最大的那个Proposer的x。如果之前没接受过其他提议，就发送\u003ccode\u003eack(n, (null, null))\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e第二步：接受阶段\u003c/p\u003e\n\u003cp\u003eProposers等待过半的Acceptors返回后，对\u003ccode\u003eack\u003c/code\u003e作出判断，如果里面有节点的\u003ccode\u003eack\u003c/code\u003e返回的nx、vx不为空，就主动放弃，找出里面最大nx的vx，再发送\u003ccode\u003eaccept(n,vx)\u003c/code\u003e给所有的Acceptors。\n如果都为空的话，就传送\u003ccode\u003eaccept(n,v)\u003c/code\u003e给所有的Acceptors。\u003c/p\u003e\n\u003cp\u003eAcceptors收到\u003ccode\u003eaccept(n,v)\u003c/code\u003e后，不过可能还会收到\u003ccode\u003eprepare(n)\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003ePaxos论文描述：\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640193486/paxos-8.png\" alt=\"paxos-8\"\u003e\u003c/p\u003e\n\u003cp\u003e一些容易想错的地方，进行声明：\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e这里的n并不是具体的int，只是为了简单描述算法，实际上这里的n是一种数据结构，但是相互之间可以被比较，并且对于每个节点而言，它们的n必然不相同。\n并不是说一个节点只能当Proposer、Acceptor、Learner中的一种，实际上，每个节点都同时具有这三种角色。\nBasic Paxos只是对一个值形成决议，并不是多个值。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"具体例子\"\u003e具体例子\u003c/h3\u003e\n\u003cp\u003e举一个具体的例子，两个客户端作为提议者，n分别为1和5，v分别为3和7，有三个接受者。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e准备阶段\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e提议者分别发送\u003ccode\u003ePrepare(n)\u003c/code\u003e给三个节点，假设说AB先接收到了客户端1的信息，C先接受到了客户端2的信息\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640193484/paxos-1.jpg\" alt=\"paxos-1\"\u003e\u003c/p\u003e\n\u003cp\u003e由于接受者之前没有提案（也可以认为目前的n是无穷小），所以接受到第一个提案后都进行响应，返回\u003ccode\u003eack(n, (null, null))\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640193485/paxos-2.jpg\" alt=\"paxos-2\"\u003e\u003c/p\u003e\n\u003cp\u003e之后AB接受到客户端2传来的\u003ccode\u003ePrepare(5)\u003c/code\u003e，5\u0026gt;1，所以会发送准备响应给2。C接受到客户端1传来的\u003ccode\u003ePrepare(1)\u003c/code\u003e，1\u0026lt;5，直接无视该请求\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640193485/paxos-3.jpg\" alt=\"paxos-3\"\u003e\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e接受阶段\n由于1、2都收到了多于半数的准备返回响应，并且返回的响应包含的之前最大提案号为空，所以会发送分别接受请求\u003ccode\u003eaccpet(1, 3)\u003c/code\u003e和\u003ccode\u003eaccept(5, 7)\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640193484/paxos-4.jpg\" alt=\"paxos-4\"\u003e\u003c/p\u003e\n\u003cp\u003e最后ABC接受到1的确认，由于之前承诺不再接受n小于5的，所以不会变。接受到5的确认后就修改为了5\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640193485/paxos-5.jpg\" alt=\"paxos-5\"\u003e\u003c/p\u003e\n\u003cp\u003e假设另一个例子，在某个顺序AB是n=5,v=7，C是n=1,v=3。此时有一个请求[9, 6]，发送给ABC之后，准备阶段，由于9\u0026gt;5，ABC会接受，并返回\n\u003ccode\u003eack(n, (nx, nv))\u003c/code\u003e，具体是AB返回\u003ccode\u003eack(9, (5, 7))\u003c/code\u003e,C返回\u003ccode\u003eack(9, (1, 3))\u003c/code\u003e，那么客户端3由于接受到的返回不为空，就会判断之前最大的n，这里是5，对应的v是7，所以在接受阶段会发送\u003ccode\u003eaccpet(9, 7)\u003c/code\u003e给所有节点。\u003c/p\u003e\n\u003cp\u003e可以参考这个视频：https://www.youtube.com/watch?v=UUQ8xYWR4do\u003c/p\u003e\n\u003ch2 id=\"multi-paxos\"\u003eMulti-Paxos\u003c/h2\u003e\n\u003cp\u003eMulti-Paxos并不是一个具体的算法，而是一种思想。指的是基于Mulit-Paxos算法通过多个Basic Paxos实例实现一系列值的共识的算法。（比如Raft算法、ZAB协议等）\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640193485/paxos-6.jpg\" alt=\"paxos-6\"\u003e\u003c/p\u003e\n\u003cp\u003e由于第一阶段收到大多数准备响应的提议者才能发起第二阶段，那么如果多个提议者同时提交提案，可能因为永远无法收到超过半数的准备响应而阻塞。（比如系统中有5个节点，有3个同时发起提案）。\n另一个问题是两轮的RPC太消耗性能，也增加了延迟。\u003c/p\u003e\n\u003cp\u003e通过引入Leader（领导者）角色以及优化Basic Paxos来解决这两个问题。\nLeader节点作为唯一的提议者，这样就不存在提议冲突的情况。\nLeader的提案永远是最新的，所以省略掉准备阶段，直接开始接受阶段：\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640193485/paxos-7.jpg\" alt=\"paxos-7\"\u003e\u003c/p\u003e\n\u003ch3 id=\"chubby的multi-paxos实现\"\u003eChubby的Multi-Paxos实现\u003c/h3\u003e\n\u003cp\u003eChubby实现了闭源的Multi-Paxos，通过引入Leader节点。Leader是通过执行Basic Paxos投票产生的。\n运行过程中会通过续租的方式延长租期，如果Leader故障，其他节点会选举出新的Leader。\n所有的读和写操作也只能在Leader上进行：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e写请求，Leader收到客户端的写请求，作为唯一的Proposer执行Basic Paxos将数据发给所有的节点来达成一致，半数以上的服务器接受了写请求之后，响应给客户端成功\u003c/li\u003e\n\u003cli\u003e读请求，很简单，Leader直接查询本地数据返回给客户端即可。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eChubby的ulti-Paxos实现的一些点：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eLeader本地的数据一定是最新的。\u003c/li\u003e\n\u003cli\u003e可以容忍$\\frac{n-1}{2}$个节点的故障\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"raft\"\u003eRaft\u003c/h2\u003e\n\u003cp\u003eRaft算法在Multi-Paxos的思想上进行了简化和限制，是最常用的一个共识算法，也是目前分布式系统的首选共识算法。包括Etcd、Consul等。\u003c/p\u003e\n\u003cp\u003e本质上来说，Raft算法是通过一切以领导者为准的方式，实现一系列值的共识和各节点的日志一致。\u003c/p\u003e\n\u003cp\u003e强烈推荐看一下这个可视化的Raft，可以加深理解：http://thesecretlivesofdata.com/raft/\u003c/p\u003e\n\u003ch3 id=\"leader选举\"\u003eLeader选举\u003c/h3\u003e\n\u003cp\u003e服务器节点的状态分为三种：Leader（领导者）、Follower（追随者）、Candidate（候选人），其中Leader有且只有一个。\u003c/p\u003e\n\u003cp\u003eLeader：系统的核心角色，负责处理写请求、管理日志复制和不断与其他节点维持心跳，告知节点Leader存活，不要选举\nFollower：普通群众，接受和处理来自Leader的消息，如果Leader心跳超时就主动站出来变成Candidate\nCandidate：候选人，向其他节点发送RequestVote的RPC消息，通知其他节点投票，一旦获得了多数投票就晋升为Leader\u003c/p\u003e\n\u003cp\u003eRaft算法实现了随机超时时间，每个节点等待Leader的心跳超时时间随机。\u003c/p\u003e\n\u003cp\u003e初始时没有Leader，都是Follower，所有节点听不到Leader心跳，超时时间最小的节点首先称为候选者。\n它会增加自己的任期编号，给自己先投一票，然后发送RPC请求其他节点投票。\n其他节点收到RPC投票消息之后，如果还没有称为候选者，也还没投票的话，就会去投一票，同时增加自己的任期编号。\n如果在选举超时时间内获得了大多数的选票，就晋升为Leader。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e关于RPC\nRaft算法总共有两类RPC，一个是请求投票RequestVote，一个是日志复制AppendEntries\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cblockquote\u003e\n\u003cp\u003e关于timeout\n每个节点的等待时间有两种：\n① 一个是election timeout，也就是从上一次Leader心跳开始算，如果过了这个timeout还没听到心跳，就自己称为Candidate，这个timeout一般是150-300ms\n② heartbeat timeout\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cblockquote\u003e\n\u003cp\u003e关于任期\n任期由单调递增的数字（任期编号）标识\n何时加1？Follow发现Leader心跳超时，将自己任期+1，并发RPC\n何时更新？\n① 跟随者接受到包含任期的RPC请求后，发现任期比自己的大，就更新自己的任期为更大的任期。\n② Leader或者Candidate发现自己的任期编号比其他节点小，会立即降为Follower\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e如果一个节点收到一个包含任期编号比自己小的RPC请求，会直接无视。\n任期编号相同时，日志完整性高的Follow会拒绝投票给日志完整性低的Candidate\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e做法就是RequestVote RPC也会包含Candidate自己最后一个log entry的index和term，如果收到RequestRPC的节点发现这个Candidate最后一个log的term小于自己的term，或者term相等的时候index小于自己的index，那么就不会投票给它。这一策略保证了Leader一定拥有最完整的log entries\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e可能会出现多个Candidate同时发起投票请求，这样的话瓜分选票会导致无法选出半数以上的票，不过Raft通过随机超时时间解决了这一问题，把超时时间都进行了分散。这里的超时时间有两种，一个是Follower和Leader维持的心跳超时，一个是等待选举超时的时间间隔。\u003c/p\u003e\n\u003cp\u003e当然还有可能出现的极限情况，比如说刚好两个Candidate各拿到了一半的票，那么陷入阻塞，此时这两个Candidate还会有随机timeout，如果时间过了就重新发送RequestVote\u003c/p\u003e\n\u003cp\u003e几个注意的点：\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e只有日志最完整的节点才能当Leader，Raft中，日志必须是连续的\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"日志复制\"\u003e日志复制\u003c/h3\u003e\n\u003cp\u003e日志项包含指令、索引值、任期编号等。\u003c/p\u003e\n\u003cp\u003e第一阶段，Leader通过日志复制AppendEntries，将日志项复制到集群的其他节点上，如果收到了大多数的“复制成功”消息，就把提交这条日志，并返回成功给客户端，否则会返回错误给客户端。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e一开始只是保存日志到本地，比如客户端提交一条\u003ccode\u003eSET x = 5\u003c/code\u003e，Leader会先把这条写在日志里，不会修改x的值，等到多数节点返回成功之后才会执行这条指令，把x设为5。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eAppendEntries RPC在每个heartbeat都会发送\u003c/p\u003e\n\u003cp\u003eLeader不需要发送消息来告知其他节点提交日志项，Leader的日志复制RPC和心跳包含了当前最大的将被提交的日志项。从而将二阶段简化为一阶段。\u003c/p\u003e\n\u003cp\u003e具体的过程为：\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640193609/raft-1.jpg\" alt=\"raft-1\"\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e客户端提交一条写请求\u003c/li\u003e\n\u003cli\u003eLeader将其存在本地日志上，然后给各个Followers发送日志复制AppendEntries RPC，\u003c/li\u003e\n\u003cli\u003e如果有多数的Follower返回成功，Leader就将日志进行提交\u003c/li\u003e\n\u003cli\u003eLeader将执行的结果返回给客户端\u003c/li\u003e\n\u003cli\u003e之后如果Follower收到新的日志复制RPC或心跳，发现自己有日志项没提交，就进行提交\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e日志一致性的保证：\nLeader的日志必然是完整的，以Leader的日志为准来协调各个节点的日志。\u003c/p\u003e\n\u003cp\u003e首先通过AppendEntries RPC的一致性检查来找到自己与Follower相同日志项的最大索引值，之前的日志Follower和Leader一致，之后的就不一致了，然后Leader强制Follower覆盖不一致日志。\u003c/p\u003e\n\u003cp\u003e引入两个变量：\nPrevLogEntry：当前要复制的日志项的前一项的索引值，下面例子中为7\nPrevLogTerm：当前要复制的日志项的前一项的任期编号，下面例子中为4\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640193609/raft-2.jpg\" alt=\"raft-2\"\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eLeader发送AppendEntries RPC，包含当前任期编号4、PrevLogEntry=7、PrevLogTerm=4，\u003c/li\u003e\n\u003cli\u003eFollower发现自己的索引中没有这一条，返回Failure\u003c/li\u003e\n\u003cli\u003eLeader递减要复制的日志项的索引，发送PrevLogEntry=6、PrevLogTerm=3\u003c/li\u003e\n\u003cli\u003eFollower能在本地日志找到这一项，返回Success\u003c/li\u003e\n\u003cli\u003eLeader知道了自己与该Follower的相同日志的最大索引，复制并更新覆盖索引值之后的日志项。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp\u003e为什么要上一条？因为这一条的话刚写，必然不一样，如果Follower一直和Leader一致，Follower是有Leader的上一条的，但是必然没有Leader新的一条，所以Leader如果从最新的一条发RPC，每一个节点都必然返回Failure，然后递减，非常浪费RPC。\n由于大部分节点是能同步日志的，所以第一次都会返回Success，然后Leader把新的一条复制过去即可，对于第一次Failure的个别节点，才会递减找到相同的最大索引值。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"成员变更\"\u003e成员变更\u003c/h3\u003e\n\u003cp\u003e在成员进行变更的时候，如何避免出现大于一个的Leader？\n比如出现了分区，节点被分为了多个簇，簇与簇之间无法沟通，那么每个簇内都会有一个Leader。\u003c/p\u003e\n\u003cp\u003e如果只是为了解决不出现多个Leader的情况，最暴力的方式就是节点全部关闭然后再重新启动，这样投票只会有一个Leader，但是这段时间系统会瘫痪，明显不合理。\n最常用的方法是单节点变更，也就是每次只变更一个节点。\u003c/p\u003e\n\u003cp\u003e比如当前集群配置为[A, B, C]，现在往里面加入[D, E]，一个一个加，先加D进去：\n首先Leader向D同步所有数据，然后Leader更新自己的配置为[A,B,C,D]，将包含新配置的日志项提交到本地状态机，完成单节点变更，之后E加入也一样。\n通过单节点变更，可以保证系统只有一个Leader。\u003c/p\u003e\n\u003cp\u003e可以看一下Raft作者讲的：\n\u003ca href=\"https://www.youtube.com/watch?v=vYp4LYbnnW8\"\u003ehttps://www.youtube.com/watch?v=vYp4LYbnnW8\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"总结\"\u003e总结\u003c/h2\u003e\n\u003cp\u003e以这张图进行总结：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640193631/%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95-1.png\" alt=\"共识算法-1\"\u003e\u003c/p\u003e\n\u003cp\u003e对于上述共识算法进行比较：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eBackup，简单备份\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e比如mac的time machine。\n首先对于Consistency一致性，是无法保证的，一旦改变当前的文件，备份的旧版本和目前的会不一致。\nTransaction事务也只能是weak。\nLatency（时延）低、Throuput（吞吐量）高，因为读写的时候不需要运行协议，直接读取即可。\nData loss，如果没备份完，系统失效了，那最新的资料会遗失。\nFailover 故障恢复，系统恢复的这段时间系统是不能工作的。\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eMaster/Salve 主从模式\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e读写请求都在master上进行，master将更新 的数据写到slave上。类似Dropbox。\u003c/p\u003e\n\u003cp\u003eConsistency：可以实现最终一致性\nTransactions：Master支持完整事务\nLatency、Throuput：读写的时候都直接在master上完成，所以低时延、高吞吐。\nData loss：可能造成数据丢失\nFailover：恢复的时候slave还是可以提供read\u003c/p\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003eMaster/Master\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eLeaderless模式，每一个节点都可以接受读写请求。比如DynamoDB。\u003c/p\u003e\n\u003cp\u003eConsistency：可以实现最终一致性\nTransactions：只能本地支持\nLatency、Throuput：低时延、高吞吐。\nData loss：可能造成数据丢失\nFailover：仍能正常运作\u003c/p\u003e\n\u003col start=\"4\"\u003e\n\u003cli\u003e2PC\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e二阶段模式\u003c/p\u003e\n\u003cp\u003eConsistency：强一致性\nTransactions：支持完整事务\nLatency、Throuput：因为每次都需要两阶段，比较差\nData loss：只要写入后资料达成一致就不会丢失\nFailover：仍能正常运作\u003c/p\u003e\n\u003col start=\"5\"\u003e\n\u003cli\u003ePaxos \u0026amp; Raft\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e虽然表中没有raft，实际上raft和paxos也差不多。\nPaxos可以认为是优化2PC之后的最优解。\u003c/p\u003e\n\u003cp\u003eConsistency：强一致性\nTransactions：支持完整事务\nLatency、Throuput：需要半数达成一致，相对差一点\nDataloss：只要写入后资料达成一致就不会丢失\nFailover：只要有半数的节点存活就可以正常运行。\u003c/p\u003e\n\u003cp\u003e参考：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"https://ithelp.ithome.com.tw/users/20121042/ironman/2792\"\u003ehttps://ithelp.ithome.com.tw/users/20121042/ironman/2792\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://time.geekbang.org/column/intro/100046101\"\u003ehttps://time.geekbang.org/column/intro/100046101\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","date":1639927098,"description":"","fuzzywordcount":7000,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"023f69570d961b1f2974b0bcefc4b0e2","publishdate":1639927098,"relpermalink":"/posts/distribution-system-2/","section":"posts","summary":"拜占庭将军问题 拜占庭将军问题是分布式领域最复杂的一个容错模型，较好地抽象了分布式系统面临的共识问题。 假如你是一位拜占庭的将军，需要与其他几个国家的军队做沟通，而","tags":["分布式","精选"],"title":"分布式系统（二）：共识算法","url":"https://blog.engine.wang/posts/distribution-system-2/","wordcount":6938},{"categories":"posts","content":"\u003ch2 id=\"acidbase2pc3pc\"\u003eACID、BASE、2PC/3PC\u003c/h2\u003e\n\u003ch3 id=\"acid\"\u003eACID\u003c/h3\u003e\n\u003cp\u003e在讲ACID之前，先讲本地事务，事务最早在数据库等课程中就接触过，简单来说，事务提供一种“要么什么也不做，要么全做完”的机制。\u003c/p\u003e\n\u003cp\u003eACID特性是数据库事务的基本特征，包括：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eAtomicity 原子性\u003c/li\u003e\n\u003cli\u003eConsistency 一致性\u003c/li\u003e\n\u003cli\u003eIsolation 隔离性\u003c/li\u003e\n\u003cli\u003eDurability 持久性\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e合称就是ACID（在英语中正好是酸的意思，之后的BASE碱也与之对应）\u003c/p\u003e\n\u003cp\u003e然而分布式事务和本地事务不同，假设有一个操作需要多个机器上执行，要么都执行，要么都不执行。\n要保持分布式事务的ACID，方法有二阶段提交协议和TCC。\u003c/p\u003e\n\u003ch3 id=\"2pc二阶段提交协议\"\u003e2PC二阶段提交协议\u003c/h3\u003e\n\u003cp\u003e一个事务跨越多个节点，成为分布式事务，为了保持ACID，需要引入一个协调者的角色来统一掌控所有节点的结果。\u003c/p\u003e\n\u003cp\u003e整个过程被分为两个阶段：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e准备阶段（投票）\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e协调者给每个参与者发送Prepare信息，每个参与者有两种选择：\n①返回失败\n②本地执行事务返回成功，但不提交。询问之后的所有事务操作都记log，以便之后的恢复。\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e提交阶段（执行）\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e如果协调者收到了失败或者超时，就直接给每个参与者发送回滚消息，否则就发送提交（commit）消息。\n参与者如果收到提交消息，就提交事务，并释放资源和锁。如果收到回滚消息，就回滚事务，并释放资源和锁。\u003c/p\u003e\n\u003cp\u003e二阶段提交协议的缺点：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e同步阻塞，从投票开始到提交完成的这段时间，所用的资源被锁死\u003c/li\u003e\n\u003cli\u003e单点故障，如果协调者故障了，就会一直阻塞\u003c/li\u003e\n\u003cli\u003e数据不一致，第二阶段发送commit时可能部分节点因为故障收不到，导致只有一部分执行了commit。\n等\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e之后有提出三阶段协议3PC，对二阶段协议进行了改进，然而由于增加了通信成本，实际用的并不多，就不细讲。\u003c/p\u003e\n\u003ch3 id=\"tcctry-confirm-cancel\"\u003eTCC（Try-Confirm-Cancel）\u003c/h3\u003e\n\u003cp\u003eTCC是一个业务层面的协议，需要在业务代码中编写，包含了预留、确认或撤销三个阶段。\n核心思想是针对每个操作都要注册一个对其对应的确认操作和补偿操作。\n首先是try阶段，先通知各个节点的将要进行的操作。\n如果try阶段的回复都是ok，就执行确认操作，通知各个节点要执行操作；如果try阶段有错误或者超时，就执行撤销操作，\u003c/p\u003e\n\u003cp\u003e可以说ACID是CAP一致性的边界，也就是最强的一致性。\u003c/p\u003e\n\u003ch3 id=\"base\"\u003eBASE\u003c/h3\u003e\n\u003cp\u003eBASE则是追求可用性，是CAP中AP的拓展。\u003c/p\u003e\n\u003cp\u003eBASE的核心是基本可用（Basically Available）和最终一致性（Eventually Consistent）\u003c/p\u003e\n\u003cp\u003e比如遇到峰值，可以用四板斧解决：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e流量削峰，将访问请求错开，比如多个秒杀商品放在不同的时间开始\u003c/li\u003e\n\u003cli\u003e延迟请求，比如买火车票抢票的时候等一段时间系统才处理\u003c/li\u003e\n\u003cli\u003e体验降级，比如先用小图片代替原始图片\u003c/li\u003e\n\u003cli\u003e过载保护，请求放入队列中排队处理，超时了就直接拒绝，队列满了之后就清除一定的请求。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e目的是在基本可用性上保持妥协，谁也不想牺牲这些服务，但是为了可用性必须这样。\u003c/p\u003e\n\u003cp\u003e最终一致性是指所有数据副本在经过一段时间的同步之后，最终能保持一致性。\n显示生活中，除了金融等对一致性要求极高的领域，它们会使用强一致性。绝大部分互联网系统都采用最终一致性。\u003c/p\u003e\n\u003cp\u003e实现最终一致性的方式用的多的有以下几种：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e读时修复，查询数据的时候如果检测到不同的数据，系统自动修复\u003c/li\u003e\n\u003cli\u003e写时修复，写失败的时候先将数据缓存下来，之后定时重传\u003c/li\u003e\n\u003cli\u003e异步修复，最常用，通过定时对账来检测副本数据的一致性并修复\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e然而异步修复和读时修复的开销比较大，需要进行一致性对比，而写时修复的开销低。\u003c/p\u003e\n\u003cp\u003e如果要设计分布式数据库的一致性的时候，可以采用自定义写一致级别（All、Quorum、One、All）来让用户自主选择业务所适合的一致性级别\u003c/p\u003e\n\u003cp\u003eBASE通过牺牲强一致性来获得高可用性。\u003c/p\u003e\n\u003ch2 id=\"cap\"\u003eCAP\u003c/h2\u003e\n\u003cp\u003e分布式系统的最大难点之一就是维护各个节点之间的数据状态一致性。\n需要通过数据库或者分布式缓存来维护数据的一致性。\u003c/p\u003e\n\u003cp\u003eCAP是三个缩写的组合：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eC（Consistency）：数据一致性，分布式系统中，同一份数据可能存在于多个实例中，其中一份的修改必须同步到所有它的备份中。也就是说每一次必然能读到最新写入的数据，或者返回错误。\u003c/li\u003e\n\u003cli\u003eA（Availability）：服务可用性，服务在接收到客户端请求时必须要给出响应。在高并发和部分结点宕机的情况下依然可以响应。也就是每一次必然会返回结果，但是不保证是最新的正确的。\u003c/li\u003e\n\u003cli\u003eP（Partition tolerance）：分区容忍性，由于网络的不可靠性，位于不同网络分区的结点可能会通信失败，如果能容忍这种情况，那么就满足分区容忍性。也就是说出现问题能够容忍。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e一个分布式系统不可能同时满足这三个基本需求，最多只能满足两项。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e满足CA\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e也就是必然一致而且能够返回正确结果，这样是不存在的，其实就是单Server，不叫分布式系统。\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e满足CP\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e牺牲A，只要系统中有一个Server没更新完，就返回错误，否则就返回正确的最新的值。\u003c/p\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e满足AP\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e牺牲C，也就是只要Server接收到请求就返回目前的值，但是不能保证一定是最新的正确的值。\u003c/p\u003e\n\u003cp\u003e分布式系统必须满足分区容忍性，也就是只能从A和P中进行取舍，数据一致性和服务可用性只能满足一个。当然实际情况不可能只顾一个而完全放弃另一个，而是在主要关心一个的前提下尽量满足另一个。\u003c/p\u003e\n\u003cp\u003e比较成熟的服务注册与发现有以下几个：Consul、Etcd、Zookeeper、Eureka\u003c/p\u003e\n\u003cp\u003e其中Consul、Etcd、Zookeeper满足了CP，而Eureka满足了AP。\u003c/p\u003e\n\u003ch2 id=\"一致化模型consistency-model\"\u003e一致化模型Consistency Model\u003c/h2\u003e\n\u003cp\u003e对Consistency的不同程度的要求也衍生出了多种不同的等级模型。根据不同的情况采取不同的模型。\u003c/p\u003e\n\u003cp\u003e假设有一场球赛，记分员负责将分数写入主Server，然后会将操作复制到各个replica server，读取分数的话可能是任意一个server。\u003c/p\u003e\n\u003cp\u003ek=0,1分别代表主队和客队，如果主队得了一分，记分员操作是：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003ev = get(k)\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eset(k, v+1)\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640193245/cap-2.png\" alt=\"cap-2\"\u003e\u003c/p\u003e\n\u003cp\u003e假设目前比分是2:5\u003c/p\u003e\n\u003ch3 id=\"strong-consistency\"\u003eStrong Consistency\u003c/h3\u003e\n\u003cp\u003e对于任何一个人，读到的一定是最新的\u003c/p\u003e\n\u003ch3 id=\"eventual-consistency\"\u003eEventual Consistency\u003c/h3\u003e\n\u003cp\u003e只把结果给其他Server，只能保证最后的时刻会更新到正确的最终值，但是之前读到任何小于结果的得分都有可能，甚至是完全没出现过的得分，比如2:0\u003c/p\u003e\n\u003ch3 id=\"consistent-prefix\"\u003eConsistent Prefix\u003c/h3\u003e\n\u003cp\u003e连同操作一起给其他Server，从而保证读到的一定是比赛中的某个比分，历史发生过。\u003c/p\u003e\n\u003ch3 id=\"bounded-staleness\"\u003eBounded Staleness\u003c/h3\u003e\n\u003cp\u003e保证读到的一定是t以内的结果。Bounded=0则为Strong Consistency。Bounded=无穷则为Eventual Consistency。\u003c/p\u003e\n\u003ch3 id=\"monotonic-reads\"\u003eMonotonic Reads\u003c/h3\u003e\n\u003cp\u003e可能返回任何结果，但是接下来会持续从同一个replica server中读取，保证每一次都至少会比之前的值新。\u003c/p\u003e\n\u003ch3 id=\"read-my-writes\"\u003eRead My Writes\u003c/h3\u003e\n\u003cp\u003e如果某个client对Server进行了set操作，那么之后的get必然是set的值。\u003c/p\u003e\n\u003cp\u003e不同的角色，要求的系统模型不一样。\n记分员：只有他会写入系统，用Read My Writes\n裁判：只能Strong Consistency\n报分员：保证是历史正确比分，然后每一次至少比上次新，Consistent Prefix+Monotonic Reads\n记者：Bounded Staleness就可以，多等点时间\n观众：无所谓，Eventual Consistency都行\u003c/p\u003e\n\u003cp\u003e银行的系统必然是Strong Consistency，只能最新。而DNS只要是Eventual Consistency就可以，因为需要快速返回结果，不是最新的也可以接受。\u003c/p\u003e\n\u003ch2 id=\"quorum-system\"\u003eQuorum System\u003c/h2\u003e\n\u003cp\u003eQuorum System随着Amazon与2007年发表的\u003ccode\u003eDynamo: Amazon’s Highly Available Key-value Store\u003c/code\u003e论文而提出，这篇论文是NoSQL的代表之作。DynamoDB是一个NoSQL数据库，支持键值和文档数据结构，具有Strongly Consistent和Eventually Consistent。\u003c/p\u003e\n\u003cp\u003e之前都是往一个Leader Server里写入，然后复制到replica server里，而我们更需要的是写入的时候任何一个Server都可以，读取的时候也是任何一个Server都可以。\n也就是Leaderless Replication\u003c/p\u003e\n\u003cp\u003e但是这样做的问题在于，如果两个写入操作的时间比较靠近，很可能出现对于不同的服务器而言，指令到达的时刻顺序不一致，从而错误。\u003c/p\u003e\n\u003cp\u003e一种方法是每次写入都加锁，也就是去抢每个replicas server的锁，直到都写完了才释放所有的锁，让下一个写入进入。但是这样的话过于严格，效率低下。\u003c/p\u003e\n\u003cp\u003e把条件放松一些。\n对于写入操作，当一个client取得w个replicas的Lock才被允许写入。\n取得R个replicas的Lock才被允许读。\n写入时搭配timestamp。\u003c/p\u003e\n\u003cp\u003e只要W+W\u0026gt;N就可以防止同时写的发生，保证不会出现最新的值不明确的情况。这个不解释。\u003c/p\u003e\n\u003cp\u003e只要W+R\u0026gt;N就可以防止同时读写的发生，保证不会出现读取的值不是最新值的情况。配合timestamp之后，根据抽屉理论，读的时候至少会读到一台最新的server，从而根据timestamp可以找出它。\u003c/p\u003e\n\u003cp\u003e通过Quorum System，可以不必设置primary server、replica server的形式，直接对任一server进行读写，仍然能保证Strong Consistency。\u003c/p\u003e\n\u003cp\u003e这样的话，通过使用DynamoDB，Amazon会在世界各个地方的数据中心存放你的数据，进行备份，也能通过local replica进行加速。\u003c/p\u003e\n\u003ch3 id=\"read-repair和anti-entropy\"\u003eRead-Repair和Anti-Entropy\u003c/h3\u003e\n\u003cp\u003e如果说有几个节点瘫痪了，导致每个都无法拿到超过一半的锁。\u003c/p\u003e\n\u003cp\u003eRead-Repair就是在读取的时候不仅通过timestamp拿到最新的结果，还顺便将最新的结果写回其他的server里去。这种适用于频繁读取的情况。\u003c/p\u003e\n\u003cp\u003e另一个方法是Anti-Entropy，也就是单独创建一个process，通过检查replica的版本并将所有server都同步成最新的。适用于读取不频繁的情况。\u003c/p\u003e\n\u003ch3 id=\"hinted-handoff\"\u003eHinted Handoff\u003c/h3\u003e\n\u003cp\u003e故障的server恢复之后，系统会写回这个server，这种做法叫Hinted Handoff。\n写失败的请求会缓存到本地硬盘上，并周期性的尝试重传。\u003c/p\u003e\n\u003ch3 id=\"quorum-nwr\"\u003eQuorum NWR\u003c/h3\u003e\n\u003cp\u003e对于AP系统，可以保证最终一致性但是无法保证强一致性。如果想满足强一致性，可以借助Quorum NWR。\u003c/p\u003e\n\u003cp\u003eQuorum NWR可以根据业务的特点，调整一致性级别。\u003c/p\u003e\n\u003cp\u003e三个要素：N、W、R\u003c/p\u003e\n\u003cp\u003eN：复制因子，也就是一个集群中，数据有多少个副本，当然不同的数据可能有不同的副本数\nW：写一致性级别，成功完成W个副本更新，才完成写操作\nR：读一致性级别，读一个数据对象需要读R个副本\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eW + R \u0026gt; N：不会出现并行读写，一定能读到最新值\u003c/strong\u003e\nW + W \u0026gt; N：不会出现并行写\nW + W \u0026lt;= N：可能出现不一致\nW + R \u0026lt;= N：可能会读不到最新的值\nR + R \u0026gt; N：\u003c/p\u003e\n\u003ch2 id=\"分布式系统的时间\"\u003e分布式系统的时间\u003c/h2\u003e\n\u003cp\u003e通常会采用W+W\u0026lt;=N来尽量保证Availablity，这种情况下如何规避并行写导致的不一致呢。\u003c/p\u003e\n\u003cp\u003e一个方式就是要了解两个指令在发出时的先后顺序，而不是到达时的顺序，从而保证一致性。看起来通过发出信号时就附加timestamp可以解决问题，看起来每台机器的时间是一样的，然而实际上并不一定。\u003c/p\u003e\n\u003cp\u003e由于每台机器自身的时间并不一定准确，甚至可能会出现接受到信息的timestamp比机器当前时间还要晚的情况（收到来自“未来”的消息），这样就很离谱，明显不合理。\u003c/p\u003e\n\u003ch3 id=\"lamport-logical-clock\"\u003eLamport Logical Clock\u003c/h3\u003e\n\u003cp\u003e在消息里夹带一个timestamp，但是在传递的时候，每个结点接受到timestamp后，会比较自身时间与timestamp的大小，然后选择最大的那个置为新的timestamp，从而保证一定递增。收到的消息的timestamp比本身时间还大的话，就将自己的时间改为timestamp的时间。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e每个参与者最开始都保存一个timestamp=0\u003c/li\u003e\n\u003cli\u003e如果在本地发生，timestamp+1\u003c/li\u003e\n\u003cli\u003e如果传递这个消息，timestamp+1，然后传递时附带该timestamp\u003c/li\u003e\n\u003cli\u003e如果接受这个消息，timestamp = Max(本地Clock, 消息timestamp) + 1\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e（Lamport发明了Latex）\u003c/p\u003e\n\u003ch3 id=\"vector-clock\"\u003eVector Clock\u003c/h3\u003e\n\u003cp\u003eLamport timestamp会显示两个先后的事件有因果关系，但是实际逻辑上并不一定，可能只是同时平行发生。\u003c/p\u003e\n\u003cp\u003e对于N个Node的系统，Vector Clock让每个Node都存储一个长度为N的timestamp vector\u003c/p\u003e\n\u003cp\u003e对于$Node_i$而言，存储$Vector_i = {t_0, t_1, ..., t_n}$\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e初始化每个Node的vector中的每个元素都为0\u003c/li\u003e\n\u003cli\u003e$Node_i$发生一个事件，$V_i[t_i]+1$\u003c/li\u003e\n\u003cli\u003e$Node_i$发生一个发送事件，$V_i[t_i]+1$，并夹带这个vector\u003c/li\u003e\n\u003cli\u003e$Node_j$发生一个接受事件，$V_j[t_i] = V_i[t_i]$、$V_j[t_j] = Max(V_j[t_j],V_i[t_i]) + 1$\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e参考：https://ithelp.ithome.com.tw/users/20121042/ironman/2792\u003c/p\u003e\n","date":1637252478,"description":"","fuzzywordcount":5100,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"e4a584c44ee6571fb543fcf4416dda32","publishdate":1637252478,"relpermalink":"/posts/distribution-system-1/","section":"posts","summary":"ACID、BASE、2PC/3PC ACID 在讲ACID之前，先讲本地事务，事务最早在数据库等课程中就接触过，简单来说，事务提供一种“要么什么也不做，要么全做完”的机制","tags":["分布式"],"title":"分布式系统（一）：CAP及基础理论","url":"https://blog.engine.wang/posts/distribution-system-1/","wordcount":5025},{"categories":"posts","content":"\u003ch2 id=\"前言\"\u003e前言\u003c/h2\u003e\n\u003cp\u003e可解释性是指人类能够理解决策原因的程度。模型一方面需要有一定的预测能力，另外还应当让人类可以理解，为什么模型会根据这些数据作出最后的判断，也就是中间的决策过程能够被解释。\u003c/p\u003e\n\u003cp\u003e模型的可解释性一直以来是一个热点且重要的研究方向。\u003c/p\u003e\n\u003cp\u003e线性回归非常好解释，一旦写出公式，人类很容易理解，但是只能表示线性关系，预测能力不足。另一边的极端是深度神经网络，它们可以在数据和预测之间建立非常深的非线性抽象联系，预测能力很好，但是中间过程几乎是黑箱，人类无法理解模型决策的依据。\u003c/p\u003e\n\u003cp\u003e所以大部分深度学习模型只能用评价指标来评价模型预测能力的好坏，而很少讨论其可解释性。\u003c/p\u003e\n\u003ch2 id=\"为什么要做可解释性分析\"\u003e为什么要做可解释性分析\u003c/h2\u003e\n\u003ch3 id=\"如果没有可解释性在很多领域的实用性会受到限制\"\u003e如果没有可解释性，在很多领域的实用性会受到限制\u003c/h3\u003e\n\u003cp\u003e在很多实际领域，如军工、医学、法律、无人驾驶，即使模型预测能力再好，没有可解释性依然不会使用，如果用户不信任模型或预测，他们就不会使用它，所以模型的中间过程不能是黑箱，中间的过程必须用合理的理由解释清楚。。\u003c/p\u003e\n\u003cp\u003e欧盟的《通用数据保护条例》（GDPR）法律要求对算法的决策过程进行解释，以使其在用于患者护理之前透明\u003c/p\u003e\n\u003cp\u003e绝大部分的模型建立者的说法都是：\n“我的模型有很好的预测能力”\u003c/p\u003e\n\u003cp\u003e但是模型使用者的问题往往是：\n“我为什么要相信你的模型？”\u003c/p\u003e\n\u003ch3 id=\"揭露错误过程\"\u003e揭露错误过程\u003c/h3\u003e\n\u003cp\u003e有可能在数据集上的表现很好，但本身模型的预测有问题，如果没有可解释性可能难以看出，比如北极熊和棕熊的分类，可能模型实际上只是识别了背景是否有冰雪，可能模型本身的预测和实际需要的并没有什么联系。如果有可解释性，就可以删掉一些没有意义的特征从而改进模型。\u003c/p\u003e\n\u003ch3 id=\"3揭示新的成像表示物\"\u003e3揭示新的成像表示物\u003c/h3\u003e\n\u003cp\u003e可解释性方法还可以揭示新的成像生物标志物，从而了解深度神经网络的具体情况。\u003c/p\u003e\n\u003ch2 id=\"对可解释性的理解\"\u003e对可解释性的理解\u003c/h2\u003e\n\u003cp\u003e可解释性指的是任何试图回答“模型为什么做出这种预测”问题的技术。我们想要弄清楚以下几个问题：\u003c/p\u003e\n\u003cp\u003ewhat？是什么驱动了模型的判断，公平性\nwhy？为什么模型会给出这个预测结果，可靠性\nhow？我们如何信任模型的预测，透明度\u003c/p\u003e\n\u003ch2 id=\"可解释性方法的分类\"\u003e可解释性方法的分类\u003c/h2\u003e\n\u003cp\u003e可解释性方法可以分为Pre-Model、In-Model和Post-Model。\u003c/p\u003e\n\u003cp\u003e其中Pre-Model指的是解释独立于模型本身，只能应用于数据，比如PCA、t-SNE、聚类等。\u003c/p\u003e\n\u003cp\u003eIn-Model指的是模型本身本质上可解释（一般是一些统计学、机器学习模型），有数理的推导过程，比如模型本身有因果性、外在约束以及自带特征权重等。比如线性回归、逻辑回归、决策树、SVM等。\u003c/p\u003e\n\u003cp\u003ePost-Model又称为Post hoc，指的是模型本身是黑盒，但是训练后应用可解释性方法（特征重要性、部分依赖性图）等，从而使得模型可以被解释。\u003c/p\u003e\n\u003ch2 id=\"通用的可解释性方法\"\u003e通用的可解释性方法\u003c/h2\u003e\n\u003ch3 id=\"特征重要性\"\u003e特征重要性\u003c/h3\u003e\n\u003cp\u003e给出不同特征的重要性权重\u003c/p\u003e\n\u003cp\u003e特征重要性可以告诉你哪些特征是最重要的或者是不重要的。\u003c/p\u003e\n\u003ch3 id=\"部分依赖图\"\u003e部分依赖图\u003c/h3\u003e\n\u003cp\u003ePDP或者PD图\u003c/p\u003e\n\u003cp\u003e可以展示一个特征如何影响预测，显示特征对预测结果的边际效应。\npartial dependence图可以告诉你一个特征是如何影响预测的。\u003c/p\u003e\n\u003ch3 id=\"shap\"\u003eSHAP\u003c/h3\u003e\n\u003cp\u003e可以讨论各个特征对预测结果的贡献。\nSHAP将预测值解释为每个输入特征的归因值之和，相比于特征重要性，SHAP更能清楚的反映每个样本中各个特征的影响力，具有样本特异性，也能反馈出作用的正负性。\n一个特征的shapley value是该特征在所有的特征序列中的平均边际贡献。\u003c/p\u003e\n\u003ch3 id=\"lime\"\u003eLIME\u003c/h3\u003e\n\u003cp\u003eLocal Interpretable Model-Agnostic Explanations（LIME）与模型无关，可以用于任何机器学习模型，通过扰动样本输入量化预测结果的变化来理解模型。\u003c/p\u003e\n\u003cp\u003e有时候可能不是自己的模型，无法更改，如果还想要可解释性，可以考虑LIME。即使对模型内部完全不清楚也能解释行为。\u003c/p\u003e\n\u003cp\u003eLIME的核心思想是：对一个复杂的分类模型(黑盒)，在局部拟合出一个简单的可解释模型，例如线性模型、决策树等等。\u003c/p\u003e\n\u003cp\u003e将图像划分为多个超像素块（划分为像素太小了）每个像素块进行扰动，看对结果的影响。从而找出影响程度最大的几个超像素\u003c/p\u003e\n\u003cp\u003e不过缺点就是比较慢，因为相当于每次改变还要过一次模型\u003c/p\u003e\n\u003ch2 id=\"深度学习医学图像的可解释性\"\u003e深度学习医学图像的可解释性\u003c/h2\u003e\n\u003ch3 id=\"概念学习模型-concept-learning-models\"\u003e概念学习模型 Concept Learning Models\u003c/h3\u003e\n\u003cp\u003e放射学家无法直接理解图像的深层特征，所以先从图像中预测高级语义特征（如临床概念），再使用这些可解释的概念进行最终预测。\u003c/p\u003e\n\u003cp\u003e不过缺点就是需要手动注释这些标签。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1644560615/dl-interpret-2.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"基于案例的模型-case-based-models\"\u003e基于案例的模型 Case-Based Models\u003c/h3\u003e\n\u003cp\u003e基于案例的模型适用于分类任务，它通过比较从图像中提取的特征和类别特异性原型。原型分类是可解释的，因为预测是通过输入和原型特征之间的相似性程度来判断的。\u003c/p\u003e\n\u003cp\u003e局限：容易受到噪声和压缩的影响，且难以训练。\u003c/p\u003e\n\u003ch3 id=\"反事实解释-counterfactual-explanation\"\u003e反事实解释 Counterfactual Explanation\u003c/h3\u003e\n\u003cp\u003e通过对原始图像施加最小扰动来最大程度地改变模型预测结果，从而能够发现关键区域和改变预测所需的重要变化。\u003c/p\u003e\n\u003cp\u003e反事实的图像基本是通过GANs或者扰动autoencoder的潜在空间来生成的。\u003c/p\u003e\n\u003cp\u003e局限：生成图像的分辨率是有限的。\u003c/p\u003e\n\u003ch3 id=\"概念因子-concept-attribution\"\u003e概念因子 Concept Attribution\u003c/h3\u003e\n\u003cp\u003e全局的解释，可以量化深层概念或放射学特征对预测结果的影响。\u003c/p\u003e\n\u003cp\u003e局限性：很难对深层的特征进行标注。\u003c/p\u003e\n\u003ch3 id=\"语言描述-language-description\"\u003e语言描述 Language Description\u003c/h3\u003e\n\u003cp\u003e在预测的同时增加文本描述提供解释，不过增加了很多注释成本。\u003c/p\u003e\n\u003cp\u003e文本解释和预测一致\u003c/p\u003e\n\u003cp\u003e局限：结构化诊断报告需要更多注释，在测试过程中重复训练句子。\u003c/p\u003e\n\u003ch3 id=\"潜在空间解释-latent-space-interpretation\"\u003e潜在空间解释 Latent Space Interpretation\u003c/h3\u003e\n\u003cp\u003e潜在空间用于揭示数据中与临床知识相关的显著变异因素。在二维中可视化高维潜在空间，以识别相似性和异常值。\u003c/p\u003e\n\u003cp\u003e比如采用PCA、t-SNE等方式降维CNN的高维特征\u003c/p\u003e\n\u003cp\u003e局限：将高维特征空间投影到二维时的信息丢失。潜在空间中的相似性并不总是转化为人类可解释特征方面的相似性。\u003c/p\u003e\n\u003ch3 id=\"归因图-attribution-map\"\u003e归因图 Attribution Map\u003c/h3\u003e\n\u003cp\u003e通过突出显示模型认为重要的输入图像区域，可以提供事后解释。\nAttribution Map可以理解为描述区域重要程度的热力图，反映的是注意力，和原图尺寸是一样的。\u003c/p\u003e\n\u003cp\u003e不过这种热力图反应的是作出贡献的程度，但是却没有反映如何为预测作出贡献。\u003c/p\u003e\n\u003cp\u003e比如分层相关性传播分层相关性传播（LRP），通过评估相关性得分生成热图，一层层计算每个神经元的贡献大小\u003c/p\u003e\n\u003ch4 id=\"camclass-activation-mapping\"\u003eCAM（Class Activation Mapping）\u003c/h4\u003e\n\u003cp\u003e类激活映射（Class Activation Maps，CAM）在最后一个卷积层之后添加一个全局平均池层。然后将全局平均池层的输出线性组合以生成类预测。通过获取最后一个卷积层激活的加权和，获得每个类的CAM。不过使用CAM的网络不能有全连接层。\u003c/p\u003e\n\u003cp\u003e接上GAP全局平均池化然后softmax，就可以获得每个class的热图\u003c/p\u003e\n\u003cp\u003eGAP替换MLP，求每张特征图所有像素的均值。支持任意大小的输入。\u003c/p\u003e\n\u003cp\u003e最后一层生成了和目标类别数量一致的特征图，经过GAP再经过softmax得到结果，这样就给每个特征图赋予了意义。\u003c/p\u003e\n\u003cp\u003e每一个类别C、每个特征图k都有一个对应的权重$w^c_k$\u003c/p\u003e\n\u003cp\u003e训练完后，对于每一个类别C，可以加权所有的特征图合成针对某个类别的热力图，从而看出重要的地方。\u003c/p\u003e\n\u003ch4 id=\"grad-cam\"\u003eGrad-CAM\u003c/h4\u003e\n\u003cp\u003eCAM的缺点在于，他需要修改原模型的结构，需要重新训练模型\u003c/p\u003e\n\u003cp\u003eGrad-CAM和CAM的最大区别在于求权重$w^c_k$的过程，Grad-CAM通过梯度的全局平均来计算权重，数学推导和CAM的权重是等价的。\u003c/p\u003e\n\u003cp\u003e第k个特征图针对类别C的权重：\n$$\n\\alpha_{k}^{c}=\\frac{1}{Z} \\sum_{i} \\sum_{j} \\frac{\\partial y^{c}}{\\partial A_{i j}^{k}}\n$$\u003c/p\u003e\n\u003cp\u003eZ是特征图像素个数，$y^c$是对应类别的分数（softmax之前的值），$ A_{i j}^{k}$是第k个特征图的(i,j)位置的像素值，得到所有权重后，加权求和即可得到热力图：\u003c/p\u003e\n\u003cp\u003e$$\nL_{G r a d-C A M}^{c}=\\operatorname{ReLU}\\left(\\sum_{k} \\alpha_{k}^{c} A^{k}\\right)\n$$\u003c/p\u003e\n\u003cp\u003e局限：没有提供相关区域如何对结果作出贡献，多个类可能高亮相同的区域。\u003c/p\u003e\n\u003ch3 id=\"解剖先验-anatomical-prior\"\u003e解剖先验 Anatomical Prior\u003c/h3\u003e\n\u003cp\u003e任务特定的结构信息被纳入网络的设计过程中。\u003c/p\u003e\n\u003cp\u003e局限：可能需要专业的临床知识，但解剖学知识不能用于所有问题。\u003c/p\u003e\n\u003ch3 id=\"内部网络表示-internal-network-representation\"\u003e内部网络表示 Internal Network Representation\u003c/h3\u003e\n\u003cp\u003e将CNN中不同过滤器学习到的特征的可视化。\u003c/p\u003e\n\u003cp\u003e局限：不同的过滤器学会识别的结构和模式在医学图像中很难解释。\u003c/p\u003e\n\u003ch2 id=\"可解释性评估方式\"\u003e可解释性评估方式\u003c/h2\u003e\n\u003cp\u003e分为基于应用的、基于人工的、基于功能的共三种\u003c/p\u003e\n\u003cp\u003e参考：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eTransparency of Deep Neural Networks for Medical Image Analysis Review of Interpretability Methods\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://zhuanlan.zhihu.com/p/258988892\"\u003ehttps://zhuanlan.zhihu.com/p/258988892\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://zhuanlan.zhihu.com/p/326586020\"\u003ehttps://zhuanlan.zhihu.com/p/326586020\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.jiqizhixin.com/articles/2019-10-30-9\"\u003ehttps://www.jiqizhixin.com/articles/2019-10-30-9\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","date":1635781293,"description":"","fuzzywordcount":3100,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"21b4c3cfc38ccdfddff84e0208aa873e","publishdate":1635781293,"relpermalink":"/posts/talk-about-model-interpreter/","section":"posts","summary":"前言 可解释性是指人类能够理解决策原因的程度。模型一方面需要有一定的预测能力，另外还应当让人类可以理解，为什么模型会根据这些数据作出最后的判断，也就是中间的决策过","tags":["深度学习","计算机视觉","可解释性"],"title":"浅谈深度学习模型的可解释性","url":"https://blog.engine.wang/posts/talk-about-model-interpreter/","wordcount":3085},{"categories":"posts","content":"\u003ch2 id=\"介绍\"\u003e介绍\u003c/h2\u003e\n\u003cp\u003e为什么需要Bigtable？\n需要一个集群支持海量的随机读写，需要支持到每秒百万级别的随机读写。在Bigtable没出之前，使用MySQL集群可以解决一些问题，然而一方面会放弃关系型数据库的很多特征，比如外键约束、跨行跨表的事务等。一方面在扩容的时候不得不翻倍扩容，非常浪费。缩减服务器也非常麻烦。另外，在每次故障恢复的时候也需要人工介入。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640192906/bigtable-0.png\" alt=\"bigtable-0\"\u003e\u003c/p\u003e\n\u003cp\u003e希望的伸缩性是可以随机增加或者去掉人任何数量的服务器，并且进行这些操作时不会使服务暂停。\u003c/p\u003e\n\u003cp\u003eBigtable建立在GFS的架构之上，是一个管理结构化数据的分布式存储系统，可以拓展到非常大的规模，比如跨越数千服务器的PB级别的数据。\nGoogle已经将其用在了很多内部产品中，Bigtable为其提供了一套高性能的可灵活拓展的解决方案。\u003c/p\u003e\n\u003cp\u003e在很多方面，Bigtable像是数据库，但相比于以往的系统，Bigtable提供了不一样的接口。它不支持完整的关系型数据模型。可以使用任意字符的行列名对数据进行索引，Bigtable将数据都视为未解释的字符串。\u003c/p\u003e\n\u003cp\u003e当然Bigtable也有缺点，一个是放弃了关系模型，不支持SQL；一个是放弃了跨行的事务，只支持单行的事务模型。\u003c/p\u003e\n\u003cp\u003eBigtable的解决方法是：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e将存储层搭建在GFS上，通过单Master调度多Tablets的形式，使得集群容易维护，伸缩性好\u003c/li\u003e\n\u003cli\u003e通过MenTable+SSTable的底层文件格式，解决高速随机读写的问题\u003c/li\u003e\n\u003cli\u003e通过Chubby分布式锁解决一致性的问题\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"数据模型\"\u003e数据模型\u003c/h2\u003e\n\u003cp\u003eBigtable是一个稀疏的、分布式的永久存储的多维排序map，这个map通过row key、column key和timestamp进行索引，每个值都是一个未解释的字符串。\u003c/p\u003e\n\u003cp\u003e(row: string, column: string, time: int64) -\u0026gt; string\u003c/p\u003e\n\u003cp\u003e下图是一个存储网页的table\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003erow是url的倒转，比如www.google.com会存为com.google.www，这样的目的是前面的www大家都一样，而且子域名就会主域名靠一起。\u003c/li\u003e\n\u003cli\u003e有多列，其中\u003ccode\u003econtents:\u003c/code\u003e列存储网页html内容。\u003ccode\u003eanchor:\u003c/code\u003e列存储指向这个页面的anchor文字，比如cnnsi.com和my.look.ca有指向www.cnn.com的anchor，就如下图所示存储。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640192906/bigtable-1.png\" alt=\"bigtable-1\"\u003e\u003c/p\u003e\n\u003ch3 id=\"rows\"\u003eRows\u003c/h3\u003e\n\u003cp\u003e行key是表的主键，可以是任意字符串，最大为64kb，在单行的读写都是原子的。\n由于读写总是通过行键，这样的数据库也叫做KV数据库。\nBigtable按行key对数据进行排序，行范围动态分区，每个行的范围被称为tablet，是分布式和负载均衡的单位。\u003c/p\u003e\n\u003ch3 id=\"column-families-列族\"\u003eColumn Families 列族\u003c/h3\u003e\n\u003cp\u003e每一行的数据需要指定列族，每个列族下不需要指定列，每个数据都可以有自己的列，每一行的列可以不一样。这也就是为什么说Bigtable是稀疏的表：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640192908/bigtable-2.png\" alt=\"bigtable-2\"\u003e\u003c/p\u003e\n\u003cp\u003e列key被分组到了一个集合里，被称为column families，每个column families里的应当是相同类型。必须先创建column families，才能使用列key存储数据。\n列key通过\u003ccode\u003efamily:qualifier\u003c/code\u003e命名。比如存储web的表可以用language当做family，另一种是可以用anchor来当做family，每个列key是一个anchor，qualifier是指向该url的网址，内容是链接文本。\n访问控制和硬盘内存的记录都是在列family层级下进行的。\n比如Bigtable的开源实现HBase，每一个列族的数据存在同一个HFile文件下。\u003c/p\u003e\n\u003ch3 id=\"timestamp\"\u003eTimestamp\u003c/h3\u003e\n\u003cp\u003eBigtable的每个单元格可以包含相同数据的多个版本，不同的版本通过时间戳进行索引。Bigtable的时间戳是64位的整数。不同版本以递减的形式存储，以便可以首先读取最新版本。\u003c/p\u003e\n\u003cp\u003e为了防止变得过于繁重，可以指定个数或过期时间，之前的版本被gc。\u003c/p\u003e\n\u003ch2 id=\"api\"\u003eAPI\u003c/h2\u003e\n\u003cp\u003eBigtable的API包括创建、删除表和列族，以及修改簇、表、列族元数据等。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e9\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-C++\" data-lang=\"C++\"\u003e\u003cspan class=\"c1\"\u003e// Open the table\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003eTable\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eOpenOrDie\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;/bigtable/web/webtable\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// Write a new anchor and delete an old anchor\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003eRowMutation\u003c/span\u003e \u003cspan class=\"nf\"\u003er1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;com.cnn.www\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003er1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;anchor:www.c-span.org\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;CNN\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003er1\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDelete\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;anchor:www.abc.com\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003eOperation\u003c/span\u003e \u003cspan class=\"n\"\u003eop\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eApply\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eop\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003er1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-C++\" data-lang=\"C++\"\u003e\u003cspan class=\"n\"\u003eScanner\u003c/span\u003e \u003cspan class=\"nf\"\u003escanner\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003eScanStream\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003estream\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003estream\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003escanner\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFetchColumnFamily\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;anchor\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003estream\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eSetReturnAllVersions\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"n\"\u003escanner\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLookup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;com.cnn.www\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(;\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003estream\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eDone\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"n\"\u003estream\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eNext\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;%s %s %lld %s\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"n\"\u003escanner\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRowName\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n  \u003cspan class=\"n\"\u003estream\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eColumnName\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n  \u003cspan class=\"n\"\u003estream\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eMicroTimestamp\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n  \u003cspan class=\"n\"\u003estream\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"构建块\"\u003e构建块\u003c/h2\u003e\n\u003cp\u003eBigtable使用GFS存储日志和数据文件，\u003ccode\u003eSSTable\u003c/code\u003e用于存储Bigtable数据，每个SSTable包含一个块序列（每个块64kb），并且SSTable可以被完全的映射到内存中，不需要接触磁盘就可以执行查找和扫描。\u003c/p\u003e\n\u003cp\u003eBigtable依赖于分布式锁Chubby，Chubby包含了5个副本，其中一个被选为master并提供request服务。我后面会专门再讲一下Chubby。\u003c/p\u003e\n\u003cp\u003eBigtable通过Chubby完成以下任务：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e确保每个时刻只有一个master\u003c/li\u003e\n\u003cli\u003e存储Bigtable数据的引导位置\u003c/li\u003e\n\u003cli\u003e存储Bigtable每个表的列族信息\u003c/li\u003e\n\u003cli\u003e存储访问控制列表ACL\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e如果Chubby不可用，那么Bigtable也将不可用\u003c/p\u003e\n\u003ch2 id=\"实现\"\u003e实现\u003c/h2\u003e\n\u003cp\u003eBigtable包含三个主要组件：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e链接到每个客户端的库\u003c/li\u003e\n\u003cli\u003e一个master服务器\u003c/li\u003e\n\u003cli\u003e多个tablet服务器\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003etablet可以动态的增加删除。\u003c/p\u003e\n\u003cp\u003emaster的职责：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e负责将tablet分配给tablet服务器\u003c/li\u003e\n\u003cli\u003e检测tablet的添加和过期\u003c/li\u003e\n\u003cli\u003e平衡Tablet server之间的负载\u003c/li\u003e\n\u003cli\u003e对GFS的文件进行gc\u003c/li\u003e\n\u003cli\u003e管理Table和列族的Schema变更\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e每个tablet服务器存储一组tablet（通常是10-1000个），\u003c/p\u003e\n\u003cp\u003eBigtable和Tablet Server都不进行数据的存储只负责在线业务，存储工作通过SSTable的数据格式写到GFS上。\u003c/p\u003e\n\u003ch3 id=\"tablet位置\"\u003eTablet位置\u003c/h3\u003e\n\u003cp\u003e通过B+树存储tablet的位置\u003c/p\u003e\n\u003cp\u003e定义了一张特殊的表Root tablet专门存放元数据，这个分区不会分裂，存的是元数据里其他Tablets的位置。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640192904/bigtable-5.jpg\" alt=\"bigtable-5\"\u003e\u003c/p\u003e\n\u003cp\u003e第一级存储在Chubby的文件，包含root tablet的位置，root包含metadata tablets，包含了其他所有tablet的位置。tablet不做分割，确保不超过三层。\u003c/p\u003e\n\u003cp\u003e举个例子，客户端查询ECOMMERCE_ORDERS业务表行键是A20210101RST的某个记录，客户端查询的具体操作：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640192906/bigtable-6.png\" alt=\"bigtable-6\"\u003e\u003c/p\u003e\n\u003cp\u003e也就是说在具体查找数据之前需要三次网络请求来获得数据的具体位置。一般前几次的查询也会缓存起来，以减少请求次数。\u003c/p\u003e\n\u003cp\u003e三层结构可以让Bigtable拓展到足够大，tablet大小限制为128MB，每条记录大约1KB，可以存$2^{34}$个Tablet，也就是160亿个Tablet。\u003c/p\u003e\n\u003cp\u003e客户端不需要经过master，让设计更加高可用\u003c/p\u003e\n\u003ch3 id=\"动态分区\"\u003e动态分区\u003c/h3\u003e\n\u003cp\u003eBigtable采用动态区间分区，通过自动去split的方式动态分区。\n好比是往箱子里放书，按照书名的字母顺序，一旦箱子装满，就中间一分为二，将下面一半放到一个新的空箱子里去。\n如果两个相邻的箱子都很空，就可以将其合并。\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640192909/bigtable-4.png\" alt=\"bigtable-4\"\u003e\u003c/p\u003e\n\u003ch2 id=\"sstable底层结构\"\u003eSSTable底层结构\u003c/h2\u003e\n\u003cp\u003eBigtable的写入数据的过程：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003etablet server先做数据验证，以及权限验证\u003c/li\u003e\n\u003cli\u003e如果合法，就以追加写的形式顺序写到GFS\u003c/li\u003e\n\u003cli\u003e写入成功后还会写到一张内存表MenTable中\u003c/li\u003e\n\u003cli\u003e写入的数据快要超过阈值时，会将内存的MemTable冻结，创建一个新的MemTable，被冻结的MemTable会被转换为SSTable写入到GFS，然后从内存中释放掉。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eMajor Compaction机制，对SSTable进行合并，把数据压实在一起，比如只留下时间戳最近的三个版本的数据。\n读取数据的时候，读取的是MemTable和SSTable的合并在一起的视图。\n也就是说并没有直接的修改和删除操作，一旦写入就是不可变的，写入的是数据的一个新版本，后台会定时gc，通过合并SSTable来清楚过期和被删除的数据。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640192906/bigtable-7.png\" alt=\"bigtable-7\"\u003e\u003c/p\u003e\n\u003ch2 id=\"总结\"\u003e总结\u003c/h2\u003e\n\u003cp\u003eBigtable包括四个组件：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e负责存储数据的GFS\u003c/li\u003e\n\u003cli\u003e负责作为分布式锁和目录服务的Chubby\u003c/li\u003e\n\u003cli\u003e复杂提供在线服务的Tablet Server\u003c/li\u003e\n\u003cli\u003e复杂调度Tablet和调整负载的Master\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640192908/bigtable-8.png\" alt=\"bigtable-8\"\u003e\u003c/p\u003e\n","date":1635265278,"description":"","fuzzywordcount":3200,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"534c672cce63a5648075561473d22efb","publishdate":1635265278,"relpermalink":"/posts/bigtable/","section":"posts","summary":"介绍 为什么需要Bigtable？ 需要一个集群支持海量的随机读写，需要支持到每秒百万级别的随机读写。在Bigtable没出之前，使用MySQL集群可以解决一些问题","tags":["Bigtable","分布式","大数据"],"title":"Google三驾马车（三）—— Bigtable","url":"https://blog.engine.wang/posts/bigtable/","wordcount":3123},{"categories":"posts","content":"\u003ch2 id=\"介绍\"\u003e介绍\u003c/h2\u003e\n\u003cp\u003eMapReduce是一个用于处理和生成大型数据集的编程模型和相关实现，它是一个分布式模型，通过一个Map函数将k/v对生存一组中间态的k/v对，然后通过一个reduce函数将所有的中间态k/v对进行聚合。\nMapReduce运行在一个大型的商用机器集群上，比如可以在数千台机器上处理大量TB级别的数据。\n实际上Google早已将其用于实际的任务，每天有超过1000个MapReduce任务在谷歌的集群上运行。\u003c/p\u003e\n\u003cp\u003e面对百亿级别的爬虫数据、日志文件等，常规方法不可能做到时效性，只能采用分布式系统进行并行计算。\u003c/p\u003e\n\u003ch2 id=\"编程模型\"\u003e编程模型\u003c/h2\u003e\n\u003cp\u003e输入是一系列k/v对的set，输出也是一系列k/v对的set\u003c/p\u003e\n\u003cp\u003e用户需要编写Map和Reduce这两个函数，其中Map函数通过输入pair来产生中间过程的k/v对\n接下来会将Key为I的中间值传递给对应处理Key I的Reduce函数\nReduce函数接受一系列的Key为I的值，然后merge在一起，每次只有0或1\n具体的见下面的例子。\u003c/p\u003e\n\u003ch3 id=\"例子\"\u003e例子\u003c/h3\u003e\n\u003cp\u003e输入文件首先分块，\n需要一个Map函数，每个输入文件输入Map进行处理，每个都是并行的，产生对应的输出，输出是一个list形式的Key/Value的键值对。\u003c/p\u003e\n\u003cp\u003e假设我们的功能是读取字符出现的次数。\n假设输入为\u0026quot;abbac\u0026quot;，被拆成了三个文件，总共也就这三个Key。分别是\u0026quot;ab\u0026quot;,\u0026quot;b\u0026quot;,\u0026quot;ac\u0026quot;，并行输入进Map，三个输出分别为：\n(a,1), (b,1)\n(b,1)\n(a,1), (c,1)\u003c/p\u003e\n\u003cp\u003e然后进行reduce操作，对于每个Key，会传入reduce函数进行汇总，去统计每个Key的出现个数。这也是并行的。\u003c/p\u003e\n\u003cp\u003e那么经过reduce操作之后，输出为：\n(a, 2)\n(b, 2)\n(c, 1)\u003c/p\u003e\n\u003cp\u003e完整的Job由一系列的MapTask和一系列的reduceTask组成。\u003c/p\u003e\n\u003cp\u003e下面来说说对于统计字母的功能下，Map和Reduce这两个函数的结构：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-C++\" data-lang=\"C++\"\u003e\u003cspan class=\"c1\"\u003e// Map函数，k指明文件，v是文件内容\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003eMap\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n  \u003cspan class=\"n\"\u003esplit\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"n\"\u003eto\u003c/span\u003e \u003cspan class=\"n\"\u003ewords\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003eeach\u003c/span\u003e \u003cspan class=\"n\"\u003eword\u003c/span\u003e \u003cspan class=\"n\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eemit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-C++\" data-lang=\"C++\"\u003e\u003cspan class=\"c1\"\u003e// reduce函数，k是这个字母，v是包含这个字母的map数量\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003ereduce\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eemit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eMapReduc和GFS都运行在一起，在并行进Map的时候，实际上避免了网络传输，中控通过某些方式能够知道该文件存在哪台主机里，然后在该主机调用Map本地操作，从而减少带宽传输限制。后面reduce只能通过网络。\u003c/p\u003e\n\u003cp\u003e最开始是按行存储，然后按列存储，这个过程叫Shuffle，从Map服务器到Reduce服务器，这一过程很消耗网络。\u003c/p\u003e\n\u003ch3 id=\"类型\"\u003e类型\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003emap\u003c/code\u003e函数 输入是\u003ccode\u003e(k1, v1)\u003c/code\u003e，输出是\u003ccode\u003elist(k2, v2)\u003c/code\u003e\n\u003ccode\u003ereduce\u003c/code\u003e函数 输入是\u003ccode\u003e(k2, list(v2))\u003c/code\u003e，输出是\u003ccode\u003elist(v2)\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e以统计词频为例，这里map的输入是(filename, fileContent)，输出是对于每一个单词为key的k/v列表，比如[\u0026quot;Apple\u0026quot;: 1, \u0026quot;Banana\u0026quot;: 1,...]。\n这里reduce的输入就是一个单独单词的一系列值，比如\u003ccode\u003e\u0026quot;Apple\u0026quot;, [1, 1, 1,...]\u003c/code\u003e，然后输出是该单词的词频。\u003c/p\u003e\n\u003ch3 id=\"更多的例子\"\u003e更多的例子\u003c/h3\u003e\n\u003cp\u003e除此之外还有很多适用于MapReduce的很好的例子。\u003c/p\u003e\n\u003ch2 id=\"实现\"\u003e实现\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640192780/mapreduce-1.png\" alt=\"mapreduce-1\"\u003e\u003c/p\u003e\n\u003cp\u003e分割输入数据，分成M个子集，被调用分布到多台机器上并行处理。之后分割中间key形成R个片（比如通过\u003ccode\u003ehash(key) mod R\u003c/code\u003e），reduce调用分布到各个机器上。\u003c/p\u003e\n\u003cp\u003e具体步骤：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e分割输入文件为M个片，每个片的大小约16-64M\u003c/li\u003e\n\u003cli\u003e一个master，和多个worker，有M个map任务和R个reduce任务将被分配，管理者的一个任务是分配map或者reduce任务给一个空闲的worker\u003c/li\u003e\n\u003cli\u003e被分配了map任务的worker需要做的是读取输入片的内容，分析出k/v对，传递给用户自定义的map函数，产生的中间k/v对缓存在内存中。\u003c/li\u003e\n\u003cli\u003e缓存在内存中的k/v对通过分割函数写入R个区域，本地的缓存对的位置传送给master，然后master把这些位置传送给reduce worker。\u003c/li\u003e\n\u003cli\u003ereduce worker通过远程调用来从map worker的磁盘上读取缓存的内容，reduce worker通过排序使得具有相同key的内容聚集在一起。如果中间数据比内存还大，就需要外排序。\u003c/li\u003e\n\u003cli\u003ereduce worker迭代排过序的中间数据，对于每一个唯一的key，把key和相关的value传递给reduce函数，reduce函数的输出被添加到最终的输出文件中\u003c/li\u003e\n\u003cli\u003e所有的map和reduce都完成之后，管理者唤醒用户程序，用户程序的MapReduce调用返回到用户代码\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"master的数据结构\"\u003eMaster的数据结构\u003c/h3\u003e\n\u003cp\u003emaster首先会存储每个map任务和reduce任务的状态（空闲、进行中、完成）以及工作机器的标识。\nmaster还会存储由map产生的中间文件的区域和大小，然后传给reduce的worker\u003c/p\u003e\n\u003ch3 id=\"容错\"\u003e容错\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eworker故障\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003emaster会定期ping每个worker，如果一段时间内没有收到响应，master就会将该结点标记为failed。正在进行的map或者reduce更是会重设状态，被调给其他worker。\n然而，这些worker已经完成的map任务也会重新设置为idle状态，将会调度给其他的worker，这是因为它们的输出会存在故障机器的本地磁盘上，不过已经完成的reduce任务不需要重新运行，因为它们会存在全局文件系统上。\u003c/p\u003e\n\u003cp\u003e如果一个map任务在A worker上执行，然后A挂了，被调度给了B worker。所有的在做reduce的worker都会被通知到这个，然后读取对应的中间数据会从B读取。\u003c/p\u003e\n\u003cp\u003eMapReduce对大规模的worker故障有弹性。\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eMaster故障\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003emaster会定期将内部的数据结构写到checkpoints里，如果master挂了，可以很容易的从最后一个checkpoints开启一个新的副本。\u003c/p\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e失败时的Semantics\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e即使有故障，也能得到和没故障发生的情况下一样的输出。\u003c/p\u003e\n\u003cp\u003e依赖于map和reduce任务提交的原子性\u003c/p\u003e\n\u003ch3 id=\"本地\"\u003e本地\u003c/h3\u003e\n\u003cp\u003e带宽是一种相对稀缺的资源，通过GFS存储在cluster的本地磁盘上。大部分输入数据会在本地读取，不消耗网络带宽。\u003c/p\u003e\n\u003ch3 id=\"任务粒度\"\u003e任务粒度\u003c/h3\u003e\n\u003cp\u003emap任务被分为了M个片，reduce任务被分为了R个片，M和R实际上会远高于实际的worker机器，\u003c/p\u003e\n\u003cp\u003emaster将做$O(M+R)$的任务调度，以及保存$O(M*N)$个状态。\u003c/p\u003e\n\u003ch3 id=\"备份任务\"\u003e备份任务\u003c/h3\u003e\n\u003cp\u003e有时候可能会出现某个任务运行过久导致严重影响整体性能，比如某个worker机器的磁盘坏了导致非常慢的运行，它依然响应服务器的心跳不能认为是failed，但是运行就是非常慢。\nMapReduce有一个备份任务的机制，就是当MapReduce即将完成的时候，也就是大多数任务都做完了，那么就会去备份还没完成的任务，只要原始任务或者备份任务的其中一个做完了就可以。\u003c/p\u003e\n\u003ch2 id=\"改良拓展性能表现与实验\"\u003e改良拓展、性能表现与实验\u003c/h2\u003e\n\u003cp\u003e上述已经是一个基本的MapReduce的任务了，一些改进拓展、性能表现与实验就不详细说明了，日后可以研究。\u003c/p\u003e\n","date":1634559678,"description":"","fuzzywordcount":2900,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"96e10a22c2f40cfcca1a0543f2648669","publishdate":1634559678,"relpermalink":"/posts/mapreduce/","section":"posts","summary":"介绍 MapReduce是一个用于处理和生成大型数据集的编程模型和相关实现，它是一个分布式模型，通过一个Map函数将k/v对生存一组中间态的k/v对，然后通过一个","tags":["MapReduce","分布式","大数据"],"title":"Google三驾马车（二）—— MapReduce","url":"https://blog.engine.wang/posts/mapreduce/","wordcount":2801},{"categories":"posts","content":"\u003ch2 id=\"介绍\"\u003e介绍\u003c/h2\u003e\n\u003cp\u003eGFS，即Google File System，谷歌文件系统。\n它是一种能够用于大型密集型数据的可拓展的分布式文件系统。（大型存储系统），它对于廉价硬件提供了容错机制；对于大量客户的情况能有高表现。\u003c/p\u003e\n\u003cp\u003eGFS的设计是由实际的应用程序负载和技术环境驱动的，与传统的文件系统的一些假设不一样。\u003c/p\u003e\n\u003ch2 id=\"设计\"\u003e设计\u003c/h2\u003e\n\u003ch3 id=\"一些假设\"\u003e一些假设\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e软硬件故障是常态而不是例外\u003c/li\u003e\n\u003cli\u003e文件是巨大的（多GB级也是普遍的）\u003c/li\u003e\n\u003cli\u003e负载包括大的流式读取和小的随机读取\u003c/li\u003e\n\u003cli\u003e负载还包括大的顺序的append写入\u003c/li\u003e\n\u003cli\u003e大多数文件是通过append而不是overwrite来改变的，一旦写入，就只能读取，而且是顺序读\u003c/li\u003e\n\u003cli\u003e放宽了一致性，从而极大简化了文件系统\u003c/li\u003e\n\u003cli\u003e引入了原子的追加写，可以并发的追加\u003c/li\u003e\n\u003cli\u003e高的持续带宽比低延迟更重要\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e一般用append，GFS对其一致性有保证，最好不用write\u003c/p\u003e\n\u003ch3 id=\"接口\"\u003e接口\u003c/h3\u003e\n\u003cp\u003e接口方面支持通用的create、delte、open、close、read、write。并且还有snapshot和append操作。\nsnapshot以低成本创建文件或者目录的副本，append允许多个客户端并发的追加同一个文件，保证原子性。\n对于实现多路合并以及生产者-消费者模型很有用。\u003c/p\u003e\n\u003ch3 id=\"架构\"\u003e架构\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640192564/gfs-1.png\" alt=\"gfs-1\"\u003e\u003c/p\u003e\n\u003cp\u003e一个GFS集群由一个master结点和多个chunk sever构成，并被多个客户端访问。它们通常都是普通的Linux机器。\u003c/p\u003e\n\u003cp\u003eGFS把文件切割为若干固定长度的Chunk块并存储，每个块的大小是64MB，在创建块时，对于每一个Chunk，master还会为其分配一个64位的全局唯一的Handle句柄。为了保证Chunk的可用性，每个块都会被复制到多个chunk server上，默认存储三个副本。\u003c/p\u003e\n\u003cp\u003emaster维护所有文件系统的元数据，包括namespace、访问控制信息、从文件到chunk的映射、以及块的当前位置。它还控制系统范围内的活动，比如chunk的租约管理、孤立chunk的gc、chunk server之间的chunk迁移。master定期与chunkserver维持心跳通信，给chunkserver指令以及接受它们的状态。客户端和chunkserver都不需要缓存文件数据，从而简化系统，唯一可能要缓存的可能就是客户机会缓存一下元数据。\u003c/p\u003e\n\u003ch3 id=\"single-master\"\u003eSingle Master\u003c/h3\u003e\n\u003cp\u003e设立一个master可以极大的简化系统的设计，可以很方便地进行全局信息的管理。然而单一的master很容易成为系统的瓶颈，所以只能让其尽可能少的参与读写。客户端从来不从master中读写文件数据，而是向master询问它需要的文件在哪，然后访问这些chunkserver去进行文件交互。\u003c/p\u003e\n\u003cp\u003e下面解释一下交互过程，首先客户端借助固定的块大小，将文件名和偏移量转换为块索引，然后向master发送包含文件名和块索引的请求，master返回一个chunk句柄和副本的位置。接下来客户端会向其中一个（往往是最近的）存储着该文件副本的chunkserver发送请求，之后对同一个chunkserver的交互不需要master的参与。事实上客户端通常一次会请求多个块。\u003c/p\u003e\n\u003ch3 id=\"chunk-size\"\u003eChunk Size\u003c/h3\u003e\n\u003cp\u003e选择的是64MB，比典型文件系统的块大得多，相对于小的chunk size，更大的chunk size的优势在于：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e减少客户端请求的chunk数量，减少客户端与master的交互需求。\u003c/li\u003e\n\u003cli\u003e大的chunk可以让客户端执行很多操作，通过较长时间与chunkserver的持续的tcp连接来减少网络开销\u003c/li\u003e\n\u003cli\u003e减少了chunk的个数，从而减少了存储在master的元数据的大小\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e当然，大的chunk size也有缺点：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e可能会出现更多客户端访问一个chunk从而导致这个chunk成为hot spots。一般来说还好，不过如果某个可执行文件被写入了某个chunk，然后在数百台机器上同时启动，那个chunkserver就很容易超载。一个解决方法是将可执行文件复制更多份，并使批队列系统错开启动时间。还有一个解决方法是允许客户机从其他客户机读取数据。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"metadata\"\u003eMetadata\u003c/h3\u003e\n\u003cp\u003e元数据包含文件和chunk的namespace、从文件到块的映射、以及每个chunk副本的位置，所有的元数据都存储在master的内存中。前面两个也通过日志的方式存储在本地磁盘中，实现持久性存储，顺带也复制在远程机器上备份。这个主要是保证即使master崩溃了也不会出现不一致。\n至于chunk副本的位置，master并不会持久地存储，而是在master启动的时候对每个chunkserver进行轮询，或者在新的chunkserver加入集群时询问。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e内存中的数据结构\n元数据存储在内存中，所以访问起来很快。\nmaster还会在后台周期性的扫描整个状态，用于实现gc、chunkserver故障时的重新复制、块迁移来平衡负载等。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e可能会认为说元数据存在master内存中，整个系统的容量会受到master内存的限制，实际上chunk由于比较大，个数不会那么多，master也只需要存每个chunk的不到64字节的元数据，所以还好。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003echunk位置\n前面说了master通过启动时的轮询获得信息，并且还会保持一个心跳来监听各个chunkserver的状态。\n由于集群很大，如果在master上持久化在本地存储chunk副本位置，之后变动会很多（改名、宕机、重启等），并且实际上chunkserver才是对chunk有着最终决定权，在master上维护一个一致性的视图是没有意义的。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e操作日志\n操作日志包含了元数据发生重大变化的历史记录，是GFS的核心。它是元数据的唯一持久性记录，也作为定义并发操作顺序的逻辑时间线。操作日志需要被可靠地存储。\n如果系统崩了，master就会重新执行log来恢复GFS，所以log也不宜过大，以免启动时间过长。会先找到重载的checkpoint然后执行之后的日志记录。检查点是一种类似B树的紧凑形式，加快恢复速度。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"一致性模型\"\u003e一致性模型\u003c/h3\u003e\n\u003cp\u003eGFS并不保持一个严格的一致性，而是保持一个相对宽松的一致性\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eGFS保证的\n命名空间是原子的，保证操作日志是全局的顺序正确的。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e数据更改之后的文件区域的状态：\u003c/p\u003e\n\u003cp\u003e文件数据更改之后，会定义一个region，其状态取决于变化的种类（write/append）、是否并行、成功还是失败。\u003c/p\u003e\n\u003cp\u003e如果它是一致的，客户端会看到变化写入的内容。\n如何区分已定义区域和未定义区域。\u003c/p\u003e\n\u003cp\u003e在一次成功的顺序变化后，GFS会：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e在chunk的所有副本上以相同的顺序应用这些变化\u003c/li\u003e\n\u003cli\u003e使用chunk版本号来检测副本\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e应用程序应当append而不是write。\u003c/p\u003e\n\u003ch2 id=\"系统交互\"\u003e系统交互\u003c/h2\u003e\n\u003cp\u003e描述客户端、master、chunkserver如何进行交互，完成数据更改、原子追加和快照。\u003c/p\u003e\n\u003ch3 id=\"租约和数据更改顺序\"\u003e租约和数据更改顺序\u003c/h3\u003e\n\u003cp\u003e数据更改（mutations）就是改变chunk的内容或者元数据的操作，比如write或append。数据更改在chunk副本上执行。\n使用租约（leases）来维持副本之间的一致的变化顺序。master会将租约授权给其中一个副本，称之为该chunk的主服务器（primary）。主服务器会为这个chunk的所有更改进行顺序排序，其余的所有副本都遵守这个顺序进行更改。\n租约机制的目的也是减少master的管理开销，租约的初始时间是60s，不过主要chunk发生了改变，primary就可以向master请求拓展，这些请求被承载在心跳信息上。\u003c/p\u003e\n\u003cp\u003e下图是写操作的控制流与详细的步骤\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640192564/gfs-2.png\" alt=\"gfs-2\"\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e客户端询问master哪个chunkserver持有当前chunk的租约，以及其他副本的位置。如果没有服务器有租约，master就选择一个副本服务器分给它租约\u003c/li\u003e\n\u003cli\u003e服务器返回primary和副本chunkserver的位置，客户端把它们存在缓存中，如果未来短期内再次访问就不需要请求master。除非primary不可达或者primary告知客户端它没有租约了。\u003c/li\u003e\n\u003cli\u003e客户端知道副本位置后，将数据push进所有的副本中，可以按照任何顺序。每个chunkserver将数据存储在一个内部的LRU缓存中\u003c/li\u003e\n\u003cli\u003e一旦所有的副本都确认接受到了数据，客户端就向primary发送写请求，标识了之前push的数据，primary会分配序列号给这些mutations，提供必要的序列化\u003c/li\u003e\n\u003cli\u003eprimary将写请求转发给各个备用副本，每个备份副本按照序列号执行更改\u003c/li\u003e\n\u003cli\u003e备份副本回复primary表示已经完成了操作\u003c/li\u003e\n\u003cli\u003eprimary响应客户端，任何遇到的错误也会报告\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"数据流\"\u003e数据流\u003c/h3\u003e\n\u003cp\u003e数据流和控制流解耦，为了充分利用每台机器的带宽，数据被线性的沿着chunkserver链进行推送，而不是分布在拓扑网络中，这样每台机器的带宽就可以被充分利用，每台机器将数据转发到网络拓扑中“最近的”没有接收到它的机器。（感觉像Prim算法）\u003c/p\u003e\n\u003ch3 id=\"原子追加\"\u003e原子追加\u003c/h3\u003e\n\u003cp\u003eGFS提供了原子追加（atomic record appends）操作。\n传统的写操作需要提供数据和偏移量，如果出现并行的情况就很可能会出现来自多个客户端的碎片。\n在GFS中，客户端只提供数据，GFS会选择偏移量并将其返回给客户端，类似于Unix的\u003ccode\u003eO_APPEND\u003c/code\u003e。\u003c/p\u003e\n\u003cp\u003e大量使用record append，如果是传统的写操作，为了保持一致性就只能使用分布式锁，代价很昂贵。\u003c/p\u003e\n\u003ch3 id=\"snapshot快照\"\u003eSnapshot快照\u003c/h3\u003e\n\u003cp\u003e类似AFS，使用标准的copy-on-write技术实现快照。\u003c/p\u003e\n\u003ch2 id=\"master操作\"\u003eMaster操作\u003c/h2\u003e\n\u003cp\u003emaster的任务：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e执行所有namespace相关的操作\u003c/li\u003e\n\u003cli\u003e管理系统的chunk副本以及与之相关的一些操作\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"namespace的管理和锁定\"\u003enamespace的管理和锁定\u003c/h3\u003e\n\u003cp\u003eGFS没有传统文件系统的per-directory数据结构。也不支持alias。\u003c/p\u003e\n\u003ch3 id=\"gc\"\u003egc\u003c/h3\u003e\n\u003cp\u003e文件被删除之后，不会立即回收资源，而是先重命名为包含删除时间戳的隐藏文件，如果隐藏文件存在超过三天，就删除它们。在此期间，这些文件可以被恢复。\n内存元数据也会被删除，切断和所有chunk的联系，在和master的心跳中，chunkserver报告自己的chunks，master会返回不出现在namespace里的，chunkserver接受到后可以删掉这些chunk。\u003c/p\u003e\n\u003ch2 id=\"容错性与诊断\"\u003e容错性与诊断\u003c/h2\u003e\n\u003ch3 id=\"高可用性\"\u003e高可用性\u003c/h3\u003e\n\u003cp\u003e通过两种简单而有效的策略来保持整个系统的高可用性:快速恢复和复制\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e快速恢复\nmaster和chunkserver都可以在几秒内启动\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003echunk复制\n默认是复制3份\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003emaster复制\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e操作日志和检查点被复制到多台机器上\u003c/p\u003e\n","date":1633946418,"description":"","fuzzywordcount":4200,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"dade7d7149f779fb475e99550c915f21","publishdate":1633946418,"relpermalink":"/posts/gfs/","section":"posts","summary":"介绍 GFS，即Google File System，谷歌文件系统。 它是一种能够用于大型密集型数据的可拓展的分布式文件系统。（大型存储系统），它对于廉价硬件提供了容错机制；","tags":["GFS","分布式","大数据"],"title":"Google三驾马车（一）—— Google File System","url":"https://blog.engine.wang/posts/gfs/","wordcount":4114},{"categories":"posts","content":"\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645299146/docker-logo.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"docker概述\"\u003eDocker概述\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003e为什么需要Docker？\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e项目环境需要迁移，重新配环境很麻烦、一些配置很复杂程序想让其他人运行。\u003c/p\u003e\n\u003cp\u003e一个解决方法是虚拟机，但是虚拟机过于笨重。为了克服虚拟机的缺点，Linux发展出了一种虚拟化技术：Linux Container（LXC），该技术可以对进程进行隔离，对于容器里面的进程来说，接触到的所有资源都是虚拟的。\u003c/p\u003e\n\u003cp\u003eDocker则是对LXC的一种封装，是目前最流行的Linux容器方案，甚至成已然为了容器的代名词。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e虚拟机（Virtual Machine）和Docker的区别：\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645299151/docker-1.png\" alt=\"docker-1\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645299231/docker-2.png\" alt=\"docker-2\"\u003e\u003c/p\u003e\n\u003cp\u003eDocker相比于传统虚拟机的优点：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e更节约资源，同样的硬件可以运行更多的容器\u003c/li\u003e\n\u003cli\u003e启动更快\u003c/li\u003e\n\u003cli\u003e运行环境一致\u003c/li\u003e\n\u003cli\u003e持续交付和部署\u003c/li\u003e\n\u003cli\u003e更方便的迁移\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eDocker完美贴合DevOps理解，适用于CI/CD流程。\u003c/p\u003e\n\u003ch2 id=\"docker原理概述\"\u003eDocker原理概述\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645299288/docker-3.png\" alt=\"docker-3\"\u003e\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e概念\u003c/th\u003e\n\u003cth\u003e解释\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eDocker Client（客户端）\u003c/td\u003e\n\u003ctd\u003e客户端通过命令行或者其他工具与Docker Host进行通信\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eDocker Host（主机）\u003c/td\u003e\n\u003ctd\u003e用来执行Docker守护进程和容器的物理或者虚拟的机器\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eDocker Registry\u003c/td\u003e\n\u003ctd\u003e保存镜像的代码仓库，类似github\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch2 id=\"docker三大概念\"\u003eDocker三大概念\u003c/h2\u003e\n\u003ch3 id=\"镜像image\"\u003e镜像（image）\u003c/h3\u003e\n\u003cp\u003e相当于一个特殊的root文件系统，比如\u003ccode\u003eubuntu:18.04\u003c/code\u003e官方镜像，就包含一套完整的Ubuntu18.04最小系统的root文件系统，image也可以是多个image堆叠在一起组成，比如在一个image里同时放centOS、MySQL、nginx、app等。\u003c/p\u003e\n\u003cp\u003eimage可以看成是container的模板，一个image可以生成多个同时运行的container。\u003c/p\u003e\n\u003cp\u003eImage从哪里获得？\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e从Docker Hub pull下来\u003c/li\u003e\n\u003cli\u003e从其他地方导出的image导入进来\u003c/li\u003e\n\u003cli\u003e自行写Dockerfile\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e大部分情况下，为了节约时间，都是使用其他人的image或者在其他image上进行一些修改，很少会从0开始写。\u003c/p\u003e\n\u003cp\u003eDockerfile类似于一个创建container的脚本，因为Dockerfile的内容比较多，下一篇专门讲一下怎么写。\u003c/p\u003e\n\u003ch3 id=\"容器container\"\u003e容器（container）\u003c/h3\u003e\n\u003cp\u003eimage是静态的定义，container是镜像运行时的实体，类似于跑起来的一个个虚拟机。镜像和容器的关系，类似于面向对象过程中的类与示例。容器通过镜像产生，并独立运行。\u003c/p\u003e\n\u003cp\u003econtainer可以被创建、启动、停止、删除、暂停等。\u003c/p\u003e\n\u003cp\u003e容器不应该向存成内写入数据，所有的文件写入操作应该使用数据卷（Volume），数据卷可以使得容器删除或者重新运行后数据不会丢失\u003c/p\u003e\n\u003ch3 id=\"仓库repository\"\u003e仓库（repository）\u003c/h3\u003e\n\u003cp\u003eDocker Registry是一个集中的存储、分发镜像的服务。可以包含多个repository，每个repository可以包含多个标签，一个标签对应一个image\u003c/p\u003e\n\u003cp\u003e最主流的仓库是官方的Docker Hub\u003c/p\u003e\n\u003ch2 id=\"docker安装\"\u003eDocker安装\u003c/h2\u003e\n\u003cp\u003eDocker的安装很简单，一般直接去官网下载安装，然后运行Docker服务，命令行输入\u003ccode\u003edocker version\u003c/code\u003e，出现版本即安装成功。\u003c/p\u003e\n\u003ch2 id=\"docker命令\"\u003eDocker命令\u003c/h2\u003e\n\u003ch3 id=\"build\"\u003ebuild\u003c/h3\u003e\n\u003cp\u003e在含有Dockerfile的文件夹中执行：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003edocker build -t \u0026lt;IMAGE\u0026gt;:\u0026lt;tag\u0026gt; .\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"run\"\u003erun\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# 运行容器\u003c/span\u003e\ndocker run \u003cspan class=\"o\"\u003e[\u003c/span\u003eoption\u003cspan class=\"o\"\u003e]\u003c/span\u003e \u0026lt;image\u0026gt; \u003cspan class=\"o\"\u003e[\u003c/span\u003ecmd\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 比如\u003c/span\u003e\ndocker run --name ubuntu -it --rm ubuntu:18.04 bash\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e其中\u003ccode\u003e--name\u003c/code\u003e赋予一个名称，\u003ccode\u003e-it\u003c/code\u003e表示交互模式[i]的终端[t]，\u003ccode\u003e--rm\u003c/code\u003e表示运行完之后就删除这个container，最后的是在容器中执行的命令，这里是\u003ccode\u003ebash\u003c/code\u003e表示打开命令行。\u003c/p\u003e\n\u003cp\u003e这里docker run如果运行的是公用镜像，在本地找不到的话会自动去docker hub pull下来。\u003c/p\u003e\n\u003cp\u003e或者先创建不进去，之后运行交互命令行：\u003ccode\u003edocker exec -it \u0026lt;id/name\u0026gt; bash\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003edocker run的一些参数如下：\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e参数\u003c/th\u003e\n\u003cth\u003e说明\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e-i\u003c/td\u003e\n\u003ctd\u003e交互式\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e-t\u003c/td\u003e\n\u003ctd\u003e终端\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e-p\u003c/td\u003e\n\u003ctd\u003e端口映射，比如 \u003ccode\u003e-p 8000:3000\u003c/code\u003e指的就是本机的8000端口映射容器的3000端口\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e-P\u003c/td\u003e\n\u003ctd\u003e让容器的端口随机映射到本机上\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e-d\u003c/td\u003e\n\u003ctd\u003e后台运行容器\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e-v\u003c/td\u003e\n\u003ctd\u003e绑定一个卷\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e--name\u003c/td\u003e\n\u003ctd\u003e指定一个别名\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e--remove\u003c/td\u003e\n\u003ctd\u003e使用完就删除\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e--mount\u003c/td\u003e\n\u003ctd\u003e加载数据卷到容器的某个目录，比如\u003ccode\u003esource=my-vol,target=/usr/share/nginx/html\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e多个可用一起使用，比如\u003ccode\u003e-it\u003c/code\u003e表示运行容器的交互式终端\u003c/p\u003e\n\u003ch3 id=\"image相关\"\u003eimage相关\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# 列出全部的image\u003c/span\u003e\ndocker image list\n\u003cspan class=\"c1\"\u003e# 或者简写为\u003c/span\u003e\ndocker image ls\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e比如\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003eREPOSITORY        TAG       IMAGE ID       CREATED         SIZE\nredis             latest    f1b6973564e9   \u003cspan class=\"m\"\u003e3\u003c/span\u003e weeks ago     113MB\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# 删除image\u003c/span\u003e\ndocker image rm \u0026lt;id\u0026gt;/\u0026lt;短id\u0026gt;/\u0026lt;lable\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"container相关\"\u003econtainer相关\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# 列出所有正在运行的container\u003c/span\u003e\ndocker container list\n\u003cspan class=\"c1\"\u003e# 或者简写为\u003c/span\u003e\ndocker container ls\n\u003cspan class=\"c1\"\u003e# 或者进一步简写为\u003c/span\u003e\ndocker ps\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e比如\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003eCONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS                    NAMES\n29436842e21d   redis     \u003cspan class=\"s2\"\u003e\u0026#34;docker-entrypoint.s…\u0026#34;\u003c/span\u003e   \u003cspan class=\"m\"\u003e52\u003c/span\u003e minutes ago   Up \u003cspan class=\"m\"\u003e52\u003c/span\u003e minutes   0.0.0.0:6379-\u0026gt;6379/tcp   my-redis\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e其中CONTAINER ID和NAME都能指代唯一的container，之后说的\u0026lt;container_id\u0026gt;可以用其中之一表示，ID取前五位即可，比如\u003ccode\u003e29436\u003c/code\u003e和\u003ccode\u003emy-redis\u003c/code\u003e都可以指定这个container。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# 列出所有container，即使是已经停止运行的。\u003c/span\u003e\ndocker container ls --all\n\n\u003cspan class=\"c1\"\u003e# 停止某容器，只是停止容器运行，之后可以随时启动\u003c/span\u003e\ndocker stop \u0026lt;container_id\u0026gt;\n\n\u003cspan class=\"c1\"\u003e# 启动某容器，不会和run一样开一个新的，而是启动一个已经停止的container\u003c/span\u003e\ndocker start \u0026lt;container_id\u0026gt;\n\n\u003cspan class=\"c1\"\u003e# 进入容器，首先这个容器需要是running的\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 比如之前创建的时候后台运行了，就可以通过exec重新进入容器\u003c/span\u003e\ndocker \u003cspan class=\"nb\"\u003eexec\u003c/span\u003e \u0026lt;option\u0026gt; \u0026lt;container_id\u0026gt; \u003cspan class=\"o\"\u003e[\u003c/span\u003ecmd\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# 重启某容器\u003c/span\u003e\ndocker restart \u0026lt;container_id\u0026gt;\n\n\u003cspan class=\"c1\"\u003e# 删除某容器，不同于停止，删除会从本地完全删掉\u003c/span\u003e\ndocker rm \u0026lt;container_id\u0026gt;\n\n\u003cspan class=\"c1\"\u003e# 结束对应container的进程（如果container还在运行的话）\u003c/span\u003e\ndocker kill/stop \u003cspan class=\"o\"\u003e[\u003c/span\u003eid\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# 列出所有被停止的container的id\u003c/span\u003e\ndocker container ls -aq\n\n\u003cspan class=\"c1\"\u003e# 删除这些停止的container，不再占本地空间，之后ls --all就不会显示了\u003c/span\u003e\ndocker container rm  \u003cspan class=\"k\"\u003e$(\u003c/span\u003edocker container ls -aq\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e修改之后，如果要将container提交保存为image，使用commit命令：\n\u003ccode\u003edocker commit --author \u0026quot;engine\u0026quot; --message \u0026quot;msg\u0026quot; \u0026lt;name\u0026gt; \u0026lt;image:label\u0026gt;\u003c/code\u003e\n会返回一个sha256，但是并不建议这样，因为每次改动一个小地方就可能会动到很多系统文件，会很臃肿\u003c/p\u003e\n\u003ch3 id=\"其他\"\u003e其他\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# 列出docker image、repository、container占用的系统空间\u003c/span\u003e\ndocker system df\n\n\u003cspan class=\"c1\"\u003e# 查看某容器的端口映射\u003c/span\u003e\ndocker port \u0026lt;container_id\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"数据管理\"\u003e数据管理\u003c/h2\u003e\n\u003cp\u003e数据管理一般是通过数据卷或者挂载主机目录这两种方式：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645299354/docker-4.png\" alt=\"types-of-mounts\"\u003e\u003c/p\u003e\n\u003ch3 id=\"数据卷volume\"\u003e数据卷Volume\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# 创建一个数据卷\u003c/span\u003e\ndocker volume create \u0026lt;vol_name\u0026gt;\n\n\u003cspan class=\"c1\"\u003e# 查看所有数据卷\u003c/span\u003e\ndocker volume ls\n\n\u003cspan class=\"c1\"\u003e# 删除数据卷\u003c/span\u003e\ndocker volume rm \u0026lt;vol_name\u0026gt;\n\n\u003cspan class=\"c1\"\u003e# 清理无主的数据卷\u003c/span\u003e\ndocker volume prune\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003ccode\u003edocker run\u003c/code\u003e的时候可以通过\u003ccode\u003e--mount\u003c/code\u003e来加载数据卷到容器的某个目录\u003c/p\u003e\n\u003ch3 id=\"挂载主机目录\"\u003e挂载主机目录\u003c/h3\u003e\n\u003cp\u003e或者挂载主机目录，通过\u003ccode\u003e--mount type=bind,source=,target=\u003c/code\u003e来挂载\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003edocker run -d -P \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    --name web \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    \u003cspan class=\"c1\"\u003e# -v /src/webapp:/usr/share/nginx/html \\\u003c/span\u003e\n    --mount \u003cspan class=\"nv\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebind,source\u003cspan class=\"o\"\u003e=\u003c/span\u003e/src/webapp,target\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr/share/nginx/html \u003cspan class=\"se\"\u003e\\\n\u003c/span\u003e\u003cspan class=\"se\"\u003e\u003c/span\u003e    nginx:alpine\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"docker-compose\"\u003eDocker Compose\u003c/h2\u003e\n\u003cp\u003eDocker Compose负责快速的部署分布式应用。\nCompose允许用户通过一个单一的\u003ccode\u003edocker-compose.yml\u003c/code\u003e文件来为一个项目创建一组容器。\u003c/p\u003e\n\u003cp\u003e安装好doker后即可使用\u003ccode\u003edocker-compose\u003c/code\u003e命令，具体的yaml文件写法见官方文档：https://docs.docker.com/compose/compose-file/\u003c/p\u003e\n\u003ch2 id=\"docker-hub\"\u003eDocker Hub\u003c/h2\u003e\n\u003ch3 id=\"search\"\u003esearch\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# 搜寻指定image，只看官方\u003c/span\u003e\ndocker search \u0026lt;image\u0026gt; -f is-official\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"pull\"\u003epull\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003edocker pull \u003cspan class=\"o\"\u003e[\u003c/span\u003eoption\u003cspan class=\"o\"\u003e]\u003c/span\u003e Registry:port/name/label\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"push\"\u003epush\u003c/h3\u003e\n\u003cp\u003e先去Docker Hub注册，可以本地命令行登录\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003edocker login\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e在hub上创建好一个仓库，假设叫\u003ccode\u003e\u0026lt;REPO\u0026gt;\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e然后将image打tag：\n\u003ccode\u003edocker image tag \u0026lt;IMAGE_ID\u0026gt; \u0026lt;HUB_ID\u0026gt;/\u0026lt;REPO\u0026gt;:\u0026lt;version\u0026gt;\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003epush到repo中\n\u003ccode\u003edocker push \u0026lt;HUB_ID\u0026gt;/\u0026lt;REPO\u0026gt;:\u0026lt;version\u0026gt;\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e参考：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"https://docs.docker.com/\"\u003ehttps://docs.docker.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://ithelp.ithome.com.tw/users/20103456/ironman/1320\"\u003ehttps://ithelp.ithome.com.tw/users/20103456/ironman/1320\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://yeasy.gitbook.io/docker_practice/\"\u003ehttps://yeasy.gitbook.io/docker_practice/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.ruanyifeng.com/blog/2018/02/docker-tutorial.html\"\u003ehttps://www.ruanyifeng.com/blog/2018/02/docker-tutorial.html\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.runoob.com/docker/docker-container-usage.html\"\u003ehttps://www.runoob.com/docker/docker-container-usage.html\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","date":1629365254,"description":"","fuzzywordcount":3000,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"29468e108464248efda12af70cf857f5","publishdate":1629365254,"relpermalink":"/posts/docker-basics/","section":"posts","summary":"Docker概述 为什么需要Docker？ 项目环境需要迁移，重新配环境很麻烦、一些配置很复杂程序想让其他人运行。 一个解决方法是虚拟机，但是虚拟机过于笨重。为了克服","tags":["Docker"],"title":"Docker基础","url":"https://blog.engine.wang/posts/docker-basics/","wordcount":2917},{"categories":"posts","content":"\u003cp\u003enas的便捷早已融入了生活,最开始是利用路由器挂载移动硬盘的方式，目前仍在使用不过容量有限(4T)。\u003c/p\u003e\n\u003cp\u003e而我的主机是win10+Ubuntu18.04双系统，除去2T的SSD系统盘之外，去年还买了两块机械硬盘(16TB+6TB)用来存文件，也就是22T，为此我基本把百度云存的一些课程完整下到了本地，win10打开samba比较容易，勾选几个选项就好，而目前大部分时间其实是在Ubuntu下跑实验，所以需要在Ubuntu下开启samba共享，简单记录一下步骤：\u003c/p\u003e\n\u003ch2 id=\"挂载硬盘\"\u003e挂载硬盘\u003c/h2\u003e\n\u003cp\u003e先查一下机械硬盘的位置:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ sudo fdisk -l\nDisk /dev/sda: 14.57 TiB, \u003cspan class=\"m\"\u003e16000900661248\u003c/span\u003e bytes, \u003cspan class=\"m\"\u003e31251759104\u003c/span\u003e sectors\nDisk model: ST16000NM000J-2T\nUnits: sectors of \u003cspan class=\"m\"\u003e1\u003c/span\u003e * \u003cspan class=\"nv\"\u003e512\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e512\u003c/span\u003e bytes\nSector size \u003cspan class=\"o\"\u003e(\u003c/span\u003elogical/physical\u003cspan class=\"o\"\u003e)\u003c/span\u003e: \u003cspan class=\"m\"\u003e512\u003c/span\u003e bytes / \u003cspan class=\"m\"\u003e4096\u003c/span\u003e bytes\nI/O size \u003cspan class=\"o\"\u003e(\u003c/span\u003eminimum/optimal\u003cspan class=\"o\"\u003e)\u003c/span\u003e: \u003cspan class=\"m\"\u003e4096\u003c/span\u003e bytes / \u003cspan class=\"m\"\u003e4096\u003c/span\u003e bytes\nDisklabel type: gpt\nDisk identifier: 50471F15-5395-44CC-94E3-CF0AE43F83A7\n\nDevice     Start         End     Sectors  Size Type\n/dev/sda1     \u003cspan class=\"m\"\u003e34\u003c/span\u003e       \u003cspan class=\"m\"\u003e32767\u003c/span\u003e       \u003cspan class=\"m\"\u003e32734\u003c/span\u003e   16M Microsoft reserved\n/dev/sda2  \u003cspan class=\"m\"\u003e32768\u003c/span\u003e \u003cspan class=\"m\"\u003e31251755007\u003c/span\u003e \u003cspan class=\"m\"\u003e31251722240\u003c/span\u003e 14.6T Microsoft basic data\n\nDisk /dev/sdb: 5.47 TiB, \u003cspan class=\"m\"\u003e6001175126016\u003c/span\u003e bytes, \u003cspan class=\"m\"\u003e11721045168\u003c/span\u003e sectors\nDisk model: ST6000NM0115-1YZ\nUnits: sectors of \u003cspan class=\"m\"\u003e1\u003c/span\u003e * \u003cspan class=\"nv\"\u003e512\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e512\u003c/span\u003e bytes\nSector size \u003cspan class=\"o\"\u003e(\u003c/span\u003elogical/physical\u003cspan class=\"o\"\u003e)\u003c/span\u003e: \u003cspan class=\"m\"\u003e512\u003c/span\u003e bytes / \u003cspan class=\"m\"\u003e4096\u003c/span\u003e bytes\nI/O size \u003cspan class=\"o\"\u003e(\u003c/span\u003eminimum/optimal\u003cspan class=\"o\"\u003e)\u003c/span\u003e: \u003cspan class=\"m\"\u003e4096\u003c/span\u003e bytes / \u003cspan class=\"m\"\u003e4096\u003c/span\u003e bytes\nDisklabel type: gpt\nDisk identifier: 5375EE2B-DB96-40E2-AA43-776B835D2253\n\nDevice     Start         End     Sectors  Size Type\n/dev/sdb1     \u003cspan class=\"m\"\u003e34\u003c/span\u003e       \u003cspan class=\"m\"\u003e32767\u003c/span\u003e       \u003cspan class=\"m\"\u003e32734\u003c/span\u003e   16M Microsoft reserved\n/dev/sdb2  \u003cspan class=\"m\"\u003e32768\u003c/span\u003e \u003cspan class=\"m\"\u003e11721041919\u003c/span\u003e \u003cspan class=\"m\"\u003e11721009152\u003c/span\u003e  5.5T Microsoft basic data\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e可以发现16T的机械硬盘分别是\u003ccode\u003e/dev/sda2\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e默认挂载点是\u003ccode\u003e/dev/sda2\u003c/code\u003e,不去动他\u003c/p\u003e\n\u003cp\u003e挂载硬盘\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ sudo umount /dev/sda2\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ sudo mount /dev/sda2 /dev/sda2\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e创建开机自动挂载,首先获取uuid\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ sudo blkid /dev/sda2\n/dev/sda2: \u003cspan class=\"nv\"\u003eLABEL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;File\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eUUID\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;02785C53785C4795\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003eTYPE\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ntfs\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003ePARTLABEL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Basic data partition\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003ePARTUUID\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;3dbd7fde-6292-4173-928e-1a5d2a5fb624\u0026#34;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e硬盘的uuid是`02785C53785C4795\u003c/p\u003e\n\u003cp\u003e修改\u003ccode\u003e/etc/fstab\u003c/code\u003e,将uuid填在末尾:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-txt\" data-lang=\"txt\"\u003eUUID=02785C53785C4795 /dev/sda2 ntfs defaults 0 2\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e第一个数字：0表示开机不检查磁盘，1表示开机检查磁盘；\n第二个数字：0表示交换分区，1代表启动分区（Linux），2表示普通分区\n挂载的分区是在WIn系统下创建的分区，磁盘格式为ntfs\u003c/p\u003e\n\u003ch2 id=\"设立samba共享\"\u003e设立Samba共享\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ sudo apt-get install samba cifs-utils\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# /etc/samba/smb.conf\u003c/span\u003e\n\u003cspan class=\"o\"\u003e[\u003c/span\u003eNASShare\u003cspan class=\"o\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"nv\"\u003epath\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e /media/engine/File\n  \u003cspan class=\"nb\"\u003eread\u003c/span\u003e \u003cspan class=\"nv\"\u003eonly\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e no\n\u003cspan class=\"c1\"\u003e# 视情况是否要允许guest访问\u003c/span\u003e\n  guest \u003cspan class=\"nv\"\u003eok\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e yes\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# 新增samba用户，后面访问nas的时候要用\u003c/span\u003e\nsudo smbpasswd -a \u0026lt;username\u0026gt;\n\u003cspan class=\"c1\"\u003e# 会弹出密码，输入即可\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ sudo systemctl restart smbd\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e配置完成\u003c/p\u003e\n\u003ch2 id=\"访问nas\"\u003e访问nas\u003c/h2\u003e\n\u003cp\u003e先查一下主机的ip：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e$ ifconfig\neno1: \u003cspan class=\"nv\"\u003eflags\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4099\u0026lt;UP,BROADCAST,MULTICAST\u0026gt;  mtu \u003cspan class=\"m\"\u003e1500\u003c/span\u003e\n        ether f0:2f:74:30:7e:7b  txqueuelen \u003cspan class=\"m\"\u003e1000\u003c/span\u003e  \u003cspan class=\"o\"\u003e(\u003c/span\u003eEthernet\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        RX packets \u003cspan class=\"m\"\u003e0\u003c/span\u003e  bytes \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e0.0 B\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        RX errors \u003cspan class=\"m\"\u003e0\u003c/span\u003e  dropped \u003cspan class=\"m\"\u003e0\u003c/span\u003e  overruns \u003cspan class=\"m\"\u003e0\u003c/span\u003e  frame \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n        TX packets \u003cspan class=\"m\"\u003e0\u003c/span\u003e  bytes \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e0.0 B\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        TX errors \u003cspan class=\"m\"\u003e0\u003c/span\u003e  dropped \u003cspan class=\"m\"\u003e0\u003c/span\u003e overruns \u003cspan class=\"m\"\u003e0\u003c/span\u003e  carrier \u003cspan class=\"m\"\u003e0\u003c/span\u003e  collisions \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n        device interrupt \u003cspan class=\"m\"\u003e16\u003c/span\u003e  memory 0x92400000-92420000\n\nlo: \u003cspan class=\"nv\"\u003eflags\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e73\u0026lt;UP,LOOPBACK,RUNNING\u0026gt;  mtu \u003cspan class=\"m\"\u003e65536\u003c/span\u003e\n        inet 127.0.0.1  netmask 255.0.0.0\n        inet6 ::1  prefixlen \u003cspan class=\"m\"\u003e128\u003c/span\u003e  scopeid 0x10\u0026lt;host\u0026gt;\n        loop  txqueuelen \u003cspan class=\"m\"\u003e1000\u003c/span\u003e  \u003cspan class=\"o\"\u003e(\u003c/span\u003eLocal Loopback\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        RX packets \u003cspan class=\"m\"\u003e707218\u003c/span\u003e  bytes \u003cspan class=\"m\"\u003e68728858\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e68.7 MB\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        RX errors \u003cspan class=\"m\"\u003e0\u003c/span\u003e  dropped \u003cspan class=\"m\"\u003e0\u003c/span\u003e  overruns \u003cspan class=\"m\"\u003e0\u003c/span\u003e  frame \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n        TX packets \u003cspan class=\"m\"\u003e707218\u003c/span\u003e  bytes \u003cspan class=\"m\"\u003e68728858\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e68.7 MB\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        TX errors \u003cspan class=\"m\"\u003e0\u003c/span\u003e  dropped \u003cspan class=\"m\"\u003e0\u003c/span\u003e overruns \u003cspan class=\"m\"\u003e0\u003c/span\u003e  carrier \u003cspan class=\"m\"\u003e0\u003c/span\u003e  collisions \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\nwlp4s0: \u003cspan class=\"nv\"\u003eflags\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4163\u0026lt;UP,BROADCAST,RUNNING,MULTICAST\u0026gt;  mtu \u003cspan class=\"m\"\u003e1500\u003c/span\u003e\n        inet 192.168.50.174  netmask 255.255.255.0  broadcast 192.168.50.255\n        inet6 fe80::6778:73ef:e70d:6cb1  prefixlen \u003cspan class=\"m\"\u003e64\u003c/span\u003e  scopeid 0x20\u0026lt;link\u0026gt;\n        ether dc:41:a9:da:14:20  txqueuelen \u003cspan class=\"m\"\u003e1000\u003c/span\u003e  \u003cspan class=\"o\"\u003e(\u003c/span\u003eEthernet\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        RX packets \u003cspan class=\"m\"\u003e10482994\u003c/span\u003e  bytes \u003cspan class=\"m\"\u003e12080226956\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e12.0 GB\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        RX errors \u003cspan class=\"m\"\u003e0\u003c/span\u003e  dropped \u003cspan class=\"m\"\u003e0\u003c/span\u003e  overruns \u003cspan class=\"m\"\u003e0\u003c/span\u003e  frame \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n        TX packets \u003cspan class=\"m\"\u003e5291322\u003c/span\u003e  bytes \u003cspan class=\"m\"\u003e897290799\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e897.2 MB\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        TX errors \u003cspan class=\"m\"\u003e0\u003c/span\u003e  dropped \u003cspan class=\"m\"\u003e0\u003c/span\u003e overruns \u003cspan class=\"m\"\u003e0\u003c/span\u003e  carrier \u003cspan class=\"m\"\u003e0\u003c/span\u003e  collisions \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e查到局域网ip地址是192.168.50.174，之后在局域网下访问nas的时候需要通过这个地址。\u003c/p\u003e\n\u003cp\u003e不同的客户端的方式不一样\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ewindows\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e可以在我的电脑上面的地址栏输入 \\192.168.50.174 然后输入账户密码访问\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003emacOS\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eFinder - go - connect to server，输入smb://192.168.50.174\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAndroid/IOS\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e一些app可以访问nas，比如nPlayer、FE File Explorer等。\u003c/p\u003e\n\u003cp\u003e内网穿透直接访问nas好像有些问题，就采用了内网穿透cloudreve云盘挂载的方式，见后面的\u003ca href=\"https://blog.engine.wang/posts/frp-notes/#cloudreve%E7%A7%81%E6%9C%89%E4%BA%91%E5%AD%98%E5%82%A8\"\u003e内网穿透记录\u003c/a\u003e\u003c/p\u003e\n","date":1627022834,"description":"","fuzzywordcount":1200,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"a4fa7aa5022a289ed30c5bb5aa899675","publishdate":1627022834,"relpermalink":"/posts/ubuntu-samba-notes/","section":"posts","summary":"nas的便捷早已融入了生活,最开始是利用路由器挂载移动硬盘的方式，目前仍在使用不过容量有限(4T)。 而我的主机是win10+Ubuntu18.04双系统，除去2","tags":["nas","Linux"],"title":"Ubuntu配置samba共享简易记录","url":"https://blog.engine.wang/posts/ubuntu-samba-notes/","wordcount":1150},{"categories":"posts","content":"\u003cp\u003e简要记录一下对路由器的折腾记录，只是一部分，剩下的后面有空就慢慢补上。\u003c/p\u003e\n\u003cp\u003e路由器成了我们生活必不可缺的一个产品，而且建议拥有自己的一台路由器，起码能对自身的网络环境有一定的掌握，还可以通过一些操作使得自己的生活更便捷。\u003c/p\u003e\n\u003cp\u003e大部分人对路由器的认知只是一个释放无线信号给设备连接wifi的产品，但是实际上路由器的功能远不止于此。\u003c/p\u003e\n\u003cp\u003e推荐有固件的路由器，比如梅林或者openwrt，因为我的是梅林，所以这里就只基于梅林固件来讲。\u003c/p\u003e\n\u003ch2 id=\"准备\"\u003e准备\u003c/h2\u003e\n\u003ch3 id=\"一个能刷梅林的路由器\"\u003e一个能刷梅林的路由器\u003c/h3\u003e\n\u003cp\u003e最关键的点，普通路由器也没啥可折腾的，我用的是ASUS RT-AC68u，这款14年的产品到现在依然坚挺，并且全新的还能卖到400-600，也是够离谱的。当然如果需要更新更好的路由器，也可以在这里挑选一下喜欢的型号，反正越贵越好，按需购买，有钱就上带X的路由器，保证速度嘎嘎快。\n\u003ca href=\"https://www.koolcenter.com/category/merlin\"\u003ehttps://www.koolcenter.com/category/merlin\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e其实去闲鱼捡二手也不错，我的另一台RT-AC68u就是花了一百多从闲鱼捡的，表面伤痕累累没关系，功能没啥问题就行。\u003c/p\u003e\n\u003cp\u003e第一次连接，路由器开机之后就会看到wifi列表里有ASUS，用一台设备（推荐电脑）连接wifi，当然这里直接连网线也是一样的。然后就会进入到初始设置页面，没自动进入的话就打开\u003ccode\u003erouter.asus.com\u003c/code\u003e或者\u003ccode\u003e192.168.50.1\u003c/code\u003e（也可能是其他ip，看实际情况）手动进入，配置宽带账号密码、管理员账户密码、wifi名称密码等等。\u003c/p\u003e\n\u003cp\u003e然后就进入了路由器后台，这里的可玩性比普通路由器高太多了\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://s2.loli.net/2022/11/25/LWnIuE4OtgK6V8k.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"闲置移动硬盘可选\"\u003e闲置移动硬盘（可选）\u003c/h3\u003e\n\u003cp\u003e主要是做nas用，因为这些进阶版的路由器基本都有几个usb插孔，可以接存储设备，可以接移动机械硬盘/移动ssd，也可以买一个拓展坞接机械硬盘/ssd。考虑到带宽，其实机械硬盘就够了，固态属于大炮打蚊子。\u003c/p\u003e\n\u003ch3 id=\"闲置u盘一个可选\"\u003e闲置U盘一个（可选）\u003c/h3\u003e\n\u003cp\u003e小的就行，如果应用起的多，需要一个u盘来做虚拟内存，当然没有也没事\u003c/p\u003e\n\u003ch3 id=\"公网ip可选\"\u003e公网ip（可选）\u003c/h3\u003e\n\u003cp\u003e可以通过租云服务器来获得，主要是为了内网穿透，当然不配内网穿透的话就不用管这个，如果有一个域名那也是极好的，没有也没关系\u003c/p\u003e\n\u003ch2 id=\"刷koolshare梅林固件\"\u003e刷Koolshare梅林固件\u003c/h2\u003e\n\u003cp\u003e华硕自带的固件虽然功能很多，但是没有软件中心，可玩性大打折扣，这里需要刷Koolshare的改版梅林。\u003c/p\u003e\n\u003cp\u003e还是在这里，选择自己的路由器型号，然后翻到最下面下载固件。\n\u003ca href=\"https://www.koolcenter.com/category/merlin\"\u003ehttps://www.koolcenter.com/category/merlin\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e路由器后台页面，前往“系统管理-固件升级”，然后上传下载的固件，安装新的固件即可。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://s2.loli.net/2022/11/25/vIb4k8YAVh5CWjL.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e再次启动进入后台，就可以看到软件中心了。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://s2.loli.net/2022/11/25/knIY23b6KDou7XZ.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"初始设置\"\u003e初始设置\u003c/h2\u003e\n\u003cp\u003e开启ssh：\n系统管理-系统设置-服务-开启ssh\u003c/p\u003e\n\u003cp\u003e这样就可以远程ssh登录了\u003c/p\u003e\n\u003ch2 id=\"nas\"\u003eNAS\u003c/h2\u003e\n\u003cp\u003e进入路由后台，\u003c/p\u003e\n\u003cp\u003e（68u有一个USB3.0一个USB2.0，建议USB3.0接移动硬盘做NAS，USB2.0接一个小U盘做虚拟内存，供日后的内网穿透和v2ray等使用）\u003c/p\u003e\n\u003cp\u003e建议先插虚拟内存，待完成挂载和建立交换分区的操作后再插入移动硬盘。\u003c/p\u003e\n\u003cp\u003eusb驱动页面找到samba共享与ftp共享\u003c/p\u003e\n\u003cp\u003e重要的是下面的权限配置，管理员肯定是全权限，如果要和其他用户共享网络文件，可以指定文件夹赋予不同权限。硬盘直接NTFS格式就可以读取的。或者格式化为ext4。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://s2.loli.net/2022/11/25/DSGniZYWs3FyxR1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"内网穿透\"\u003e内网穿透\u003c/h2\u003e\n\u003cp\u003e具体的教程见我的这篇文章的后面部分：\u003ca href=\"http://blog.engine.wang/posts/frp-notes\"\u003efrp内网穿透原理及配置记录\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"虚拟内存\"\u003e虚拟内存\u003c/h2\u003e\n\u003cp\u003e本来虚拟内存挂一下U盘就能解决，结果我在我的ASUS RT-AC68u路由器的后台页面一直看到的未加载，明明已经格式化为ext4了\u003c/p\u003e\n\u003cp\u003e记录一下解决方法：\u003c/p\u003e\n\u003cp\u003e1.ssh连接路由器\u003c/p\u003e\n\u003cp\u003e和连接服务器一样，只是把ip改成192.168.50.1即可\u003c/p\u003e\n\u003cp\u003e2.fdisk -l 查看U盘在哪个区\u003c/p\u003e\n\u003cp\u003e比如在\u003ccode\u003e/dev/sda1\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e3.在路由器上格式化U盘\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003emkfs.ext2 /dev/sda1\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e4.建立一个挂在区，挂载U盘\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003emkdir /mnt/usb\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003emount -t ex2 /dev/sda1 /mnt/usb\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e理论上不会报错，这时候刷新路由器后台页面，就会显示U盘已经挂载了，就可以使用虚拟内存了\u003c/p\u003e\n\u003ch2 id=\"科学上网\"\u003e科学上网\u003c/h2\u003e\n\u003ch3 id=\"fancyssr下载\"\u003efancyssr下载\u003c/h3\u003e\n\u003cp\u003e先下载对应的安装包：\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/hq450/fancyss_history_package/tree/master/fancyss_arm\"\u003ehttps://github.com/hq450/fancyss_history_package/tree/master/fancyss_arm\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"允许安装\"\u003e允许安装\u003c/h3\u003e\n\u003cp\u003e直接上传如果报错：\u003c/p\u003e\n\u003cp\u003e检测到离线安装包：含非法关键词！！！\n根据法律规定，koolshare软件中心将不会安装此插件！！！\u003c/p\u003e\n\u003cp\u003e则需要登录路由器，运行下面的命令即可安装成功：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e$ sed -i 's/\\tdetect_package/\\t# detect_package/g' /koolshare/scripts/ks_tar_install.sh\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e然后自行配置订阅、选择节点和开启服务，所有连接到此路由器的设备都能直连外网。\u003c/p\u003e\n","date":1623908618,"description":"","fuzzywordcount":1700,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"db5a7dde9deddc76df7b134ecabb5ee0","publishdate":1623908618,"relpermalink":"/posts/router-1/","section":"posts","summary":"简要记录一下对路由器的折腾记录，只是一部分，剩下的后面有空就慢慢补上。 路由器成了我们生活必不可缺的一个产品，而且建议拥有自己的一台路由器，起码能对自身的网络环境","tags":["路由器","网络","Linux"],"title":"路由器折腾记录","url":"https://blog.engine.wang/posts/router-1/","wordcount":1650},{"categories":"posts","content":"\u003cp\u003eWaitGroup用于任务编排，解决并发-等待的问题。\u003c/p\u003e\n\u003cp\u003e试想一下，某个并发场景需要完成前置的几个协程任务才能完成另一个任务，如果没有WaitGroup、Channel等机制，可能需要轮询查看前置任务是否完成，非常浪费资源。\u003c/p\u003e\n\u003cp\u003eWaitGroup的作用是阻塞goroutine，并可以在特定的情况下唤醒。\u003c/p\u003e\n\u003ch2 id=\"waitgroup使用方式\"\u003eWaitGroup使用方式\u003c/h2\u003e\n\u003cp\u003eWaitGroup包含三个方法：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDone\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWait\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eAdd可以设置WaitGroup的计数值，一般放在前面写\nDone用来将计数值-1，写在前置goroutine里\nWait会阻塞当前的goroutine，直到WaitGroup的计数值为0，写在需要等待的goroutine里，很多情况下是main goroutine。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003esay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003es\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003esync\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eWaitGroup\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDone\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSleep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e200\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"nx\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMillisecond\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003es\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003esync\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eWaitGroup\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ego\u003c/span\u003e \u003cspan class=\"nf\"\u003esay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ego\u003c/span\u003e \u003cspan class=\"nf\"\u003esay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;2\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWait\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e比如使用WaitGroup后，可以确保主协程会在前面的goroutine结束之后才会继续。\u003c/p\u003e\n\u003ch2 id=\"基础\"\u003e基础\u003c/h2\u003e\n\u003ch3 id=\"nocopy字段\"\u003enocopy字段\u003c/h3\u003e\n\u003cp\u003e对于一些不应该被复制的结构体，可以在里面增加\u003ccode\u003enocopy\u003c/code\u003e字段，它的底层是：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003enoCopy\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// Lock is a no-op used by -copylocks checker from `go vet`.\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003enoCopy\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eLock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003enoCopy\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eUnLock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e用\u003ccode\u003ego vet\u003c/code\u003e检测就会报错。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"nx\"\u003eCopy\u003c/span\u003e \u003cspan class=\"nx\"\u003epasses\u003c/span\u003e \u003cspan class=\"nx\"\u003elock\u003c/span\u003e \u003cspan class=\"nx\"\u003eby\u003c/span\u003e \u003cspan class=\"nx\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eDemo\u003c/span\u003e \u003cspan class=\"nx\"\u003econtains\u003c/span\u003e \u003cspan class=\"nx\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003enoCopy\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"源码解析\"\u003e源码解析\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eWaitGroup\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003enoCopy\u003c/span\u003e \u003cspan class=\"nx\"\u003enoCopy\u003c/span\u003e\n\n  \u003cspan class=\"c1\"\u003e// 前两个元素作为state，后一个元素作为信号量\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 第一个是当前阻塞的goroutine个数，第二个是WaitGroup计数值，第三个是信号量\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 对于32bit和64bit系统，字段有些许差别，后面有代码表示，这里不作讨论\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003estate1\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"kt\"\u003euint32\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ewg\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eWaitGroup\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003edelta\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 获取state和信号量\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003estatep\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003esemap\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 高32bit是计数值，所以把delta左移32位加到WaitGroup计数值上\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003estate\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddUint64\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003estatep\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003euint64\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003edelta\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e\u003cspan class=\"mi\"\u003e32\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 当前计数值\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003ev\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003eint32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e32\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 等待者数量\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003euint32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 计数值大于0或者w等于0，直接正常的返回\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ev\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"nx\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 接下来的情况就是计数值等于0，但是还有等待者的情况，此时等待的已经没有意义\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 比如说一开始只设了wg.Add(3)，结果启动了五个goroutine里面都有Done，Done了三次之后，剩下的两个协程不会等它们执行完了。\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 直接把组合的statep设为0（v和w都设为0）\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003estatep\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n  \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ew\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eruntime_Semrelease\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003esemap\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ewg\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eWaitGroup\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eDone\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"c1\"\u003e// 一直阻塞，直到state的计数值=0\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ewg\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eWaitGroup\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eWait\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003estatep\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003esemap\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003estate\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLoadUint64\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003estatep\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ev\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003eint32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e32\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ew\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003euint32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 如果为0.直接返回\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ev\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 否则阻塞\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCompareAndSwapUint64\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003estatep\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003estate\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"nf\"\u003eruntime_Semacquire\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003esemap\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"waitgroup的易错场景\"\u003eWaitGroup的易错场景\u003c/h2\u003e\n\u003ch3 id=\"add一个负数\"\u003eAdd一个负数\u003c/h3\u003e\n\u003cp\u003e除非能保证Add负数之后计数器仍大于0，否则会panic。一般不会Add负数，都通过Done的方式来-1。\u003c/p\u003e\n\u003cp\u003e另一种就是Done的次数过多，这样会导致减到负数之后直接导致panic。\u003c/p\u003e\n\u003ch3 id=\"add在wait之后调用\"\u003eAdd在Wait之后调用\u003c/h3\u003e\n\u003cp\u003e如果在一些子goroutine里面开头调用\u003ccode\u003eAdd\u003c/code\u003e，结束调用\u003ccode\u003eDone\u003c/code\u003e，然后主协程\u003ccode\u003eWait\u003c/code\u003e，会出现\u003ccode\u003eAdd\u003c/code\u003e在\u003ccode\u003eWait\u003c/code\u003e之后的情况，那么\u003ccode\u003eWait\u003c/code\u003e不会被这些自协程阻塞，这些自协程很可能得不到执行。\u003c/p\u003e\n\u003ch3 id=\"未置为0就重用\"\u003e未置为0就重用\u003c/h3\u003e\n\u003cp\u003eWaitGroup可以完成一次编排任务，计数值降为0后可以继续被其他任务所用，但是不要在还没使用完的时候就用于其他任务，这样由于带着计数值，很可能出问题。\u003c/p\u003e\n\u003ch3 id=\"自产自销\"\u003e自产自销\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e9\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e \u003cspan class=\"nx\"\u003esync\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eWaitGroup\u003c/span\u003e\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e:=\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ego\u003c/span\u003e \u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDone\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWait\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e输出是什么？大概率是什么也不会输出，或者输出0，基本不会正常输出012的排列，原因在于\u003ccode\u003ewg.Add()\u003c/code\u003e不应该加在goroutine里面而是应该在外面，如果像这样加在里面，实际上for循环结束之后，还没等\u003ccode\u003ewg.Add(1)\u003c/code\u003e开始，\u003ccode\u003ewg.Wait()\u003c/code\u003e就不阻塞了。\u003c/p\u003e\n\u003cp\u003e那么我们修改成下面的形式就对了吗？\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e9\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e \u003cspan class=\"nx\"\u003esync\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eWaitGroup\u003c/span\u003e\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e:=\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ego\u003c/span\u003e \u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDone\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWait\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e最后的输出更加离谱，是\u003ccode\u003e333\u003c/code\u003e。\n事实上，通常在进入第一个goroutine的时候，for循环就已经遍历完了，这个时候i的值就已经加到了3\u003c/p\u003e\n\u003cp\u003e如果想要正确的结果，就应该将i作为匿名函数的参数：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e9\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e \u003cspan class=\"nx\"\u003esync\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eWaitGroup\u003c/span\u003e\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e:=\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ego\u003c/span\u003e \u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDone\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWait\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"作为参数的wg\"\u003e作为参数的wg\u003c/h3\u003e\n\u003cp\u003ewg是不能被复制的！\u003c/p\u003e\n\u003cp\u003e看下面的代码：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003ef1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ewg\u003c/span\u003e \u003cspan class=\"nx\"\u003esync\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eWaitGroup\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDone\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e \u003cspan class=\"nx\"\u003esync\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eWaitGroup\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ego\u003c/span\u003e \u003cspan class=\"nf\"\u003ef1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ewg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWait\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e乍一看似乎没问题，但是会报死锁：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"nx\"\u003efatal\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eall\u003c/span\u003e \u003cspan class=\"nx\"\u003egoroutines\u003c/span\u003e \u003cspan class=\"nx\"\u003eare\u003c/span\u003e \u003cspan class=\"nx\"\u003easleep\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"nx\"\u003edeadlock\u003c/span\u003e\u003cspan class=\"p\"\u003e!\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e问题就出在参数wg，WaitGroup内部维护了计数，不允许被copy，WaitGroup的结构：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eWaitGroup\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003enoCopy\u003c/span\u003e \u003cspan class=\"nx\"\u003enoCopy\u003c/span\u003e\n\n\t\u003cspan class=\"c1\"\u003e// 64-bit value: high 32 bits are counter, low 32 bits are waiter count.\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"c1\"\u003e// 64-bit atomic operations require 64-bit alignment, but 32-bit\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"c1\"\u003e// compilers do not ensure it. So we allocate 12 bytes and then use\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"c1\"\u003e// the aligned 8 bytes in them as state, and the other 4 as storage\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"c1\"\u003e// for the sema.\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"nx\"\u003estate1\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"kt\"\u003euint32\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1646219952/waitGroup-1.jpg\" alt=\"waitGroup-1\"\u003e\u003c/p\u003e\n","date":1615039428,"description":"","fuzzywordcount":1900,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"6943378907aba7564d4abcd7f01d478e","publishdate":1615039428,"relpermalink":"/posts/go-concurrency-4-waitgroup/","section":"posts","summary":"WaitGroup用于任务编排，解决并发-等待的问题。 试想一下，某个并发场景需要完成前置的几个协程任务才能完成另一个任务，如果没有WaitGroup、Chann","tags":["Golang","并发"],"title":"Go并发（四）WaitGroup源码剖析","url":"https://blog.engine.wang/posts/go-concurrency-4-waitgroup/","wordcount":1854},{"categories":"posts","content":"\u003cp\u003eRWMutex专门用于解决读写问题。\u003c/p\u003e\n\u003ch2 id=\"rwmutex使用方式\"\u003eRWMutex使用方式\u003c/h2\u003e\n\u003cp\u003e方法有五个：\n\u003ccode\u003eLock\u003c/code\u003e：写操作调用，如果锁被写或读占用，会阻塞，如果拿到了锁，其他的读写都会阻塞\n\u003ccode\u003eUnlock\u003c/code\u003e：写操作调用。释放writer的锁。\n\u003ccode\u003eRLock\u003c/code\u003e：读操作调用，如果锁被写占用，会阻塞，否则就不会\n\u003ccode\u003eRUnlock\u003c/code\u003e：读操作调用。释放reader的锁。\n\u003ccode\u003eRLocker\u003c/code\u003e：返回一个读操作的接口，它的\u003ccode\u003eLock\u003c/code\u003e方法会调\u003ccode\u003eRLock\u003c/code\u003e，\u003ccode\u003eUnlock\u003c/code\u003e会调\u003ccode\u003eRUnlock\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e使用举例，比如一个可以自增和读的计数器，其中读的频率更高。\u003c/p\u003e\n\u003cp\u003e对于这种情况，我们用Mutex的话会损失性能，因为并发读是允许的，所以采用\u003ccode\u003eRWMutex\u003c/code\u003e更好。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e32\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eCounter\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003emu\u003c/span\u003e    \u003cspan class=\"nx\"\u003esync\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eRWMutex\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003eCount\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eCounter\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eIncr\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003emu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003emu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUnlock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eCount\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eCounter\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eRead\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003emu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRLock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003emu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRUnlock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eCount\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ec\u003c/span\u003e \u003cspan class=\"nx\"\u003eCounter\u003c/span\u003e\n  \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ego\u003c/span\u003e \u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSleep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSecond\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRead\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}()\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIncr\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSleep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eSecond\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"rwmutex原理基础\"\u003eRWMutex原理基础\u003c/h2\u003e\n\u003cp\u003e已经有了Mutex，为什么还要RWMutex？因为对于并发读的场景，实际上没必要加锁，加锁会影响性能。\u003c/p\u003e\n\u003cp\u003e也就是说如果当前一个读操作的goroutine持有了锁，对于其他的读操作的goroutine而言，无需等待，可以并发访问变量。\u003c/p\u003e\n\u003cp\u003e当然对于写操作，必须独占锁，写完之后才能继续读或写。\u003c/p\u003e\n\u003cp\u003eRWMutex同一时间可以被任意数量的Reader持有，或者被单个的Writer持有。\u003c/p\u003e\n\u003cp\u003e读写问题一般有三种方式：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e读优先\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e写优先\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e不指定优先级\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eRWMutex采用写优先的策略，也就是说一旦有一个writer在请求锁的话，新来的reader不会获取锁。writer会等到来的时候存在的reader读完就开始写，保证writer不会饥饿。\u003c/p\u003e\n\u003cp\u003eRWMutex基于Mutex实现，所以代码容易很多，相当于在Mutex的基础上做了一个变体。\u003c/p\u003e\n\u003ch2 id=\"源码解析\"\u003e源码解析\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eRWMutex\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 互斥锁，解决多个writer的竞争\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003ew\u003c/span\u003e           \u003cspan class=\"nx\"\u003eMutex\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// writer信号量\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003ewriterSem\u003c/span\u003e   \u003cspan class=\"kt\"\u003euint32\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// reader信号量\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003ereaderSem\u003c/span\u003e   \u003cspan class=\"kt\"\u003euint32\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// reader数量\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003ereaderCount\u003c/span\u003e \u003cspan class=\"kt\"\u003eint32\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 对于reader正在读的场景，记录当前正在读的reader的数量，也就是writer要等待的reader的数量\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003ereaderWait\u003c/span\u003e  \u003cspan class=\"kt\"\u003eint32\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 支持的最大的reader数量，2^30个\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003econst\u003c/span\u003e \u003cspan class=\"nx\"\u003erwmutexMaxReaders\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e30\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e这样设计的原因在于，writer的个数是无所谓的，因为都通过Mutex进行完全的互斥，但是reader的个数很关键。\u003c/p\u003e\n\u003cp\u003e没有writer竞争或持有锁的时候，readerCount就是reader的个数，如果有的话就是一个负数。\u003c/p\u003e\n\u003cp\u003e先看\u003ccode\u003eRLock\u003c/code\u003e，也就是读的锁，什么时候会阻塞读？就是在有writer在等锁的时候。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e9\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eRWMutex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eRLock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 先给readerCount+1\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 如果结果是负值，说明有writer竞争或持有锁\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 见后面writer的lock方法，一旦有writer拿到了写锁，readerCount就会被置为readerCount-rwmutexMaxReaders，也就是非常小的负数\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ereaderCount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 阻塞读\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003eruntime_SemacquireMutex\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ereaderSem\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eRWMutex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eRUnlock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// readCount-1，如果有writer竞争，就调用rUnlockSlow\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003er\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ereaderCount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"nx\"\u003er\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003erUnlockSlow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eRWMutex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003erUnlockSlow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003er\u003c/span\u003e \u003cspan class=\"kt\"\u003eint32\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ereaderWait\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 如果reader都释放了锁，就唤醒writer，把锁给writer\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003eruntime_Semrelease\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ewriterSem\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003ewriter通过\u003ccode\u003eMutex\u003c/code\u003e保持互斥，通过\u003ccode\u003eLock\u003c/code\u003e和\u003ccode\u003eUnlock\u003c/code\u003e加锁和释放锁：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eRWMutex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eLock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// writer之间的互斥\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 通知其他reader，有writer在等锁，把readerCount置为很小的负数\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003er\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ereaderCount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"nx\"\u003erwmutexMaxReaders\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nx\"\u003erwmutexMaxReaders\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 当前的reader没读完，阻塞写\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003er\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ereaderWait\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eruntime_SemacquireMutex\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ewriterSem\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eRWMutex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eUnlock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 通知reader当前的writer写完了\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003er\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ereaderCount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003erwmutexMaxReaders\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 唤醒阻塞的reader\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"nb\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eruntime_Semrelease\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ereaderSem\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 释放写锁，其他writer可以来拿\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003erw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUnlock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"rwmutex的易错场景\"\u003eRWMutex的易错场景\u003c/h2\u003e\n\u003ch3 id=\"不可复制\"\u003e不可复制\u003c/h3\u003e\n\u003cp\u003e因为包含了Mutex，其他字段也有状态意义，所以RWMutex肯定也是不能复制的。\u003c/p\u003e\n\u003ch3 id=\"释放没加锁的rwmutex\"\u003e释放没加锁的RWMutex\u003c/h3\u003e\n\u003cp\u003e和前面的Mutex一样\u003c/p\u003e\n\u003ch3 id=\"重入导致死锁\"\u003e重入导致死锁\u003c/h3\u003e\n\u003cp\u003e和Mutex一样\u003c/p\u003e\n\u003ch3 id=\"reader调用writer导致死锁\"\u003ereader调用writer导致死锁\u003c/h3\u003e\n\u003cp\u003e比如在reader方法里调用writer，由于writer必须等待活跃reader完成，相当于自己锁自己。\u003c/p\u003e\n\u003ch3 id=\"环形依赖导致的死锁\"\u003e环形依赖导致的死锁\u003c/h3\u003e\n\u003cp\u003ewriter需要等待活跃的reader完成读\n新来的reader会等待writer\n如果活跃的reader调用新来的reader，那么就会环形依赖导致死锁。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1646219904/RWMutex-1.jpg\" alt=\"RWMutex-1\"\u003e\u003c/p\u003e\n","date":1613743428,"description":"","fuzzywordcount":1900,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"60212a32070028589b3cba231c5da09b","publishdate":1613743428,"relpermalink":"/posts/go-concurrency-3-rwmutex/","section":"posts","summary":"RWMutex专门用于解决读写问题。 RWMutex使用方式 方法有五个： Lock：写操作调用，如果锁被写或读占用，会阻塞，如果拿到了锁，其他的读写都会阻塞 Unlo","tags":["Golang","并发"],"title":"Go并发（三）RWMutex源码剖析","url":"https://blog.engine.wang/posts/go-concurrency-3-rwmutex/","wordcount":1807},{"categories":"posts","content":"\u003ch2 id=\"基本并发原语\"\u003e基本并发原语\u003c/h2\u003e\n\u003cp\u003e接下来的几节将会解析Go的这几个基本并发原语（同步原语）：Mutex、RWMutex、WaitGroup、Cond、Channel\u003c/p\u003e\n\u003cp\u003e为什么要用并发原语？\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e共享资源保护（通常用Mutex、RWMutex）\u003c/li\u003e\n\u003cli\u003e任务编排，需要goroutine按照一定规律执行（通常用WaitGroup、Channel）\u003c/li\u003e\n\u003cli\u003e消息传递，不同goroutine之间的消息传递（通常用Channel）\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e本篇要说的Mutex互斥锁是go中使用最广泛的并发原语（或者叫同步原语）。\u003c/p\u003e\n\u003ch2 id=\"mutex使用方式\"\u003eMutex使用方式\u003c/h2\u003e\n\u003cp\u003eMutex互斥锁的使用方式很简单：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003emu\u003c/span\u003e \u003cspan class=\"nx\"\u003esync\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMutex\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 进入临界区之前先上锁\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"nx\"\u003emu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"cm\"\u003e/*\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e=====================\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e 一些需要保护的临界区\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e=====================\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e*/\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 退出临界区之后要解锁\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"nx\"\u003emu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUnlock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e更多的时候是嵌入到struct里，比如并发安全的计数器：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eCounter\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003emu\u003c/span\u003e \u003cspan class=\"nx\"\u003esync\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMutex\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003eCount\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e如果嵌入struct中，比较好的编程风格是把Mutex字段放在需要被控制的字段的上面一个，这样比较清晰。这个结构的实例如果访问了共享资源，可以：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eCounter\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ei\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003emu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eLock\u003c/span\u003e\n  \u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003emu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eUnlock\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eCount\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"nx\"\u003ei\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eMutex不需要初始化，不会出现空指针或者获取不到锁的情况。\u003c/p\u003e\n\u003cp\u003eMutex可以被任意一个goroutine释放锁，如果不是当前拿锁的goroutine释放锁的话就会带来严重的问题。所以务必要遵守\u003cstrong\u003e谁申请谁释放\u003c/strong\u003e的原则\u003c/p\u003e\n\u003cp\u003e另外，还要注意\u003cstrong\u003eLock和Unlock成对出现\u003c/strong\u003e有的时候可能有一些复杂的分支，一些分支会漏写\u003ccode\u003eUnlock()\u003c/code\u003e，或者删除代码的时候误删等，从而造成死锁。\u003c/p\u003e\n\u003cp\u003e所以更好的方式是采用defer的方式，让Lock和Unlock总是紧凑的成对出现，以免后面忘记Unlock：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"nx\"\u003emu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"nx\"\u003emu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUnlock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 访问共享资源的操作\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eMutex不能被复制，需要用到一个新的Mutex直接初始化，如果复制了可能会带着之前的状态，从而造成问题。\u003c/p\u003e\n\u003cp\u003eMutex不可重入，关于重入，有些语言（如Java）支持，即一个进程获取到了锁之后，再次获取这个锁可以成功，其他进程会被阻塞。但是Mutex不支持重入，因为它不会检测哪个goroutine拥有这把锁。也就是说不能两次获取同一把锁。\u003c/p\u003e\n\u003ch2 id=\"mutex原理基础\"\u003eMutex原理基础\u003c/h2\u003e\n\u003ch3 id=\"mutex演进\"\u003eMutex演进\u003c/h3\u003e\n\u003cp\u003e最初的Mutex只是普通实现了抢锁、阻塞、释放锁等流程。\n之后逐渐加入了：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e让新加入的goroutine有更多机会获取到锁\u003c/li\u003e\n\u003cli\u003e让新来的和唤醒的有更多机会竞争锁\u003c/li\u003e\n\u003cli\u003e解决饥饿问题，不会让goroutine阻塞太久\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e当一个锁被释放后，如果有多于一个协程的都在获取这个锁，锁最终会按照FIFO的原则给排队中的协程。\u003c/p\u003e\n\u003cp\u003e单纯的FIFO虽然公平但是效率不高，对于刚刚排到队刚唤醒的gorourine和新到的goroutine相比，新来的goroutine已经在CPU上运行，上下文切换会降低效率，所以新来的会和刚唤醒的goroutine对锁进行竞争。而不是直接把醒来的goroutine放到队尾。\u003c/p\u003e\n\u003cp\u003e但是这么做可能会造成饥饿，因此如果等待者在1ms之内没有获取到锁，将会从正常模式切换到饥饿模式。\u003c/p\u003e\n\u003ch3 id=\"mutex的两种模式正常模式和饥饿模式\"\u003eMutex的两种模式：正常模式和饥饿模式。\u003c/h3\u003e\n\u003cp\u003e正常模式下，等待的goroutine按照FIFO的顺序排队，刚唤醒的等待者与新来的goroutine进行竞争，因为新来的goroutine可能有很多。如果有等待者等待了1ms以上，就进入饥饿模式。\n饥饿模式下，Mutex的所有权严格按照FIFO依次交出，新到达的goroutine不再尝试获取Mutex，也不会自旋。它们只是会排队在末尾。\u003c/p\u003e\n\u003cp\u003e如果等待者发现它是队列的最后一个等待者，或者它等待了不到1ms，那么就切换为正常模式。\n正常模式的性能很好，但是饥饿模式有必要性，否则可能出现goroutine饿死的情况。\u003c/p\u003e\n\u003ch3 id=\"自旋锁\"\u003e自旋锁\u003c/h3\u003e\n\u003cp\u003e自旋这个概念也有很多很重要的应用，后面讲并发调度底层原理的时候也会提到，等待CPU调度的时候也一样有这种自旋的概念，这里先解释一下，不然后面源码看不懂。\u003c/p\u003e\n\u003cp\u003e自旋锁指的是一个线程在获取锁的时候，如果锁已经被其他线程获取，那么该线程会循环等待，不断判断是够能够被成功获取，一旦能获取到锁才会退出循环。自旋锁不会引起调用者的睡眠。\u003c/p\u003e\n\u003cp\u003eMutex的源码出现了\u003ccode\u003esync_runtime_canSpin\u003c/code\u003e和\u003ccode\u003esync_runtime_doSpin\u003c/code\u003e这两个自旋锁有关的函数，由于其源码涉及到了最底层的并发原理，将放到后面再讲，这里先理解一下两个函数的作用。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esync_runtime_canSpin\u003c/code\u003e：返回目前自旋是否有意义。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esync_runtime_doSpin\u003c/code\u003e：开始自旋。\u003c/p\u003e\n\u003ch3 id=\"信号量\"\u003e信号量\u003c/h3\u003e\n\u003cp\u003e信号量机制（semaphore）在很多地方都有应用，在操作系统中也学习过，见之前的\u003ca href=\"https://blog.engine.wang/posts/os-basics-thread/\"\u003e操作系统基础（二）进程与线程\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003esema提供了\u003ccode\u003esleep\u003c/code\u003e和\u003ccode\u003ewakeup\u003c/code\u003e的并发原语。\u003c/p\u003e\n\u003cp\u003eMutex的源码出现了\u003ccode\u003esync_runtime_SemacquireMutex\u003c/code\u003e和\u003ccode\u003epoll_runtime_Semrelease\u003c/code\u003e这两个信号量相关的函数，这里只理解一下函数的作用：\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esync_runtime_SemacquireMutex\u003c/code\u003e：对当前锁进行sleep，阻塞自己\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003epoll_runtime_Semrelease\u003c/code\u003e：唤醒sleep的锁，\u003c/p\u003e\n\u003ch2 id=\"mutex源码解析\"\u003eMutex源码解析\u003c/h2\u003e\n\u003ch3 id=\"变量\"\u003e变量\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003esync/mutex\u003c/code\u003e的源码只有两百行（去掉注释只有一百来行），当然其中更底层的是原子包（源码位于\u003ccode\u003esync/atomic.go\u003c/code\u003e）、自旋锁（源码位于\u003ccode\u003eruntime/proc.go\u003c/code\u003e）、信号量（源码位于\u003ccode\u003eruntime/sema.go\u003c/code\u003e），这几个之后再讨论，先看\u003ccode\u003esync/mutex.go\u003c/code\u003e。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eLocker\u003c/code\u003e接口，\u003ccode\u003eLocker\u003c/code\u003e接口有两个方法\u003ccode\u003eLock()\u003c/code\u003e和\u003ccode\u003eUnlock()\u003c/code\u003e，只要实现了这两个方法就属于Locker类，Mutex就是实现了\u003ccode\u003eLocker\u003c/code\u003e的接口。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eLocker\u003c/span\u003e \u003cspan class=\"kd\"\u003einterface\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"nf\"\u003eLock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"nf\"\u003eUnlock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003eMutex\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// state，这一个字段包含了多种数据，下面细说\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003estate\u003c/span\u003e \u003cspan class=\"kt\"\u003eint32\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 等待者队列的信号量变量，用以阻塞或唤醒goroutine\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003esema\u003c/span\u003e \u003cspan class=\"kt\"\u003euint32\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003estate是一个字段，前三个比特分别表示mutexLocked、mutexWoken和mutexStarving，剩余的bit表示mutexWaiter\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"c1\"\u003e// state的各个字段的意义\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kd\"\u003econst\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 上锁状态，1\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003emutexLocked\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"kc\"\u003eiota\u003c/span\u003e \u003cspan class=\"c1\"\u003e// mutex is locked\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 唤醒状态，2\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003emutexWoken\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 饥饿状态，4\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003emutexStarving\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// mutex上阻止的goroutine个数，3\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003emutexWaiterShift\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003eiota\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003estarvationThresholdNs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"mf\"\u003e1e6\u003c/span\u003e\n\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645951599/mutex-2.jpg\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"lock方法\"\u003eLock方法\u003c/h3\u003e\n\u003cp\u003e首先看\u003ccode\u003eLock()\u003c/code\u003e方法：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eMutex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eLock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 通过atomic提供的CAS原子操作\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 如果m.state是0，表示当前锁是空闲的\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 可以获取到锁，把自己的状态设为mutexLocked（state=1）\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCompareAndSwapInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003emutexLocked\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003erace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eEnabled\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"nx\"\u003erace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAcquire\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eunsafe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePointer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 当前锁被持有，调用lockSlow，尝试通过自旋竞争或者饥饿goroutine竞争\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003elockSlow\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e如果不能直接抢到锁就切换为\u003ccode\u003elockSlow\u003c/code\u003e的方法获取锁：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e32\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e33\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e34\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e35\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e36\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e37\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e38\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e39\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e40\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e41\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e42\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e43\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e44\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e45\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e46\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e47\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e48\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e49\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e50\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e51\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e52\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e53\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e54\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e55\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e56\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e57\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e58\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e59\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e60\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e61\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e62\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e63\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e64\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e65\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e66\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e67\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e68\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e69\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e70\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e71\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e72\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e73\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e74\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e75\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e76\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e77\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e78\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e79\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e80\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e81\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e82\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e83\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e84\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e85\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e86\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e87\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e88\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e89\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e90\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e91\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e92\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e93\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e94\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e95\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eMutex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003elockSlow\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 请求的初始时间\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"kd\"\u003evar\u003c/span\u003e \u003cspan class=\"nx\"\u003ewaitStartTime\u003c/span\u003e \u003cspan class=\"kt\"\u003eint64\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 饥饿标记\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003estarving\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 唤醒标记\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003eawoke\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 自旋次数\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003eiter\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 当前锁的状态\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003eold\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\n  \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 锁未被释放，且非饥饿状态，尝试自旋\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 这里为了效率用的位运算，不过会难读一点\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// mutexLocked = 1，mutexStarving = 100，mutexLocked|mutexStarving = 101\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// old \u0026amp; 101 == 1，也就是说old是0?1，也就是说是locked状态，而且非饥饿\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexLocked\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexStarving\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"nx\"\u003emutexLocked\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nf\"\u003eruntime_canSpin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eiter\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e// 一直自旋，直到发现锁被释放，awoke设为true，唤醒\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"nx\"\u003eawoke\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexWoken\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexWaiterShift\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCompareAndSwapInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexWoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003eawoke\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e// 否则就自旋\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e      \u003cspan class=\"nf\"\u003eruntime_doSpin\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e// 自旋迭代次数+1\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e      \u003cspan class=\"nx\"\u003eiter\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e// 更新状态到old里\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e      \u003cspan class=\"nx\"\u003eold\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\n      \u003cspan class=\"k\"\u003econtinue\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"nx\"\u003enew\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 如果old状态非饥饿，就设置为上锁状态\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexStarving\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e// |=位运算，可以将mutexLocked位置置1，也就是加锁\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e      \u003cspan class=\"nx\"\u003enew\u003c/span\u003e \u003cspan class=\"o\"\u003e|=\u003c/span\u003e \u003cspan class=\"nx\"\u003emutexLocked\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 如果mutex状态是饥饿，那新来的goroutine直接插入队尾，不会自旋也不会抢锁\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexLocked\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexStarving\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e// 等待者数量+1\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e      \u003cspan class=\"nx\"\u003enew\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"nx\"\u003emutexWaiterShift\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 如果当前没上锁，而且处于饥饿状态，就设置为饥饿状态\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003estarving\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexLocked\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"nx\"\u003enew\u003c/span\u003e \u003cspan class=\"o\"\u003e|=\u003c/span\u003e \u003cspan class=\"nx\"\u003emutexStarving\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 如果被唤醒了\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eawoke\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003enew\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexWoken\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003ethrow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;sync: inconsistent mutex state\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e// 新状态清除唤醒标记\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e      \u003cspan class=\"nx\"\u003enew\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;^=\u003c/span\u003e \u003cspan class=\"nx\"\u003emutexWoken\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 成功设置新状态\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCompareAndSwapInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e// 正常请求到了锁，结束循环\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexLocked\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexStarving\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e// 如果之前就在队列里，就加入到队列头\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e      \u003cspan class=\"nx\"\u003equeueLifo\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ewaitStartTime\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003ewaitStartTime\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003ewaitStartTime\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eruntime_nanotime\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e// 阻塞等待\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e      \u003cspan class=\"nf\"\u003eruntime_SemacquireMutex\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esema\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003equeueLifo\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e// 唤醒之后检查是否应该处于饥饿状态\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e      \u003cspan class=\"nx\"\u003estarving\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003estarving\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"nf\"\u003eruntime_nanotime\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"nx\"\u003ewaitStartTime\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nx\"\u003estarvationThresholdNs\u003c/span\u003e\n      \u003cspan class=\"nx\"\u003eold\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e// 如果饥饿\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexStarving\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexLocked\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexWoken\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexWaiterShift\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"nf\"\u003ethrow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;sync: inconsistent mutex state\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 加锁并将等待者数量-1\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"nx\"\u003edelta\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003eint32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexLocked\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexWaiterShift\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"nx\"\u003estarving\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexWaiterShift\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"c1\"\u003e// 退出饥饿模式\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e          \u003cspan class=\"nx\"\u003edelta\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"nx\"\u003emutexStarving\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003edelta\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"nx\"\u003eawoke\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\n      \u003cspan class=\"nx\"\u003eiter\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"nx\"\u003eold\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003erace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eEnabled\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003erace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAcquire\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eunsafe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePointer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"unlock方法\"\u003eUnlock方法\u003c/h3\u003e\n\u003cp\u003eUnlock比Lock的代码稍微简单一点\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eMutex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eUnlock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003erace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eEnabled\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003e_\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003erace\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRelease\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eunsafe\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePointer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 去掉锁标志\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003enew\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexLocked\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003enew\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eunlockSlow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"nx\"\u003eMutex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nf\"\u003eunlockSlow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003eint32\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 没有加锁的情况下释放了锁，报错\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 也就是此时new=-1，new+mutexLocked=0，(new+mutexLocked)\u0026amp;mutexLocked = 0\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003enew\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexLocked\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexLocked\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003ethrow\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;sync: unlock of unlocked mutex\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 如果不是饥饿状态的话\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003enew\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexStarving\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nx\"\u003eold\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003enew\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e// 如果没有等待者了，可以直接返回\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexWaiterShift\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexLocked\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexWoken\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexStarving\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e// 有等待者的话，并且当前没有唤醒的等待者，就唤醒一个\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e      \u003cspan class=\"nx\"\u003enew\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eold\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e\u003cspan class=\"nx\"\u003emutexWaiterShift\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e \u003cspan class=\"nx\"\u003emutexWoken\u003c/span\u003e\n      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eatomic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCompareAndSwapInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eold\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eruntime_Semrelease\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esema\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\n      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"nx\"\u003eold\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003estate\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 如果是饥饿状态，直接交给下一个等待者，新来的goroutine不会获得锁\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003eruntime_Semrelease\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003esema\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"mutex的易错场景\"\u003eMutex的易错场景\u003c/h2\u003e\n\u003ch3 id=\"lock和unlock不成对出现\"\u003eLock和Unlock不成对出现\u003c/h3\u003e\n\u003cp\u003e如果只有Lock没有Unlock，那么永远都无法解锁，造成死锁，全部饿死。\u003c/p\u003e\n\u003cp\u003e如果没有Lock就Unlock，则会panic。\u003c/p\u003e\n\u003cp\u003e最不要在前面Lock，在if里Unlock，逻辑复杂的时候容易出问题。\u003c/p\u003e\n\u003cp\u003e最好是\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"nx\"\u003emu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"nx\"\u003emu\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eUnlock\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"复制mutex\"\u003e复制mutex\u003c/h3\u003e\n\u003cp\u003eMutex不可以被复制，它的state包含状态，在并发的环境下根本不知道当前状态是什么，如果要一个新的Mutex就new一个初始化为0的Mutex。\u003c/p\u003e\n\u003ch3 id=\"重入\"\u003e重入\u003c/h3\u003e\n\u003cp\u003e锁的重入指的是重复加锁，比如一个线程获取到了锁，之后其他线程获取这个锁只能阻塞，此时如果这个线程又获取一次这个锁，那么会直接成功返回，这样的锁就是可重入锁。\u003c/p\u003e\n\u003cp\u003e但是\u003cstrong\u003eMutex不是可重入锁\u003c/strong\u003e，所以不可以重入，因为Mutex并没有记录哪个goroutine拥有了这把锁。\u003c/p\u003e\n\u003cp\u003e当然如果要把go的Mutex改造成可重入的也很简答，只要建立一个结构体，封装Mutex、goroutine的标识、重入次数，\u003c/p\u003e\n\u003cp\u003egoroutine的标识可以采用goroutine id，或者自己生成一个唯一的token。\u003c/p\u003e\n\u003ch2 id=\"mutex拓展\"\u003eMutex拓展\u003c/h2\u003e\n\u003cp\u003e理解好源码之后，可以开发一些拓展功能。\u003c/p\u003e\n\u003cp\u003e比如发现锁被占用了直接reture false而不是排队阻塞，比如获取等待者的数量，直接通过unsafe把state字段里的等待者数量抽出来。\u003c/p\u003e\n\u003cp\u003e还可以通过引入Mutex实现线程安全的各种数据结构。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645951622/mutex-1.png\" alt=\"mutex-1\"\u003e\u003c/p\u003e\n","date":1612620228,"description":"","fuzzywordcount":4400,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"19ce33b1d9157650b51353bfe8cf0561","publishdate":1612620228,"relpermalink":"/posts/go-concurrency-2-mutex/","section":"posts","summary":"基本并发原语 接下来的几节将会解析Go的这几个基本并发原语（同步原语）：Mutex、RWMutex、WaitGroup、Cond、Channel 为什么要用并发原语","tags":["Golang","并发"],"title":"Go并发（二）Mutex源码剖析","url":"https://blog.engine.wang/posts/go-concurrency-2-mutex/","wordcount":4355},{"categories":"posts","content":"\u003ch2 id=\"写在前面\"\u003e写在前面\u003c/h2\u003e\n\u003cp\u003eGo语言最有魅力的一个方面就在于它内建的并发支持，Go的并发所涉及的内容化很多，预计会占用比较长的篇幅。等基本更新完成后会在此处放上所有文章的链接。\u003c/p\u003e\n\u003cp\u003e首先会从一些基本概念入手，之后会谈谈基本并发原语和go的并发原子操作，实际上就是尽量完整的剖析\u003ccode\u003esync\u003c/code\u003e这个包下的所有内容，会尽量附带着源码讲，这部分内容比较庞大但是我认为很值得。\u003c/p\u003e\n\u003cp\u003e接着是最重要的goroutine，以及channel、Context等内容，会提到一些进阶写法和容易错的点。\u003c/p\u003e\n\u003cp\u003e最后会尽量深入的讲一下底层的CSP理论、线程调度MPG模型等，从而对Go并发有更深入的理解。\u003c/p\u003e\n\u003cp\u003e参考资料来源于国内外的书籍、博客、课程、论坛等，主线参考鸟窝的Go并发编程实战课，在此基础上细化了知识点，并增加了自身对相关源码和实际使用的理解。\u003c/p\u003e\n\u003ch2 id=\"从并发谈起\"\u003e从并发谈起\u003c/h2\u003e\n\u003ch3 id=\"什么是并发\"\u003e什么是并发？\u003c/h3\u003e\n\u003cp\u003e并发（Concurrent）指的是在一个时间间隔内可以处理多个任务；与之相对的概念是顺序（Sequential），即多个任务只能按顺序完成。\u003c/p\u003e\n\u003cp\u003e另一个容易混淆的概念是并行（Parallel），并行指的是在一个时刻内可以同时处理多个事件；与之相对的概念是串行（Serial），指的是物理上只能一个一个任务的执行，一个瞬间最多只能有一个任务在执行。\u003c/p\u003e\n\u003cp\u003e并发：宏观同时，微观轮换\n并行：宏观微观都是同时进行\u003c/p\u003e\n\u003cp\u003e单核多线程：并发、串行\n多核多线程：并发、并行\u003c/p\u003e\n\u003cp\u003eErlang 之父 Joe Armstrong画的一张排队使用咖啡机的场景生动的表示了并发与并行的区别。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://pic4.zhimg.com/80/v2-674f0d37fca4fac1bd2df28a2b78e633_720w.jpg?source=1940ef5c\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"为什么要并发\"\u003e为什么要并发？\u003c/h3\u003e\n\u003cp\u003e并发可以有效的利用多个CPU核心，从而大大提高程序的执行效率。\u003c/p\u003e\n\u003cp\u003e并发程序可以更好地处理复杂业务，进行多任务拆分、简化任务调度、同步执行任务。\u003c/p\u003e\n\u003cp\u003e当然并发也会引入额外的复杂度和风险，可能会带来不一致、死锁、饥饿、安全性等问题，而且并发程序难以调试，可能会出现诡异的结果。\u003c/p\u003e\n\u003ch3 id=\"并发方案\"\u003e并发方案\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e多进程：操作简单，进程之间由于资源不共享，不会有冲突的问题，但是开销很大，能开启的进程数少，所以一般不会使用该方式。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e多线程：属于操作系统层面的并发，开销比多进程小但是比协程大，会存在数据冲突和锁的问题\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e非阻塞I/O：基于回调的异步非阻塞I/O\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e协程：用户态的轻量级线程，开销很小，Go采取了这种方式\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"并发导致的数据竞争\"\u003e并发导致的数据竞争\u003c/h3\u003e\n\u003cp\u003e两个或多个goroutine在没有同步措施的情况下读写同一个共享资源时，会出现数据竞争的情况。无法知晓几个goroutine代码运行的先后顺序，从而导致可能产生多种结果。\u003c/p\u003e\n\u003cp\u003e举一个具体的例子：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"nx\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n\u003cspan class=\"k\"\u003ego\u003c/span\u003e \u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 1\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}()\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 2\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 3\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e由于开启了一个并发的协程，完全不知道1会在2之前还是2-3之间还是3之后执行，所以输出也不确定。\u003c/p\u003e\n\u003cp\u003e如何解决这一问题？\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e设置等待时间（不推荐）\u003c/li\u003e\n\u003cli\u003e加锁\u003c/li\u003e\n\u003cli\u003echannel\n...\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"操作的原子性\"\u003e操作的原子性\u003c/h3\u003e\n\u003cp\u003e如果一件事是原子的，那么我们说它就是并发安全的，Go有单独的包\u003ccode\u003esync/atomic\u003c/code\u003e包含了语言支持的原子操作。\u003c/p\u003e\n\u003cp\u003e将在后面单独写一篇来介绍Go并发原子操作，这里暂时跳过。\u003c/p\u003e\n\u003ch2 id=\"死锁活锁与饥饿\"\u003e死锁、活锁与饥饿\u003c/h2\u003e\n\u003ch3 id=\"死锁\"\u003e死锁\u003c/h3\u003e\n\u003cp\u003e死锁是并发中一个绕不开的话题，操作系统中学过导致死锁的四个条件：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e互斥条件\u003c/li\u003e\n\u003cli\u003e请求和保持条件\u003c/li\u003e\n\u003cli\u003e不剥夺条件\u003c/li\u003e\n\u003cli\u003e环路等待条件\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e并发编程的时候很容易出现死锁的问题，看到这种报错信息：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"nx\"\u003efatal\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eall\u003c/span\u003e \u003cspan class=\"nx\"\u003egoroutines\u003c/span\u003e \u003cspan class=\"nx\"\u003eare\u003c/span\u003e \u003cspan class=\"nx\"\u003easleep\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"nx\"\u003edeadlock\u003c/span\u003e\u003cspan class=\"p\"\u003e!\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"活锁\"\u003e活锁\u003c/h3\u003e\n\u003cp\u003e陷入活锁的程序并不像死锁一样陷入绝境，而是一直在进行，但是这些操作无法向前推进程序的状态。\u003c/p\u003e\n\u003cp\u003e一个例子就是网络发送数据包遇到冲突，都等待一段时间重发，结果由一起冲突。\u003c/p\u003e\n\u003cp\u003e这就像两个礼貌的司机在狭窄的桥上相遇，他们都互相礼让都调头更换了另一座桥，结果又在另一座桥上相遇。\u003c/p\u003e\n\u003ch3 id=\"饥饿\"\u003e饥饿\u003c/h3\u003e\n\u003cp\u003e饥饿指的是一个可运行的进程尽管能继续执行，但是被调度器无限忽视，导致拿不到时间片来执行的情况。\u003c/p\u003e\n\u003cp\u003e并发进程无法获得执行工作所需的所有资源。往往是由于一些并发进程比较贪婪，每次都轮到贪婪进程优先获得资源，而其他的一些难以拿到资源的进程就会饥饿。\u003c/p\u003e\n\u003ch2 id=\"数据竞争的检测方法race\"\u003e数据竞争的检测方法：race\u003c/h2\u003e\n\u003cp\u003e多个goroutine同时操作共有的变量会发生各种意想不到的问题，可以通过\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"k\"\u003ego\u003c/span\u003e \u003cspan class=\"nx\"\u003erun\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"nx\"\u003erace\u003c/span\u003e \u003cspan class=\"nx\"\u003exxx\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003ego\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e来查看可能的竞态检测。\u003c/p\u003e\n\u003cp\u003e就以前面的为例：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kn\"\u003epackage\u003c/span\u003e \u003cspan class=\"nx\"\u003emain\u003c/span\u003e\n\n\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\n\t\u003cspan class=\"s\"\u003e\u0026#34;fmt\u0026#34;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ego\u003c/span\u003e \u003cspan class=\"kd\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}()\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e如果直接\u003ccode\u003ego run\u003c/code\u003e，无法看出是否有数据竞争，但是通过\u003ccode\u003ego run -race\u003c/code\u003e，就可以看到具体那几行出现了数据竞争：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"o\"\u003e==================\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eWARNING\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eDATA\u003c/span\u003e \u003cspan class=\"nx\"\u003eRACE\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eWrite\u003c/span\u003e \u003cspan class=\"nx\"\u003eat\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x00c00012e058\u003c/span\u003e \u003cspan class=\"nx\"\u003eby\u003c/span\u003e \u003cspan class=\"nx\"\u003egoroutine\u003c/span\u003e \u003cspan class=\"mi\"\u003e7\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003efunc1\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n      \u003cspan class=\"nx\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003eUsers\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003eAdministrator\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003eDropbox\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003eGoProject\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003eConcurrency\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003ego\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e10\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mh\"\u003e0x5a\u003c/span\u003e\n\n\u003cspan class=\"nx\"\u003ePrevious\u003c/span\u003e \u003cspan class=\"nx\"\u003eread\u003c/span\u003e \u003cspan class=\"nx\"\u003eat\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x00c00012e058\u003c/span\u003e \u003cspan class=\"nx\"\u003eby\u003c/span\u003e \u003cspan class=\"nx\"\u003emain\u003c/span\u003e \u003cspan class=\"nx\"\u003egoroutine\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n      \u003cspan class=\"nx\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003eUsers\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003eAdministrator\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003eDropbox\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003eGoProject\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003eConcurrency\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003ego\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e12\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mh\"\u003e0x92\u003c/span\u003e\n\n\u003cspan class=\"nx\"\u003eGoroutine\u003c/span\u003e \u003cspan class=\"mi\"\u003e7\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003erunning\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nx\"\u003ecreated\u003c/span\u003e \u003cspan class=\"nx\"\u003eat\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"nx\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n      \u003cspan class=\"nx\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003eUsers\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003eAdministrator\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003eDropbox\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003eGoProject\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003eConcurrency\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"nx\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003ego\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e9\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mh\"\u003e0x84\u003c/span\u003e\n\u003cspan class=\"o\"\u003e==================\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e就说了第10行goroutine7的\u003ccode\u003edata++\u003c/code\u003e和第12行main goroutine的\u003ccode\u003eif data == 0\u003c/code\u003e出现了数据竞争的情况。而且说明了goroutine7是第9行启动的。\u003c/p\u003e\n\u003cp\u003e一般会在测试的时候使用\u003ccode\u003ego -race\u003c/code\u003e进行数据竞争的检测，从而调整代码，尽量避免数据竞争的发生。一般线上部署不会使用\u003ccode\u003erace\u003c/code\u003e，因为会影响性能。\u003c/p\u003e\n\u003cp\u003e当然还有一个问题，因为是编译完之后才能通过具体地址检测的，即使某个地方可能会有冲突但是运行的时候没有表现出来，race也检测不到。\u003c/p\u003e\n","date":1611503186,"description":"","fuzzywordcount":2000,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"7164cc749bcfb8b3ff170c6b2e911d65","publishdate":1611503186,"relpermalink":"/posts/go-concurrency-1-introduction/","section":"posts","summary":"写在前面 Go语言最有魅力的一个方面就在于它内建的并发支持，Go的并发所涉及的内容化很多，预计会占用比较长的篇幅。等基本更新完成后会在此处放上所有文章的链接。 首先","tags":["Golang","并发"],"title":"Go并发（一）：并发的基本概念","url":"https://blog.engine.wang/posts/go-concurrency-1-introduction/","wordcount":1976},{"categories":"posts","content":"\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640248844/survival-analysis-0.png\" alt=\"survival-analysis-1\"\u003e\u003c/p\u003e\n\u003ch2 id=\"背景与简介\"\u003e背景与简介\u003c/h2\u003e\n\u003cp\u003e在生物医学、金融保险等领域，生存分析是一种很常见而且重要的方法。\u003c/p\u003e\n\u003cp\u003e生存分析主要用在癌症等疾病的研究中，比如对某种抗癌药物做临床试验，筛选一部分癌症患者，分为两组，一组服用该试验药物，一组服用对照药物，服药后开始统计每个患者从服药一直到死亡的生存时间。\u003c/p\u003e\n\u003cp\u003e生存分析可以抽象概述为，研究在不同条件下，特定事件发生与时间的关系是否存在差异。这些具体事件可以是死亡，也可以是痊愈、肿瘤转移、复发、出院、重新入院等任何可以明确识别的事件，而不同条件即为不同的分组依据，可以是年龄、性别、地域、某个基因表达量的高低、某个突变的携带与否等等。\u003c/p\u003e\n\u003cp\u003e（后面均用\u0026quot;死亡\u0026quot;来代指这个特定事件\u003c/p\u003e\n\u003ch2 id=\"概念与推导\"\u003e概念与推导\u003c/h2\u003e\n\u003ch3 id=\"生存时间t\"\u003e生存时间T\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640248843/surv-time-1.png\" alt=\"survival-time\"\u003e\u003c/p\u003e\n\u003cp\u003e把生存时间作为一个随机变量，用PDF（概率密度函数）和CDF（分布函数）来表达\u003c/p\u003e\n\u003cp\u003e其中CDF为$F(t) = Pr(T \u0026lt; t)$，也就是t之前死亡的概率\u003c/p\u003e\n\u003ch3 id=\"生存概率\"\u003e生存概率\u003c/h3\u003e\n\u003cp\u003eS(t)，Survival probability，研究对象从试验开始到某个特定时间点仍然存活的概率,$S(t) = pr(T \u0026gt; t)$\u003c/p\u003e\n\u003cp\u003e$S(t) = 1 - F(t)$\u003c/p\u003e\n\u003cp\u003e之后的Kaplan-Meier模型主要关注S(t)\u003c/p\u003e\n\u003ch3 id=\"风险概率\"\u003e风险概率\u003c/h3\u003e\n\u003cp\u003e$h(t): \\text{Hazard function}$\u003c/p\u003e\n\u003cp\u003e$$h(t) = \\lim_{\\epsilon \\to 0}\\frac{P(T \\in (t, t+\\epsilon] | T \\geqslant t)}{\\epsilon} = \\frac{f(t)}{S(t)}$$\u003c/p\u003e\n\u003cp\u003e前一个等号的意义 很明显，表示的意义就是研究对象从试验开始到某个特定时间点t之前存活，但是在t时间点发生\u0026quot;死亡\u0026quot;的概率\u003c/p\u003e\n\u003cp\u003e后面一个等号的推导过程\u003c/p\u003e\n\u003cp\u003e$$\n\\begin{array}{llr}\nh(t)\u0026amp; = \\lim_{\\Delta t \\to 0} \\frac{P(t \u0026lt; T \\leqslant t + \\Delta t | T \u0026gt; t)}{\\Delta t}\\newline\n\u0026amp; = \\lim_{\\Delta t \\to 0} \\frac{P(t \u0026lt; T \\leqslant t + \\Delta t )}{\\Delta t S(t)} \u0026amp; \\scriptsize{S(t)的定义}\\newline\n\u0026amp; = \\lim_{\\Delta t \\to 0} \\frac{F(t + \\Delta t) - F(t)}{\\Delta t S(t)} \u0026amp; \\scriptsize{F(t)的定义}\\newline\n\u0026amp; = \\frac{f(t)}{S(t)}\u0026amp;  \\scriptsize{f(t)是F(t)的微分}\n\\end{array}\n$$\u003c/p\u003e\n\u003cp\u003e然后还可以进一步推导：\u003c/p\u003e\n\u003cp\u003e$$\nh(t) = \\frac{f(t)}{S(t)} = \\frac{f(t)}{1 - F(t)} = - \\frac{\\partial log[1 - F(t)]}{\\partial t} = - \\frac{\\partial log[S(t)]}{\\partial t}\n$$\u003c/p\u003e\n\u003cp\u003e表示了$h(t)$和$S(t)$的关系\u003c/p\u003e\n\u003cp\u003e$H(t): \\text{Comulative\\ Hazard\\ function}$\n \n$$H(t) = \\int_0^t h(u) du$$\u003c/p\u003e\n\u003cp\u003e进一步推导：\n$$H(t) = \\int_0^t h(u) du = - \\int_0^t \\frac{ \\partial log[S(u)]}{\\partial u} du = -log[S(t)]$$\u003c/p\u003e\n\u003cp\u003e$$\\to S(t) = exp[-H(t)]$$\u003c/p\u003e\n\u003cp\u003e之后的Cox比例风险模型主要关注H(t)\u003c/p\u003e\n\u003ch2 id=\"hazard-function理解\"\u003eHazard function理解\u003c/h2\u003e\n\u003cp\u003ehazard function 本身不是概率，它描述的是一种在给定时间点的风险，$\\Delta t \\times h(t)$表示在$(t, t + \\Delta t]$的概率\u003c/p\u003e\n\u003cp\u003ehazard function优势：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e描述给定时间点的风险，这是我们需要的信息\u003c/li\u003e\n\u003cli\u003e可以很好的处理数据缺失的情况\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"举个例子\"\u003e举个例子\u003c/h2\u003e\n\u003cp\u003e假设survival time服从指数分布$Exp(\\lambda)$，即$f(x) = \\lambda e ^{-\\lambda x}, x \u0026gt; 0$\u003c/p\u003e\n\u003cp\u003e也就是$f(t) = \\lambda e ^{-\\lambda x}$\u003c/p\u003e\n\u003cp\u003e可以推出：\u003c/p\u003e\n\u003cp\u003e$F(t) = 1 - e ^{-\\lambda x}$\u003c/p\u003e\n\u003cp\u003e$S(t) = 1 - F(t) = e ^{-\\lambda x}$\u003c/p\u003e\n\u003cp\u003e$h(t) = \\frac{f(t)}{S(t)} = \\lambda$\u003c/p\u003e\n\u003cp\u003e$H(t) = \\lambda t$\u003c/p\u003e\n\u003cp\u003e$E(T) = \\frac{1}{\\lambda} （指数分布的性质）= \\frac{1}{h(t)}$\u003c/p\u003e\n\u003cp\u003e其他的分布同理\nGamma distribution\nWeibull distribution\nLog-normal distribution\ngenerized gamma distribution...\u003c/p\u003e\n\u003ch2 id=\"删失数据-censoring\"\u003e删失数据 Censoring\u003c/h2\u003e\n\u003cp\u003e生存分析中，很常见的一种特征就是删失数据\u003c/p\u003e\n\u003cp\u003e指的是在临床试验中，出现一些数据丢失的情况，比如病人中途主动退出、无法联系到、结束时还未发生特定事件。保留了从一开始到丢失前进度的数据成为右删失，另一种称为左删失。（后面只讨论右删失）\u003c/p\u003e\n\u003ch3 id=\"type-i-censoring观测时间确定\"\u003eType I Censoring：观测时间确定\u003c/h3\u003e\n\u003cp\u003e每一项数据增加一个表示：\u003c/p\u003e\n\u003cp\u003e$$(U_i, \\delta_i) = {min (T_i, c), I(T_i \\leqslant c)}, i = 1, ... , n$$\u003c/p\u003e\n\u003cp\u003e$$I(T_i \\leqslant C) = \\begin{cases}\n1, \u0026amp; T_i \\leqslant C,\\\n0, \u0026amp; T_i \u0026gt; C\n\\end{cases}$$\u003c/p\u003e\n\u003cp\u003ec是实验时间，是一个常量\n也就是说如果是$(c, 0)$，则代表被删失，如果是$(T_i, 1)$，则没有被删失\u003c/p\u003e\n\u003ch3 id=\"type-ii-censoring观测人数确定\"\u003eType II Censoring：观测人数确定\u003c/h3\u003e\n\u003cp\u003e比如观测n人，当死亡r人时停止试验\n$T_{(1, n)}, T_{(2, n)}, ..., T_{(r, n)}$\u003c/p\u003e\n\u003ch3 id=\"type-iii-censoring随机censoring\"\u003eType III Censoring：随机Censoring\u003c/h3\u003e\n\u003cp\u003e不用常量c而是用随机变量$C_i$\u003c/p\u003e\n\u003cp\u003e$(U_i, \\delta_i) = {min (T_i, C_i), I(T_i \\leqslant C_i)}, i = 1, ... , n$\u003c/p\u003e\n\u003cp\u003e只考虑右删失，我们只观察$(U_i, \\delta_i)$\n如果$(U_i, \\delta_i) = (u_i, 1)$，则说明$T_i = u_i, C_i \u0026gt; u_i$\n如果$(U_i, \\delta_i) = (u_i, 0)$，则说明$T_i \\geqslant u_i, C_i = u_i$\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640245124/survival-analysis-2.png\" alt=\"survival-analysis-2\"\u003e\u003c/p\u003e\n\u003cp\u003e(推导见https://www.bilibili.com/video/BV1WE411P78Z?p=2)\u003c/p\u003e\n\u003ch2 id=\"kaplan-meier模型\"\u003eKaplan-Meier模型\u003c/h2\u003e\n\u003cp\u003e与生存表、Cox并列的一种生存分析的方法，也叫乘积极限(product-limit estimator)\u003c/p\u003e\n\u003cp\u003e$\\hat{S}(t)=\\prod_{i: t_{i} \\leq t}\\left(1-\\frac{d_{i}}{n_{i}}\\right), \\quad t \\geq 0$\u003c/p\u003e\n\u003cp\u003e$d_i$是在$t_i$时刻死亡的人数，$n_i$是还在风险中的人数\u003c/p\u003e\n\u003cp\u003e例子：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640245203/survival-analysis-example-1.png\" alt=\"survival-analysis-example-1\"\u003e\u003c/p\u003e\n\u003ch3 id=\"life-table-生存表\"\u003eLife table 生存表\u003c/h3\u003e\n\u003cp\u003e举例：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640245336/life-table-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e设时间点为$t_0, t_1, ... ,t_n$，那么在$t_i$时间点下的生存概率：\n$$S(t_i) = \\Pi_{j=0}^{i}(1-P(t_j死亡))$$\u003c/p\u003e\n\u003cp\u003e也就是：\n$$S\\left(t_{i}\\right)=S\\left(t_{i-1}\\right)\\left(1-\\frac{d_{i}}{n_{i}}\\right)$$\u003c/p\u003e\n\u003cp\u003e$n_i$表示$t_i$时的有效人数，$d_i$表示$t_i$时的死亡人数\u003c/p\u003e\n\u003cp\u003e$t_i$处的生存率等于$t_{i-1}$时的生存率乘以（1-$t_i$时间点的死亡率）\u003c/p\u003e\n\u003ch3 id=\"kaplan-meier-生存曲线\"\u003eKaplan-Meier 生存曲线：\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1640245508/km-curve-1.png\" alt=\"\"\u003e\n加号表示删失数据\u003c/p\u003e\n\u003cp\u003e往往是多条线（因为是不同的组）\u003c/p\u003e\n\u003ch2 id=\"cox比例风险回归模型\"\u003eCox比例风险回归模型\u003c/h2\u003e\n\u003cp\u003eCox Proportional-Hazards Model是由英国统计学家D.R.Cox于1972年提出的一种半参数回归模型（半参数值既包含参数模型，又包含非参数模型）\u003c/p\u003e\n\u003cp\u003e参数模型：有限维度，有限个参数就可以表示模型分布，比如正态分布的均值和标准差\n非参数模型：属于某个无限维的空间，无法用有限个参数来表示，比如决策树、随机森林\u003c/p\u003e\n\u003cp\u003eCox建立回归的是前面提到的$h(x)$\nCox模型：\n$$h(t) = h_0(t) \\times exp({b_1x_1 + b_2x_2 + ... b_px_p})$$\u003c/p\u003e\n\u003cp\u003e其中$h(t)$指的是不同时间的风险值（hazard），$x_i$指的是具有预测效应的变量，$b_i$指的是每个变量对应的效应值，$h_0(t)$是基准风险函数，根据不同的数据来使用不同的分布模型，是非参数模型\u003c/p\u003e\n\u003cp\u003e建模时，首先确定需要研究的可能影响生存率的因素，也就是$x_i$，我们主要要做的就是找到合适的$h_0(t)$以及所有协变量的系数$b_p$，需要用到极大似然估计等方法求解参数。\u003c/p\u003e\n\u003ch3 id=\"两个基本假设\"\u003e两个基本假设\u003c/h3\u003e\n\u003cp\u003e对公式两边取对数进行变形：\u003c/p\u003e\n\u003cp\u003e$$log(h(t)) = log(h_0(t)) + \\beta X$$\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e模型中各危险因素对危险率的影响不随时间改变，且与时间无关\u003c/li\u003e\n\u003cli\u003e对数危险率与各个危险因素呈线性相关\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"参数的极大似然估计\"\u003e参数的极大似然估计\u003c/h3\u003e\n\u003cp\u003e通过极大似然估计来求解参数，极大似然估计的思想是，让已经发生的事件出现的可能性最大。\u003c/p\u003e\n\u003cp\u003e举个例子，有三个人$X_1, X_2, X_3$分别在三个时间点$t_1, t_2, t_3$死亡\u003c/p\u003e\n\u003cp\u003e以$t=t_1$为例，此时我们的目标是$max\\ h(t_1, X_1)$和$min\\ h(t_1, X_2) + h(t_1, X_3)$，统一这两个的目标：\u003c/p\u003e\n\u003cp\u003e$$max\\ \\frac{h(t_1, X_1)}{h(t_1, X_1) + h(t_1, X_2) + h(t_1, X_3)}$$\u003c/p\u003e\n\u003cp\u003e（分母加一个分子不影响结果，但是可以让最后一项不至于分母为0）\u003c/p\u003e\n\u003cp\u003e类推得到$t_2$的目标：\n$$max\\ \\frac{h(t_2, X_2)}{h(t_2, X_2) + h(t_2, X_3)}$$\u003c/p\u003e\n\u003cp\u003e$t_3$的目标：\n$$max\\ \\frac{h(t_3, X_3)}{h(t_3, X_3)}$$\u003c/p\u003e\n\u003cp\u003e所以似然函数是：\n$$L(\\beta) = \\frac{h(t_1, X_1)}{h(t_1, X_1) + h(t_1, X_2) + h(t_1, X_3)} \\frac{h(t_2, X_2)}{h(t_2, X_2) + h(t_2, X_3)} \\frac{h(t_3, X_3)}{h(t_3, X_3)}$$\u003c/p\u003e\n\u003cp\u003e代入$h(x)$的公式之后消掉$h_0(t)$，得到：\n$$L(\\beta) = \\frac{exp(\\beta · X_1)}{exp(\\beta · X_1) + exp(\\beta · X_2) + exp(\\beta · X_3)} \\frac{exp(\\beta · X_2)}{exp(\\beta · X_2) + exp(\\beta · X_3)} \\frac{exp(\\beta · X_3)}{exp(\\beta · X_3)}$$\u003c/p\u003e\n\u003cp\u003e这里我们假设的是3个事件，再泛化到N个的情况：\n$$L(\\beta)=\\prod_{i=1}^{N} \\frac{\\exp \\left(\\beta \\cdot X_{i}\\right)}{\\sum_{j: t_{j} \\geq t_{i}} \\exp \\left(\\beta \\cdot X_{j}\\right)}$$\u003c/p\u003e\n\u003cp\u003e对数似然函数：\n$$l(\\beta)=\\log L(\\beta)=\\sum_{i=1}^{N}\\left[\\beta \\cdot X_{i}-\\log \\left(\\sum_{j: t_{j} \\geq t_{i}} \\exp \\left(\\beta \\cdot X_{j}\\right)\\right)\\right]$$\u003c/p\u003e\n\u003cp\u003e梯度为：\n$$\\frac{\\partial l(\\beta)}{\\partial \\beta}=\\sum_{i=1}^{N}\\left[\\beta-\\frac{\\sum_{j: t_{j} \\geq t_{i}} X_{j} \\cdot \\exp \\left(\\beta \\cdot X_{j}\\right)}{\\sum_{j: t_{j} \\geq t_{i}} \\exp \\left(\\beta \\cdot X_{j}\\right)}\\right]$$\u003c/p\u003e\n\u003cp\u003e就可以采用梯度下降法来对参数进行估计\u003c/p\u003e\n\u003ch3 id=\"解读结果\"\u003e解读结果\u003c/h3\u003e\n\u003cp\u003e解得了合适的$h_0(t)$以及协变量系数之后，我们可以比较某个协变量$x_i$在不同值的时候对应的不同风险比$\\frac{x_i + 1}{x_i}$。\u003c/p\u003e\n\u003cp\u003e$$hazard\\ ratio = \\frac{h_0(t) \\times e^{b_1x_1 + b_2x_2 + ...b_i(x_i+1) + ... b_px_p}}{h_0(t) \\times e^{b_1x_1 + b_2x_2  + ...b_ix_i + ... b_px_p}} = e^{b_i}$$\u003c/p\u003e\n\u003cp\u003e举个例子，假如某个指标$x_i$表示年龄，那么对于年龄x和年龄x+1的人来说，死亡风险比是$e^{b_i}$，如果$b_i\u0026gt;0$，则年龄增大，死亡风险增大。反之减小。等于0则是不起作用\u003c/p\u003e\n","date":1608708180,"description":"","fuzzywordcount":2900,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"0e1e02e38f5d391ab4a52157146d4210","publishdate":1608708180,"relpermalink":"/posts/survival-analysis-basic/","section":"posts","summary":"背景与简介 在生物医学、金融保险等领域，生存分析是一种很常见而且重要的方法。 生存分析主要用在癌症等疾病的研究中，比如对某种抗癌药物做临床试验，筛选一部分癌症患者，","tags":["生存分析","统计学"],"title":"生存分析基础","url":"https://blog.engine.wang/posts/survival-analysis-basic/","wordcount":2837},{"categories":"posts","content":"\u003ch3 id=\"第一章导论\"\u003e第一章：导论\u003c/h3\u003e\n\u003ch2 id=\"概念部分\"\u003e概念部分\u003c/h2\u003e\n\u003cp\u003e第一台通用电子计算机诞生于1946年\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e计算机技术的飞速发展得益于\u003c/strong\u003e：计算机制造技术的发展、计算机系统结构的创新\u003c/p\u003e\n\u003cp\u003e纷纷放弃高性能转向多核，标志着系统结构的重大转折：\u003cstrong\u003e从单纯依靠指令集并行转向开发线程级并行和数据集并行\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e计算机系统的层次结构\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eL6: 应用语言虚拟机\u003c/p\u003e\n\u003cp\u003eL5: 高级语言虚拟机\u003c/p\u003e\n\u003cp\u003eL4: 汇编语言虚拟机\u003c/p\u003e\n\u003cp\u003eL3: 操作系统虚拟机\u003c/p\u003e\n\u003cp\u003eL2: 传统机器级\u003c/p\u003e\n\u003cp\u003eL1: 微程序机器级\u003c/p\u003e\n\u003cp\u003eL1-L3通常使用解释实现（一条一条来）\u003c/p\u003e\n\u003cp\u003eL4-L6通常使用翻译实现（全部翻译成下面一个低级再执行）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e计算机系统结构定义\u003c/strong\u003e：计算机系统结构是程序员所看到的计算机属性，即概念性结构与功能特性，是计算机系统的\u0008软硬件的界面\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e广义的系统结构\u003c/strong\u003e：指令结构、组成和硬件\u003c/p\u003e\n\u003cp\u003e包括：指令系统、寻址方式、数据表示、寄存器定义、中断系统、工作状态的切换、存储系统、信息保护、I/O结构等\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e计算机组成\u003c/strong\u003e：计算机系统结构的逻辑实现\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e计算机实现\u003c/strong\u003e：计算机系统结构的物理实现\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e一种体系结构可以有多种组成，一种组成可以有多种物理实现\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e系统结构的分类\u003c/strong\u003e\n冯氏分类法：按照最大并行度（字宽×一次能处理的字数）分\nFlynn分类：按指令流和数据流的多倍性分，分为以下四类：\u003c/p\u003e\n\u003cp\u003e①单指令流单数据流（SISD）\u003c/p\u003e\n\u003cp\u003e②单指令流多数据流（SIMD）\u003c/p\u003e\n\u003cp\u003e③多指令流单数据流（MISD）\u003c/p\u003e\n\u003cp\u003e④多指令流多数据流（MIMD）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e冯诺依曼结构\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e最大特点：以运算器为中心\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e虚拟机\u003c/strong\u003e：用软件实现的机器\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e系列机\u003c/strong\u003e：同一个厂家生产的具有相同\u0008系统结构但具有不同组成和实现的一系列不同型号的计算机\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e兼容机\u003c/strong\u003e：由不同厂家生产的具有相同系统结构的计算机\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e软件兼容\u003c/strong\u003e：向上兼容、向下兼容、向前兼容和向后兼容，其中向后兼容是系列机的根本特征\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e模拟\u003c/strong\u003e：用软件的方法在一台计算机上实现另一台计算机的指令集（本机要解释执行另一台机子的程序）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e仿真\u003c/strong\u003e：\u0008用一台现有计算机上的微程序去解释实现另一台计算机的指令集（本机要实现另一台机子的指令集）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e并行性\u003c/strong\u003e：包括同时性（同一时刻）和并发性（同一间隔）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e提高并行性的措施\u003c/strong\u003e：时间重叠、资源重复、资源共享\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e耦合度\u003c/strong\u003e：反应计算机之间物理连接的紧密程度和交互强弱，分为紧密耦合系统和松散耦合系统\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e计算机系统设计经常使用的4个定量原理\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e以经常性事件为重点\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eAmdahl定律\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eCPU性能公式\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e程序的局部性原理\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"计算部分\"\u003e计算部分\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eAmdahl定律\u003c/strong\u003e（P7）\u003c/p\u003e\n\u003cp\u003e$加速比 = \\frac{执行时间_{改进前}}{执行时间_{改进后}} = \\frac{1}{（ 1 - 可改进比例 ）+ \\frac{可改进比例}{部件加速比} }$\n依赖于可改进比例和部件加速比\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eCPU时间\u003c/strong\u003e（P9）\u003c/p\u003e\n\u003cp\u003e$CPU时间 = IC \\times CPI \\times 时钟周期时间$\u003c/p\u003e\n\u003cp\u003e$时钟周期 = \\frac{1}{f}$\u003c/p\u003e\n\u003cp\u003e$MIPS速率 = \\frac{f}{CPI} $\u003c/p\u003e\n\u003cp\u003e执行时间和吞吐率（P11）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e性能比较\u003c/strong\u003e（P14）\u003c/p\u003e\n\u003ch3 id=\"第二章指令集结构\"\u003e第二章：指令集结构\u003c/h3\u003e\n\u003ch2 id=\"概念部分-1\"\u003e概念部分\u003c/h2\u003e\n\u003cp\u003e区别不同指令集结构的主要因素是\u003cstrong\u003eCPU中用来储存操作数的储存单元的类型\u003c/strong\u003e，因此可以把指令集结构分为\u003cstrong\u003e堆栈结构\u003c/strong\u003e、\u003cstrong\u003e累加器结构\u003c/strong\u003e和\u003cstrong\u003e通用寄存器结构\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e寻址方式\u003c/strong\u003e：\n指一种指令集结构如何确定所要访问的数据的地址\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e对指令集的基本要求\u003c/strong\u003e：\n完整性、规整性、高效率和兼容性\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e指令集结构设计涉及的内容\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e① 指令集功能设计，主要由CISC和RISC两种方向\u003c/p\u003e\n\u003cp\u003e② 寻址方式设计\u003c/p\u003e\n\u003cp\u003e③ 操作数表示和操作数类型\u003c/p\u003e\n\u003cp\u003e④ 寻址方式的表示\u003c/p\u003e\n\u003cp\u003e⑤ 指令集格式的设计，变长、固定长度、混合\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e指令集三种编码格式\u003c/strong\u003e：\u003c/p\u003e\n\u003cp\u003e可变长度编码\u003c/p\u003e\n\u003cp\u003e固定长度编码\u003c/p\u003e\n\u003cp\u003e混合型编码\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eRISC遵循的原则\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e① 指令条数少而简单\u003c/p\u003e\n\u003cp\u003e② 采用简单而又统一的指令格式\u003c/p\u003e\n\u003cp\u003e③ 指令的执行在单个机器周期内完成\u003c/p\u003e\n\u003cp\u003e④ 只有load和store能访问存储器\u003c/p\u003e\n\u003cp\u003e⑤ 大多数指令采用硬连逻辑\u003c/p\u003e\n\u003cp\u003e⑥ 强调优化编译器的作用\u003c/p\u003e\n\u003cp\u003e⑦ 充分利用流水线\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eI类指令\u003c/strong\u003e：\nload、store等\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e0-5\u003c/th\u003e\n\u003cth\u003e6-10\u003c/th\u003e\n\u003cth\u003e11-15\u003c/th\u003e\n\u003cth\u003e16-31\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e操作码\u003c/td\u003e\n\u003ctd\u003ers\u003c/td\u003e\n\u003ctd\u003ert\u003c/td\u003e\n\u003ctd\u003e立即数\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e\u003cstrong\u003eR类指令\u003c/strong\u003e：\nALU等\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e0-5\u003c/th\u003e\n\u003cth\u003e6-10\u003c/th\u003e\n\u003cth\u003e11-15\u003c/th\u003e\n\u003cth\u003e16-20\u003c/th\u003e\n\u003cth\u003e21-25\u003c/th\u003e\n\u003cth\u003e26-31\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e操作码\u003c/td\u003e\n\u003ctd\u003ers\u003c/td\u003e\n\u003ctd\u003ert\u003c/td\u003e\n\u003ctd\u003erd\u003c/td\u003e\n\u003ctd\u003eshamt\u003c/td\u003e\n\u003ctd\u003efunct\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cbr\u003e\n\u003ch3 id=\"第三章流水线技术\"\u003e第三章：流水线技术\u003c/h3\u003e\n\u003ch2 id=\"概念部分-2\"\u003e概念部分\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003e流水线技术的概念\u003c/strong\u003e：\n把一个重复的过程分解为若干个子过程，每一个子过程用一个专门的部件来实现。多个处理过程在时间上错开依次通过各段，让每个子过程和其他过程并行，这就是流水线技术\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e流水线技术的特点\u003c/strong\u003e：\u003c/p\u003e\n\u003cp\u003e① 流水线把一个处理过程分解为若干个子过程，每个子过程由一个专门的功能部件来实现，依靠它们的并行工作来缩短程序的执行时间\u003c/p\u003e\n\u003cp\u003e② 流水线各段时间应该尽可能相等\u003c/p\u003e\n\u003cp\u003e③ 流水线的每一个功能部件的后面都要有一个缓冲存储器\u003c/p\u003e\n\u003cp\u003e④ 流水线适合于大量重复的时序过程\u003c/p\u003e\n\u003cp\u003e⑤ 流水线需要有通过时间和排空时间\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e流水线分类\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e单功能流水线：只能完成一种固定功能\u003c/p\u003e\n\u003cp\u003e多功能流水线：可以实现不同的功能\u003c/p\u003e\n\u003cp\u003e静态流水线：同一时间各段只能按照同一种功能的连接方式工作\u003c/p\u003e\n\u003cp\u003e动态流水线：同一时间各段可以有不同的连接，执行多种功能\u003c/p\u003e\n\u003cp\u003e部件级流水线：把运算部件分段\u003c/p\u003e\n\u003cp\u003e处理机级流水线：把指令的解释执行过程分段\u003c/p\u003e\n\u003cp\u003e处理机间流水线：在处理机间流水\u003c/p\u003e\n\u003cp\u003e线性流水线：没有反馈回路\u003c/p\u003e\n\u003cp\u003e非线性流水线：有反馈回路\u003c/p\u003e\n\u003cp\u003e顺序流水线：任务流出流入的顺序一致\u003c/p\u003e\n\u003cp\u003e乱序流水线：任务流出的顺序和流入的顺序可以不一样\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e解决流水线瓶颈问题的方法\u003c/strong\u003e\n细分瓶颈段、重复设置瓶颈段\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e经典的五段流水线划分\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e一条指令的执行过程可以划分为以下五个部分：\u003c/p\u003e\n\u003cp\u003e取指令周期（IF）\u003c/p\u003e\n\u003cp\u003e指令译码/读寄存器（ID）\u003c/p\u003e\n\u003cp\u003e执行/有效地址计算（EX）\u003c/p\u003e\n\u003cp\u003e存储器访问/分支完成（MEM）\u003c/p\u003e\n\u003cp\u003e写回周期（WB）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e相关的概念\u003c/strong\u003e：相关是指两条指令之间存在某种依赖关系\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e相关的分类\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e数据相关：指令之间有数据关联（有传递性）\u003c/p\u003e\n\u003cp\u003e名相关：名指的是寄存器名或存储器名，数据不关联但是用了相同的名，名相关又分为反相关（一写一读）和输出相关（都写）\u003c/p\u003e\n\u003cp\u003e控制相关：由分支指令引起的相关\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e流水线冲突的概念\u003c/strong\u003e：\n对于具体的流水线而言，由于相关的存在，导致指令流的下一条指令不能在指定的时钟周期执行\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e流水线冲突的分类\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e结构冲突：硬件资源无法满足重叠执行的要求\u003cbr\u003e\n     — 消除结构冲突：气泡停顿、设置独立指令数据存储器、Cache分为指令Cache和数据Cache\n数据冲突：重叠执行时需要用到前面的数据\u003cbr\u003e\n     — 数据冲突分为：写后读（RAW）、写后写（WAW）\u003c/p\u003e\n\u003cp\u003e     — 解决数据冲突：定向技术（直接从产生的地方送到需要的地方）、通过编译器指令调度解决\n控制冲突：分支指令等引起的冲突\u003cbr\u003e\n     — 解决控制冲突：冻结或排空流水线（最简单但是分支延迟大）、尽早判断分支是否成功（提前到ID段末尾）、软件方法\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e减少分支延迟的静态方法\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e预测分支失败\u003c/p\u003e\n\u003cp\u003e预测分支成功\u003c/p\u003e\n\u003cp\u003e延迟分支（在延迟槽中放入有用的指令，三种调度方法：从前调度、从目标处调入、从失败处调入）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e不采用单周期的原因\u003c/strong\u003e：\u003c/p\u003e\n\u003cp\u003e① 单周期效率低，不同指令需要的时钟周期不一样\u003c/p\u003e\n\u003cp\u003e② 单周期需要重复设置部件，而多周期可以共享\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e流水寄存器的作用\u003c/strong\u003e：\u003c/p\u003e\n\u003cp\u003e① 将各段隔开来，使之不会相互干扰\u003c/p\u003e\n\u003cp\u003e② 保存相应段的处理结果\u003c/p\u003e\n\u003cp\u003e③ 向后传递后面要用到的数据或控制信息\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e流水线的实现（P82 - P90）\u003c/strong\u003e\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e$IF/IR$\u003c/th\u003e\n\u003cth\u003e$IR/EX$\u003c/th\u003e\n\u003cth\u003e$EX/MEM$\u003c/th\u003e\n\u003cth\u003e$MEM/WD$\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e$NPC$\u003c/td\u003e\n\u003ctd\u003e$NPC$\u003c/td\u003e\n\u003ctd\u003e$cond$\u003c/td\u003e\n\u003ctd\u003e$LMD$\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e$IR$\u003c/td\u003e\n\u003ctd\u003e$A$\u003c/td\u003e\n\u003ctd\u003e$ALU0$\u003c/td\u003e\n\u003ctd\u003e$ALU0$\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003ctd\u003e$B$\u003c/td\u003e\n\u003ctd\u003e$B$\u003c/td\u003e\n\u003ctd\u003e$IR$\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003ctd\u003e$Imm$\u003c/td\u003e\n\u003ctd\u003e$IR$\u003c/td\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003ctd\u003e$IR$\u003c/td\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch2 id=\"计算部分-1\"\u003e计算部分\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003e吞吐率\u003c/strong\u003e：单位时间内流水线完成的任务数量\u003c/p\u003e\n\u003cp\u003e$TP = \\frac{n}{T_k}$\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e加速比\u003c/strong\u003e：不用流水线所用的时间和用流水线所用时间之比\u003c/p\u003e\n\u003cp\u003e$S = \\frac{T_s}{T_k}$\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e效率\u003c/strong\u003e：设备实际使用时间与整个运行时间之比（画图之后即为阴影面积/完整面积）\u003c/p\u003e\n\u003cp\u003e易出大题（P61 例题3.1、P104 章后习题3.11）\n\u0008\u003cstrong\u003e务必注意题目里说的是静态流水线还是动态流水线\u003c/strong\u003e，静态流水线必须一个操作做完之后 才能开另一个功能，参见P60例3.1个P60例3.2\u003c/p\u003e\n\u003cbr\u003e\n\u003ch3 id=\"第四章指令级并行\"\u003e第四章：指令级并行\u003c/h3\u003e\n\u003ch2 id=\"概念部分-3\"\u003e概念部分\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003e指令级并行概念\u003c/strong\u003e：利用流水线使指令重叠并行执行，这种指令之间潜在并行性称为指令级并行（ILP，Instruction-Level Parallelism）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eCPI\u003c/strong\u003e：（Cycles Per Instruction）每条指令所消耗的时钟周期数\n\u003cstrong\u003eIPC\u003c/strong\u003e：（Instructions Per Cycle）每个时钟周期完成的指令条数\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e基本程序块\u003c/strong\u003e：一段除了入口和出口之外不包含其他分支的线性代码段（就是指中间没分支）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e循环级并行\u003c/strong\u003e：让一个循环中的不同循环体并行执行\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e开发循环级并行的技术\u003c/strong\u003e：循环展开技术、采用向量指令和向量数据表示\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e指令顺序\u003c/strong\u003e：由源程序确定的在完全串行方式下指令的执行顺序\u003c/p\u003e\n\u003cp\u003e正确执行程序\u003cstrong\u003e必须保持的最关键的两个因素\u003c/strong\u003e：数据流（数据从其产生者指令到消费者指令的实际流动）和异常行为（无论怎么改变顺序，都不影响程序中异常的发生情况）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e指令调度\u003c/strong\u003e：通过在编译时让编译器重新组织指令顺序或者通过硬件在执行时调整指令顺序来消除冲突\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e静态调度与动态调度\u003c/strong\u003e：第三章为静态调度，第四章为动态调度，以下为二者区别：\n① 静态调度发生在编译过程中，动态调度发生在运行过程中\n② 动态调度相比静态有更多优点：能够处理一些编译时不明确的相关、能够套用在其他流水线上\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e精确异常和不精确异常\u003c/strong\u003e：\n精确异常：发生异常时，处理机的现场和严格按程序顺序执行时的\u0008现场相同\n不精确异常：发生异常时，处理机的现场和严格按程序顺序执行时的\u0008现场不同\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eTomasulo算法\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e保留栈\u003c/strong\u003e：在采用Tomasulo算法的MIPS处理器浮点部件中，在运算部件的入口设置的用来保存已经流出并等待到本功能部件执行的指令\n\u003cstrong\u003eCDB\u003c/strong\u003e：公共数据总线\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eROB\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e动态分支预测技术\u003c/strong\u003e：根据分支指令过去的表现来预测其将来的行为\n\u003cstrong\u003eBHT\u003c/strong\u003e：分支历史表，用于记录相关分支指令最近几次的执行情况并根据此进行预测\n\u003cstrong\u003e分支目标缓冲\u003c/strong\u003e：是一种动态分支预测技术，将执行过的成功的分支指令的地址和预测的分支目标地址记录在一个硬件表中，每次取指令时比较，达到减少分支开销的作用\n\u003cstrong\u003e前瞻执行\u003c/strong\u003e：解决控制相关的方法，对分支指令的结果进行预测，按照这个预测结果继续后续的过程，不过指令执行的结果不是放在寄存器或存储器中，而是放在ROB缓冲器中，相应指令确认后才将结果写到寄存器或存储器\n\u003cstrong\u003eROB\u003c/strong\u003e：前瞻执行缓冲器\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e多流出处理机的两种基本风格\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e超标量：一种多指令流出技术，每个时钟周期流出的指令条数不确定，但有个上限\n超长指令字：一种多指令流出技术，每个时钟周期流出的指令条数是固定的，这些指令构成一条长指令或者指令包，通过编译器静态调度\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e超流水\u003c/strong\u003e\n一个时钟周期内分时流出多条指令\u003c/p\u003e\n\u003ch2 id=\"计算部分-2\"\u003e计算部分\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003e实际CPI\u003c/strong\u003e：\u003c/p\u003e\n\u003cp\u003e$CPI_{流水线} = CPI_{理想} + 停顿_{结构冲突} + 停顿_{数据冲突} + 停顿_{控制冲突}$\u003c/p\u003e\n\u003cbr\u003e\n\u003ch3 id=\"第五章存储系统\"\u003e第五章：存储系统\u003c/h3\u003e\n\u003ch2 id=\"概念部分-4\"\u003e概念部分\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003e人们追求的储存器特性\u003c/strong\u003e：容量大、速度快、价格低\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e走出困境的唯一方法\u003c/strong\u003e：采用多级存储层次结构\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e多级存储层次\u003c/strong\u003e：采用不同的技术实现的存储器，处在离CPU不同位置的层次上，各存储器之间一般满足包容关系，任何一层存储器中的内容都是其下一层的储存器内容的子集。目标是达到离CPU最近的存储器的速度，最远的存储器的容量。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e“Cache-主存”与“主存-辅存”的区别\u003c/strong\u003e\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e\u003c/th\u003e\n\u003cth\u003eCache-主存层次\u003c/th\u003e\n\u003cth\u003e主存-辅存层次\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e目的\u003c/td\u003e\n\u003ctd\u003e为了弥补主存速度的不足\u003c/td\u003e\n\u003ctd\u003e为了弥补主存容量的不足\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e存储管理的实现\u003c/td\u003e\n\u003ctd\u003e由专用硬件实现\u003c/td\u003e\n\u003ctd\u003e由软件实现\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e访问速度的比值\u003c/td\u003e\n\u003ctd\u003e几比一\u003c/td\u003e\n\u003ctd\u003e几万比一\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e块/页大小\u003c/td\u003e\n\u003ctd\u003e几十个字节\u003c/td\u003e\n\u003ctd\u003e几百到几千字节\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eCPU对第二级的访问方式\u003c/td\u003e\n\u003ctd\u003e可以直接访问\u003c/td\u003e\n\u003ctd\u003e均通过第一级\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e不命中时是否切换\u003c/td\u003e\n\u003ctd\u003e不切换\u003c/td\u003e\n\u003ctd\u003e切换到其他进程\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e\u003cstrong\u003e映像规则\u003c/strong\u003e\n全相联映像：主存中的任意一块可以被放置到Cache中的任意一个位置，空间利用率最高、冲突概率最低、实现最复杂\n直接映像：    主存中的\u0008每一块只能被放到Cache中唯一的位置，空间利用率最低、冲突概率最高、实现最简单\n组相联映像：主存中的每一块可以被放置到Cache中唯一一组中的任何一个位置，是上面二者的折中\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e查找算法\u003c/strong\u003e\n查找Cache在哪，通过查找目录表实现，目录表项与储存器块对应\u003c/p\u003e\n\u003cp\u003e目录表\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e有效位\u003c/th\u003e\n\u003cth\u003e标识\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003c/table\u003e\n\u003cp\u003e有效位为1表示有效，标识tag标识了存放的信息存在于哪个主存块中\u003c/p\u003e\n\u003cp\u003e主存地址\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e标识\u003c/th\u003e\n\u003cth\u003e索引\u003c/th\u003e\n\u003cth\u003e块内位移\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003c/table\u003e\n\u003cp\u003e\u003cstrong\u003e替换算法\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e随机法\u003c/p\u003e\n\u003cp\u003eFIFO\u003c/p\u003e\n\u003cp\u003eLRU\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eLRU算法的硬件实现\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e堆栈法\u003c/p\u003e\n\u003cp\u003e比较对法\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e写策略\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e写直达法：执行写操作时，不仅写入Cache，而且也直接写入下一级存储器（易于实现）\n（不按写分配，不命中直接写入下一级而不调块）\u003c/p\u003e\n\u003cp\u003e写回法：执行写操作时，只写入Cache。仅当Cache中相应的块被替换\u0008时，才写回主存（速度快）\n（按写分配，不命中时调块）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eCache对低CPI、高时钟频率的CPU来说更为重要\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e改进Cache性能\u0008\u003c/strong\u003e\n包括三个方面：\u003c/p\u003e\n\u003cp\u003e① 降低不命中率（8种）\u003c/p\u003e\n\u003cp\u003e② 减少不命中开销（5种）\u003c/p\u003e\n\u003cp\u003e③ 减少Cache命中时间（4种）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e三种类型的不命中\u003c/strong\u003e\n强制性不命中：首次访问就没命中\n\u0008容量不命中：某些块被\u0008替换了，之后又访问了这些块（原因主要是容量小了）\n冲突不命中：组相联或直接映像很多块映到了同一组（块）中，原块被替换，之后又访问了这些块\u003c/p\u003e\n\u003cp\u003e相联度越高，冲突不命中就越少（因为每块可选的位置变多了，冲突几率下降），对强制不命中和容量不命中没什么影响\u003c/p\u003e\n\u003cp\u003eCache\u0008容量增加，容量不命中下降，对强制性不命中没影响\u003c/p\u003e\n\u003cp\u003e减少三种不命中的方法：\n强制性不命中：增加块大小，\u0008预取（本身比例很少）\n容量不命中：增加容量\n冲突不命中：提高相联度（理想情况：全相联）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e降低不命中率的八种方法\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e① 增加Cache块大小\u003cbr\u003e\n            最简单，减少强制不命中，但增加了冲突不命中（因为块的个数少了），同时也会增大不命中开销\u003c/p\u003e\n\u003cp\u003e② 增加Cache容量\u003cbr\u003e\n            最直接，但会增加成本和命中时间\u003c/p\u003e\n\u003cp\u003e③ 提高相联度\u003cbr\u003e\n            会增加命中时间\n         （2:1Cache经验规则：容量为N的直接映像Cache的不命中率和容量为N/2的两路组相联Cache的不命中率差不多）\u003c/p\u003e\n\u003cp\u003e④ 伪相联Cache\u003cbr\u003e\n            访问\u0008如果命中就和直接映像一样，如果不命中就检查另一个位置是否匹配，简单的方法是将索引的最高位取反。保持命中速度和低不命中率，会让CPU流水线的设计复杂化\u003c/p\u003e\n\u003cp\u003e⑤ 硬件预取\u003cbr\u003e\n            指令和数据在处理器提出访问之前进行预取，由Cache之外的硬件完成，放入一个缓冲器中。预取应当利用存储器的空闲带宽，不能影响对正常不命中的处理，否则可能会降低性能\u003c/p\u003e\n\u003cp\u003e⑥ 编译器控制的预取\u003cbr\u003e\n            由编译器在程序中加入预取指令实现预取。每次预取需要花费一条指令的开销\u003c/p\u003e\n\u003cp\u003e⑦ 编译器优化\u003cbr\u003e\n            三种方法：代码和数据重组、内外循环交换、分块\u003c/p\u003e\n\u003cp\u003e⑧ 牺牲Cache\u003cbr\u003e\n            在Cache和下一级之间设置一个全相联小Cache来存储被替换掉的块，减少冲突不命中很有效，尤其是小容量Cache\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e减少Cache不命中开销的五种方法\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e① 采用两级Cache（有计算）\u003c/p\u003e\n\u003cp\u003e② 让读不命中优先于写\n            会增加命中时间\u003c/p\u003e\n\u003cp\u003e③ 写缓冲合并\u003cbr\u003e\n            写入的数据与缓冲器已有地址比较，如果有地址匹配的就合并\u003c/p\u003e\n\u003cp\u003e④ 请求字处理技术\u003cbr\u003e\n            从下一级调入Cache的块只有一个字是立即需要的，称为请求字，两种方法：尽早重启动、请求字优先\u003cbr\u003e\n            在Cache块较小或者下一条指令正好访问Cache块的另一部分时，效果不明显\u003c/p\u003e\n\u003cp\u003e⑤ 非阻塞Cache技术\u003cbr\u003e\n            在Cache不命中时仍允许CPU进行其他的命中访问\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e减少Cache命中\u0008时间的四种方法\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e① 容量小、结构简单的Cache\u003cbr\u003e\n            增大不命中率\u003c/p\u003e\n\u003cp\u003e② 虚拟Cache\u003cbr\u003e\n            可以直接用虚拟地址进行访问的Cache\u003c/p\u003e\n\u003cp\u003e③ Cache访问流水化\u003cbr\u003e\n            把对第一级Cache的访问按流水方式组织\u003c/p\u003e\n\u003cp\u003e④ 踪迹Cache\u003cbr\u003e\n            存放CPU所执行过的动态序列，包含分支预测展开的指令\u003cbr\u003e\n            地址映像机制复杂，相同的指令序列可能被重复存放，提高了Cache的空间利用率\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e主存主要的性能指标\u003c/strong\u003e：延迟和带宽\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e并行主存系统\u003c/strong\u003e：在一个访存周期内能并行访问多个储存字的存储器\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e并行存储器结构包括\u003c/strong\u003e：\n单体多字存储器\n多体交叉存储器\u003c/p\u003e\n\u003ch2 id=\"计算部分-3\"\u003e计算部分\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003e平均每位价格C、命中率H、平均访存时间\u003c/strong\u003e（P155）\u003c/p\u003e\n\u003cp\u003e$M_1{T_1, S_1, C_1}、M_2{T_2, S_2, C_2}$\u003c/p\u003e\n\u003cp\u003eT: 平均访存时间，S: 存储容量，C: 平均每位价格\u003c/p\u003e\n\u003cp\u003e平均每位价格 = $\\frac{M_1C_1 + M_2C_2}{M_1 + M_2}$\u003c/p\u003e\n\u003cp\u003e命中率 = $\\frac{N_1}{N_1+N_2}$\u003c/p\u003e\n\u003cp\u003e平均访存时间 = $HT_1 + (1-H)(T_1+T_M) = T_1 + (1-H)T_M = T_1 + FT_M$\n不命中开销 $T_M = T_2 + T_B$\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eCache的容量\u003c/strong\u003e（P163）\u003c/p\u003e\n\u003cp\u003eCache容量 = $2^{index} \\times$ 相联度 $\\times$ 块大小\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e程序执行时间\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e$CPU$时间 = $IC \\times (CPI + $每条指令的平均访存次数$\\times $不命中率$ \\times $不命中开销$) \\times $时钟周期时间\u003c/p\u003e\n\u003cp\u003e（P172例题）\u003c/p\u003e\n\u003ch3 id=\"第六章输入输出系统\"\u003e第六章：输入输出系统\u003c/h3\u003e\n\u003ch2 id=\"概念部分-5\"\u003e概念部分\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eI/O系统包括\u003c/strong\u003e：I/O设备、I/O设备与处理机的连接\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e系统的响应时间\u003c/strong\u003e：从用户输入命令开始，到得到结果所花费的时间（等于I/O系统的响应时间+CPU的处理时间）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eI/O系统的三个性能指标\u003c/strong\u003e\n可靠性：一直连续提供服务的能力，用平均无故障时间MTTF衡量，其倒数为失效率（计算时失效率可累加，倒数相加再倒）\n可用性：正常工作的时间在连续两次正常服务间隔中的比例    可用性=$\\frac{MTTF}{MTTF+MTTR}$\n可信性：服务的质量（无法度量）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e磁盘阵列\u003c/strong\u003e：使用多个磁盘的组合来代替一个大容量的磁盘\n阵列的并行性包括：多个请求可以由多个盘来并行处理、一个请求访问多个块也可以多个块合作地并行处理\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e各种RAID\u003c/strong\u003e\n（检测盘个数是数据盘个数为8个时所需要的检测盘个数）\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e名称\u003c/th\u003e\n\u003cth\u003e描述\u003c/th\u003e\n\u003cth\u003e可容忍故障\u003c/th\u003e\n\u003cth\u003e检测盘个数\u003c/th\u003e\n\u003cth\u003e优点\u003c/th\u003e\n\u003cth\u003e缺点\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eRAID0\u003c/td\u003e\n\u003ctd\u003e非冗余阵列，没有冗余信息\u003c/td\u003e\n\u003ctd\u003e0\u003c/td\u003e\n\u003ctd\u003e0\u003c/td\u003e\n\u003ctd\u003e无空间开销\u003c/td\u003e\n\u003ctd\u003e无纠错能力\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eRAID1\u003c/td\u003e\n\u003ctd\u003e镜像盘，\u0008每个磁盘都有备份\u003c/td\u003e\n\u003ctd\u003e1\u003c/td\u003e\n\u003ctd\u003e8\u003c/td\u003e\n\u003ctd\u003e计算少，快\u003c/td\u003e\n\u003ctd\u003e空间开销大\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eRAID2\u003c/td\u003e\n\u003ctd\u003e汉明纠错码位交叉\u003c/td\u003e\n\u003ctd\u003e1\u003c/td\u003e\n\u003ctd\u003e4\u003c/td\u003e\n\u003ctd\u003e不依靠故障盘诊断\u003c/td\u003e\n\u003ctd\u003e空间开销log\u003csub\u003e2\u003c/sub\u003en\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eRAID3\u003c/td\u003e\n\u003ctd\u003e位交叉奇偶校验磁盘阵列\u003c/td\u003e\n\u003ctd\u003e1\u003c/td\u003e\n\u003ctd\u003e1\u003c/td\u003e\n\u003ctd\u003e空间开销小，大规模I/O带宽高\u003c/td\u003e\n\u003ctd\u003e小规模I/O支持不好\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eRAID4\u003c/td\u003e\n\u003ctd\u003e块交叉奇偶校验磁盘阵列\u003c/td\u003e\n\u003ctd\u003e1\u003c/td\u003e\n\u003ctd\u003e1\u003c/td\u003e\n\u003ctd\u003e空间开销小，小规模I/O带宽高\u003c/td\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eRAID5\u003c/td\u003e\n\u003ctd\u003e块交叉分布奇偶校验磁盘阵列\u003c/td\u003e\n\u003ctd\u003e1\u003c/td\u003e\n\u003ctd\u003e1\u003c/td\u003e\n\u003ctd\u003e空间开销小，小规模I/O带宽高\u003c/td\u003e\n\u003ctd\u003e小规模读写需要访问4次\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eRAID6\u003c/td\u003e\n\u003ctd\u003eP+Q双校验磁盘阵列\u003c/td\u003e\n\u003ctd\u003e2\u003c/td\u003e\n\u003ctd\u003e2\u003c/td\u003e\n\u003ctd\u003e容忍两个磁盘出错\u003c/td\u003e\n\u003ctd\u003e小规模读写需要访问6次\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e\u003cstrong\u003e实现盘阵列的方式\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e软件方式\u003c/p\u003e\n\u003cp\u003e阵列卡方式\u003c/p\u003e\n\u003cp\u003e子系统方式\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e通道处理机\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e专门负责\u0008整个计算机的输入输出工作，通道处理机只能执行有限的一组输入输出指令\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e输入输出系统的层次\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eCPU-\u0026gt;通道-\u0026gt;设备控制器-\u0026gt;外设\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e通道的主要硬件\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e寄存器\u003c/p\u003e\n\u003cp\u003e控制逻辑\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e通道的工作过程\u003c/strong\u003e（3步）\u003c/p\u003e\n\u003cp\u003e① 在用户程序中启动一个访管指令，由管理程序来编制一个通道程序，并启动通道\u003c/p\u003e\n\u003cp\u003e② 通道处理机执行通道程序，完成指定的数据的输入输出工作\u003c/p\u003e\n\u003cp\u003e③ 通道程序结束后向CPU发出中断请求\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e通道的种类\u003c/strong\u003e（3种）\u003c/p\u003e\n\u003cp\u003e① 字节多路通道，为多台低中速外设服务，以字节交叉的方式分时轮流服务，可以包含多个子通道，每个子通道连接一台设备控制器\u003c/p\u003e\n\u003cp\u003e② 选择通道，为多台高速外围设备服务，一段时间内只为一条高速外设独占\u003c/p\u003e\n\u003cp\u003e③ 数组多路通道，适用于高速设备，每次选择一个高速设备后传送一个数据块，轮流为多台外围设备服务\u003c/p\u003e\n\u003ch2 id=\"计算部分-4\"\u003e计算部分\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003e通道流量分析（P238）\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e字节多路通道：（连一个外设，传一个字节，再连一个外设，传一个字节...）\u003c/p\u003e\n\u003cp\u003ep台设备传输n个数据所需时间：$T_{BYTE}=(T_S+T_D)\\times p\\times n$\u003c/p\u003e\n\u003cp\u003e最大流量：$f_{MAX-BYTE} = \\frac{1}{T_S+T_D}$\u003c/p\u003e\n\u003cp\u003e选择通道：（一台设备的数据传输工作全部结束后通道才为另一台设备服务）\u003c/p\u003e\n\u003cp\u003ep台设备传输n个数据所需时间：$T_{SELECT}=(\\frac{T_S}{n}+T_D)\\times p\\times n$\u003c/p\u003e\n\u003cp\u003e最大流量：$f_{MAX-SELECT} = \\frac{1}{\\frac{T_S}{n}+T_D}$\u003c/p\u003e\n\u003cp\u003e数组多路通道：（连一个外设，传一个k个字节的数据块，再连一个外设，传一个k个字节的数据块...）\u003c/p\u003e\n\u003cp\u003ep台设备传输n个数据所需时间：$T_{BLOCK}=(\\frac{T_S}{k}+T_D)\\times p\\times n$\u003c/p\u003e\n\u003cp\u003e最大流量：$f_{MAX-BLOCK} = \\frac{1}{\\frac{T_S}{k}+T_D}$\u003c/p\u003e\n\u003cbr\u003e\n\u003ch3 id=\"第八章多处理机\"\u003e第八章：多处理机\u003c/h3\u003e\n\u003ch2 id=\"概念部分-6\"\u003e概念部分\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eMIMD的成为通用多处理机系统结构的选择的原因\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eMIMD具有灵活性\u003c/p\u003e\n\u003cp\u003eMIMD可以充分利用现有微处理机的性价比优势\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eMIMD的分类\u003c/strong\u003e：\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e集中式共享存储器结构\u003c/strong\u003e（CSMA、UMA、对称式共享存储器多处理机SMP）\u003c/p\u003e\n\u003cp\u003e多个处理器共享一个集中式的物理存储器，单一主存而且主存对于各处理器而言是对等的\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e分布式存储器多处理机\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e存储器分布到各个处理器上，优点：\u003c/p\u003e\n\u003cp\u003e①降低对存储器和互联网络的带宽要求\u003c/p\u003e\n\u003cp\u003e②对本地存储器的访问延迟时间小；\u003c/p\u003e\n\u003cp\u003e缺点：处理器之间的通信较为复杂，访问延迟大\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e两种储存器系统结构\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e共享地址空间：物理上分离的所有储存器作为一个统一的共享逻辑空间进行编址，不同处理器的同一个物理地址指向同一个存储单元\u003c/p\u003e\n\u003cp\u003e独立编址：每个节点的存储器编址为一个独立的地址空间，不同\u0008处理器的地址是独立的。每一个处理器-存储器模块实际上是一台单独的计算机\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e两种通信机制\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e共享存储器通信机制：处理器之间通过store-load对相同存储器地址进行读写来实现的\n优点：\u003c/p\u003e\n\u003cp\u003e① 与常用的SMP通信机制兼容\u003c/p\u003e\n\u003cp\u003e② 易于编程\u003c/p\u003e\n\u003cp\u003e③ 数据量小时开销较低\u003c/p\u003e\n\u003cp\u003e④ 可以采用cache来减少远程通信的频度\u003c/p\u003e\n\u003cp\u003e消息传递通信机制：处理器之间通过发送消息来进行通信\u003c/p\u003e\n\u003cp\u003e优点\u003c/p\u003e\n\u003cp\u003e① 硬件简单\u003c/p\u003e\n\u003cp\u003e② 通信是显式的\u003c/p\u003e\n\u003cp\u003e③ 减少不当的同步带来的可能的错误\u003c/p\u003e\n\u003cp\u003e④ 显式通信让编程者重点关注主要通信开销\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eCache一致性协议\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e监听式协议\u003c/p\u003e\n\u003cp\u003e目录式协议\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eCache一致性问题解决方法\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e写作废协议\u003c/p\u003e\n\u003cp\u003e写更新协议\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e同时多线程技术\u003c/strong\u003e：\u003c/p\u003e\n\u003cp\u003e一种在多流出、动态调度的处理器上同时开发线程级并行和指令级并行的技术\u003c/p\u003e\n","date":1591254309,"description":"","fuzzywordcount":8000,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"0ec51da4f6170c7bf6de905b849dbfde","publishdate":1591254309,"relpermalink":"/posts/computer-system-structure-1/","section":"posts","summary":"第一章：导论 概念部分 第一台通用电子计算机诞生于1946年 计算机技术的飞速发展得益于：计算机制造技术的发展、计算机系统结构的创新 纷纷放弃高性能转向多核，标志着系统","tags":["系统结构"],"title":"计算机系统结构","url":"https://blog.engine.wang/posts/computer-system-structure-1/","wordcount":7980},{"categories":"posts","content":"\u003cp\u003e（仅针对同济大学学生服务站小程序，本文只提供思路，需要具体代码的话可以私信。如果你一直呆在学校，可以考虑使用该方法自动签到，但是一旦离开上海，请务必向辅导员申报！）\u003c/p\u003e\n\u003cp\u003e之前寒假期间的打卡用的是问卷星，直接通过Selenium自动化来模拟操作前端填写问卷和提交打卡，都是流于表面的一些js操作，实现起来很简便。但是开学之后我们更换为了小程序打卡，微信小程序虽然是类前端，但它不同于常规网页，无法直接在浏览器中打开，只能借助微信来启动，可以理解为微信给它套了一个壳，提供了一些内置组件UI、请求统一处理、微信api调用、单独的IDE等等。小程序只能借助微信才能打开，只能通过腾讯发布的Wechat DevTool才能调试。\u003c/p\u003e\n\u003cp\u003e那么问题来了，我们应该在小程序中怎么去模拟打卡的操作呢，我先试了试反编译，看看小程序的具体逻辑。\u003c/p\u003e\n\u003ch2 id=\"反编译\"\u003e反编译\u003c/h2\u003e\n\u003cp\u003e这里需要一台root过的安卓手机（推荐留个root过的安卓备用机，做很多事会比较方便，注意最好用备用机不要用主力机），没有的话也可以使用安卓模拟器先root再操作。\u003c/p\u003e\n\u003cp\u003e安装微信和支持root超级权限的文件管理器，在模拟器里用微信登陆自己的账号，打开小程序，等小程序加载完成后，通过root文件管理器前往\u003ccode\u003edata/data/com.tencent.mm/MicroMsg/\u0026lt;很长的一串数字字母字符串\u0026gt;/appbrand/pkg/\u003c/code\u003e文件夹下，在里面通过时间信息找到对应的wxpkg文件（不root的话是无法操作这些文件的），可以就地压缩然后通过微信或者其他软件发送到电脑上。\u003c/p\u003e\n\u003cp\u003e最早的小程序反编译脚本是这个项目：https://github.com/qwerty472123/wxappUnpacker\u003c/p\u003e\n\u003cp\u003e作者弃坑之后可以利用另一位大佬改进的项目：\n\u003ca href=\"https://github.com/xuedingmiaojun/wxappUnpacker\"\u003ehttps://github.com/xuedingmiaojun/wxappUnpacker\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e按照README的说明来操作，就不具体解释\u003c/p\u003e\n\u003cp\u003e中途如果遇到报错可以利用搜索引擎解决一下\u003c/p\u003e\n\u003cp\u003e最后成功的输出\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-js\" data-lang=\"js\"\u003e\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eGenerate\u003c/span\u003e \u003cspan class=\"nx\"\u003ewxss\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003esecond\u003c/span\u003e \u003cspan class=\"nx\"\u003eturn\u003c/span\u003e\u003cspan class=\"p\"\u003e)...\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eGenerate\u003c/span\u003e \u003cspan class=\"nx\"\u003ewxss\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003esecond\u003c/span\u003e \u003cspan class=\"nx\"\u003eturn\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nx\"\u003edone\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eSave\u003c/span\u003e \u003cspan class=\"nx\"\u003ewxss\u003c/span\u003e\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003cspan class=\"nx\"\u003esaveDir\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"nx\"\u003eC\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\u003cspan class=\"err\"\u003e\\\u003c/span\u003e\u003cspan class=\"nx\"\u003eUsers\u003c/span\u003e\u003cspan class=\"err\"\u003e\\\u003c/span\u003e\u003cspan class=\"nx\"\u003ewyc\u003c/span\u003e\u003cspan class=\"err\"\u003e\\\u003c/span\u003e\u003cspan class=\"nx\"\u003eDesktop\u003c/span\u003e\u003cspan class=\"err\"\u003e\\\u003c/span\u003e\u003cspan class=\"nx\"\u003e_97557709_27\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eSplit\u003c/span\u003e \u003cspan class=\"nx\"\u003eand\u003c/span\u003e \u003cspan class=\"nx\"\u003emake\u003c/span\u003e \u003cspan class=\"nx\"\u003eup\u003c/span\u003e \u003cspan class=\"nx\"\u003edone\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eDelete\u003c/span\u003e \u003cspan class=\"nx\"\u003efiles\u003c/span\u003e\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eDeleted\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\n\n\u003cspan class=\"nx\"\u003eFile\u003c/span\u003e \u003cspan class=\"nx\"\u003edone\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\n\u003cspan class=\"nx\"\u003eTotal\u003c/span\u003e \u003cspan class=\"nx\"\u003euse\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"mf\"\u003e3.545\u003c/span\u003e\u003cspan class=\"nx\"\u003es\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e就会生成一个小程序源项目文件夹，可以直接用Wechat Dev Tool打开：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641816256/checkin-1.png\" alt=\"checkin-1\"\u003e\u003c/p\u003e\n\u003cp\u003e看了前端代码之后，可以看到所有的前端逻辑，签到的流程很简单，如下：\u003c/p\u003e\n\u003cp\u003e初次使用小程序：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e完成学籍认证\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e如果学籍信息正确且该学籍没有绑定微信，则绑定学生信息到该微信id\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e（注意，该小程序每个学籍只能绑定一个微信，也就是说你不可以通过其他人的微信来绑定你的学籍）\u003c/p\u003e\n\u003cp\u003e之后每次启动小程序：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e通过微信id，后端可以查到这名学生的签到信息\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e2-1. 如果已经签过到了，只提示“你已经签过到了”\u003c/p\u003e\n\u003cp\u003e2-2. 如果当天没有签到，显示签到表单让用户填写\u003c/p\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e提交表单到后端，更新用户签到记录\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003e值的一提的是，这里提交的位置信息并不是显示在前端的xx市xx区xx路，而是经纬度和xx市xx区，其他位置信息没用到，并且实际上校验的时候只要市正确即可，所以签到的话只要是标在上海市都没问题。\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e所以只需要向后端服务器发送一条包含位置信息的POST请求，不论使用的设备在哪里，只要在data里写明上海，那么就会在上海打卡。\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e然而只有前端并没有实质的收获，实际上也不需要前端代码，只是想通过反编译的方式了解一下逻辑。关键的是后端接口，可以抓包来获取，然后伪造打卡请求即可。\u003c/p\u003e\n\u003ch2 id=\"抓包\"\u003e抓包\u003c/h2\u003e\n\u003cp\u003e使用常见的抓包工具，抓包工具用顺手的就行，Fidder、Charles、Proxyman...我这次使用的是Proxyman，当然这几个都是完全同理的。\u003c/p\u003e\n\u003cp\u003e微信小程序的抓包有一些不同，配置好手机和电脑连上之后，直接抓会获取不到：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641816256/checkin-2.png\" alt=\"checkin-2\"\u003e\u003c/p\u003e\n\u003cp\u003e（当然这里我们知道了base url，结合之前的前端源码，可以知道所有的api的url，但是不知道header、token等信息，发送post请求会比较麻烦。）\u003c/p\u003e\n\u003cp\u003e为什么抓不到呢？这是因为微信7.0对https的证书做了限制，只有系统信任的证书才可以被允许，而我们安装的是软件的第三方证书\u003c/p\u003e\n\u003cp\u003e你需要通过下面两种方式中的一种，才可以捕获成功：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e安装微信7.0之前的版本（简单）\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e安卓root之后，把证书移动到系统证书目录下（会比较麻烦）\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e我两种方法都用过，第一种非常无脑，去豌豆荚下一个老版的微信即可，当然第二种方法会更好一些，毕竟老版本之后可能会有问题。\u003c/p\u003e\n\u003cp\u003e按照软件的教程给电脑安装证书，手机配置网络代理，然后打开打卡小程序开始抓包，这个小程序抓包很轻松，api直接明文暴露了出来\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641816256/checkin-3.png\" alt=\"checkin-3\"\u003e\u003c/p\u003e\n\u003cp\u003e弄清楚这几个接口的含义、Header的信息、Auth的方式、POST数据的格式以及返回的信息含义，如果后端没有做一些处理的话，理论上就能直接伪装一个POST请求来进行签到。\u003c/p\u003e\n\u003cp\u003e这些api的含义很明显，其他的就不细说了，主要说一下要用到的两个：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e用户是否签到\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003emethod: GET\u003c/p\u003e\n\u003cp\u003eurl: \u0026quot;https://tjxsfw.chisai.tech/api/school_tjxsfw_student/yqfkLogDailyreport/hasDoneToday?studentPid=\u0026quot; + studentPid\u003c/p\u003e\n\u003cp\u003eheader: 需要jwt验证\u003c/p\u003e\n\u003cp\u003eHeader中需要加入\u0026quot;Bearer: \u0026lt;jwt_token\u0026gt;\u0026quot;来验证\u003c/p\u003e\n\u003cp\u003e返回一个json，如果code==200并且data=true，则表示已经签过到了，data=false表示今天还没签到\u003c/p\u003e\n\u003cp\u003e这个api用于检测你是否需要签到，以及签到是否成功\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e签到\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003emethod: POST\u003c/p\u003e\n\u003cp\u003eurl: \u0026quot;https://tjxsfw.chisai.tech/api/school_tjxsfw_student/yqfkLogDailyreport/v2\u0026quot;\u003c/p\u003e\n\u003cp\u003edata: 签到的json，包含用户信息、签到地点、打卡时间等\u003c/p\u003e\n\u003cp\u003eheader: 需要jwt验证\u003c/p\u003e\n\u003cp\u003e第二天用postman试了一下，直接从proxyman里复制请求信息，然后修改时间，发了个POST过去，打开小程序，提示已经打过卡了，说明该方法有效\u003c/p\u003e\n\u003ch2 id=\"构造请求反馈方式与定时任务\"\u003e构造请求、反馈方式与定时任务\u003c/h2\u003e\n\u003ch3 id=\"构建请求\"\u003e构建请求\u003c/h3\u003e\n\u003cp\u003e既然我们知道了具体的api，那么构造请求就非常简单了，C++、Java、C#、Python、JavaScript、Golang...基本上正常的编程语言都可以，选择自己顺手的即可。照着抓包到的请求抄一下header和token什么的，然后记得把请求的data里的日期改成现在的时间点。\u003c/p\u003e\n\u003cp\u003e如果硬是要给明天后天也签个到，我没试过，理论上后端肯定会判断时间的，大概率会失败。主要是没这个必要，只要每天定时打卡即可\u003c/p\u003e\n\u003cp\u003e（注意，同济大学学生服务站小程序会在每天的00：00-00：30分进行维护，需要绕开这个时间打卡）\u003c/p\u003e\n\u003ch3 id=\"反馈方式\"\u003e反馈方式\u003c/h3\u003e\n\u003cp\u003e我们设置了自动打卡，那么打完卡之后，小程序是不会通知你的，这时候就需要一个被通知的方式，来告诉你自动打卡成功或者失败的消息。\u003c/p\u003e\n\u003cp\u003e途径有很多，我说说几个能想到的：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eQQ Bot\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e优点：部署完之后会很方便，还可以做其他事，有很全面的交互\n缺点：构建比较复杂，尤其是tx几个月前封杀了一些第三方机器人，酷q倒了之后，目前我了解到的仅mirai可用。这件事主要表明了tx想要封杀第三方机器人的态度，导致QQ Bot的未来很迷茫。\n适合人群：已经有自己的正常运行的QQ Bot，再写一个插件即可\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eTelegram Bot/ Discord Bot\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e优点：和QQ Bot优点一样，不过很稳定，软件官方支持的Bot\n缺点：需要全程科学上网\n适合人群：能全程科学上网的telegram/discord重度用户\u003c/p\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003eIFTTT\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e优点：很容易，不用写代码，不用自己买服务器或域名\n缺点：功能比较简陋（但是只是通知的话够用了）\u003c/p\u003e\n\u003cp\u003e另外还搜到了一些其他的第三方软件，用法和IFTTT类似，需要的可以自己去搜索\u003c/p\u003e\n\u003cp\u003e推荐采用IFTTT通知的方式，最容易实现。可以参考：https://zhuanlan.zhihu.com/p/103419701\u003c/p\u003e\n\u003ch3 id=\"定时任务\"\u003e定时任务\u003c/h3\u003e\n\u003cp\u003e需要设置一个定时任务来在每天的一个时间点打卡，所以不能关机。推荐使用云服务器或者是闲置的不关机电脑。\u003c/p\u003e\n\u003cp\u003e这里分windows、mac\u0026amp;linux三个平台来说\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eWindows\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e先构造一个bat脚本来启动程序，或者也可以打包程序为exe\u003c/p\u003e\n\u003cp\u003e通过计算机管理 - 创建基本任务 - 定位bat或者exe文件 - 设置每日执行一次和执行的时间，然后就ok了\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eMacOS/Linux\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e因为mac也是类Unix系统，所以和Linux都可以使用crontab来设置定时任务，具体的教程网上很多\u003c/p\u003e\n\u003ch3 id=\"后续\"\u003e后续\u003c/h3\u003e\n\u003cp\u003e设定好定时任务后，就免去了每日打卡的操作，它会自动定时打卡，成功后通过手机发送通知。每天点三下屏幕都不想做，可能就是懒癌晚期吧。\u003c/p\u003e\n","date":1589107476,"description":"","fuzzywordcount":3200,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"e75917bccd238e7800d54591644ef76d","publishdate":1589107476,"relpermalink":"/posts/miniprogram-auto-checkin/","section":"posts","summary":"（仅针对同济大学学生服务站小程序，本文只提供思路，需要具体代码的话可以私信。如果你一直呆在学校，可以考虑使用该方法自动签到，但是一旦离开上海，请务必向辅导员申报","tags":["脚本"],"title":"同济学生服务站小程序如何每日自动打卡","url":"https://blog.engine.wang/posts/miniprogram-auto-checkin/","wordcount":3138},{"categories":"posts","content":"\u003ch2 id=\"背景\"\u003e背景\u003c/h2\u003e\n\u003cp\u003emongodb是一个基于分布式文件存储的数据库。由C++语言编写。旨在为WEB应用提供可扩展的高性能数据存储解决方案。它是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。\u003c/p\u003e\n\u003cp\u003e这里简单的讲一下使用方法，不涉及底层理论\u003c/p\u003e\n\u003ch2 id=\"起步\"\u003e起步\u003c/h2\u003e\n\u003ch3 id=\"mac下安装mongodb\"\u003eMac下安装MongoDB\u003c/h3\u003e\n\u003cp\u003e之前是\n\u003ccode\u003ebrew install mongodb\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e但是现在会报错：No available formula with the name “mongodb”。\u003c/p\u003e\n\u003cp\u003e先tap一个仓库 \u003ccode\u003ebrew tap mongodb/brew\u003c/code\u003e\n安装mongodb社区版 \u003ccode\u003ebrew install mongodb-community\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"运行mongod\"\u003e运行mongod\u003c/h3\u003e\n\u003cp\u003e新建一个\u003ccode\u003e/data/db\u003c/code\u003e文件夹\u003c/p\u003e\n\u003cp\u003e运行MongoDB服务\n\u003ccode\u003esudo mongod\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e（注：macOS 10.15 Catalina无法在根目录下进行修改，可以在其他目录新建，启动服务时通过\u003ccode\u003esudo mongod --dbpath=new_path/data/db\u003c/code\u003e指定）\u003c/p\u003e\n\u003cp\u003e定位和启动MongoDB命令行\n\u003ccode\u003ecd /usr/local/Cellar/mongodb/4.0.3_1/bin\u003c/code\u003e\n\u003ccode\u003e./mongo\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eMongoDB和关系型数据库（Oracle、MySQL等）的区别：\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eSQL\u003c/th\u003e\n\u003cth\u003eMongoDB\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003etable\u003c/td\u003e\n\u003ctd\u003ecollection(集合)\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003erow\u003c/td\u003e\n\u003ctd\u003edocument(文档)\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003ecolume\u003c/td\u003e\n\u003ctd\u003efield(数据字段)\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e每个文档是一组键值对（BSON）相同的字段不需要相同的数据类型\u003c/p\u003e\n\u003ch2 id=\"基本命令\"\u003e基本命令\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003eshow dbs\u003c/code\u003e 展示所有数据库\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003euse xx\u003c/code\u003e 使用某个数据库\u003c/p\u003e\n\u003cp\u003e使用了某个数据库后：\u003ccode\u003eshow collections\u003c/code\u003e查看所有的集合\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003edb.dropDatabase()\u003c/code\u003e 删除当前数据库\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003edb.\u0026lt;col\u0026gt;.drop()\u003c/code\u003e 删除某个集合\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003emongodump -o \u0026lt;output_path\u0026gt;\u003c/code\u003e 导出数据库\n（如果设置了密码，需要通过下面的命令导出）\n\u003ccode\u003esudo mongodump -o \u0026lt;output_path\u0026gt; --authenticationDatabase admin --username \u0026lt;db_username\u0026gt; --password \u0026lt;db_password\u0026gt;\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003emongorestore -d \u0026lt;dbname\u0026gt; \u0026lt;db_path\u0026gt;\u003c/code\u003e 导入数据库\u003c/p\u003e\n\u003ch3 id=\"验证\"\u003e验证\u003c/h3\u003e\n\u003cp\u003e本地的还好，如果部署到服务器上，默认是无法外网访问数据库的，倘若你想访问，就得开放端口然后在mongo的配置文件里设置0.0.0.0。然后mongo默认也没有密码\u003c/p\u003e\n\u003cp\u003e这就会产生一个很蛋疼的事，当其他人访问你服务器的ip的27017端口时，可以直接完全操作你的数据库，对于非个人弄着玩的项目，这显然是不可能接受的。\u003c/p\u003e\n\u003cp\u003e所以我们需要增加数据库验证，这里最常见的就是增加账号密码登录，方法如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"o\"\u003e//\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003e先使用\u003c/span\u003e\u003cspan class=\"k\"\u003eadmin\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003euse\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"k\"\u003eadmin\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"o\"\u003e//\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003e创建\u003c/span\u003e\u003cspan class=\"n\"\u003eroot密码\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003ecreateUser\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"err\"\u003e{\u003c/span\u003e\u003cspan class=\"k\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;root\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003epwd\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;password\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"n\"\u003eroles\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;root\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"err\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e其他的role：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eread\nreadWrite\ndbAdmin\nuserAdmin\nclusterAdmin\nreadAnyDatabase\nreadWriteAnyDatabase\nuserAdminAnyDatabase\ndbAdminAnyDatabase\n\u003c/code\u003e\u003c/pre\u003e\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan class=\"o\"\u003e//\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"err\"\u003e创建用户\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003edb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"k\"\u003ecreateUser\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"err\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"k\"\u003euser\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;username\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"n\"\u003epwd\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;password\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"n\"\u003eroles\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;userAdminAnyDatabase\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;dbAdminAnyDatabase\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;readWriteAnyDatabase\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"w\"\u003e\u003c/span\u003e\u003cspan class=\"err\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e在\u003ccode\u003e/etc/mongo.conf\u003c/code\u003e配置文件里，把auth=true前面的\u003ccode\u003e#\u003c/code\u003e去掉，让验证生效。\u003c/p\u003e\n\u003cp\u003e重启mongodb服务\u003ccode\u003esudo service mongodb restart\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e之后的连接方式：mongo命令行连接：\n\u003ccode\u003emongo admin -u username -p password\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e本地GUI（如navicat）连接，设置账号密码即可\u003c/p\u003e\n\u003ch3 id=\"字段操作\"\u003e字段操作\u003c/h3\u003e\n\u003cp\u003e字段重命名：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003edb.col.update({},{$rename:{\u0026quot;old_field\u0026quot;:\u0026quot;new_field\u0026quot;}},false,true)\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e比如：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003edb.questionnaire.update({},{$rename:{\u0026quot;questionList\u0026quot;:\u0026quot;question\u0026quot;}},false,true)\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e字段增加：\n还可以指定默认值xxx\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003edb.col.update({},{$set:{new_field:'xxx'}},{multi:true})\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e字段删除：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003edb.col.update({},{$unset:{'old_field':''}},false, true)\n\u003c/code\u003e\u003c/pre\u003e\u003cpre tabindex=\"0\"\u003e\u003ccode\u003edb.user_questionnaire.update({},{$unset:{'inputCostEstimation':''}},false, true)\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"查找\"\u003e查找\u003c/h3\u003e\n\u003cp\u003e列出集合信息：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003edb.\u0026lt;collection-name\u0026gt;.find()\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e列出第一条集合的信息（按Json排版一下）：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003edb.\u0026lt;collection-name\u0026gt;.findOne()\ndb.\u0026lt;col-name\u0026gt;.find({query}, {show})\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003equery是一个查询字段。比如{\u0026quot;name\u0026quot;:\u0026quot;yicheng\u0026quot;}这种形式\n后面的参数决定field是否显示，比find({\u0026quot;name\u0026quot;:\u0026quot;yicheng\u0026quot;}, {\u0026quot;_id\u0026quot;: 0, \u0026quot;age\u0026quot;: 1}) 表示_id不会显示，age会显示\u003c/p\u003e\n\u003cp\u003e条件比较：\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e操作\u003c/th\u003e\n\u003cth\u003e描述\u003c/th\u003e\n\u003cth\u003e用法\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e$gt\u003c/td\u003e\n\u003ctd\u003e\u0026gt;\u003c/td\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e$gte\u003c/td\u003e\n\u003ctd\u003e\u0026gt;=\u003c/td\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e$lt\u003c/td\u003e\n\u003ctd\u003e\u0026lt;\u003c/td\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e$lte\u003c/td\u003e\n\u003ctd\u003e\u0026lt;=\u003c/td\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e$eq\u003c/td\u003e\n\u003ctd\u003e=\u003c/td\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e$ne\u003c/td\u003e\n\u003ctd\u003e!=\u003c/td\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e$in\u003c/td\u003e\n\u003ctd\u003ein\u003c/td\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e$nin\u003c/td\u003e\n\u003ctd\u003enot in\u003c/td\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e\u003cstrong\u003e增删改\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e增加：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003edb.col.insert(json)\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003ee.g.\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003edb.col.insert({\u0026quot;name\u0026quot;:\u0026quot;engine\u0026quot;, \u0026quot;age\u0026quot;:18})\n\ndb.articles.insert({\u0026quot;title\u0026quot;:\u0026quot;Test\u0026quot;,\u0026quot;author\u0026quot;:\u0026quot;engine\u0026quot;,\u0026quot;time\u0026quot;:\u0026quot;2020.02.27\u0026quot;,\u0026quot;kind\u0026quot;:\u0026quot;tech\u0026quot;,\u0026quot;tags\u0026quot;:\u0026quot;golang,website\u0026quot;,\u0026quot;content\u0026quot;:\u0026quot;This is a blog for test\u0026quot;,\u0026quot;comment\u0026quot;:\u0026quot;comment1\u0026quot;,\u0026quot;view\u0026quot;:10,\u0026quot;like\u0026quot;:5})\n\ndb.user.insert({\u0026quot;name\u0026quot;:\u0026quot;user1\u0026quot;,avatar:\u0026quot;https://i.loli.net/2020/03/15/XsJjRomr1dy8u4D.png\u0026quot;,\u0026quot;type\u0026quot;:0,\u0026quot;score\u0026quot;:20,\u0026quot;password\u0026quot;:\u0026quot;123456\u0026quot;,\u0026quot;todo\u0026quot;:\u0026quot;\u0026quot;})\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e删除：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003edb.col.remove(query)\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e修改\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003edb.mycoll.update(query, object[, upsert_bool, multi_bool])\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e第一个参数是查询条件，第二个参数是修改信息，第三个是如果没找到是否相当于插入（默认为false），第四个参数是修改一个还是所有（默认为false）\u003c/p\u003e\n\u003cp\u003ee.g.\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003edb.col.update({\u0026quot;name\u0026quot;:\u0026quot;engine\u0026quot;}, {$set:{\u0026quot;age\u0026quot;:20}})\n\ndb.col.update({\u0026quot;age\u0026quot;: {$gt: 20}}, {$set:{\u0026quot;age\u0026quot;: 30}}, false, true)\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e更复杂的逻辑：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003edb.getCollection('participant').find().forEach(\n   function(item){\n       db.getCollection('participant').update({\u0026quot;_id\u0026quot;:item._id},{$set:{\u0026quot;modifyTimes\u0026quot;: 3}})\n   }\n)\n\u003c/code\u003e\u003c/pre\u003e\u003ctable class=\"reference\"\u003e\n\u003ctbody\u003e\u003ctr\u003e\n\u003cth\u003e数据类型\u003c/th\u003e\n\u003cth\u003e描述\u003c/th\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eString\u003c/td\u003e\u003ctd\u003e字符串。存储数据常用的数据类型。在 MongoDB 中，UTF-8 编码的字符串才是合法的。   \u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eInteger\u003c/td\u003e\u003ctd\u003e整型数值。用于存储数值。根据你所采用的服务器，可分为 32 位或 64 位。  \u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eBoolean\u003c/td\u003e\u003ctd\u003e布尔值。用于存储布尔值（真/假）。  \u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eDouble\u003c/td\u003e\u003ctd\u003e双精度浮点值。用于存储浮点值。  \u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eMin/Max keys\u003c/td\u003e\u003ctd\u003e将一个值与 BSON（二进制的 JSON）元素的最低值和最高值相对比。  \u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eArray\u003c/td\u003e\u003ctd\u003e用于将数组或列表或多个值存储为一个键。  \u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eTimestamp\u003c/td\u003e\u003ctd\u003e时间戳。记录文档修改或添加的具体时间。  \u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eObject\u003c/td\u003e\u003ctd\u003e用于内嵌文档。  \u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eNull\u003c/td\u003e\u003ctd\u003e用于创建空值。  \u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eSymbol\u003c/td\u003e\u003ctd\u003e符号。该数据类型基本上等同于字符串类型，但不同的是，它一般用于采用特殊符号类型的语言。\u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eDate\u003c/td\u003e\u003ctd\u003e日期时间。用 UNIX 时间格式来存储当前日期或时间。你可以指定自己的日期时间：创建 Date 对象，传入年月日信息。  \u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eObject ID\u003c/td\u003e\u003ctd\u003e对象 ID。用于创建文档的 ID。  \u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eBinary Data\u003c/td\u003e\u003ctd\u003e二进制数据。用于存储二进制数据。\u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eCode\u003c/td\u003e\u003ctd\u003e代码类型。用于在文档中存储 JavaScript 代码。\u003c/td\u003e\u003c/tr\u003e\n\u003ctr\u003e\u003ctd\u003eRegular expression\u003c/td\u003e\u003ctd\u003e正则表达式类型。用于存储正则表达式。\u003c/td\u003e\u003c/tr\u003e\n\u003c/tbody\u003e\u003c/table\u003e\n\u003cp\u003e更新某个字段的值\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003edb.getCollection\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;participant\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e.find\u003cspan class=\"o\"\u003e()\u003c/span\u003e.forEach\u003cspan class=\"o\"\u003e(\u003c/span\u003e\n   \u003cspan class=\"k\"\u003efunction\u003c/span\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003eitem\u003cspan class=\"o\"\u003e){\u003c/span\u003e\n       db.getCollection\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;participant\u0026#39;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e.update\u003cspan class=\"o\"\u003e({\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;_id\u0026#34;\u003c/span\u003e:item._id\u003cspan class=\"o\"\u003e}\u003c/span\u003e,\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"nv\"\u003e$set\u003c/span\u003e:\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;modifiTimes\u0026#34;\u003c/span\u003e: 2\u003cspan class=\"o\"\u003e}})\u003c/span\u003e\n   \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"golang的mongodb接口mgo\"\u003eGolang的MongoDB接口：mgo\u003c/h2\u003e\n\u003cp\u003e简单的使用\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan class=\"kd\"\u003etype\u003c/span\u003e \u003cspan class=\"nx\"\u003ePerson\u003c/span\u003e \u003cspan class=\"kd\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003eName\u003c/span\u003e  \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003ePhone\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"kd\"\u003efunc\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// mgo.Dial核心函数，由url新建一个session\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"nx\"\u003esession\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003emgo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDial\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;mongodb://127.0.0.1:27017/\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nb\"\u003epanic\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003edefer\u003c/span\u003e \u003cspan class=\"nx\"\u003esession\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\t\u003cspan class=\"c1\"\u003e// Optional. Switch the session to a monotonic behavior.\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"nx\"\u003esession\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetMode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003emgo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eMonotonic\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kc\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// c就连到了对应的collection\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"nx\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003esession\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDB\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;test\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;people\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 插入数据\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eInsert\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003ePerson\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Ale\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;+55 53 8116 9639\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\n\t\t\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003ePerson\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Cla\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;+55 53 8402 8510\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e})\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003eresult\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nx\"\u003ePerson\u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// result是一个查询结果\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\t\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nx\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFind\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003ebson\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003eM\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;name\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;Ale\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e}).\u003c/span\u003e\u003cspan class=\"nf\"\u003eOne\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nx\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nx\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"kc\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"nx\"\u003elog\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFatal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nx\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"nx\"\u003efmt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Phone:\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nx\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nx\"\u003ePhone\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e","date":1587364154,"description":"","fuzzywordcount":2200,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"267df8ec8a2756f3cc5188929c44ba57","publishdate":1587364154,"relpermalink":"/posts/mongodb-basics/","section":"posts","summary":"背景 mongodb是一个基于分布式文件存储的数据库。由C++语言编写。旨在为WEB应用提供可扩展的高性能数据存储解决方案。它是一个介于关系数据库和非关系数据库之","tags":["MongoDB","Database"],"title":"Mongodb初级教程","url":"https://blog.engine.wang/posts/mongodb-basics/","wordcount":2188},{"categories":"posts","content":"\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645945891/os-io-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"文件基本概念\"\u003e文件基本概念\u003c/h2\u003e\n\u003cp\u003e文件是记录在外存上相关信息的具名集合，对于用户而言文件是逻辑外存最小的分配单位，文件是一组有意义信息的集合\u003c/p\u003e\n\u003cp\u003e在系统运行时，计算机以进程为基本单位进行资源的调度和分配，而在用户进行输入输出时，则以文件为基本单位。\u003c/p\u003e\n\u003cp\u003e需要系统提供一个文件管理系统来让用户管理文件，文件系统由一组文件和目录结构组成\u003c/p\u003e\n\u003ch3 id=\"文件属性\"\u003e文件属性\u003c/h3\u003e\n\u003cp\u003e文件名、标志符（唯一标签，用户不可读）、类型、位置、大小、保护信息、时间、日期和用户标识\u003c/p\u003e\n\u003cp\u003e文件属于抽象数据类型\u003c/p\u003e\n\u003ch3 id=\"文件基本操作\"\u003e文件基本操作\u003c/h3\u003e\n\u003cp\u003e（操作系统应该向上提供的文件操作功能）\n创建文件、写文件、读文件、在文件内重定位、删除文件（完全删除）、截短文件（删除内容不删属性）\u003c/p\u003e\n\u003ch3 id=\"文件的打开与关闭\"\u003e文件的打开与关闭\u003c/h3\u003e\n\u003cp\u003e要读一个文件首先要用open系统调用打开该文件，open中的参数包括文件路径名和文件名，\u003c/p\u003e\n\u003cp\u003eread只需要使用open返回的文件描述符，不使用文件名作为参数\u003c/p\u003e\n\u003cp\u003e每个打开文件有以下信息：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e文件指针\u003c/li\u003e\n\u003cli\u003e文件打开计数器\u003c/li\u003e\n\u003cli\u003e文件磁盘位置\u003c/li\u003e\n\u003cli\u003e访问权限\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"文件的逻辑结构\"\u003e文件的逻辑结构\u003c/h3\u003e\n\u003cp\u003e文件的逻辑结构是\u003cstrong\u003e从用户观点出发看到的文件内部的组织形式\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e文件按照逻辑结构分为无结构文件（流式文件）和有结构文件（记录式文件）\u003c/p\u003e\n\u003cp\u003e无结构文件（流式文件）：以字节为单位\u003c/p\u003e\n\u003cp\u003e有结构文件（记录式文件）：分为顺序文件、索引文件、顺序索引文件、散列文件\u003c/p\u003e\n\u003cp\u003e文件的目录结构（文件之间的组织形式）\n文件存放在外存中（文件的物理结构）\u003c/p\u003e\n\u003ch3 id=\"访问方法\"\u003e访问方法\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e顺序访问\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e直接访问\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"目录结构\"\u003e目录结构\u003c/h3\u003e\n\u003cp\u003e引入\u003cstrong\u003e文件控制块(FCB)\u003c/strong\u003e 这个数据结构\u003c/p\u003e\n\u003cp\u003eFCB包括基本信息、存取控制信息和使用信息\u003c/p\u003e\n\u003cp\u003e目录相关操作有：搜索文件、创建文件、删除文件、遍历目录、重命名文件、跟踪文件系统\u003c/p\u003e\n\u003ch3 id=\"保护\"\u003e保护\u003c/h3\u003e\n\u003cp\u003e信息需要被保护，不受物理损坏（可靠性）和非法访问（保护）\u003c/p\u003e\n\u003cp\u003e口令、存取控制和用户权限表都是常见的文件保护方法\u003c/p\u003e\n\u003cp\u003e可靠性通常靠文件备份来提供\u003c/p\u003e\n\u003cp\u003e访问类型：读、写、执行、添加、删除、列表清单\u003c/p\u003e\n\u003cp\u003e为每个文件添加一个访问控制列表（ACL）\u003c/p\u003e\n\u003cp\u003e加密保护和访问控制：加密保护安全性更高，访问控制灵活性更好。访问控制需要由系统实现来保证安全性\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645945891/os-io-2.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"错题归纳\"\u003e错题归纳\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e从用户的角度看，引入文件系统的目的是实现对文件的按名存取；从系统角度看，文件系统则负责对文件储存空间进行组织分配、负责文件储存并对存入的文件进行保护和检索\u003c/li\u003e\n\u003cli\u003eFCB的有序集合称为文件目录，一个FCB就是一个文件目录项\u003c/li\u003e\n\u003cli\u003e逻辑结构的组织形式取决于用户，物理结构的组织形式取决于储存介质特性\u003c/li\u003e\n\u003cli\u003e文件目录项（FCB）不包括FCB的物理位置\u003c/li\u003e\n\u003cli\u003e对一个访问的限制，常由用户访问权限和文件属性共同限制，与优先级无关\u003c/li\u003e\n\u003cli\u003e一个文件被用户首次打开的过程中，操作系统需要将文件控制块读到内存中，不是文件内容\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"文件系统实现\"\u003e文件系统实现\u003c/h2\u003e\n\u003ch3 id=\"文件系统层次结构\"\u003e文件系统层次结构\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645945891/os-io-3.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e用户调用接口：给用户文件操控的接口\u003c/li\u003e\n\u003cli\u003e文件目录系统：管理文件目录\u003c/li\u003e\n\u003cli\u003e存取控制模块：实现文件保护\u003c/li\u003e\n\u003cli\u003e逻辑文件系统与文件信息缓冲区：根据逻辑结构将用户要读写的逻辑记录转换成文件逻辑结构内的相应块号\u003c/li\u003e\n\u003cli\u003e物理文件系统：把相应块号转成实际物理地址\u003c/li\u003e\n\u003cli\u003e辅助分配模块：管理辅存空间，辅存空间的分配和回收\u003c/li\u003e\n\u003cli\u003e设备管理模块：管理相关设备\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e单层结构目录、双层结构目录、树状结构目录、无环图目录（同一文件可以在不同目录中）、通用图目录\u003c/p\u003e\n\u003cp\u003e物理块是分配和传输的基本单位\u003c/p\u003e\n\u003ch3 id=\"目录实现\"\u003e目录实现\u003c/h3\u003e\n\u003cp\u003e线性链表、哈希表\u003c/p\u003e\n\u003ch3 id=\"外存分配方式\"\u003e外存分配方式\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e连续分配\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e每个文件在磁盘上占有一组连续的块\u003c/p\u003e\n\u003cp\u003e分配方式可以用第一块磁盘的地址和连续块数量来确定\u003c/p\u003e\n\u003cp\u003e优点：实现简单、存取速度快\n缺点：不方便动态增加，容易产生外部碎片\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e链接分配（隐式、显式）\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e以离散分配的方式，消除外部碎片\u003c/p\u003e\n\u003cp\u003e隐式：除最后一个块外，每个块都有一个指向下一个盘块的指针，目录包括第一个指针和最后一个指针\u003c/p\u003e\n\u003cp\u003e显式：显式地存放在内存的一张链接表中，文件分配表（File Allocation Table, FAT）\u003c/p\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e索引分配（一级、二级、多级）\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e每个文件设置一个索引块，是一个磁盘块地址的数组\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645945891/os-io-4.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645945891/os-io-5.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"错题归纳-1\"\u003e错题归纳\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e文件储存空间的管理实质上是对外存空闲区的管理和组织\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"磁盘结构\"\u003e磁盘结构\u003c/h2\u003e\n\u003cp\u003e概念：磁盘由表面涂有磁性物质的圆形盘片组成，每个盘片被划成一个个磁道，每个磁道被划成一个个扇区\u003c/p\u003e\n\u003cp\u003e如何读写：磁头移动到目标位置，盘片旋转，对应扇区划过磁道，完成读写\u003c/p\u003e\n\u003cp\u003e磁盘的物理地址依靠柱面号、盘面号、扇区号来确定\u003c/p\u003e\n\u003cp\u003e磁盘分类：\n活动头磁盘、固定头磁盘\n可换盘磁盘、固定盘磁盘\u003c/p\u003e\n\u003ch3 id=\"磁盘调度算法\"\u003e磁盘调度算法\u003c/h3\u003e\n\u003cp\u003e一次读/写操作需要的时间包括\n寻找时间：读写之前磁头移动到磁道花费的时间，$T_S = T_{启动磁头臂} + m_{跨越一个磁道耗时}*n_{需要跨越的磁道数}$\n延迟时间：通过旋转磁盘让磁头定位到目标扇区所需要的时间，平均延迟时间$T_R = \\frac{1}{2} * \\frac{1}{r}$ (r为转速)\n传输时间：从磁盘读出或向磁盘写入数据所经历的时间，转速为r，读写的字节数b，每个磁道字节数N，传输时间$T_t = \\frac{1}{r} * \\frac{b}{N}$\u003c/p\u003e\n\u003cp\u003e延迟时间和传输时间是硬件决定的，操作系统只能通过调度算法优化寻找时间\u003c/p\u003e\n\u003cp\u003e磁盘调度算法：\n先来先服务（FCFS）：按顺序处理\n最短寻找时间（SSTF）：先处理离目前磁头最近的请求，贪心算法（局部最优不一定是全局最优），可能导致饥饿\n扫描算法（SCAN）：只有移动到最内侧磁道才能往外侧移动，只有移动到最外侧磁道才能往内侧移动\nLOOK调度算法：扫描算法的升级，在移动方向上没有请求了就可以改变方向\n循环扫描算法（C-SCAN）：扫描算法的变形，每次扫描的移动方向一样，扫到底了直接快速移到开头，中间不管，这样解决了SCAN算法两侧与中间不均的问题\nC-LOOK：C-SCAN的升级，相比C-SCAN头尾不需要是磁盘的最前面和最后面，只要有请求的最前面和最后面\u003c/p\u003e\n\u003cp\u003e题目里的SCAN都默认是对应的LOOK算法\u003c/p\u003e\n\u003ch3 id=\"减少\"\u003e减少\u003c/h3\u003e\n\u003cp\u003e交替编号\n错位命名\u003c/p\u003e\n\u003ch2 id=\"io管理\"\u003eI/O管理\u003c/h2\u003e\n\u003ch3 id=\"io设备分类\"\u003eI/O设备分类\u003c/h3\u003e\n\u003cp\u003e按照使用特性：\n人机交互外部设备：比如鼠标键盘（数据传输最慢）\n储存设备：比如移动硬盘（数据传输最快）\n网络通信设备：比如路由器\u003c/p\u003e\n\u003cp\u003e按照传输速率：\n低速设备、中速设备、高速设备\u003c/p\u003e\n\u003cp\u003e按照信息交换的单位：\n块设备（传输快、可以寻址）、字符设备（不可寻址，通常用中断驱动控制）\u003c/p\u003e\n\u003ch3 id=\"io控制方式\"\u003eI/O控制方式\u003c/h3\u003e\n\u003cp\u003e程序直接控制方式：CPU不断轮询检查是否设备就绪，简单，CPU利用率低\u003c/p\u003e\n\u003cp\u003e中断驱动方式：CPU先让IO进程阻塞，之后IO设备向CPU发出中断让其执行，CPU利用率提高，但频繁中断浪费CPU时间\u003c/p\u003e\n\u003cp\u003eDMA（直接存储器存取）方式：在IO与内存之间开辟新的数据通路，仅在开始和结束时才需要CPU干预，数据传输不需要经过CPU，可以传数据块\u003c/p\u003e\n\u003cp\u003e通道控制方式：可以看成专门处理IO的阉割版CPU，完成后才向CPU发送中断\u003c/p\u003e\n\u003cp\u003e上面四个方式从上往下CPU干预程度越来越低，CPU利用率越来越高\u003c/p\u003e\n\u003ch3 id=\"io子系统的层次结构\"\u003eI/O子系统的层次结构\u003c/h3\u003e\n\u003cp\u003e用户层I/O软件：比如库函数printf\n设备独立性软件\n设备驱动程序\n中断处理程序\n硬件设备\u003c/p\u003e\n\u003cp\u003e中间三层属于I/O核心子系统\u003c/p\u003e\n","date":1582185668,"description":"","fuzzywordcount":2700,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"45a966ff277e634465226f99e1e219a4","publishdate":1582185668,"relpermalink":"/posts/os-basics-io/","section":"posts","summary":"文件基本概念 文件是记录在外存上相关信息的具名集合，对于用户而言文件是逻辑外存最小的分配单位，文件是一组有意义信息的集合 在系统运行时，计算机以进程为基本单位进行资","tags":["OS"],"title":"操作系统基础（四）文件IO","url":"https://blog.engine.wang/posts/os-basics-io/","wordcount":2646},{"categories":"posts","content":"\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944931/os-memory-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"基础\"\u003e基础\u003c/h2\u003e\n\u003ch3 id=\"程序装入和链接\"\u003e程序装入和链接\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e编译：编译程序将源代码编译成若干目标模块\u003c/li\u003e\n\u003cli\u003e链接：链接程序把各个目标模块，包括外部库函数链接在一起\u003c/li\u003e\n\u003cli\u003e装入：由装入程序将装入模块装入内存中运行\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e其中链接分为三种：\n静态链接\n装入时动态链接：装入时边装入边链接\n运行时动态链接：执行时才链接\u003c/p\u003e\n\u003cp\u003e装入也分为三种：\n绝对（静态）装入：在编程阶段就把物理地址计算好\n可重定位装入：有一个逻辑地址到物理地址的映射，之后不能变\n动态重定位装入：运行时才转换，之后可以变\u003c/p\u003e\n\u003ch3 id=\"地址绑定\"\u003e地址绑定\u003c/h3\u003e\n\u003cp\u003e将指令和数据绑定到内存地址有三种情况：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e编译时：生成绝对代码，编译时就知道了进程在内存中的驻留地址，所生成的编译代码就可以从该位置往后扩展（开始位置发生变化就要重新编译）\u003c/li\u003e\n\u003cli\u003e加载时：生成可重定位代码\u003c/li\u003e\n\u003cli\u003e执行时：绑定延迟到执行时才进行\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e物理地址: 内存地址寄存器中的地址，又叫绝对地址、实地址\u003c/p\u003e\n\u003cp\u003e逻辑地址: CPU生成的地址，又叫相对地址、虚地址（用户程序在经过汇编后目标代码常用，把首地址设为0，后面是相对地址）\u003c/p\u003e\n\u003cp\u003e编译和加载时的地址绑定方法生成相同逻辑地址和物理地址，而执行时的地址绑定方案生成不同的逻辑和物理地址，这种情况通常称逻辑地址为虚拟地址\u003c/p\u003e\n\u003cp\u003e运行时从虚拟地址到物理地址的映射由\u003cstrong\u003e内存管理单元\u003c/strong\u003e来完成\u003c/p\u003e\n\u003ch3 id=\"内存映射与保护\"\u003e内存映射与保护\u003c/h3\u003e\n\u003cp\u003e内存通常分为两个区域：用于驻留操作系统和用于用户进程\u003c/p\u003e\n\u003cp\u003e为输入队列中需要调入内存的进程分配内存空间，采用连续内存分配，每个进程位于一个连续的区域\u003c/p\u003e\n\u003cp\u003e逻辑地址通过界限地址寄存器（判断是否合理）、重定位寄存器（加一个基地址）映射到物理地址，定位到内存\u003c/p\u003e\n\u003cp\u003e内存保护：\u003c/p\u003e\n\u003cp\u003e（1）界地址保护\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e设置地址上界寄存器、下界寄存器的地址检查机制\u003c/li\u003e\n\u003cli\u003e基址、限长寄存器和动态地址转换机构\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944931/os-memory-2.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eCPU所能访问的存储器只有内存和CPU内的寄存器，因此执行指令以及指令使用的数据必须在这些可访问的存储设备中，否则就要在CPU使用前把数据移到内存中\u003c/p\u003e\n\u003cp\u003e确定进程只能访问其合法范围，通过基地址寄存器和界限地址寄存器可以做到：\u003c/p\u003e\n\u003cp\u003e基地址寄存器：a\n界限地址寄存器：b\n那么程序可以访问a~a+b的所有地址\u003c/p\u003e\n\u003cp\u003e寄存器 $\\to$ cache $\\to$ 内存 $\\to$ 外存\u003c/p\u003e\n\u003ch3 id=\"交换\"\u003e交换\u003c/h3\u003e\n\u003cp\u003e进程可以暂时从内存中交换到辅存上（换出），需要再次执行时再调回内存中（换入）\u003c/p\u003e\n\u003cp\u003e处于阻塞或者优先级低，会被换出，优先级更改会被换入\u003c/p\u003e\n\u003ch2 id=\"连续内存分配\"\u003e连续内存分配\u003c/h2\u003e\n\u003ch3 id=\"内存分配\"\u003e内存分配\u003c/h3\u003e\n\u003cp\u003e单一连续分配：分为系统区用户区，简单但是只适用于单用户\n固定分区分配：用户空间划分好多个分区（分为大小均相同分区和大小不相同分区两种）\n动态分区分配：用户空间一开始不划分，而是在装入内存时根据进程大小动态建立分区\u003c/p\u003e\n\u003cp\u003e以下都是讨论动态分区（可变分区）：\u003c/p\u003e\n\u003cp\u003e从一组可用孔中选择一个合适的空闲孔的方法：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e首次适应：分配第一个足够大的孔（空闲分区链以地址递增顺序链接）\u003c/li\u003e\n\u003cli\u003e最佳适应：分配最小的足够大的孔（空闲分区链按长度递增顺序链接）\u003c/li\u003e\n\u003cli\u003e最差适应：分配最大的孔\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e首次适应被认为既是最简单的，也是最好最快，最佳和最差容易生成小碎片（不要被最佳的名字忽悠，这家伙性能很差，会产生最多的外部碎片）\u003c/p\u003e\n\u003cp\u003e分区式存储管理优缺点：\n优点：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e便于动态申请内存\u003c/li\u003e\n\u003cli\u003e便于共享内存\u003c/li\u003e\n\u003cli\u003e便于动态链接\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e缺点：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e碎片问题，内存利用率不高\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"碎片\"\u003e碎片\u003c/h3\u003e\n\u003cp\u003e内部碎片：固定分区方法会有内部碎片，程序所占空间小于分给它的空间，内部空间的间隙为内部碎片\u003c/p\u003e\n\u003cp\u003e外部碎片：动态分区随着进程装入和移出内存，空闲内存被分为小片段，中间产生的空隙为外部碎片，首次适应和最佳适应都会有这种外部碎片问题\u003c/p\u003e\n\u003cp\u003e解决外部碎片的方法：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e紧缩，仅在重定位是动态并在运行时可用，把所有的孔移到一段，开销较大（可重定位分区）\u003c/li\u003e\n\u003cli\u003e允许物理地址非连续，只要有物理内存就能为进程分配，有两种互补的实现技术：分页、分段、段页\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"分页\"\u003e分页\u003c/h2\u003e\n\u003cp\u003e以上是连续内存分配管理方式，接下来的分页和分段是非连续内存分配管理方式\n连续分配方式，比如说一个需要1GB的程序，就必须要去内存找一块连续的1G空闲区间分配给它，而非连续分配方式可以分散地给这段程序分配内存空间\u003c/p\u003e\n\u003cp\u003e分页不会产生外部碎片，每个进程平均产生半个块大小的内部碎片（很小的）\u003c/p\u003e\n\u003cp\u003e把物理内存分为固定大小的块，称为帧，也叫物理块\n把逻辑内存分为同样大小的块，称为页\u003c/p\u003e\n\u003cp\u003e每个地址分为页号p和偏移d，前面的页号经过页表变成内存块号，后面的页内偏移直接对过去\u003c/p\u003e\n\u003cp\u003e页表：为每个进程建立一张页表，将进程的每一页离散地储存在内存的物理块中（页号→块号）\u003c/p\u003e\n\u003cp\u003e举个例子：\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e32 - 12\u003c/th\u003e\n\u003cth\u003e11 - 0\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e页号P\u003c/td\u003e\n\u003ctd\u003e偏移量W\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e说明总共有2\u003csup\u003e20\u003c/sup\u003e页（也就是1M页），每页2\u003csup\u003e12\u003c/sup\u003e大小（也就是4KB）\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944931/os-memory-3.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944931/os-memory-4.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e采用分页技术不会产生外部碎片，但是会有内部碎片，产生的原因是进程所需内存不是页的整数倍，最后一页可能装不满最后一个帧（物理块），导致产生页内碎片\u003c/p\u003e\n\u003cp\u003e分页的一个重要特点是用户视角的内存和实际物理内存的分离，用户看到的是一整块内存用于一个进程，但实际的物理内存则是分散的，逻辑地址到物理地址的映射用户不知道。\u003c/p\u003e\n\u003cp\u003e用户进程不能访问该进程非占用的内存，即无法访问页表规定之外的内存\u003c/p\u003e\n\u003cp\u003e页表的初始地址放在寄存器中\u003c/p\u003e\n\u003ch3 id=\"快表\"\u003e快表\u003c/h3\u003e\n\u003cp\u003e快表（TLB）是一种高速缓冲寄存器，加速地址变换过程，通常采用TLB + 页表的形式\u003c/p\u003e\n\u003cp\u003e每次要访存两次，为了提高速度，加入TLB（快表），本质是一个cache，可以看成是页表的子集，里面不是连续存储\u003c/p\u003e\n\u003cp\u003eTLB由键和值组成，包括页表中的一小部分条目，逻辑地址的页号提交给TLB，如果命中那么直接得到帧号，否则就访问页表（TLB失效），同时把页号和帧号加入到TLB中\u003c/p\u003e\n\u003cp\u003e快表的有效性基于局部性原理\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944931/os-memory-5.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e页号在TLB中被查找到的几率称为命中率，有效内存访问时间要按加权计算\u003c/p\u003e\n\u003cp\u003e保护：每个帧有相关联的保护位\u003c/p\u003e\n\u003cp\u003e共享页：可以共享公共代码\u003c/p\u003e\n\u003cp\u003e二级页表和多级页表：把页表再一步离散化，用页表再映射页表\u003c/p\u003e\n\u003ch2 id=\"分段\"\u003e分段\u003c/h2\u003e\n\u003cp\u003e支持用户视角的内存管理方案，逻辑地址空间由一组段组成，分段地址中的地址包括段号和段内偏移，用户通过段号和段内偏移来指定地址 \u0026lt;segment-number, offset\u0026gt;\u003c/p\u003e\n\u003cp\u003e为每个段分配一个连续的分区\u003c/p\u003e\n\u003cp\u003e段表可以把二维数组定位到一维物理地址，每个段在段表中占一个表项，记录了该段在内存中的起始地址和段的长度（防止越界），段内地址不能大于段长\u003c/p\u003e\n\u003cp\u003e段表示例：\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e段号\u003c/th\u003e\n\u003cth\u003e段首地址\u003c/th\u003e\n\u003cth\u003e段长\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e0\u003c/td\u003e\n\u003ctd\u003e50k\u003c/td\u003e\n\u003ctd\u003e20k\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e0\u003c/td\u003e\n\u003ctd\u003e100k\u003c/td\u003e\n\u003ctd\u003e60k\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e...\u003c/td\u003e\n\u003ctd\u003e...\u003c/td\u003e\n\u003ctd\u003e...\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944931/os-memory-6.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e硬件支持：一对寄存器（段表基址寄存器和段表长度寄存器）\u003c/p\u003e\n\u003cp\u003e也可以加快表，逻辑和页表类似\u003c/p\u003e\n\u003ch3 id=\"分页和分段的比较\"\u003e分页和分段的比较\u003c/h3\u003e\n\u003cp\u003e页是信息的物理单位，是出于系统管理的需要；\n页的大小固定且由系统确定，由硬件实现，系统中的页只能有一种大小；\n分页的作业地址空间是一维的\u003c/p\u003e\n\u003cp\u003e段是信息的逻辑单位，是出于用户的需要；\n段的长度不固定，取决于用户编写的程序的，通常由编译程序在对源程序进行编译时，根据信息的性质来划分；\n分段的作业地址空间是二维的，除了要给出段名还要给出段长\u003c/p\u003e\n\u003ch2 id=\"段页式\"\u003e段页式\u003c/h2\u003e\n\u003cp\u003e段号+段内页号+页内地址\u003c/p\u003e\n\u003cp\u003e首先被分为若干个逻辑段，每一段都有自己的段号，然后在里面分页\u003c/p\u003e\n\u003cp\u003e段页式中，一个进程对应一张段表，每个段对应一张页表\u003c/p\u003e\n\u003cp\u003e需要三次访问：第一次访问段表，第二次访问页表，第三次访问指令/数据的实际地址\u003c/p\u003e\n\u003cp\u003e段页式的地址空间是二维的\u003c/p\u003e\n\u003cp\u003e用分段方法来分配和管理用户地址空间，用分页方法来管理物理存储空间\u003c/p\u003e\n\u003ch2 id=\"tips\"\u003eTips：\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e链接完成重定位，形成逻辑地址，装载完成从逻辑地址到物理地址的变换\u003c/li\u003e\n\u003cli\u003e内存保护需要操作系统和硬件机构合作完成\u003c/li\u003e\n\u003cli\u003e固定分区、分页、段页都有内部碎片，不过分段没有内部碎片\u003c/li\u003e\n\u003cli\u003e页式管理划分的页面大小是相等的\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"虚拟内存\"\u003e虚拟内存\u003c/h3\u003e\n\u003cp\u003e引入原因：暂时不运行和运行完的程序仍然占用内存\u003c/p\u003e\n\u003cp\u003e虚拟内存技术允许执行进程不必完全在内存中，程序可以比物理内存大，将用户逻辑内存与物理内存分开\u003c/p\u003e\n\u003cp\u003e虚拟存储器：具有请求调入和置换的功能，能从逻辑上对内存容量加以扩充的一种储存系统，其运行速度接近内存，成本又接近外存\u003c/p\u003e\n\u003cp\u003e虚拟内存特征：多次性、对换性、虚拟性\u003c/p\u003e\n\u003ch3 id=\"局部性原理\"\u003e局部性原理\u003c/h3\u003e\n\u003cp\u003e时间局部性原理：\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e程序中的某一条指令一旦执行，不久以后该指令可能再次执行；某个数据被访问过，不久以后该数据可能再次被访问\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e空间局部性原理：\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e某个储存单元被访问，不久之后其附近的储存单元也将被访问，一段时间内访问的地址可能集中在一定的范围内\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"虚拟内存的实现\"\u003e虚拟内存的实现\u003c/h3\u003e\n\u003cp\u003e请求分页储存管理\n请求分段储存管理\n请求段页式储存管理\u003c/p\u003e\n\u003ch3 id=\"请求分页管理方式\"\u003e请求分页管理方式\u003c/h3\u003e\n\u003cp\u003e页表机制扩充：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e状态位P\u003c/li\u003e\n\u003cli\u003e访问位A\u003c/li\u003e\n\u003cli\u003e修改位M\u003c/li\u003e\n\u003cli\u003e外存地址\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944931/os-memory-7.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"缺页中断\"\u003e缺页中断\u003c/h2\u003e\n\u003cp\u003e在请求分页系统中，每当所要访问的页面不在内存时，就会产生缺页中断\u003c/p\u003e\n\u003ch2 id=\"页面置换算法\"\u003e页面置换算法\u003c/h2\u003e\n\u003ch3 id=\"1-最佳置换算法opt\"\u003e1. 最佳置换算法（OPT）\u003c/h3\u003e\n\u003cp\u003e选择的被淘汰的页面是之后最长时间内不再访问的，可以保证最低的缺页率，但是无法预知未来所以无法实现，可以拿来测量其他算法\u003c/p\u003e\n\u003cp\u003e谁最后访问，先换掉谁\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944931/os-memory-8.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"2-先进先出算法fifo\"\u003e2. 先进先出算法（FIFO）\u003c/h3\u003e\n\u003cp\u003e优先淘汰最早进入内存的页面，因为不符合实际规律，用的比较少\u003c/p\u003e\n\u003cp\u003e谁呆的时间最长，先换掉谁\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944931/os-memory-9.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"-3-最近最久未使用算法lru\"\u003e★ 3. 最近最久未使用算法（LRU）\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944931/os-memory-10.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e选择过程：\n第一行从后往前数n个（n是物理块数），跳过重复的，那个就是要被替换的\u003c/p\u003e\n\u003cp\u003e比如上面例子第八列的4，往前数3个 0→3→2（重复的0跳过了），那么就替换2\n第十列的3，往前数3个 2-\u0026gt;4-\u0026gt;0，就替换0\u003c/p\u003e\n\u003ch3 id=\"4-clock算法\"\u003e4. Clock算法\u003c/h3\u003e\n\u003ch2 id=\"页面分配策略\"\u003e页面分配策略\u003c/h2\u003e\n\u003ch3 id=\"驻留集大小\"\u003e驻留集大小\u003c/h3\u003e\n\u003cp\u003e驻留集大小确定方式：\n固定分配：给进程分配一定空间的物理块，后面不可变，即驻留集大小不变\n可变分配：给进程分配的物理块在运行期间可以改变\n局部置换：发生缺页时只能置换自己的物理块\n全局置换：可以置换自己的，也可以置换其他进程的\u003c/p\u003e\n\u003cp\u003e有三种组合方式：\n固定分区局部置换：初始分配固定数量，缺点是很难确定初始分多少\n可变分区全局置换：只要缺页就会获得新的物理块，确定是之后缺页率会增多\n可变分区局部置换：根据发生缺页的频率来动态改变进程的物理块\u003c/p\u003e\n\u003ch3 id=\"调入页面的时机\"\u003e调入页面的时机\u003c/h3\u003e\n\u003cp\u003e预调页策略：一次调入若干个相邻的页（根据局部性原理），不过成功率不高，一般是运行前采用\n请求调页策略：在缺页时调入，每次调一页，I/O开销大，一般是运行期间采用\u003c/p\u003e\n\u003ch3 id=\"从何处调入页面\"\u003e从何处调入页面\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e有足够的对换区空间：全部从对换区调入所需页面，进程运行之前把所有有关文件从文件区复制到对换区\u003c/li\u003e\n\u003cli\u003e没有足够的对换区空间：不会修改的文件直接从文件区调入，要修改的就得先去对换区\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"抖动\"\u003e抖动\u003c/h3\u003e\n\u003cp\u003e页面置换中最糟糕的情况：刚换出的页面马上又要换入主存，刚换入的页面马上又要换出，这种频繁的调度称为抖动或颠簸\u003c/p\u003e\n\u003ch2 id=\"tips-1\"\u003eTips\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e虚拟内存的实现只能建立在离散分配的内存管理的基础上\u003c/li\u003e\n\u003cli\u003e虚拟内存技术是补充内存逻辑空间的技术\u003c/li\u003e\n\u003cli\u003e虚拟储存器理论逻辑上的最大容量由地址长度决定，实际上可能的最大容量为理论最大容量和内存外存和之中较小的那一个\u003c/li\u003e\n\u003cli\u003e所有的调度策略都不可能完全避免抖动\u003c/li\u003e\n\u003c/ul\u003e\n","date":1581162304,"description":"","fuzzywordcount":4100,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"3d86498a5fae760ed5340b5549064ff3","publishdate":1581162304,"relpermalink":"/posts/os-basics-memory/","section":"posts","summary":"基础 程序装入和链接 编译：编译程序将源代码编译成若干目标模块 链接：链接程序把各个目标模块，包括外部库函数链接在一起 装入：由装入程序将装入模块装入内存中运行 其中链接","tags":["OS"],"title":"操作系统基础（三）内存","url":"https://blog.engine.wang/posts/os-basics-memory/","wordcount":4060},{"categories":"posts","content":"\u003cp\u003e本部分主要包括四个模块：进程与线程的概念、处理机调度算法、进程同步和死锁问题\u003c/p\u003e\n\u003ch2 id=\"一进程与线程\"\u003e一、进程与线程\u003c/h2\u003e\n\u003ch3 id=\"进程\"\u003e进程\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944201/os-thread-0.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e进程是进程实体的运行过程。是系统进行资源分配和调度的一个独立单位。\u003c/p\u003e\n\u003cp\u003e进程包含运行时的所有信息，不仅仅包含程序代码，还包括当前活动，通过程序计数器和处理器寄存器的内容来表示；另外还经常包括堆栈端和数据段，还有可能包括堆\u003c/p\u003e\n\u003cp\u003e正文段：包括全局变量、常量等\n数据栈段：局部变量、传递的实参等\n数据堆段：被分配的内存\nPCB：进程自身的一些信息\u003c/p\u003e\n\u003cp\u003e程序不是进程，程序是被动实体，进程是活动实体，当一个可执行文件被装入内存时，一个程序才可能成为进程。同一个程序也可以通过创建副本而成为多个独立的进程\u003c/p\u003e\n\u003cp\u003e进程控制块 (Process Control Block, PCB) 描述进程的基本信息和运行状态，所谓的创建进程和撤销进程，都是指对 PCB 的操作。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003ePCB是进程存在的唯一标志，动态性是进程最基本的特征。\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e（下图显示了 4 个程序创建了 4 个进程，这 4 个进程可以并发地执行。）\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944201/os-thread-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e进程是由多程序的并发执行而提出的，和程序是截然不同的概念，进程的特点如下：\n（了解即可）\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e动态性，有动态的地址空间，有生命周期（后面有图），动态产生、变化和消亡，最基本的特征\u003c/li\u003e\n\u003cli\u003e并发性，多个进程实体能在一段时间内同时运行，引入进程的目的就是为了并发\u003c/li\u003e\n\u003cli\u003e独立性，各进程地址空间相互独立\u003c/li\u003e\n\u003cli\u003e异步性，各进程按照各自独立、不可预知的速度向前推进\u003c/li\u003e\n\u003cli\u003e结构性，程序段、数据段、PCB\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch4 id=\"进程和程序的区别\"\u003e进程和程序的区别\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003e程序是静态的，进程是动态的（算一个根本区别）\u003c/li\u003e\n\u003cli\u003e程序是有序代码的集合，进程是程序的执行\u003c/li\u003e\n\u003cli\u003e程序是永久的，进程是暂时的\u003c/li\u003e\n\u003cli\u003e进程包括程序、数据和PCB\u003c/li\u003e\n\u003cli\u003e通过多次执行，一个程序可以对应多个进程；通过调用关系，一个进程可以包括多个程序\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"进程状态的切换-\"\u003e进程状态的切换 ★\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944201/os-thread-2.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e最重要的一条是从就绪到运行\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e就绪状态：等待被调度，进程已经获得了除了处理机之外的一切所需资源\u003c/li\u003e\n\u003cli\u003e运行状态：进程正在处理机上运行，对于单CPU而言，同一时间运行的进程只能有一个\u003c/li\u003e\n\u003cli\u003e等待状态：等待资源或等待I/O，即使处理机空闲也无法运行\u003c/li\u003e\n\u003cli\u003e新的状态：进程正在被创建，尚未转化到运行状态\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e应该注意以下内容：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e只有就绪态和运行态可以相互转换，其它的都是单向转换。就绪状态的进程通过调度算法从而获得 CPU 时间，转为运行状态；而运行状态的进程，在分配给它的 CPU 时间片用完之后就会转为就绪状态，等待下一次调度。\u003c/li\u003e\n\u003cli\u003e不能从等待直接到运行，因为在等I/O，给CPU也没有。不能从就绪到等待，因为就绪只缺CPU，别的都不缺，给了也没用。\u003c/li\u003e\n\u003cli\u003e等待状态是缺少需要的资源从而由运行状态转换而来，但是该资源不包括 CPU 时间，缺少 CPU 时间会从运行态转换为就绪态。\u003c/li\u003e\n\u003cli\u003e某个时间点上等待只能等一个资源\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"进程间通信\"\u003e进程间通信\u003c/h3\u003e\n\u003cp\u003e不和其他任何进程共享数据的进程是独立的，如果互相有意向那么该进程是协作的\u003c/p\u003e\n\u003cp\u003e有许多理由：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e信息共享\u003c/li\u003e\n\u003cli\u003e提高运算速度\u003c/li\u003e\n\u003cli\u003e模块化\u003c/li\u003e\n\u003cli\u003e方便\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e进程之间交换数据不能通过访问地址空间，因为进程各自的地址空间是私有的\u003c/p\u003e\n\u003cp\u003ePV操作是低级进程通信方式，高级进程通信方式包括：\u003cstrong\u003e共享内存、消息传递、管道通信、共享文件\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e共享内存比消息传递快，它可以达到内存的速度，要求通信进程共享一些变量，进程通过使用这些变量来共享信息、主要由程序员提供通信，操作系统只需要提供共享呢内存；\u003c/p\u003e\n\u003cp\u003e消息传递更易于实现，适合交换少量的数据，不需要避免冲突，允许进程交换信息。提供通信的主要职责在于操作系统本身\u003c/p\u003e\n\u003ch3 id=\"进程控制块pcb\"\u003e进程控制块(PCB)\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e进程状态：包括新的、就绪、运行、等待、停止\u003c/li\u003e\n\u003cli\u003e程序计数器：表示要执行的下一个指令的地址\u003c/li\u003e\n\u003cli\u003eCPU寄存器：包括很多东西，中断时要保存\u003c/li\u003e\n\u003cli\u003eCPU调度信息：包括进程优先级、调度队列指针和其他调度参数\u003c/li\u003e\n\u003cli\u003e内存管理信息：\u003c/li\u003e\n\u003cli\u003e记账信息：\u003c/li\u003e\n\u003cli\u003eI/O状态信息：\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ePCB块是进程的唯一标识，OS就是通过控制PCB来对并发执行的进程进行控制和管理的\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944201/os-thread-3.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"进程调度\"\u003e进程调度\u003c/h3\u003e\n\u003cp\u003e进程调度会选择一个可用的程序到CPU上执行\u003c/p\u003e\n\u003ch4 id=\"调度队列\"\u003e调度队列\u003c/h4\u003e\n\u003cp\u003e进程到系统后会进入作业队列，包括所有进程。等待运行的会进入到就绪队列。通常用链表表示\u003c/p\u003e\n\u003ch4 id=\"调度程序\"\u003e调度程序\u003c/h4\u003e\n\u003cp\u003e操作系统必须按某种方式从队列中选择进程，进程的选择是由相应的调度程序来执行的\u003c/p\u003e\n\u003cp\u003e短期调度程序\n长期调度程序\u003c/p\u003e\n\u003ch4 id=\"上下文切换\"\u003e上下文切换\u003c/h4\u003e\n\u003cp\u003e一个进程运行时，CPU中所有寄存器中的内容、进程的状态以及运行栈中的内容被称为进程的上下文（和PCB对应）\u003c/p\u003e\n\u003cp\u003e通过执行一个状态保存来\u003cstrong\u003e保存\u003c/strong\u003eCPU当前状态，之后执行一个状态\u003cstrong\u003e恢复\u003c/strong\u003e重新开始运行。将CPU切换到另一个进程需要保存当前状态并恢复另一个进程的状态，这一状态切换称为上下文切换。\u003c/p\u003e\n\u003ch3 id=\"进程控制\"\u003e进程控制\u003c/h3\u003e\n\u003ch4 id=\"进程的创建\"\u003e进程的创建\u003c/h4\u003e\n\u003cp\u003e允许一个进程创建另一个进程，创建者称为父进程，被创建的称为子进程，子进程可以获得父进程的所有资源，子进程结束会归还资源给父进程，父进程结束必须同时撤销子进程。\u003c/p\u003e\n\u003cp\u003e创建进程的过程：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e分配唯一的进程标志号(pid)\u003c/li\u003e\n\u003cli\u003e分配资源\u003c/li\u003e\n\u003cli\u003e初始化PCB\u003c/li\u003e\n\u003cli\u003e插入到就绪队列\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e通过fork()系统调用，可以创建新进程\u003c/p\u003e\n\u003ch4 id=\"进程的终止\"\u003e进程的终止\u003c/h4\u003e\n\u003cp\u003e包括正常结束和异常结束\u003c/p\u003e\n\u003cp\u003e终止进程的过程\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e根据pid搜索PCB，读出状态\u003c/li\u003e\n\u003cli\u003e立即终止\u003c/li\u003e\n\u003cli\u003e若还有子进程，一并终止\u003c/li\u003e\n\u003cli\u003e归还资源\u003c/li\u003e\n\u003cli\u003e把PCB从队列中删除\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e如果一个进程终止，那么它的所有子进程都终止。这种现象称为级联终止\u003c/p\u003e\n\u003ch4 id=\"进程的阻塞\"\u003e进程的阻塞\u003c/h4\u003e\n\u003cp\u003e自发的行为 block()\u003c/p\u003e\n\u003ch4 id=\"进程的唤醒\"\u003e进程的唤醒\u003c/h4\u003e\n\u003cp\u003ewakeup()\u003c/p\u003e\n\u003ch3 id=\"线程\"\u003e线程\u003c/h3\u003e\n\u003cp\u003e线程是CPU使用的基本单元，由线程ID、程序计数器、寄存器集合和栈组成，它与属于同一进程的其他线程共享代码段、数据段和其他操作系统资源\u003c/p\u003e\n\u003cp\u003e线程是独立调度的基本单位，引入线程的目的是为了简化进程间的通信，减小程序在并发执行时所付出的时间开销，提高操作系统的并发性\u003c/p\u003e\n\u003cp\u003e线程自己不拥有系统资源，只有一点点必要的运行资源，但是它可以和同一进程的其他线程一起共享进程拥有的全部资源\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944201/os-thread-4.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e举个栗子：QQ和浏览器是两个进程，浏览器进程里面有很多线程，例如 HTTP 请求线程、事件响应线程、渲染线程等等，线程的并发执行使得在浏览器中点击一个新链接从而发起 HTTP 请求时，浏览器还可以响应用户的其它事件。\u003c/p\u003e\n\u003cp\u003e多线程编程的优点:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e响应度高\u003c/li\u003e\n\u003cli\u003e资源共享\u003c/li\u003e\n\u003cli\u003e经济\u003c/li\u003e\n\u003cli\u003e多处理器体系机构的利用\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch4 id=\"多线程模型\"\u003e多线程模型\u003c/h4\u003e\n\u003cp\u003e有两种不同的方法来提供线程支持：用户层的用户线程和内核层的内核线程，二者有三种对应关系\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e多对一模型：多个用户线程映射到一个内核线程\u003c/li\u003e\n\u003cli\u003e一对一模型：有更好的并发功能，但是开销比较大\u003c/li\u003e\n\u003cli\u003e多对多模型\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch4 id=\"线程池\"\u003e线程池\u003c/h4\u003e\n\u003cp\u003e为了解决创建线程时间和丢弃，以及没有限制线程数量可能会导致资源用尽的问题，产生了线程池的解决方法\u003c/p\u003e\n\u003cp\u003e线程池会在进程开始时创建一定数量的线程，并放入池中来等待，服务器每次收到请求就会唤醒池中的一个线程，线程完成了任务又会返回池中。如果池中没有可用线程，服务器会等待。\u003c/p\u003e\n\u003cp\u003e优点：\n使用现有线程比创建新线程快\n限制了数量，不会耗尽资源\u003c/p\u003e\n\u003ch4 id=\"线程库\"\u003e线程库\u003c/h4\u003e\n\u003cp\u003e线程库为程序员提供创建和管理线程的api\u003c/p\u003e\n\u003cp\u003ePthread\nWin32\nJava\u003c/p\u003e\n\u003ch4 id=\"多线程问题\"\u003e多线程问题\u003c/h4\u003e\n\u003cp\u003efork()和exec()\u003c/p\u003e\n\u003cp\u003e取消：异步取消、延迟取消\u003c/p\u003e\n\u003ch3 id=\"进程与线程的区别\"\u003e进程与线程的区别\u003c/h3\u003e\n\u003ch4 id=\"资源方面\"\u003e资源方面\u003c/h4\u003e\n\u003cp\u003e\u003cstrong\u003e进程是资源分配的基本单位\u003c/strong\u003e，但是线程不拥有资源，线程可以访问隶属进程的资源，线程没有自己独立的地址空间。\u003c/p\u003e\n\u003ch4 id=\"调度方面\"\u003e调度方面\u003c/h4\u003e\n\u003cp\u003e\u003cstrong\u003e线程是独立调度的基本单位\u003c/strong\u003e，在同一进程中，线程的切换不会引起进程切换，从一个进程中的线程切换到另一个进程中的线程时，会引起进程切换。\u003c/p\u003e\n\u003ch4 id=\"系统开销\"\u003e系统开销\u003c/h4\u003e\n\u003cp\u003e由于创建或撤销进程时，系统都要为之分配或回收资源，如内存空间、I/O 设备等，所付出的开销远大于创建或撤销线程时的开销。类似地，在进行进程切换时，涉及当前执行进程 CPU 环境的保存及新调度进程 CPU 环境的设置，而线程切换时只需保存和设置少量寄存器内容，开销很小。\u003c/p\u003e\n\u003ch4 id=\"通信方面\"\u003e通信方面\u003c/h4\u003e\n\u003cp\u003e线程间可以通过直接读写同一进程中的数据进行通信，但是进程通信需要借助 IPC。\u003c/p\u003e\n\u003ch4 id=\"并发性\"\u003e并发性\u003c/h4\u003e\n\u003cp\u003e一个进程间的多个线程可以并发\u003c/p\u003e\n\u003ch3 id=\"tips\"\u003eTips\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e一个进程被不同的地方调用，会形成不同的进程\u003c/li\u003e\n\u003cli\u003e同一个线程可以被多个进程调用，线程还是同一个\u003c/li\u003e\n\u003cli\u003e对进程的管理和控制是通过执行各种原语来实现的\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"二处理机调度\"\u003e二、处理机调度\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944201/os-thread-5.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e单处理器系统，每次只允许一个进程运行，这个效率啊，efficiency。\u003c/p\u003e\n\u003cp\u003e每当CPU空闲时，操作系统就必须从就绪队列中选择一个进程来执行，由短期调度程序或者CPU调度来执行。调度程序从内存中选择一个能够执行的进程并为之分配CPU\u003c/p\u003e\n\u003cp\u003e就绪队列可实现为FIFO队列、优先队列、树或者简单的无序链表\u003c/p\u003e\n\u003cp\u003eCPU调度决策可在如下四种环境下发生：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e进程从运行切换到等待（I/O请求、调用wait等）\u003c/li\u003e\n\u003cli\u003e从运行切换到就绪（出现中断）\u003c/li\u003e\n\u003cli\u003e从等待切换到就绪（I/O完成）\u003c/li\u003e\n\u003cli\u003e终止\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e1、4的情况下，调度方式是非抢占的，2、3是抢占的\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e调度的层级：\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e作业调度：给作业获得竞争处理机的机会\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e中级调度：内存调度，提高内存利用率和系统吞吐量\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e进程调度：低级调度，从就绪队列选进程分配处理机\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e进程调度方式：\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e剥夺调度：有另一个优先级高的进程进入，立即调度\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e非剥夺调度：等一个进程介绍才会调度，不抢\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"调度准则\"\u003e调度准则\u003c/h3\u003e\n\u003cp\u003e用于比较的特征准则有：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCPU使用率\u003c/li\u003e\n\u003cli\u003e吞吐量：一个单位时间内完成进程的数量\u003c/li\u003e\n\u003cli\u003e周转时间：从进程提交到进程完成的时间称为周转时间\u003c/li\u003e\n\u003cli\u003e平均周转时间：多个作业周转时间平均值\u003c/li\u003e\n\u003cli\u003e带权周转时间：周转时间/运行时间\u003c/li\u003e\n\u003cli\u003e平均带权周转时间：多个作业带权周转时间的平均值\u003c/li\u003e\n\u003cli\u003e等待时间：为最就绪队列中等待所花的时间，调度算法不影响进程运行时间，只影响在队列中的等待时间\u003c/li\u003e\n\u003cli\u003e响应时间：从提交请求到响应请求的时间\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"调度算法\"\u003e调度算法\u003c/h3\u003e\n\u003cp\u003eCPU调度是多道程序操作系统的基础，通过在进程之间切换CPU，操作系统可以提高计算机的吞吐率。\u003c/p\u003e\n\u003cp\u003e不同环境的调度算法目标不同，因此需要针对不同环境来讨论调度算法。\u003c/p\u003e\n\u003cp\u003e几个概念：\n\u003cstrong\u003e周转时间\u003c/strong\u003e：最后完成的时刻-刚进来的时刻，即包括等待时间与运行时间\n\u003cstrong\u003e带权周转时间\u003c/strong\u003e：周转时间/进程运行时间\n\u003cstrong\u003e响应比\u003c/strong\u003e：（等待时间+要求服务时间）/ 要求服务时间\u003c/p\u003e\n\u003ch4 id=\"1-批处理系统\"\u003e1. 批处理系统\u003c/h4\u003e\n\u003cp\u003e批处理系统没有太多的用户操作，在该系统中，调度算法目标是保证吞吐量和周转时间（从提交到终止的时间）。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1.1 先来先服务 first-come first-serverd（FCFS）\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e按照请求的顺序进行调度。\u003c/p\u003e\n\u003cp\u003e用FIFO队列就可以实现\u003c/p\u003e\n\u003cp\u003e有利于长作业，但不利于短作业，因为短作业必须一直等待前面的长作业执行完毕才能执行，而长作业又需要执行很长时间，造成了短作业等待时间过长。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1.2 短作业优先 shortest job first（SJF）\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e按估计运行时间最短的顺序进行调度。\u003c/p\u003e\n\u003cp\u003eSJF算法调度理论上确实是最佳的，但问题在于如何知道下一个CPU区间的长度\u003c/p\u003e\n\u003cp\u003e长作业有可能会饿死，处于一直等待短作业执行完毕的状态。因为如果一直有短作业到来，那么长作业永远得不到调度。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1.3 最短剩余时间优先 shortest remaining time next（SRTN）\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e按估计剩余时间最短的顺序进行调度。\u003c/p\u003e\n\u003ch4 id=\"2-交互式系统\"\u003e2. 交互式系统\u003c/h4\u003e\n\u003cp\u003e交互式系统有大量的用户交互操作，在该系统中调度算法的目标是快速地进行响应。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2.1 时间片轮转\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e将所有就绪进程按 FCFS 的原则排成一个队列，每次调度时，把 CPU 时间分配给队首进程，该进程可以执行一个时间片。当时间片用完时，由计时器发出时钟中断，调度程序便停止该进程的执行，并将它送往就绪队列的末尾，同时继续把 CPU 时间分配给队首的进程。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e时间片轮转算法是为了多个用户能及时干预系统\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e时间片轮转算法的效率和时间片的大小有很大关系：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e因为进程切换都要保存进程的信息并且载入新进程的信息，如果时间片太小，会导致进程切换得太频繁，在进程切换上就会花过多时间。\u003c/li\u003e\n\u003cli\u003e而如果时间片过长，那么实时性就不能得到保证。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2.2 优先级调度\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e为每个进程分配一个优先级，按优先级进行调度。\u003c/p\u003e\n\u003cp\u003e为了防止低优先级的进程永远等不到调度，可以随着时间的推移增加等待进程的优先级。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2.3 多级反馈队列\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e一个进程需要执行 100 个时间片，如果采用时间片轮转调度算法，那么需要交换 100 次。\u003c/p\u003e\n\u003cp\u003e多级队列是为这种需要连续执行多个时间片的进程考虑，它设置了多个队列，每个队列时间片大小都不同，例如 1,2,4,8,..。进程在第一个队列没执行完，就会被移到下一个队列。这种方式下，之前的进程只需要交换 7 次。\u003c/p\u003e\n\u003cp\u003e每个队列优先权也不同，最上面的优先权最高。因此只有上一个队列没有进程在排队，才能调度当前队列上的进程。\u003c/p\u003e\n\u003cp\u003e可以将这种调度算法看成是时间片轮转调度算法和优先级调度算法的结合。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944201/os-thread-7.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch4 id=\"3-实时系统\"\u003e3. 实时系统\u003c/h4\u003e\n\u003cp\u003e实时系统要求一个请求在一个确定时间内得到响应。\u003c/p\u003e\n\u003cp\u003e分为硬实时和软实时，前者必须满足绝对的截止时间，后者可以容忍一定的超时。\u003c/p\u003e\n\u003ch3 id=\"tips-1\"\u003eTips\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e考虑到系统资源利用率，要选择让I/O繁忙型作业有更高的优先级\u003c/li\u003e\n\u003cli\u003e作业和进程的区别，作业由用户提交、以用户任务为单位，进程由系统自动生成、以操作系统控制为单位\u003c/li\u003e\n\u003cli\u003e分时操作系统采用时间片轮转调度算法\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"三进程同步\"\u003e三、进程同步\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"%C2%B5https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944201/os-thread-6.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"同步与互斥\"\u003e同步与互斥\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e同步\u003c/strong\u003e：直接相互制约同步\u003c/p\u003e\n\u003cp\u003e进程之间的合作，比如A进程向B进程提供数据，多个进程会按一定顺序执行；\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e互斥\u003c/strong\u003e：间接相互制约\u003c/p\u003e\n\u003cp\u003e源于资源共享，几个进程抢相同的资源，多个进程在同一时刻只有一个进程能进入临界区。\u003c/p\u003e\n\u003cp\u003e互斥可能会出现两种情况：\n饥饿：拥有其他所有资源却得不到CPU的就绪进程\n死锁：进程之间相互等待对方资源却无法得到，陷入永远的阻塞\u003c/p\u003e\n\u003cp\u003e进程互斥实际上是进程同步的一种特殊情况，可以认为是逐次使用互斥资源\u003c/p\u003e\n\u003ch3 id=\"临界资源和临界区\"\u003e临界资源和临界区\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003e临界资源\u003c/strong\u003e ：一次仅允许一个进程使用的资源，比如说硬件资源打印机什么的，一些非硬件资源比如一些变量、数据\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e临界区\u003c/strong\u003e ：对临界资源进行访问的那段代码称为临界区\u003c/p\u003e\n\u003cp\u003e不论是硬件临界资源还是软件临界资源，多个进程必须互斥地对它们进行访问\u003c/p\u003e\n\u003cp\u003e把临界资源的访问分为四个部分：进入区、临界区、退出区、剩余区\u003c/p\u003e\n\u003cp\u003e为了互斥访问临界资源，每个进程在进入临界区之前，需要先进行检查，看是否正在被访问，如果未被访问就可以进入临界区，并设置它正在被访问的标志。在进入临界区之前执行的这段代码称为进入区。\u003c/p\u003e\n\u003cp\u003e在出来之前也要运行一段代码，把访问标志清除，这段代码称为退出区。\u003c/p\u003e\n\u003cp\u003e进入区和退出区起到互斥保护临界区的作用\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eentry\u003c/span\u003e \u003cspan class=\"n\"\u003esection\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 进入区\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003ecritical\u003c/span\u003e \u003cspan class=\"n\"\u003esection\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 临界区\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"n\"\u003eexit\u003c/span\u003e \u003cspan class=\"n\"\u003esection\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 退出区\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003eremainer\u003c/span\u003e \u003cspan class=\"n\"\u003esection\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 剩余区\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e临界区不是原语的，中途可以出现中断等（反正其他的还是进不来）\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e同步机制的原则：\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e空闲让进\u003c/li\u003e\n\u003cli\u003e忙则等待\u003c/li\u003e\n\u003cli\u003e有限等待\u003c/li\u003e\n\u003cli\u003e让权等待\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"信号量\"\u003e信号量\u003c/h3\u003e\n\u003cp\u003e信号量（Semaphore）是一个整型变量，可以对其执行wait和signal操作，也就是常见的 P 和 V 操作。\u003c/p\u003e\n\u003cp\u003ewait是P（申请资源），signal是V（释放资源）\u003c/p\u003e\n\u003cp\u003eS.value的初值就代表资源的数目，如果S.value \u0026lt; 0，那么其绝对值表示阻塞的进程的个数\u003c/p\u003e\n\u003ch4 id=\"整型信号量\"\u003e整型信号量\u003c/h4\u003e\n\u003cp\u003e\u003cstrong\u003eP\u003c/strong\u003e ：如果信号量S大于 0 ，执行 -1 操作；如果信号量等于 0，进程睡眠，等待信号量大于 0；\n\u003cstrong\u003eV\u003c/strong\u003e ：对信号量S执行 +1 操作，唤醒睡眠的进程让其完成 down 操作。\u003c/p\u003e\n\u003cp\u003eP V操作需要被设计成原语，不可分割，通常的做法是在执行这些操作的时候屏蔽中断。\u003c/p\u003e\n\u003cp\u003e缺点是在S\u0026lt;=0时，会出现”忙等”，没有遵循让权等待\u003c/p\u003e\n\u003ch4 id=\"记录型信号量\"\u003e记录型信号量\u003c/h4\u003e\n\u003cp\u003e再增加一个进程链表，链接上述的等待进程\nP V操作修改为\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-C++\" data-lang=\"C++\"\u003e\u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esemaphore\u003c/span\u003e \u003cspan class=\"n\"\u003eS\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eS\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eS\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 请求一个资源\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eS\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eblock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eS\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eL\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 如果资源没了，就调用block阻塞掉，插入到信号量链表S.L中\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esemaphore\u003c/span\u003e \u003cspan class=\"n\"\u003eS\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eS\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eS\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 释放一个资源\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eS\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ewakeup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eS\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eL\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 如果释放掉后还是堵着的，那么唤醒一个堵着的资源\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"c1\"\u003e//（如果释放掉后不堵了，前一步也是0，说明链表原本就没有东西，所以不存在wakeup）\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cstrong\u003e实现前驱关系\u003c/strong\u003e：比如S1结束才能执行S2，可以设置一个信号量a，初始值为0，S1中V(a)，S2中P(a)\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e实现互斥关系\u003c/strong\u003e：比如S1和S2互斥，可以设置一个信号量a，初始值为1，S1、S2都用P(a) V(a)夹紧中间过程\u003c/p\u003e\n\u003cp\u003e如果信号量的取值只能为 0 或者 1，那么就成为了  \u003cstrong\u003e互斥量（Mutex）\u003c/strong\u003e ，0 表示临界区已经加锁，1 表示临界区解锁。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"k\"\u003etypedef\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esemaphore\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003esemaphore\u003c/span\u003e \u003cspan class=\"n\"\u003emutex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eP1\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 临界区\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003eup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eP2\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 临界区\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003eup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"实现同步互斥\"\u003e实现同步互斥\u003c/h3\u003e\n\u003ch4 id=\"软件实现petersons-algotithm\"\u003e软件实现：Peterson's Algotithm\u003c/h4\u003e\n\u003cp\u003eflag表示有这个意愿，turn表示把回合让给谁，这是一个很谦让的算法，进程i要来先打个招呼，说我有执行的打算，然后把回合让给进程j，如果j没打算，那么i直接进去，进去之后，j如果再进来，直接把回合又给了i，j达到了while等待条件，只能等着i的执行完之后，j再进去\u003c/p\u003e\n\u003cp\u003eP[i]进程\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-C\" data-lang=\"C\"\u003e\u003cspan class=\"n\"\u003eflag\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTRUE\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eturn\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eflag\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eturn\u003c/span\u003e\u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// j正在访问临界区，i等着\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003ecritical\u003c/span\u003e \u003cspan class=\"n\"\u003esection\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eflag\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eFALSE\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eremainder\u003c/span\u003e \u003cspan class=\"n\"\u003esection\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eP[j]进程\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-C\" data-lang=\"C\"\u003e\u003cspan class=\"n\"\u003eflag\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTRUE\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eturn\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eflag\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eturn\u003c/span\u003e\u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"n\"\u003ecritical\u003c/span\u003e \u003cspan class=\"n\"\u003esection\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eflag\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eFALSE\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003eremainer\u003c/span\u003e \u003cspan class=\"n\"\u003esection\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"典型问题生产者-消费者问题\"\u003e典型问题：生产者-消费者问题\u003c/h3\u003e\n\u003cp\u003e这是一个非常重要而典型的问题，进程同步60%以上的题目都是生产者消费者的改编\u003c/p\u003e\n\u003cp\u003e问题描述：有一群生产者进程在生产产品，并将这些产品提供给消费者进程去进行消费。使用一个缓冲区来保存物品，只有缓冲区没有满，生产者才可以放入物品；只有缓冲区不为空，消费者才可以拿走物品。\u003c/p\u003e\n\u003cp\u003e因为缓冲区属于临界资源，因此需要使用一个互斥量 mutex 来控制对缓冲区的互斥访问。（缓冲区用循环队列就可以模拟）\u003c/p\u003e\n\u003cp\u003e为了同步生产者和消费者的行为，需要记录缓冲区中物品的数量。数量可以使用信号量来进行统计，这里需要使用两个信号量：empty 记录空缓冲区的数量，full 记录满缓冲区的数量。其中，empty 信号量是在生产者进程中使用，当 empty 不为 0 时，生产者才可以放入物品；full 信号量是在消费者进程中使用，当 full 信号量不为 0 时，消费者才可以取走物品。\u003c/p\u003e\n\u003cp\u003e注意，不能先对缓冲区进行加锁，再测试信号量。也就是说，不能先执行 down(mutex) 再执行 down(empty)。如果这么做了，那么可能会出现这种情况：生产者对缓冲区加锁后，执行 down(empty) 操作，发现 empty = 0，此时生产者睡眠。消费者不能进入临界区，因为生产者对缓冲区加锁了，消费者就无法执行 up(empty) 操作，empty 永远都为 0，导致生产者永远等待下，不会释放锁，消费者因此也会永远等待下去。\u003c/p\u003e\n\u003cp\u003e顺序执行的时候显然没有任何问题，然而在并发执行的时候，就会出现差错，比如共享变量counter，会出现冲突。解决的关键是将counter作为临界资源来处理。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"cp\"\u003e##define N 100\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003etypedef\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esemaphore\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003esemaphore\u003c/span\u003e \u003cspan class=\"n\"\u003emutex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003esemaphore\u003c/span\u003e \u003cspan class=\"n\"\u003eempty\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"n\"\u003esemaphore\u003c/span\u003e \u003cspan class=\"n\"\u003efull\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eproducer\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTRUE\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eitem\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eproduce_item\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eempty\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003einsert_item\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003efull\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003econsumer\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTRUE\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003efull\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edown\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eitem\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eremove_item\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003econsume_item\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eempty\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cstrong\u003e实际例子：吃水果问题\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e桌子上有一个盘子，可以放一个水果。爸爸每次放一个苹果，妈妈每次放一个桔子；女儿每次吃一个苹果，儿子每次吃一个桔子。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e32\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e33\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e34\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e35\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e36\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e37\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-C++\" data-lang=\"C++\"\u003e\u003cspan class=\"n\"\u003esemaphore\u003c/span\u003e \u003cspan class=\"n\"\u003eS\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e  \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSA\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSO\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 盘子的互斥信号量、苹果和桔子的互斥信号量\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n\u003cspan class=\"n\"\u003efather\u003c/span\u003e\u003cspan class=\"p\"\u003e(){\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ehave\u003c/span\u003e \u003cspan class=\"n\"\u003ean\u003c/span\u003e \u003cspan class=\"n\"\u003eapple\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eS\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eput\u003c/span\u003e \u003cspan class=\"n\"\u003ean\u003c/span\u003e \u003cspan class=\"n\"\u003eapple\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSA\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003emother\u003c/span\u003e\u003cspan class=\"p\"\u003e(){\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ehave\u003c/span\u003e \u003cspan class=\"n\"\u003ean\u003c/span\u003e \u003cspan class=\"n\"\u003eorange\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eS\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eput\u003c/span\u003e \u003cspan class=\"n\"\u003ean\u003c/span\u003e \u003cspan class=\"n\"\u003eorange\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSO\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003edaughter\u003c/span\u003e\u003cspan class=\"p\"\u003e(){\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSA\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eget\u003c/span\u003e \u003cspan class=\"n\"\u003ean\u003c/span\u003e \u003cspan class=\"n\"\u003eapple\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eS\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eeat\u003c/span\u003e \u003cspan class=\"n\"\u003ean\u003c/span\u003e \u003cspan class=\"n\"\u003eapple\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eson\u003c/span\u003e\u003cspan class=\"p\"\u003e(){\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSO\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eget\u003c/span\u003e \u003cspan class=\"n\"\u003ean\u003c/span\u003e \u003cspan class=\"n\"\u003eorange\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eS\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 吃完之后要V(S)才能接着让爸爸妈妈接着放\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003eeat\u003c/span\u003e \u003cspan class=\"n\"\u003ean\u003c/span\u003e \u003cspan class=\"n\"\u003eorange\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"典型问题哲学家就餐问题\"\u003e典型问题：哲学家就餐问题\u003c/h3\u003e\n\u003cp\u003e这是由Dijkstra提出的典型进程同步问题\u003c/p\u003e\n\u003cp\u003e5个哲学家坐在桌子边，桌子上有5个碗和5支筷子，哲学家开始思考，如果饥饿了，就拿起两边筷子进餐（两支筷子都拿起才能进餐），用餐后放下筷子，继续思考\u003c/p\u003e\n\u003cp\u003e多个临界资源的问题\u003c/p\u003e\n\u003cp\u003e只考虑筷子互斥：可能会产生死锁，比如所有人都同时拿起右边筷子，左边无限等待\n再考虑吃饭行为互斥：同时只让一个人吃饭，肯定不会冲突或死锁，但是资源比较浪费\u003c/p\u003e\n\u003cp\u003e解决方法1：允许4位哲学家同时去拿左边的筷子\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-C++\" data-lang=\"C++\"\u003e\u003cspan class=\"n\"\u003esemaphore\u003c/span\u003e \u003cspan class=\"n\"\u003echopstick\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 筷子信号量\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"n\"\u003esemaphore\u003c/span\u003e \u003cspan class=\"n\"\u003eeating\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 允许四个哲学家可以同时拿筷子\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003ephilosopher\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 第i个哲学家的程序\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"n\"\u003ethinking\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eeating\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echopstick\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 请求左边的筷子\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echopstick\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e%\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 请求右边的筷子\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"n\"\u003eeating\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echopstick\u003c/span\u003e\u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e%\u003c/span\u003e\u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echopstick\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eeating\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e解决方式2：奇数位置的哲学家先左后右，偶数位置的哲学家先右后左\u003c/p\u003e\n\u003ch3 id=\"典型问题读者写者问题\"\u003e典型问题：读者写者问题\u003c/h3\u003e\n\u003cp\u003e读进程：Reader进程\n写进程：Writer进程\u003c/p\u003e\n\u003cp\u003e允许多个进程同时读一个共享文件，因为读不会使数据混乱；但同时仅仅允许一个写者在写\u003c/p\u003e\n\u003cp\u003e写-写互斥，写-读互斥，读-读允许\u003c/p\u003e\n\u003cp\u003e纯互斥问题，没有同步关系没有先后之分\u003c/p\u003e\n\u003cp\u003e需要多加一个读者计数器，并且修改这个时要同步，所以要再加一个变量保证修改count时的互斥\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-C++\" data-lang=\"C++\"\u003e\u003cspan class=\"n\"\u003esemaphore\u003c/span\u003e \u003cspan class=\"n\"\u003ermutex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ewmutex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// readcount的互斥信号量，数据的互斥信号量\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ereadcount\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eReader\u003c/span\u003e\u003cspan class=\"p\"\u003e(){\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 每次进入和退出因为涉及readcount变化，要保证同时只有一个，所以分别设置rmutex\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ermutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 抢readcount信号量，防止多个reader同时进入 导致readcount变化不同\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereadcount\u003c/span\u003e\u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n      \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewmutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 第一个进来的读者，抢公共缓冲区\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ereadcount\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ermutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 其他reader可以进来了\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eperform\u003c/span\u003e \u003cspan class=\"n\"\u003eread\u003c/span\u003e \u003cspan class=\"n\"\u003eoperation\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ermutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 再抢一次，使每次只有一个退出\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"n\"\u003ereadcount\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereadcount\u003c/span\u003e\u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n      \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewmutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 最后一个reader走了，释放公共缓冲区\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ermutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e(){\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 写者很简单，只需要考虑wmutex公共缓冲区\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e  \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewmutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eperform\u003c/span\u003e \u003cspan class=\"n\"\u003ewrite\u003c/span\u003e \u003cspan class=\"n\"\u003eoperation\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewmutex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e上面的算法可能会导致写者可能会被插队，如果是RWR，中间的W被堵了，结果后面的R还能进去，W还要等后面的R读完\u003c/p\u003e\n\u003cp\u003e变形：让写者优先，如果有写者，那么后来的读者都要阻塞，实现完全按照来的顺序进行读写操作。\n解决方法：再增加一个wfirst信号量，初始为1，在读者的Read()和之前的阶段和写者部分都加一个P(wfirst)作为互斥入口，结尾V(wfirst)释放即可\u003c/p\u003e\n\u003cp\u003e变形：让写者真正优先，可以插队\n解决方法：增加一个writecount统计，也就是加一个写者队列，写者可以霸占这个队列一直堵着\u003c/p\u003e\n\u003ch3 id=\"例子汽车过窄桥问题\"\u003e例子：汽车过窄桥问题\u003c/h3\u003e\n\u003cp\u003e来往各有两条路，但是中间有一个窄桥只能容纳一辆车通过，方向一样的车可以一起过\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e32\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e33\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e34\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e35\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e36\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e37\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e38\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e39\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e40\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e41\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e42\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-C++\" data-lang=\"C++\"\u003e\u003cspan class=\"n\"\u003esemaphore\u003c/span\u003e \u003cspan class=\"n\"\u003emutex1\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emutex2\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebridge\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecount1\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"n\"\u003ecount2\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eProcess\u003c/span\u003e \u003cspan class=\"nf\"\u003eNorth\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emutex1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount1\u003c/span\u003e\u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n      \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebridge\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 第一辆车来了就抢bridge让对面的车进不来\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecount1\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emutex1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ecross\u003c/span\u003e \u003cspan class=\"n\"\u003ethe\u003c/span\u003e \u003cspan class=\"n\"\u003ebridge\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emutex1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecount1\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount1\u003c/span\u003e\u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n      \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebridge\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 最后一辆车走了就释放bridge让对面的车可以进来\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emutex1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eProcess\u003c/span\u003e \u003cspan class=\"nf\"\u003eSouth\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n  \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emutex2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount2\u003c/span\u003e\u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n      \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebridge\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecount2\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emutex2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ecross\u003c/span\u003e \u003cspan class=\"n\"\u003ethe\u003c/span\u003e \u003cspan class=\"n\"\u003ebridge\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emutex2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecount2\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount2\u003c/span\u003e\u003cspan class=\"o\"\u003e==\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e){\u003c/span\u003e\n      \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebridge\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emutex2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch3 id=\"管程\"\u003e管程\u003c/h3\u003e\n\u003cp\u003e使用信号量机制实现的生产者消费者问题需要客户端代码做很多控制，而管程把控制的代码独立出来，不仅不容易出错，也使得客户端代码调用更容易。\u003c/p\u003e\n\u003cp\u003e（管程有点像用一个类来封装初始化、共享数据、操作代码等）\u003c/p\u003e\n\u003cp\u003e管程有一个重要特性：在一个时刻只能有一个进程使用管程。进程在无法继续执行的时候不能一直占用管程，否者其它进程永远不能使用管程。\u003c/p\u003e\n\u003cp\u003e管程定义了一个数据结构和能为并发进程所执行的一组操作，这组操作可以同步进程和改变管程中的数据\u003c/p\u003e\n\u003cp\u003e管程引入了  \u003cstrong\u003e条件变量\u003c/strong\u003e  以及相关的操作：\u003cstrong\u003ewait()\u003c/strong\u003e 和 \u003cstrong\u003esignal()\u003c/strong\u003e 来实现同步操作。对条件变量执行 wait() 操作会导致调用进程阻塞，把管程让出来给另一个进程持有。signal() 操作用于唤醒被阻塞的进程。\u003c/p\u003e\n\u003ch3 id=\"tips-2\"\u003eTips\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e临界资源同一时间只能被一个进程访问，而共享资源一段时间可以被多个访问，磁盘属于共享设备而不是临界资源\u003c/li\u003e\n\u003cli\u003e要对并发进程进行同步的原因是：并发进程是异步的\u003c/li\u003e\n\u003cli\u003ePV操作由两个不可被中断的过程组成，也就是它们两个，它们都属于低级进程通信原语，不是系统调用\u003c/li\u003e\n\u003cli\u003e有五个并发进程涉及到同一个变量A，说明有五段代码，也就是说有5个临界区\u003c/li\u003e\n\u003cli\u003e信箱通信是一种间接通信方式\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"四死锁\"\u003e四、死锁\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944527/os-thread-9.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e多个程序因为竞争共享资源而造成的僵局，若无外力作用，这些进程都将永远无法继续推进\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e★产生死锁的四个条件\u003c/strong\u003e，都满足就会产生：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003e互斥条件\u003c/strong\u003e：要求某资源进行排它性占有\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e不剥夺条件\u003c/strong\u003e：进程已经获得的资源在未被使用完前不可被剥夺\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e请求和保持条件\u003c/strong\u003e：已经至少拥有了一个资源，但是又提出了一个新的资源请求\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e循环/环路等待条件\u003c/strong\u003e（必要而非充分）：存在一个进程--资源循环链\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e举个例子，你手上拿着一个苹果，一个苹果只能被一个人拥有，这是互斥条件；别人不能把苹果从你手中抢走，这是不剥夺条件；你抱着这个苹果不放还想去拿别的苹果，这是请求和保持；一圈人都想拿他右边那个人的苹果，陷入循环，这是循环等待条件\u003c/p\u003e\n\u003ch3 id=\"死锁处理\"\u003e死锁处理\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e不让死锁发生：预防死锁、避免死锁\u003c/li\u003e\n\u003cli\u003e允许死锁发生，但死锁发生时要能检测到并加以处理：检测死锁、解除死锁\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645944527/os-thread-8.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"预防死锁\"\u003e预防死锁\u003c/h3\u003e\n\u003cp\u003e设置某些限制条件，破坏上面四个必要条件的一个或几个：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e（互斥在很多场合下是必须要遵循的，没办法破坏该条件）\u003c/li\u003e\n\u003cli\u003e摈弃“请求和保持条件”：所有进程一次性获得所有资源\u003c/li\u003e\n\u003cli\u003e摈弃“不可剥夺性”：如果提出新的申请无法满足，则放弃所有已经拥有的资源\u003c/li\u003e\n\u003cli\u003e摈弃“环路等待”：资源按顺序编号，进程必须按顺序申请资源\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"避免死锁\"\u003e避免死锁\u003c/h3\u003e\n\u003cp\u003e在资源的动态分配过程中，用某种方法防止系统进入不安全状态，从而避免死锁\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e银行家算法\u003c/strong\u003e（过程省略，找个例子就很容易理解）（卧槽，看完了才发现不考）\n尝试分配，然后检测安全性\u003c/p\u003e\n\u003ch3 id=\"死锁检测及解除\"\u003e死锁检测及解除\u003c/h3\u003e\n\u003cp\u003e不采取任何限制措施，允许死锁，通过系统检测机构及时检测出死锁的产生，并采取某些措施解除死锁\u003c/p\u003e\n\u003cp\u003e接触死锁的方法：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e剥夺资源\u003c/li\u003e\n\u003cli\u003e撤销进程\n\u003cbr\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"tips-3\"\u003eTips\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e进程产生死锁的主要原因。时间上可能是进程运行中的推进顺序不当，空间上的原因是对独占资源分配不当，而不是系统资源不足\u003c/li\u003e\n\u003cli\u003e死锁的避免是根据防止系统进入不安全状态采取措施，实现的结果是让进程推进合理\u003c/li\u003e\n\u003cli\u003e结束死锁甚至可以终止所有死锁进程，但是一般不会从非死锁进程处抢夺资源\u003c/li\u003e\n\u003cli\u003e死锁状态一定是不安全状态，但是不安全状态不一定有死锁，还可能是其他的\u003c/li\u003e\n\u003cli\u003e限制用户申请资源的顺序属于死锁预防的破坏循环等待，限制给进程分配资源的顺序属于死锁避免\u003c/li\u003e\n\u003c/ul\u003e\n","date":1579501799,"description":"","fuzzywordcount":9700,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"8d7b8c7a45d8c191a27e813b0b32645b","publishdate":1579501799,"relpermalink":"/posts/os-basics-thread/","section":"posts","summary":"本部分主要包括四个模块：进程与线程的概念、处理机调度算法、进程同步和死锁问题 一、进程与线程 进程 进程是进程实体的运行过程。是系统进行资源分配和调度的一个独立单位。","tags":["OS"],"title":"操作系统基础（二）进程与线程","url":"https://blog.engine.wang/posts/os-basics-thread/","wordcount":9654},{"categories":"posts","content":"\u003ch2 id=\"概述\"\u003e概述\u003c/h2\u003e\n\u003cp\u003e操作系统是指控制和管理整个计算机系统的硬件和软件资源，并且合理地组织调度计算机工作和资源的分配，以提供给用户和其他软件方便接口和环境的程序集合。\u003c/p\u003e\n\u003cp\u003e从底层到上层分别是：\u003c/p\u003e\n\u003cp\u003e硬件-\u0026gt;操作系统-\u0026gt;计算机程序-\u0026gt;用户\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645632990/os-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"操作系统的特征\"\u003e操作系统的特征\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003e并发\u003c/strong\u003e：两个或多个事件在同一时间间隔内发生\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e共享\u003c/strong\u003e：系统中的资源可供内存中多个并发执行的进程共同使用\u003c/p\u003e\n\u003cp\u003e并发和共享是操作系统两个最基本的特征\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e虚拟\u003c/strong\u003e：把物理实体变为若干个逻辑的对应\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e异步\u003c/strong\u003e：进程的执行走走停停，以不可预知的速度向前推进\u003c/p\u003e\n\u003ch2 id=\"操作系统的目的和功能\"\u003e操作系统的目的和功能\u003c/h2\u003e\n\u003cp\u003e功能：处理机管理、存储器管理、设备管理、文件管理以及提供接口给用户。\u003c/p\u003e\n\u003cp\u003e操作系统为用户提供操作计算机硬件系统的接口\u003c/p\u003e\n\u003ch3 id=\"命令接口\"\u003e命令接口\u003c/h3\u003e\n\u003cp\u003e联机控制方式（适用于分时、实时操作系统）：说一句做一句\u003c/p\u003e\n\u003cp\u003e脱机控制方式（适用于批处理）：写在单子上，按单子一个一个做\u003c/p\u003e\n\u003ch3 id=\"程序接口\"\u003e程序接口\u003c/h3\u003e\n\u003cp\u003e程序接口由一组\u003cstrong\u003e系统调用命令\u003c/strong\u003e组成，在程序中使用这些调用命令来请求操作系统为其提供服务\u003c/p\u003e\n\u003cp\u003e系统调用只能用过用户程序间接使用\u003c/p\u003e\n\u003ch2 id=\"操作系统的发展\"\u003e操作系统的发展\u003c/h2\u003e\n\u003ch3 id=\"1-手工操作阶段\"\u003e1. 手工操作阶段\u003c/h3\u003e\n\u003ch3 id=\"2-批处理阶段\"\u003e2. 批处理阶段\u003c/h3\u003e\n\u003cp\u003e单道批处理系统：内存中始终保持一道作业\n\u003cstrong\u003e特征：自动性、顺序性、单道性\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e多道批处理系统：允许多个程序同时进入内存并运行\n\u003cstrong\u003e特征：多道、宏观并行、微观串行\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e批处理的缺点是缺少交互性\u003c/p\u003e\n\u003ch3 id=\"3-分时操作系统\"\u003e3. 分时操作系统\u003c/h3\u003e\n\u003cp\u003e采用分时技术，把处理器的运行时间分为很短的时间片，按照时间片轮转算法把处理器分配给各个联机作业使用。\u003c/p\u003e\n\u003cp\u003e分时操作系统可以让多个用户通过终端连接同一个主机，用户之间互不干扰。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e特征：同时性、交互性、独立性、及时性\u003c/strong\u003e\u003c/p\u003e\n\u003ch3 id=\"4-实时操作系统\"\u003e4. 实时操作系统\u003c/h3\u003e\n\u003cp\u003e为了完成紧急任务而不需要时间片排队，通常采用抢占式的优先级高者优先调度\u003c/p\u003e\n\u003cp\u003e实时系统必须在被控制对象规定时间内处理来自外部的事件\u003c/p\u003e\n\u003cp\u003e通常运用场景是一些需要立即反应的场合，比如股票、订票、机床控制什么的\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e特征：及时性、可靠性\u003c/strong\u003e\u003c/p\u003e\n\u003ch3 id=\"5-网络操作系统和分布式计算机系统\"\u003e5. 网络操作系统和分布式计算机系统\u003c/h3\u003e\n\u003cp\u003e网络中各种资源的共享以及各台计算机之间的通信\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e特征：分布性、并行性\u003c/strong\u003e\u003c/p\u003e\n\u003ch2 id=\"操作系统的运行环境\"\u003e操作系统的运行环境\u003c/h2\u003e\n\u003ch3 id=\"内核态与用户态\"\u003e内核态与用户态\u003c/h3\u003e\n\u003cp\u003e程序分为内核程序和外层应用程序，他们能执行的指令的权限不一样，所以操作系统划分为了用户态（目态）和核心态（管态）来严格区分这两种程序\u003c/p\u003e\n\u003cp\u003e操作系统内核运行在核心态，用户程序运行在用户态\u003c/p\u003e\n\u003cp\u003e内核包括：\u003c/p\u003e\n\u003ch4 id=\"1-时钟管理\"\u003e1. 时钟管理\u003c/h4\u003e\n\u003ch4 id=\"2-中断机制\"\u003e2. 中断机制\u003c/h4\u003e\n\u003ch4 id=\"3-原语\"\u003e3. 原语\u003c/h4\u003e\n\u003cp\u003e处于最底层、运行具有原子性、运行时间较短，有这些特点的程序被称为原语\u003c/p\u003e\n\u003ch4 id=\"4-系统控制的数据结构及处理\"\u003e4. 系统控制的数据结构及处理\u003c/h4\u003e\n\u003ch3 id=\"运行机制\"\u003e运行机制\u003c/h3\u003e\n\u003ch3 id=\"中断和异常\"\u003e中断和异常\u003c/h3\u003e\n\u003ch4 id=\"中断外中断与当前运行的程序无关比如设备的中断请求时钟中断等等\"\u003e中断：外中断，与当前运行的程序无关，比如设备的中断请求、时钟中断等等\u003c/h4\u003e\n\u003ch4 id=\"异常内中断指令内部导致中断\"\u003e异常：内中断，指令内部导致中断\u003c/h4\u003e\n\u003cp\u003e中断处理一定会保存程序状态子寄存器\u003c/p\u003e\n\u003cp\u003e外部中断，PC值由中断隐指令自动保存，通用寄存器的内容由操作系统保存\u003c/p\u003e\n\u003ch3 id=\"系统调用\"\u003e系统调用\u003c/h3\u003e\n\u003cp\u003e按照供功能可以分为设备管理、文件管理、进程控制、进程通信、内存管理等\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1645632990/os-3.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e从用户态转到核心态会用到访管指令，访管指令在用户态使用，所以它不可能是特权指令\u003c/p\u003e\n\u003cp\u003e用户态指令：\u003c/p\u003e\n\u003cp\u003e核心态指令：输入输出指令\u003c/p\u003e\n\u003cp\u003e从用户态转换到核心态，这是由硬件完成的\u003c/p\u003e\n\u003cp\u003e置时钟指令只能在核心态下完成\u003c/p\u003e\n\u003cp\u003e中断发生后，进入中断处理的程序在核心态执行，是操作系统程序\u003c/p\u003e\n\u003cp\u003e广义指令（系统调用指令），必然在核心态执行，调用都可以\u003c/p\u003e\n\u003cp\u003e输入输出必然在核心态执行\u003c/p\u003e\n\u003cp\u003e分清楚调用和执行，有不少都是用户态可以调用但是执行必须在核心态的\u003c/p\u003e\n\u003cp\u003eCPU处于核心态，除了访管指令，其余所有指令都可以调用\u003c/p\u003e\n\u003cp\u003e导致用户从用户态切到内核态的操作有：某个东西导致了异常中断、I/O等等\u003c/p\u003e\n\u003ch2 id=\"tips\"\u003eTips\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e操作系统不关心高级语言编译器\u003c/li\u003e\n\u003cli\u003e单处理机系统中，进程与进程不能并行\u003c/li\u003e\n\u003cli\u003e用户可以使用命令接口和系统调用来使用计算机\u003c/li\u003e\n\u003cli\u003e计算机开机后，操作系统最终被加载到RAM上（内存中的系统区）\u003c/li\u003e\n\u003cli\u003e提高单机资源利用率的关键技术是多道程序设计技术\u003c/li\u003e\n\u003cli\u003e提到多道批处理就往提交若干作业（清单）上靠，提到分时就往用户靠，提到实时就往响应速度靠\u003c/li\u003e\n\u003cli\u003e通用操作系统使用时间片轮转算法\u003c/li\u003e\n\u003cli\u003e通道技术是一种硬件技术\u003c/li\u003e\n\u003cli\u003e进程调度不需要硬件的支持\u003c/li\u003e\n\u003cli\u003e异常处理后不一定会返回到发生异常的地方继续执行，比如除以0会直接跳过\u003c/li\u003e\n\u003c/ul\u003e\n","date":1578126593,"description":"","fuzzywordcount":1600,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"f98ba3fc2ed62340b2959e53c788eda6","publishdate":1578126593,"relpermalink":"/posts/os-basics-introduction/","section":"posts","summary":"概述 操作系统是指控制和管理整个计算机系统的硬件和软件资源，并且合理地组织调度计算机工作和资源的分配，以提供给用户和其他软件方便接口和环境的程序集合。 从底层到上层","tags":["OS"],"title":"操作系统基础（一）导论","url":"https://blog.engine.wang/posts/os-basics-introduction/","wordcount":1575},{"categories":"posts","content":"\u003cp\u003eDjango项目写好了，最后一步就是部署(deployment)，部署十分关键，只有部署在服务器上，别人才能从互联网上通过ip地址或域名直接访问到你的网页。\u003c/p\u003e\n\u003cp\u003e第一步是购买vps（Virtual Private Server 虚拟服务器），这个很简单而且网上教程一大把，这里就不详述，我在vultr购买的海外服务器，这样不用浪费时间去备案了，vultr的一大特色就是按时长收费，如果你的vps出了什么问题，可以随时关停，并且它还支持微信支付宝，价格也很便宜。\n\u003ca href=\"https://www.vultr.com/?ref=7617179\"\u003e （vultr官网） \u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eDjango的本地预览十分方便，一行\u003ccode\u003epython manage.py runserver\u003c/code\u003e就能搞定，但部署上线可没有这么简单。因为网上关于Django部署的教程都很杂乱，当时部署的时候就踩了很多很多坑，为了给之后一个参考，我又重新部署了一次，来记录详细的过程。\u003c/p\u003e\n\u003ch2 id=\"相关软件版本\"\u003e相关软件版本：\u003c/h2\u003e\n\u003cp\u003eDjango 2.1.3\nPython 3.6.6\nnginx 1.14.0\nuwsgi 2.0.17.1\u003c/p\u003e\n\u003cp\u003e服务器：\nUbuntu-server 18.04\u003c/p\u003e\n\u003ch2 id=\"准备工作\"\u003e准备工作\u003c/h2\u003e\n\u003cp\u003e首先打开ssh软件，Xshell、Putty什么的都行，通过vultr上vps详情页上给的ip和root密码连接到这台vps。\u003c/p\u003e\n\u003cp\u003e刚拿到的船新Linux，第一步先给它来个更新:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003esudo apt-get update\nsudo apt-get upgrade\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e建议使用非root用户，部署时最好使用python虚拟环境，具体操作不是本文的重点，便不赘述了\u003c/p\u003e\n\u003cp\u003e系统自带Python3.6、vim和git，所以不用装\u003c/p\u003e\n\u003cp\u003e安装python3-pip、python3-setuptools、gcc、python3-dev、wheel：\n（缺一不可，不然之后用pip安装uwsgi会有各种各样的报错）\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003esudo apt-get install python3-pip python-setuptools python3-dev wheel\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"放置django项目\"\u003e放置Django项目\u003c/h2\u003e\n\u003cp\u003e直接在服务器端用vim什么的写Django当然可取（虽然会很酸爽），但更多的时候我们是在本地写好了Django项目，要把它挪到服务器上。\u003c/p\u003e\n\u003cp\u003e在传输之前，要做一些工作：\u003c/p\u003e\n\u003cp\u003e先更改一下\u003ccode\u003esetting.py\u003c/code\u003e里的\u003ccode\u003eALLOWED_HOSTS\u003c/code\u003e，把服务器的ip加进去，有域名的话顺便把域名也加进去，要不然之后会无法加载Django项目\u003c/p\u003e\n\u003cp\u003e在本地的Python虚拟环境上使用\u003ccode\u003epip freeze \u0026gt; requirements.txt\u003c/code\u003e,生成一个txt文件，里面是需要的Python库以及其版本，之后一并传给服务器\u003c/p\u003e\n\u003cp\u003e传输文件到服务器的方法非常之多：可以使用Xshell自带的文件传输，也可以使用linux命令scp或安装更直观的lrzsz，或者使用本地的FileZilla、Winscp等软件，当然万能的git也很不错。\u003c/p\u003e\n\u003cp\u003e不过考虑到之后这个web项目之后也要修改，用上面的方法感觉都不是特别方便，介绍一个非常好用的方法，那就是使用Pycharm自带的deployment功能，可以实现实时上传以及下载文件，很是方便。\u003c/p\u003e\n\u003cp\u003e在\u003ccode\u003eTools\u003c/code\u003e-\u0026gt;\u003ccode\u003eDeployment\u003c/code\u003e-\u0026gt;\u003ccode\u003eConfiguration\u003c/code\u003e中配置好与自己服务器的连接，IP地址、用户名、密码以及对应项目路径\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1543389659/pycharm-deployment-1.jpg\" width=60%\u003e\n\u003c/center\u003e\n\u003ccenter\u003e\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1543389659/pycharm-deployment-2.jpg\" width=60%\u003e\n\u003c/center\u003e\n\u003cp\u003e在\u003ccode\u003eSettings\u003c/code\u003e-\u0026gt;\u003ccode\u003eProject Interpreter\u003c/code\u003e里把项目解释器更改为服务器里的Python，mappings里填写两边项目的目录，再加一条\u003ccode\u003emanage.py\u003c/code\u003e的映射\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1543389660/pycharm-deployment-3.jpg\" width=60%\u003e\n\u003c/center\u003e\n\u003cp\u003eapply之后Pycharm右下角会出现上传进度条，会有点慢，喝杯茶等一段时间即可\u003c/p\u003e\n\u003cp\u003e传输完毕后会发现本地的项目已经全部上传到服务器了\u003c/p\u003e\n\u003cp\u003e但这个毕竟不是这篇文章的重点，不重点介绍，遇到了什么问题可以留言或者私信我。\u003c/p\u003e\n\u003cp\u003e最后别忘了把\u003ccode\u003erequirements.txt\u003c/code\u003e上传到服务器，用pycharm的话只要直接把文件拖进本地项目目录，Pycharm就会自动帮我们上传到服务器。\u003c/p\u003e\n\u003cp\u003e在服务器上使用\u003ccode\u003epip install -r requirements.txt\u003c/code\u003e来安装必要的Python packages\n\u003cbr\u003e\u003c/p\u003e\n\u003ch2 id=\"安装与配置uwsgi\"\u003e安装与配置uwsgi\u003c/h2\u003e\n\u003cp\u003e使用pip3安装uwsgi（注意是pip安装，不是apt-get，否则之后会各种报错）\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003epip3 install uwsgi\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e下面来试一下uwsgi是否好使：\n找个位置新建一个py文件，就叫\u003ccode\u003euwsgi_test.py\u003c/code\u003e好了，然后用vim打开\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003etouch uwsgi_test.py\nvim uwsgi_test.py\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e写入以下内容：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-Python\" data-lang=\"Python\"\u003e\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003eapplication\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eenv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estart_response\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n    \u003cspan class=\"n\"\u003estart_response\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;200 OK\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;Content-Type\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;text/html\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"sa\"\u003eb\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;Hello Uwsgi\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003ewq保存退出（vim的基本操作不赘述，网上教程一大把）\u003c/p\u003e\n\u003cp\u003e然后输入以下命令启动uwsgi，把这个部署到某个端口，以9090端口为例\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003euwsgi --http :9090 --wsgi-file uwsgi_test.py\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e这时会出现\u003ccode\u003espawned uWSGI worker 1 (and the only) (pid: 11812, cores: 1) \u003c/code\u003e\n找个浏览器，访问\u003ccode\u003ehttp://\u0026lt;你的服务器ip\u0026gt;:9090/\u003c/code\u003e，不出意外的话你会看到Hello Uwsgi的字样，说明uwsgi能正常运行。\u003c/p\u003e\n\u003cp\u003e在项目目录下新建\u003ccode\u003euwsgi.ini\u003c/code\u003e文件并编辑加入以下内容：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003euwsgi\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 直接访问uwsgi的端口号，绕过nginx\u003c/span\u003e\n\u003cspan class=\"n\"\u003ehttp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e8010\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 转发给nginx的端口号\u003c/span\u003e\n\u003cspan class=\"n\"\u003esocket\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mf\"\u003e127.0.0.1\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e8001\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 是否使用主线程\u003c/span\u003e\n\u003cspan class=\"n\"\u003emaster\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 项目的绝对路径\u003c/span\u003e\n\u003cspan class=\"n\"\u003echdir\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003evar\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003ewww\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePROJECT_NAME\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;/\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# Django项目wsgi.py文件的相对路径\u003c/span\u003e\n\u003cspan class=\"n\"\u003ewsgi\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ePROJECT_NAME\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;/\u003c/span\u003e\u003cspan class=\"n\"\u003ewsgi\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epy\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 进程数\u003c/span\u003e\n\u003cspan class=\"n\"\u003eprocesses\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 每个进程的线程数\u003c/span\u003e\n\u003cspan class=\"n\"\u003ethreads\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 监听端口\u003c/span\u003e\n\u003cspan class=\"n\"\u003estats\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mf\"\u003e127.0.0.1\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e9191\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 每次退出时是否清理环境配置\u003c/span\u003e\n\u003cspan class=\"n\"\u003evacuum\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 目录中一旦有文件被改动就自动重启\u003c/span\u003e\n\u003cspan class=\"n\"\u003etouch\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003ereload\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003evar\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003ewww\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003emy_site\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 存放日志\u003c/span\u003e\n\u003cspan class=\"n\"\u003edaemonize\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003evar\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003ewww\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003emy_site\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003euWSGI\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e[uwsgi]\n# 直接访问uwsgi的端口号，绕过nginx\nhttp = :8010\n# 转发给nginx的端口号\nsocket = 127.0.0.1:8001\n# 是否使用主线程\nmaster = true\n# 项目的绝对路径\nchdir = /var/www/bangumi_project/\n# Django项目wsgi.py文件的相对路径\nwsgi-file = bangumi_project/wsgi.py\n# 进程数\nprocesses = 4\n# 每个进程的线程数\nthreads = 2\n# 监听端口\nstats = 127.0.0.1:9191\n# 每次退出时是否清理环境配置\nvacuum = true\n# 目录中一旦有文件被改动就自动重启\ntouch-reload = /var/www/bangumi_project\n# 存放日志\ndaemonize = /var/www/bangumi_project/uWSGI.log\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e加入uwsgi.ini的目的是使让uwsgi对接Django项目的启动变得更简便，否则就得在终端敲很长的代码\u003c/p\u003e\n\u003cp\u003e有了\u003ccode\u003euwsgi.ini\u003c/code\u003e我们只需要输入\u003ccode\u003euwsgi --ini uwsgi.ini\u003c/code\u003e就可以运行，浏览器输入ip地址加:8010端口（先绕过nginx因为还没配置呢），发现可以显示我们的项目了，这时css等静态文件可能没获取到，别急\u003c/p\u003e\n\u003ch2 id=\"安装和配置nginx\"\u003e安装和配置nginx\u003c/h2\u003e\n\u003cp\u003e先\u003ccode\u003esudo apt-get install nginx\u003c/code\u003e安装nginx，安装后nginx会自动启动，默认端口为80端口，浏览器输入ip地址加:80，可以看到\u0026quot;Welcome to nginx\u0026quot;的欢迎界面\u003c/p\u003e\n\u003cp\u003e把/etc/nginx/目录下的\u003ccode\u003euwsgi_params\u003c/code\u003e复制到项目目录下，也可以直接项目目录下新建\u003ccode\u003euwsgi_params\u003c/code\u003e文件，写入以下内容：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003euwsgi_param  QUERY_STRING       \u003cspan class=\"nv\"\u003e$query_string\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\nuwsgi_param  REQUEST_METHOD     \u003cspan class=\"nv\"\u003e$request_method\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\nuwsgi_param  CONTENT_TYPE       \u003cspan class=\"nv\"\u003e$content_type\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\nuwsgi_param  CONTENT_LENGTH     \u003cspan class=\"nv\"\u003e$content_length\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\nuwsgi_param  REQUEST_URI        \u003cspan class=\"nv\"\u003e$request_uri\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\nuwsgi_param  PATH_INFO          \u003cspan class=\"nv\"\u003e$document_uri\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\nuwsgi_param  DOCUMENT_ROOT      \u003cspan class=\"nv\"\u003e$document_root\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\nuwsgi_param  SERVER_PROTOCOL    \u003cspan class=\"nv\"\u003e$server_protocol\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\nuwsgi_param  REQUEST_SCHEME     \u003cspan class=\"nv\"\u003e$scheme\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\nuwsgi_param  HTTPS              \u003cspan class=\"nv\"\u003e$https\u003c/span\u003e if_not_empty\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\nuwsgi_param  REMOTE_ADDR        \u003cspan class=\"nv\"\u003e$remote_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\nuwsgi_param  REMOTE_PORT        \u003cspan class=\"nv\"\u003e$remote_port\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\nuwsgi_param  SERVER_PORT        \u003cspan class=\"nv\"\u003e$server_port\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\nuwsgi_param  SERVER_NAME        \u003cspan class=\"nv\"\u003e$server_name\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e前往/etc/nginx/目录，查看\u003ccode\u003enginx.conf\u003c/code\u003e（nginx基础配置），发现里面有这么两行，意思就是包含conf.d文件夹中所有以conf后缀的配置和site-enabled文件夹中的内容\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003einclude /etc/nginx/conf.d/*.conf;\ninclude /etc/nginx/sites-enabled/*;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e我们不更改nginx.conf基础配置，只需要修改\u003ccode\u003econf.d\u003c/code\u003e目录下的conf文件即可，进入\u003ccode\u003econf.d\u003c/code\u003e文件夹，修改\u003ccode\u003edefault.conf\u003c/code\u003e文件，没有的话就新建一个（还可以修改site-enabled/default或者sites-available/default，效果都一样的）\u003c/p\u003e\n\u003cp\u003e然后写入以下内容：（务必根据自己的情况做相应更改）\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-nginx\" data-lang=\"nginx\"\u003e\u003cspan class=\"k\"\u003eupstream\u003c/span\u003e \u003cspan class=\"s\"\u003edjango\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"kn\"\u003eserver\u003c/span\u003e \u003cspan class=\"n\"\u003e127.0.0.1\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e8001\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eserver\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# 监听端口，可改\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kn\"\u003elisten\u003c/span\u003e       \u003cspan class=\"mi\"\u003e80\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# 修改为你的ip或者域名\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kn\"\u003eserver_name\u003c/span\u003e  \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"s\"\u003e.2.3.4\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# 编码方式\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kn\"\u003echarset\u003c/span\u003e \u003cspan class=\"s\"\u003eutf-8\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e# 日志记录，可选\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kn\"\u003eaccess_log\u003c/span\u003e      \u003cspan class=\"s\"\u003e/var/www/\u0026lt;PROJECT_NAME\u0026gt;/nginx_access.log\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kn\"\u003eerror_log\u003c/span\u003e       \u003cspan class=\"s\"\u003e/var/www/\u0026lt;PROJECT_NAME\u0026gt;/nginx_error.log\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e# 静态文件所在目录（自行修改）\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kn\"\u003elocation\u003c/span\u003e \u003cspan class=\"s\"\u003e/static\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kn\"\u003ealias\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/www/my_site/blog/static\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e# 媒体文件所在目录（自行修改）\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"c1\"\u003e#location /media  {\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"c1\"\u003e#    alias /home/www/djangotest/Hello/media; # 媒体文件所在文件夹\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"c1\"\u003e#}\n\u003c/span\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kn\"\u003elocation\u003c/span\u003e \u003cspan class=\"s\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kn\"\u003einclude\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/www/\u0026lt;PROJECT_NAME\u0026gt;/uwsgi_params\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kn\"\u003euwsgi_pass\u003c/span\u003e \u003cspan class=\"s\"\u003edjango\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e运行\u003ccode\u003eservice nginx restart\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e如果报错\u003ccode\u003enginx.service failed because the control process exited with error code\u003c/code\u003e，那么运行一下\u003ccode\u003enginx -t -c /etc/nginx/nginx.conf\u003c/code\u003e，可以很容易的找到问题在哪。\u003c/p\u003e\n\u003cp\u003e浏览器输入ip地址，如果发现看到的还是\u0026quot;Welcome to nginx\u0026quot;，这个是因为在\u003ccode\u003enginx.conf\u003c/code\u003e中还include了一个\u003ccode\u003esites-enabled/*\u003c/code\u003e，它覆盖了我们在\u003ccode\u003edefault.conf\u003c/code\u003e中的配置，可以干脆直接去\u003ccode\u003enginx.conf\u003c/code\u003e里把\u003ccode\u003einclude /etc/nginx/sites-enabled/*;\u003c/code\u003e这一行删掉，或者调换两行位置。\n如果当时直接修改的sites-available或者sites-enabled中的default，就不会有这个问题\u003c/p\u003e\n\u003cp\u003e这时再访问我们的ip，就能看到自己在本地搭建的Django项目了，因为在配置nginx的时候写入了static的路径，所以css什么的都加载进来了。\u003c/p\u003e\n\u003cp\u003e至此nginx配置完毕\u003c/p\u003e\n\u003ch2 id=\"后续工作\"\u003e后续工作\u003c/h2\u003e\n\u003cp\u003e服务器上的Django还没有执行数据库迁移与管理员创建，所以记得执行\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003epython manage.py makemigrations\npython manage.py migrate\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e以及\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003epython manage.py createsuperuser\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e每次有更新时都要重载uwsgi与nginx才能生效，为了方便uwsgi的重载，在项目目录下新建一个\u003ccode\u003euwsgi\u003c/code\u003e文件夹，然后在里面新建两个文件:\u003ccode\u003euwsgi.pid\u003c/code\u003e（用于重载停止等操作）和\u003ccode\u003euwsgi.status\u003c/code\u003e（用于查看状态）\u003c/p\u003e\n\u003cp\u003e修改\u003ccode\u003euwsgi.ini\u003c/code\u003e，把原先的stats那行删掉，下面加上这两行：\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003estats=%(chdir)/uwsgi/uwsgi.status\npidfile=%(chdir)/uwsgi/uwsgi.pid\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e这样如果项目有更新，就可以使用这两个命令来分别重载uwsgi和nginx了\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003euwsgi --reload uwsgi/uwsgi.pid\nsystemctl reload nginx.service\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e至此我们的Django项目就部署完成了\u003c/p\u003e\n","date":1576947439,"description":"","fuzzywordcount":3700,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"82be9178df08613391ead81d6abd7a97","publishdate":1576947439,"relpermalink":"/posts/django2+nginx+uwsgi+ubuntu%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/","section":"posts","summary":"Django项目写好了，最后一步就是部署(deployment)，部署十分关键，只有部署在服务器上，别人才能从互联网上通过ip地址或域名直接访问到你的网页。 第一","tags":["Django","Linux","nginx"],"title":"Django2+nginx+uwsgi+Ubuntu部署记录","url":"https://blog.engine.wang/posts/django2+nginx+uwsgi+ubuntu%E9%83%A8%E7%BD%B2%E8%AE%B0%E5%BD%95/","wordcount":3603},{"categories":"posts","content":"\u003cp\u003e注：以下软件或组件只是自我记录，因为是颜控，所以包含大量主观感情色彩\u003c/p\u003e\n\u003cp\u003e本篇不含软件资源，如果有需要建议去官网购买正版\u003c/p\u003e\n\u003cp\u003e多图预警！！！流量党请慎重\u003c/p\u003e\n\u003ch2 id=\"科研篇\"\u003e科研篇\u003c/h2\u003e\n\u003ch3 id=\"xmind\"\u003eXmind\u003c/h3\u003e\n\u003cp\u003e最好用的思维导图软件，做出来的图很漂亮。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641893834/xmind-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e如果想放在ppt里，不要直接导出png图片，而应该导出为svg，然后拖进ppt。如果采用放大加平滑会有更好的演示效果。\u003c/p\u003e\n\u003ch3 id=\"ivysci\"\u003eIvySci\u003c/h3\u003e\n\u003cp\u003e青藤学术，论文管理软件，功能丰富，支持多端登录，比如论文管理、框选翻译、自动显示引用、笔记记录等等，比老牌的那几个论文管理软件好用。ReadPaper也不错，就是刚起步bug还比较多。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641872960/IvySci-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"mathpix-snip\"\u003eMathpix Snip\u003c/h3\u003e\n\u003cp\u003e区域截图，通过Ai识别返回Latex语法，每个月有免费的次数，不过还是够用的，神器\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641872960/mathpix-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e更新：别拿它图片做图床，过段时间后会被清理，当时图省事直接用它的图床，没保存到本地，笔记里的好几十张图片都没了 o(╥﹏╥)o\u003c/p\u003e\n\u003cp\u003e图床，我推荐cloudinary\u003c/p\u003e\n\u003ch3 id=\"texpad\"\u003eTexpad\u003c/h3\u003e\n\u003cp\u003emac平台上最好用颜值最高的Latex编辑器，可以自动同步编译，当然云端的Overleaf也不错（如果网好的话）\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641872968/texpad-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"生活篇\"\u003e生活篇\u003c/h2\u003e\n\u003ch3 id=\"cleanmymac-x\"\u003eCleanMyMac X\u003c/h3\u003e\n\u003cp\u003e界面极其优雅，功能强大的Mac清理软件\u003c/p\u003e\n\u003cp\u003e这个软件的易用性、外观和音效颠覆了我对清理类软件的看法，用起来很舒服，比win平台的某些流氓管家不知道高到哪里去了\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1551701107/yicheng.me%20Blog/Screen_Shot_2019-02-22_at_3.29.35_PM.png\" width=80%\u003e\n\u003c/center\u003e\n\u003ch3 id=\"fantastical-2\"\u003eFantastical 2\u003c/h3\u003e\n\u003cp\u003e想找个同步Google Calendar事件的Mac端日历，最后找到了找个。界面优雅且功能强大的日历应用，曾获年度设计奖，比默认日历多了很多功能，能绑定Google Calendar和Apple日历事件，在菜单栏显示，非常方便。\u003c/p\u003e\n\u003ccenter\u003e\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1551701106/yicheng.me%20Blog/Screen_Shot_2019-02-22_at_3.25.36_PM.png\" width=80%\u003e\n\u003c/center\u003e\n\u003ch3 id=\"network--battery\"\u003eNetwork \u0026amp; Battery\u003c/h3\u003e\n\u003cp\u003e最好看的网速菜单栏显示软件，试了就知道\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641872968/network-and-battery-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"网易云音乐spotify在线音乐流媒体\"\u003e网易云音乐、Spotify（在线音乐流媒体）\u003c/h3\u003e\n\u003cp\u003e可能对我这种找歌靠日推而不是靠歌手的人而言，不粉任何当红歌星，就听听acg、纯音乐什么的，版权基本对我没有影响。相比国内其他音乐软件而言，网易云的界面是最耐看的，日推算法很准确，评论氛围也不错。\u003c/p\u003e\n\u003cp\u003e后来接触到了spotify之后就和Spotify结合着用，Spotify的推荐算法很强，多平台播放同步和支持Google home也很酸爽。\u003c/p\u003e\n\u003cp\u003e更新：这两年网易云的版权越来越少了，杂七杂八的东西也多了起来，Spotify版权更差，而且大多数没有歌词，后面基本都是本地听无损了。当然网易云可以通过代理的方法从其他地方获取灰掉的歌，只是不太方便。\u003c/p\u003e\n\u003ch3 id=\"audirvana-plus本地无损音乐播放器\"\u003eAudirvana Plus（本地无损音乐播放器）\u003c/h3\u003e\n\u003cp\u003e本地无损音乐播放器，墙裂推荐，听起来确实和其他音乐软件的音效不一样，就不只是听个响了，配合wav、ape等无损格式食用更佳（如1G多的加州旅馆）\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641872958/Audirvana-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"hidden-bar\"\u003eHidden Bar\u003c/h3\u003e\n\u003cp\u003e开源的菜单栏隐藏工具，可以帮助右上方的菜单栏变得干净。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641872959/hidden-bar-1.gif\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"fe-file-explorer\"\u003eFE File Explorer\u003c/h3\u003e\n\u003cp\u003e文件管理、nas连接都很方便\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641872968/fe-file-explorer-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"iina\"\u003eIINA\u003c/h3\u003e\n\u003cp\u003emac下很好用的一款开源的颜值很高的视频播放器\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641872960/IINA-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"uniconverter\"\u003eUniConverter\u003c/h3\u003e\n\u003cp\u003e万兴的文件格式转换软件（万兴真的是国产软件的清流），支持超多格式，界面干净，非常好用。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641894992/uniconverter-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"pdf-expertpdfelement\"\u003ePDF Expert、Pdfelement\u003c/h3\u003e\n\u003cp\u003e前者是轻量的pdf阅读软件，响应速度非常快。后者是万兴的pdf软件，功能很强大，经常拿它转换一些pdf，让它们的文字可以被搜索到。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641894993/pdf-expert-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"shadowsocksx-ngclashx\"\u003eShadowsocksX-NG、ClashX\u003c/h3\u003e\n\u003cp\u003e某科学的上网方法，节点不建议自己撘，还是找个靠谱的服务商比较好，一个月几十块钱，国内程序员、搞学术的必需品。就不细说了。\u003c/p\u003e\n\u003ch3 id=\"dropbox\"\u003eDropbox\u003c/h3\u003e\n\u003cp\u003e赫赫有名的同步云盘，和国内云盘的理念不同，dropbox只是纯粹的做同步和备份工作，不限速，多平台同步、国外支持云盘导入导出的软件基本都支持dropbox，唯一的缺点就是初始空间只有2G，之后可以做任务攒到18G左右（可以去淘宝买），订阅的话很贵，但是体验是真的舒服。我是配合NAS一起食用NAS放大文件（如视频），dropbox储存一些重要的小文件（如笔记、代码）。\u003c/p\u003e\n\u003cp\u003eDropbox的历史文档自动存储救了我好几次，好用到哭泣。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641894992/dropbox-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"telegram\"\u003eTelegram\u003c/h3\u003e\n\u003cp\u003e优雅的聊天应用，Mac/Win/Android/ios全平台推荐，聊天信息完全加密，（因为不透露用户隐私，tg在老家毛子那都被墙了），另外全平台传文件非常好用，吊打QQ，因为大家都懂的原因，国内用的人确实不是很多，和QQ互补着用挺好，微信就算了吧，文件太拉胯了。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641894992/telegram-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"paste\"\u003ePaste\u003c/h3\u003e\n\u003cp\u003e很方便的复制粘贴工具，可以记录历史复制的内容，提高效率\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1644157207/paste-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"downie4allavsoft\"\u003eDownie4、Allavsoft\u003c/h3\u003e\n\u003cp\u003e都是很好用的视频下载器，可以下载很多网站的视频，比如Bilibili、Youtube等等\u003c/p\u003e\n\u003ch3 id=\"parallels-desktop\"\u003eParallels Desktop\u003c/h3\u003e\n\u003cp\u003emacOS下的最强虚拟机软件，不过说实话，真不建议用mac开虚拟机，太浪费了，有win需求的话建议再买一台win。\u003c/p\u003e\n\u003ch2 id=\"程序猿篇\"\u003e程序猿篇\u003c/h2\u003e\n\u003ch3 id=\"jetbrains全家桶\"\u003eJetbrains全家桶\u003c/h3\u003e\n\u003cp\u003ePycharm、Idea、WEbstorm、Goland、Clion、Android Studio\u003c/p\u003e\n\u003cp\u003e（Jetbrains家的ide，用过的都说好）\u003c/p\u003e\n\u003cp\u003excode只有做ios、mac app开发的时候的挺好，毕竟垄断了，Visual Studio for mac用起来有点怪，还是乖乖的在win下用宇宙第一IDE吧。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641894992/jetbrains-1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"atomvs-code\"\u003eAtom/VS Code\u003c/h3\u003e\n\u003cp\u003e最开始选的Atom，中途无数次尝试VS Code（毕竟推荐的人很多），但是最后还是选择了Atom，性能确实不如vs code，但也没有感到明显的延迟（插件十来个也是秒开）。\u003c/p\u003e\n\u003cp\u003e用的是material ui的darker配色，比较耐看。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1549894263/E8F0C761-0FF4-4739-BFFB-62126E855D78_.png.jpg\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eAtom：99分的界面+70分的性能\u003c/p\u003e\n\u003cp\u003eVS code：90分的界面+99分的性能\u003c/p\u003e\n\u003cp\u003e颜控当然是选择Atom了\u003c/p\u003e\n\u003ch3 id=\"transmit\"\u003eTransmit\u003c/h3\u003e\n\u003cp\u003e图形化的ftp软件，在mac与远程服务器之间传输数据，很好用\u003c/p\u003e\n\u003ch3 id=\"startuml\"\u003eStartUML\u003c/h3\u003e\n\u003cp\u003eUML分析设计应用，画UML图还不错，虽然有些方面很糟心（比如复制什么的），但是好像找不出更能打的软件了。\u003c/p\u003e\n\u003ch3 id=\"navicat\"\u003eNavicat\u003c/h3\u003e\n\u003cp\u003e数据库管理软件，比命令行直观多了\u003c/p\u003e\n\u003ch3 id=\"postman\"\u003ePostman\u003c/h3\u003e\n\u003cp\u003e大名鼎鼎的api调试神器，CRUD程序猿必备\u003c/p\u003e\n\u003ch3 id=\"iterm2\"\u003eiTerm2\u003c/h3\u003e\n\u003cp\u003e代替自带终端bash的神器，自定义很丰富。\u003c/p\u003e\n\u003ch2 id=\"命令行组件\"\u003e命令行组件\u003c/h2\u003e\n\u003ch3 id=\"homebrew必装\"\u003eHomeBrew（必装）\u003c/h3\u003e\n\u003cp\u003eMac中类似linux的包管理工具，神器\u003c/p\u003e\n\u003cp\u003e安装Xcode命令行工具：\u003ccode\u003excode-select --install\u003c/code\u003e\n安装HomeBrew：\u003ccode\u003e/usr/bin/ruby -e \u0026quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)\u0026quot;\u003c/code\u003e\n等待即可，如果连不上可能是wall的原因\u003c/p\u003e\n\u003ch3 id=\"pythongitnode\"\u003epython、git、node...\u003c/h3\u003e\n\u003cp\u003e这类必装组件太多了，就不单独提了\u003c/p\u003e\n\u003ch3 id=\"oh-my-zsh\"\u003eoh-my-zsh\u003c/h3\u003e\n\u003cp\u003e下载zsh\n\u003ccode\u003ebrew install zsh\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e设置为默认shell\n\u003ccode\u003esudo sh -c \u0026quot;echo /usr/local/bin/zsh \u0026gt;\u0026gt; /etc/shells\u0026quot;\u003c/code\u003e\n\u003ccode\u003echsh -s /usr/local/bin/zsh\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003ezsh进一步配置及美化可以上网搜寻一些文章，我用了一圈主题最后还是回到了zsh的原版主题\u003c/p\u003e\n\u003cp\u003e功能很强大，这里不细谈了\u003c/p\u003e\n\u003ch3 id=\"neofetch\"\u003eneofetch\u003c/h3\u003e\n\u003cp\u003e显示ASCII形式的logo以及系统和硬件信息，很炫酷，华而不实hh\u003c/p\u003e\n\u003cp\u003e安装只需要\u003ccode\u003ebrew install neofetch\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e使用只需要输入\u003ccode\u003eneofetch\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1551701105/yicheng.me%20Blog/Screen_Shot_2019-02-21_at_6.23.13_PM.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"设计狮篇\"\u003e设计狮篇\u003c/h2\u003e\n\u003ch3 id=\"adobe全家桶\"\u003eAdobe全家桶\u003c/h3\u003e\n\u003cp\u003ePS、Pr、Ae、Au、Ai...不解释了，接触设计、多媒体的应该都会用到Adobe家的软件，Adobe在Mac平台下有加成。（而office在Mac下就是被削了）\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1641819661/adobe-1.jpg\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"sip\"\u003eSip\u003c/h3\u003e\n\u003cp\u003e屏幕取色器，可以取到屏幕任意位置的颜色数值，rgb、html格式都有，做ppt、PS和前端都很方便\u003c/p\u003e\n\u003ch3 id=\"sketch\"\u003eSketch\u003c/h3\u003e\n\u003cp\u003emac上最好用的矢量绘图软件，适合画概念图\u003c/p\u003e\n\u003cp\u003e未完待续...\u003c/p\u003e\n","date":1573371487,"description":"","fuzzywordcount":2800,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"b2d689ffd9ac7b85ca24f1220fe12c8b","publishdate":1573371487,"relpermalink":"/posts/mac-software-recommend/","section":"posts","summary":"注：以下软件或组件只是自我记录，因为是颜控，所以包含大量主观感情色彩 本篇不含软件资源，如果有需要建议去官网购买正版 多图预警！！！流量党请慎重 科研篇 Xmind 最好用的思维","tags":["macOS"],"title":"mac软件推荐","url":"https://blog.engine.wang/posts/mac-software-recommend/","wordcount":2716},{"categories":"posts","content":"\u003cp\u003e前年的时候，也就是17年年底，鉴于最低配的苏菲4性能比较羸弱，可怜的4G内存开个Chrome和Office就能吃满，分分钟卡爆，于是原来的电脑出掉了，准备更换一台高性能的电脑。\u003c/p\u003e\n\u003cp\u003e当时还在原专业读土木，某些软件只有Windows才有，上mbp显然是没想过的，另外宿舍用台式机也比较麻烦，所以只能选Windows笔记本。\u003c/p\u003e\n\u003cp\u003e预算其实并不是非常充足，但是内心有一种强烈的想法：买个配置够用的电脑多用几年。说实话五千块的电脑用三四年，真心不如一万的电脑用七八年。\u003c/p\u003e\n\u003cp\u003e卡顿是对时间的浪费，崩溃是对心血的亵渎。\u003c/p\u003e\n\u003cp\u003e一台电脑，配置固然是核心，但对我这种强迫症而言，工业设计也是一个重要因素。于是最后决定在XPS 15或者precision 5510中选择，它们的模具是一样的，主要区别在于其显卡和定位，前者是搭载游戏显卡，定位是超极本；后者搭载图形显卡，定位是移动图形工作站。\u003c/p\u003e\n\u003cp\u003e因为不玩大型游戏，所以最后选择了海淘一款官翻的precision 5510移动图形工作站，虽然买的价格不到国行新机的一半，但还是非常高。最后咬咬牙还是买了，事实证明这台precision 5510确实值这个价。\u003c/p\u003e\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1550418842/precision5510.jpg\" width=100%\u003e\n\u003cp\u003e主要部件如下：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eintel i7 6820HQ 处理器\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e16GB 镁光 DDR4  内存条\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSK hynix 512GB 固态硬盘\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e夏普 SHP1476 屏幕\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eNvidia Quadro M1000M 图形显卡\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eWindows10 pro 系统\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e使用这台工作站，跑了一年多Windows，总的体验当然是很用得很舒服，基本没出现过卡顿的情况，除了Ae渲染时风扇会狂转，其他时候完全无压力啊。win10本身尤其是UWP应用对4k触摸屏还是比较友好的（除了Windows的遗留win7风格界面），但是一些比较老旧或者小众的软件根本没有适配4k，导致那些软件要么字体非常小，看瞎了，要么强行靠缩放来保持尺寸，导致图标和字体发虚严重。4k在windows下的体验只能打80分。\u003c/p\u003e\n\u003cp\u003e最开始没想到要装黑苹果，只是偶然在B站看到了科技美学的XPS 15顶配黑苹果评测，瞬间被折服了:\n\u003ca href=\"https://www.bilibili.com/video/av6079016\"\u003e「科技美学」戴尔XPS15顶配版体验测评 黑苹果系统安装\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e当海舟用手开始在屏幕上拖视频块来做FCP剪辑时，弹幕已经沸腾了，就算是顶配定制版MacBook Pro也没有触摸屏，不管原因是为了与ipad的交互区分开，以免造成产品线混淆（正常人理解）还是考虑到抬手触屏不方便 触控板万岁！（果粉理解）亦或只是为了节约屏幕成本 赚更多的钱（果黑理解），事实还是：mbp就是没有配置触摸屏。\u003c/p\u003e\n\u003cp\u003e然而有趣的是，Mac OS系统和软件不仅支持高分辨率屏幕触摸操作，甚至比win10还支持的更好。\u003c/p\u003e\n\u003cp\u003e前几天通过针大的教程\u003ca href=\"https://hyejeong.cn/hackintosh5510mojave\"\u003eDell Precision 5510 Mojave Clover分享\u003c/a\u003e，花了两三天就比较顺利的装上了黑苹果，版本为Mojave 10.14.3，针大不仅写了很详细的教程和分享clover等文件，还通过私信解决了我的很多疑问，非常感激。如果有同样的precision5510想安装黑苹果的，可以去参考针大的这篇文章。\u003c/p\u003e\n\u003cp\u003e因为一些软件只能在win上运行，因此装的是双系统，512GB的SSD给Mac OS分了320GB，给win10留了剩下的一百来G。\u003c/p\u003e\n\u003cp\u003e下面对precision m5510 4k版黑苹果的各个方面做一个简单的小结，与mbp相比的优势与不足，以及黑苹果的完整程度：\u003c/p\u003e\n\u003ch2 id=\"屏幕\"\u003e屏幕\u003c/h2\u003e\n\u003cp\u003eMacBook Pro 15.4英寸的屏幕是 2880 x 1800 P3广色域 Retina视网膜屏\nPrecision5510 / XPS15 4k版的是 3840 x 2160 100%AdobeRGB UHD 康宁大猩猩玻璃触屏\u003c/p\u003e\n\u003cp\u003e单论屏幕素质，Retina的校色更准确，观感更舒适，而Dell的镜面屏分辨率更高，观感更鲜艳。这两款屏幕的素质在笔记本中绝对都在第一梯队，是设计人员的福音，两款屏幕属于神仙打架。\u003c/p\u003e\n\u003cp\u003e但有着触摸屏和Mac OS的加持，Precision 4k版本实现了mbp没有加入的触屏功能，感觉像是体验到了未来的mbp。\u003c/p\u003e\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1550418841/photo_2019-02-17_23.40.37.jpg\" width=100%\u003e\n\u003ch2 id=\"触控板\"\u003e触控板\u003c/h2\u003e\n\u003cp\u003embp的触控板有目共睹，触感和手势交互甩了普通PC一条街，precision/xps的触控板在win本中属于很优秀的，说实话触感虽然和mac是两种感觉，但也十分不错，可喜的是在黑苹果中precision/xps也各种手势操作能够有效执行，比如三指上下划、五指缩放等等，虽然还有一些距离但已经有些接近mbp了。但是前者触控板做工任然有一些瑕疵，看到很多反馈是有一部分比例的x/p本触控板出现轻微的下凹或上凸。\u003c/p\u003e\n\u003cp\u003eMac可以不需要鼠标，只用触控板做大部分工作，但是我尝试了一下搭载Mac OS的5510，还是不能完全脱离鼠标。\u003c/p\u003e\n\u003ch2 id=\"键盘\"\u003e键盘\u003c/h2\u003e\n\u003cp\u003eprecision/xps的键盘键程太短，说实话敲起来完全没有感觉，而且品控有的有些问题，我的两个Shift键都失灵了，扣下键帽也按不动就很难受，必须接着外接机械键盘，这样确实没问题而且敲得爽，但是外接键盘背来背去很不方便。\u003c/p\u003e\n\u003ch2 id=\"续航\"\u003e续航\u003c/h2\u003e\n\u003cp\u003e续航是4k版本的大短板，第一次使用这台电脑时，不插电两个小时后电脑就没电自动关机了，我的内心是绝望的。一方面是电池本身不足，另一方面是屏幕和显卡等（尤其是屏幕）耗电严重，我的这台5510就算开着屏幕什么软件也不运行，也就只能撑两个来小时；中大型软件开几个，80分钟内就能耗光全部电量。平常使用一直都得插着电，电脑要背走，充电器必须跟着，没有插座的地方完全不敢开机。\u003c/p\u003e\n\u003cp\u003e也许是我的这台情况过于严重了，其他的4k屏5510可能要好一些，不过也好不到太多，续航确实是硬伤。\u003c/p\u003e\n\u003ch2 id=\"相关驱动\"\u003e相关驱动\u003c/h2\u003e\n\u003cp\u003eintel的网卡无法驱动，需要去某宝单独购买，拆机后自动识别和正常苹果没区别。丽台M1000M图形显卡无法驱动，不过i7 6820hq的集显就够用了，只要不玩大游戏就好说，设计软件无压力。其他的驱动基本都可以正常运行。\u003c/p\u003e\n\u003ch3 id=\"总结\"\u003e总结\u003c/h3\u003e\n\u003cp\u003e总的说来，precision 5000系列/XPS 15可能是win阵营中，最适合安装黑苹果的机器之一，尤其是4k版本，触摸屏的加持更是更够体验到Mac OS别样的功能，4k下Mac的体验也比win10强太多了。\u003c/p\u003e\n\u003cp\u003e另外这个系列的模具工艺质量与工业设计很出色，也是PC本中少见的设计感与mbp有的一拼的产品。\u003c/p\u003e\n\u003cp\u003e以上便是我的Precision 5510安装黑苹果后的使用体验，若有任何疑问或错误请联系我，谢谢。\u003c/p\u003e\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1550418841/photo_2019-02-17_23.40.26.jpg\" width=100%\u003e\n\u003cp\u003e两天时间陆陆续续装了一些应用上去（未完待续），下一篇不鸽的话会写Mac的应用推荐与资源分享，不见不散\u003c/p\u003e\n","date":1567665187,"description":"","fuzzywordcount":2500,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"04f25bd7f7098ef8d8fa8d43f5198c8b","publishdate":1567665187,"relpermalink":"/posts/precision5510-hackintosh/","section":"posts","summary":"前年的时候，也就是17年年底，鉴于最低配的苏菲4性能比较羸弱，可怜的4G内存开个Chrome和Office就能吃满，分分钟卡爆，于是原来的电脑出掉了，准备更换一","tags":["黑苹果","折腾"],"title":"Precision5510 黑苹果使用体验","url":"https://blog.engine.wang/posts/precision5510-hackintosh/","wordcount":2446},{"categories":"posts","content":"\u003ch2 id=\"atom介绍\"\u003eAtom介绍\u003c/h2\u003e\n\u003cp\u003eAtom是一个Github出品的一个开源的免费文本编辑器，和VS Code、Sublime Text是对标产品。\u003c/p\u003e\n\u003cp\u003eAtom和VS Code一样，都是用Eletron构建的，插件也基本通用，可以认为是平替，我之所以用Atom主要还是因为其界面看上去更清爽，虽然性能比VS Code差，但是内存够大，实际体验也没有什么延迟。\u003c/p\u003e\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1537506574/atom_1.png\" width=100%\u003e\n\u003cp\u003e如果不清楚markdown的语法，可以访问 \u003ca href=\"https://www.markdownguide.org/basic-syntax/\"\u003eMarkdown basics\u003c/a\u003e进行学习，markdown的语法和配置都非常简单，比$LaTeX$容易太多了。\u003c/p\u003e\n\u003cp\u003e通过安装支持markdown插件就可以进行markdown的笔记写作，下面是一些我认为比较好的插件\u003c/p\u003e\n\u003ch2 id=\"markdown-preview-enhanced\"\u003eMarkdown Preview Enhanced\u003c/h2\u003e\n\u003cp\u003eAtom有原生对markdown的支持，但是毕竟简陋，Markdown Preview Enhanced可以扩展更多的功能，比如公式、图床、导出等。\u003c/p\u003e\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1544349042/Annotation_2018-12-09_175025.jpg\" width=\"90%\"\u003e\n\u003ch2 id=\"material-ui\"\u003eMaterial UI\u003c/h2\u003e\n\u003cp\u003eMaterial UI几乎是我所有编辑器的UI（包括Atom、VS Code、Jetbrains全家桶等），这套UI非常优雅和美观。\u003c/p\u003e\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1544348243/Annotation_2018-12-09_173501.jpg\" width=\"90%\"\u003e\n\u003ch2 id=\"title-bar-replacer-windows专用\"\u003eTitle-bar-replacer (windows专用)\u003c/h2\u003e\n\u003cp\u003eTitle-bar-replacer可以隐藏掉windows上方比较唐突的白色标题栏，使软件更加一体化。\u003c/p\u003e\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1544348538/Annotation_2018-12-09_174204.jpg\" width=\"90%\"\u003e\n\u003ch2 id=\"markdown-table-editor\"\u003eMarkdown-table-editor\u003c/h2\u003e\n\u003cp\u003eMarkdown语法写表格非常麻烦，markdown-table-editor可以使得我们在用写表格的时候更加方便，可以通过Tab、Enter等键快速排版\u003c/p\u003e\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1544348803/Annotation_2018-12-09_174619.jpg\" width=\"90%\"\u003e\n\u003ch3 id=\"其他的一些操作\"\u003e其他的一些操作\u003c/h3\u003e\n\u003ch2 id=\"修改字体\"\u003e修改字体\u003c/h2\u003e\n\u003cp\u003e修改软件界面字体，需要手动修改\u003ccode\u003estyles.less\u003c/code\u003e，通过\u003ccode\u003eFile\u003c/code\u003e-\u0026gt;\u003ccode\u003estylesheet\u003c/code\u003e来打开它\u003c/p\u003e\n\u003cp\u003e修改字体的属性：\u003ccode\u003eatom-text-editor\u003c/code\u003e, 我最喜欢的代码字体是\u003ccode\u003eFira Code\u003c/code\u003e, 需要在本地电脑先安装\u003ca href=\"https://github.com/tonsky/FiraCode\"\u003eFira Code\u003c/a\u003e，然后修改为：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-CSS\" data-lang=\"CSS\"\u003e\u003cspan class=\"nt\"\u003eatom-text-editor\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"n\"\u003etext-rendering\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"kc\"\u003eoptimizeLegibility\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"kp\"\u003e-webkit-\u003c/span\u003e\u003cspan class=\"n\"\u003efont-smoothing\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eantialiased\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"k\"\u003efont-family\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Fira Code\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"k\"\u003efont-weight\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"mi\"\u003e500\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"k\"\u003eline-height\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"mf\"\u003e1.7\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"nt\"\u003eatom-text-editor\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nc\"\u003eeditor\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"err\"\u003e.syntax--storage.syntax--type.syntax--function.syntax--arrow,\u003c/span\u003e\n  \u003cspan class=\"err\"\u003e.syntax--keyword.\u003c/span\u003e\u003cspan class=\"n\"\u003esyntax--operator\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"nf\"\u003enot\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"err\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eaccessor\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esyntax--punctuation\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esyntax--definition\u003c/span\u003e \u003cspan class=\"err\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efont-family\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Fira Code\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nc\"\u003esyntax--string\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nc\"\u003esyntax--quoted\u003c/span\u003e\u003cspan class=\"o\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nc\"\u003esyntax--string\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nc\"\u003esyntax--regexp\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kp\"\u003e-webkit-\u003c/span\u003e\u003cspan class=\"k\"\u003efont-feature-settings\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;liga\u0026#34;\u003c/span\u003e \u003cspan class=\"kc\"\u003eoff\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;calt\u0026#34;\u003c/span\u003e \u003cspan class=\"kc\"\u003eoff\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"err\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e如果要修改markdown右侧预览窗口的字体，则需要去markdown-preview-enhanced的theme里修改css。具体的路径为：\u003c/p\u003e\n\u003cp\u003eWindows通常在\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eC:\\Users\\\u0026lt;USER\u0026gt;\\.atom\\packages\\markdown-preview-enhanced\\node_modules\\@shd101wyy\\mume\\styles\\preview_theme\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003emacOS通常在\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e/Users/\u0026lt;USER\u0026gt;/.atom/packages/markdown-preview-enhanced/node_modules/@shd101wyy/mume/styles/preview_theme\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e选择目前使用的markdown预览样式的css文件，通常是github-light。\u003c/p\u003e\n\u003cp\u003e打开这个css，然后修改诸如字体等属性：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-css\" data-lang=\"css\"\u003e\u003cspan class=\"nt\"\u003ehtml\u003c/span\u003e \u003cspan class=\"nt\"\u003ebody\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003efont-family\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Fira Code\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e最后的样式：\u003c/p\u003e\n\u003cp\u003eWindows:\u003c/p\u003e\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1549894263/E8F0C761-0FF4-4739-BFFB-62126E855D78_.png.jpg\" width=100%\u003e\n\u003cp\u003eMacOS:\u003c/p\u003e\n\u003cimg src=\"https://res.cloudinary.com/dbmkzs2ez/image/upload/v1585187085/aNa4CHec.png\" width=\"100%\"\u003e\n","date":1553242345,"description":"","fuzzywordcount":1000,"kind":"page","lang":"zh","lastmod":1671120107,"objectID":"c42971315f87203e20f315923ddf67cd","publishdate":1553242345,"relpermalink":"/posts/use-atom-as-an-elegant-markdown-editor/","section":"posts","summary":"Atom介绍 Atom是一个Github出品的一个开源的免费文本编辑器，和VS Code、Sublime Text是对标产品。 Atom和VS Code一样，都是用Ele","tags":["Atom","markdown","美化"],"title":"Atom的Markdown配置与美化","url":"https://blog.engine.wang/posts/use-atom-as-an-elegant-markdown-editor/","wordcount":902}]